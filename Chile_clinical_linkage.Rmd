---
title: "Record matching"
author: "Adele Tyson"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/delat/OneDrive/MPhil Population Health Sciences 2022-2023/12 Dissertation")
```

```{r libraries, message = FALSE, warning = FALSE}

library(janitor)
library(Hmisc)
library(readxl)
library(reclin2)
library(lubridate)
library(fdm2id) # for predict that works for kmeans
library(ppclust) # for cmeans
library(tidyverse)

```

```{r import commune lookup}
commune_region_lookup <- read_excel("04_Data/Outputs/region_service_commune.xlsx") %>% clean_names()

```

```{r import school data}
chile_merged_raw <- read.csv("04_Data/Data_Chile_Merge.csv") %>% clean_names()

chile_merged <- chile_merged_raw %>%
  rename(sex_desc = sex,
         year = agno,
         school_code = rbd,
         school_check_code = dgv_rbd, 
         school_name = nom_rbd,
         school_region_code = cod_reg_rbd,
         school_region_name_abr = nom_reg_rbd_a,
         school_province_code = cod_pro_rbd,
         school_commune_code = cod_com_rbd,
         school_commune_name = nom_com_rbd,
         school_dept_code = cod_deprov_rbd,
         school_dept_name = nom_deprov_rbd,
         school_dependency_code = cod_depe, # has categories 1-6, no1 and no2 here are no1 in grouped
         school_dependency_code_grouped = cod_depe2, # has categories 1-5
         school_rurality_code = rural_rbd,
         school_operation_status = estado_estab, 
         teaching_code1 = cod_ense, # min = 10, max = 910, eg preschool, special education hearing impaired
         teaching_code2 = cod_ense2, # subject matter coding, 1-8
         teaching_code3 = cod_ense3, # age based coding, 1-7
         grade_code1 = cod_grado, # grade of schooling, 1-10, 21-25, 31-34, nests in teaching_code1
         grade_code2 = cod_grado2, # equivalent grade of schooling for adult special education, 1-8, 99
         grade_letter = let_cur, # refers to the class within the grade, close to start of alphabet is higher aptitude
         course_timing = cod_jor, # time of day, morning, afternoon, both, night, no info
         course_type = cod_tip_cur, # 0 = simple course, 1-4 = combined course, 99 = no info
         course_descr = cod_des_cur, # Description of course (TP secondary education only). 0: Does not apply, 1: Only High School, 2: Dual, 3: Other
         student_id = mrun,
         sex = gen_alu, # 0 = no info, 1 = male, 2 = female
         dob = fec_nac_alu_2, # The second one has DD
         age_june30 = edad_alu, # age at 30th June 2021
         special_needs_status = int_alu, # integrated student indicator, 0 = no, 1 = yes. Mostly no
         special_needs_code = cod_int_alu, # ADHD, blindness, etc. 0 = none. 105 = autism, 203 = ADHD. See ER_Matricula_por_alumno_PUBL_MRUN annex 7
         student_region_code = cod_reg_alu,
         student_commune_code = cod_com_alu,
         student_commune_name = nom_com_alu,
         economic_sector_code = cod_sec,
         economic_specialty_code = cod_espe,
         economic_branch_code = cod_rama,
         economic_profspec_code = cod_men,
         teaching_code_new = ens)


```

```{r import clinical data}
clinical_raw <- read_excel("04_Data/dataset_ssas_2015_2021.xlsx") %>% clean_names
#describe(clinical_raw)

clinical <- clinical_raw %>%
  select(c(-procedence, -ethnicity, -education_level, -disability, -foster_care)) %>%
  # Fix the date columns
  mutate(dob_eng = ifelse(str_detect(date_of_birth, "/"), 1, ifelse(str_detect(date_of_birth, "-"), 0, NA)),
         apt_eng = ifelse(str_detect(date_appointment, "/"), 1, ifelse(str_detect(date_appointment, "-"), 0, NA)),
         dob_day = ifelse(dob_eng == 1, as.integer(str_extract(date_of_birth, "^\\d+")), 
                          ifelse(dob_eng == 0, as.integer(str_extract(date_of_birth, "^\\d+")), NA)),
         dob_month = ifelse(dob_eng == 1, as.integer(str_extract(date_of_birth, "(?<=/)\\d+(?=/)")), 
                            ifelse(dob_eng == 0, str_extract(date_of_birth, "(?<=-)\\w+(?=-)"), NA)),
         dob_year = ifelse(dob_eng == 1, as.integer(str_extract(date_of_birth, "\\d+$")), 
                           ifelse(dob_eng == 0, as.integer(str_extract(date_of_birth, "\\d+$")) + 2000, NA)),
         dob_month_eng = as.integer(ifelse(dob_month == "ene", 1,
                                           ifelse(dob_month == "abr", 4, 
                                                  ifelse(dob_month == "ago", 8, 
                                                         ifelse(dob_month == "sept", 9, 
                                                                ifelse(dob_month == "dic", 12, dob_month)))))),
         dob = make_date(year = dob_year, month = dob_month_eng, day = dob_day),
         apt_day = ifelse(apt_eng == 1, as.integer(str_extract(date_appointment, "^\\d+")), 
                          ifelse(apt_eng == 0, as.integer(str_extract(date_appointment, "^\\d+")), NA)),
         apt_month = ifelse(apt_eng == 1, as.integer(str_extract(date_appointment, "(?<=/)\\d+(?=/)")), 
                            ifelse(apt_eng == 0, str_extract(date_appointment, "(?<=-)\\w+(?=-)"), NA)),
         apt_year = ifelse(apt_eng == 1, as.integer(str_extract(date_appointment, "\\d+$")), 
                           ifelse(apt_eng == 0, as.integer(str_extract(date_appointment, "\\d+$")) + 2000, NA)),
         apt_month_eng = as.integer(ifelse(apt_month == "ene", 1,
                                           ifelse(apt_month == "abr", 4, 
                                                  ifelse(apt_month == "ago", 8, 
                                                         ifelse(apt_month == "sept", 9, 
                                                                ifelse(apt_month == "dic", 12, apt_month)))))),
         apt_date = make_date(year = apt_year, month = apt_month_eng, day = apt_day),
         age_june30 = trunc(time_length(interval(ymd(dob), ymd("2021-06-30")), unit = "year")),
         commune_name = ifelse(comuna == "CHOL CHOL", "CHOLCHOL",
                                      ifelse(comuna == "CURACAUTIN", "CURACAUTÍN", 
                                             ifelse(comuna == "PITRUFQUEN", "PITRUFQUÉN", 
                                                    ifelse(comuna == "PUCON", "PUCÓN", 
                                                           ifelse(comuna == "TOLTEN", "TOLTÉN", 
                                                                  ifelse(comuna == "VILCUN", "VILCÚN", comuna)))))),
         ses_status = ifelse(socio_economic_level == "FONASA - A", 1, 
                            ifelse(socio_economic_level == "FONASA - B", 2,
                                   ifelse(socio_economic_level == "FONASA - C", 2, 
                                          ifelse(socio_economic_level == "FONASA - D", 2,
                                                 ifelse(socio_economic_level == "Private Health Insurance", 3, NA)))))
         ) %>%
  left_join(commune_region_lookup, by = "commune_name") %>%
  select(id, gender, commune_name, health_service_name, region_name, socio_economic_level, ses_status, dob, age_june30, apt_date, hospital, medical_specialty, type_appointment, codigo, diagnosis) 

clinical_small_raw <- read_excel("04_Data/Dataset_Vill_2014_2021.xlsx", col_names = TRUE) %>% clean_names()

clinical_small <- clinical_small_raw %>%
  rename("dob" = "fecha_nacimiento",
         "apt_date" = "fecha_ejecutada") %>%
  mutate(age_june30 = trunc(time_length(interval(ymd(dob), ymd("2021-06-30")), unit = "year")),
         commune_name = ifelse(comuna == "CHOL CHOL", "CHOLCHOL",
                                      ifelse(comuna == "CURACAUTIN", "CURACAUTÍN", 
                                             ifelse(comuna == "PITRUFQUEN", "PITRUFQUÉN", 
                                                    ifelse(comuna == "PUCON", "PUCÓN", 
                                                           ifelse(comuna == "TOLTEN", "TOLTÉN", 
                                                                  ifelse(comuna == "VILCUN", "VILCÚN", 
                                                                         ifelse(comuna == "DIEGO DE ALMAGRO  (#)", "DIEGO DE ALMAGRO",
                                                                                ifelse(comuna == "MACHALI", "MACHALÍ",
                                                                                       ifelse(comuna == "TEMUCO (##)", "TEMUCO", comuna))))))))),
         ses_status = ifelse(socio_economic_level == "FONASA - A", 1, 
                            ifelse(socio_economic_level == "FONASA - B", 2,
                                   ifelse(socio_economic_level == "FONASA - C", 2, 
                                          ifelse(socio_economic_level == "FONASA - D", 2,
                                                 ifelse(socio_economic_level == "Private Health Insurance", 3, NA)))))
         ) %>%
  rename("type_appointment" = "appoinment", "codigo" = "cod_dg_1", "diagnosis" = "diagnostico_1") %>%
  left_join(commune_region_lookup, by = "commune_name") %>%
  select(id, gender, commune_name, health_service_name, region_name, socio_economic_level, ses_status, dob, age_june30, apt_date, hospital, medical_specialty, type_appointment, codigo, diagnosis) 

clinical_communes <- clinical %>% group_by(commune_name) %>% summarise() %>% arrange() %>%
  mutate(commune_in_school_data = ifelse(commune_name %in% unique(chile_merged$student_commune_name), 1, 0)) # Needs to all be 1's
#clinical_communes <- clinical %>% group_by(student_commune_name) %>% summarise() %>% arrange() %>%
#  mutate(commune_in_school_data = ifelse(student_commune_name %in% unique(chile_merged$student_commune_name), 1, 0)) # Needs to all be 1's

#chile_merged %>% filter(school_region_name_abr == "ARAUC") %>% group_by(school_commune_name) %>% summarise() %>% arrange()



```

Fixed the date columns because they were in English and Spanish. Redefined the age column to be age at 30th June 2021.

Get one row per person to make matching more efficient. Take the earliest appointment for each person.



```{r restructure clinical}
patients <- clinical %>%
  group_by(id, gender, commune_name, dob, ses_status) %>%
  #group_by(id, gender, student_commune_name, dob, age_june30) %>%
  summarise() %>% 
  #summarise(first_apt = min(apt_date)) %>%
  ungroup() %>% 
  #rename("dob_full" = "dob",
  #       "sex_desc" = "gender") %>%
  #left_join(commune_region_lookup, by = "school_commune_name") %>%
  rename("student_commune_name" = "commune_name",
         "sex_desc" = "gender")
  #mutate(#school_region_name_abr = ifelse(comuna %in% c("CHOL CHOL", "CURACAUTIN", "PITRUFQUEN", "PUCON", "TOLTEN", "VILCUN"), "ARAUC", school_region_name_abr),
  #       dob = as.numeric(format(dob_full, "%Y%m")))
  # Some communes in the clinical data were not represented in the schools data but are also in Araucanía (ARAUC)
write_xlsx(patients, "04_Data/Outputs/patients.xlsx")

patients_small <- clinical_small %>%
  group_by(id, gender, commune_name, dob, ses_status) %>%
  summarise(first_apt = min(apt_date)) %>%
  ungroup() %>% 
  #rename("dob_full" = "dob") %>%
  left_join(commune_region_lookup, by = "commune_name") %>%
  mutate(#school_region_name_abr = ifelse(comuna %in% c("CHOL CHOL", "CURACAUTIN", "PITRUFQUEN", "PUCON", "TOLTEN", "VILCUN"), "ARAUC", school_region_name_abr),
         #dob = as.numeric(format(dob_full, "%Y%m")),
         sex_desc = str_to_title(gender)) %>%
  rename("student_commune_name" = "commune_name") %>%
  select(c(id, sex_desc, dob, student_commune_name, ses_status))

write_xlsx(patients_small, "04_Data/Outputs/patients_small.xlsx")

```

NB: there are 1473 unique ID's in patients and it's 1477 rows long, therefore 4 duplicates - probably moved communes.

Are all the records in the small dataset in the big one? No

```{r}
clinical %>% filter(id %in% clinical_small$id)

```

Are all the people in the small dataset in the big one? No

```{r}
patients %>% filter(id %in% patients_small$id)

```

Assume this is because the big clinical dataset only has people with autism, not ADHD.



# Record linkage using machine learning

First try linkage using ML, as done by Jan van der Laan here https://cran.r-project.org/web/packages/reclin2/vignettes/record_linkage_using_machine_learning.html 


Only try to link clinical data to records in the schools data for the Araucanía (ARAUC) because that's where the clinical data is from.

```{r set up data}
school <- chile_merged %>%
  rename(commune_name = student_commune_name) %>%
  left_join(commune_region_lookup, by = "commune_name") %>%
  filter(health_service_name == "Servicio de Salud Araucanía Sur") %>% # This should be filtered either on the specific ARAUC communes in the clinical data or using student_commune_region not school_region.
  filter(age_june30 >= 6 & age_june30 <= 18, sex != 0) %>% # Could try without this filter to pick up edge cases just in case
  # filter only the communes represented in the clinical data here?
  mutate(autism = ifelse(special_needs_code == 105, 1, 0),
         dob = ymd(dob),
         ses_status = ifelse(school_fee == "", 0, 
                             ifelse(school_fee == "GRATUITO", 1, 
                                    ifelse(school_fee == "$1.000 A $10.000", 2,
                                           ifelse(school_fee == "$10.001 A $25.000", 2, 
                                                  ifelse(school_fee == "$25.001 A $50.000", 2,
                                                         ifelse(school_fee == "$50.001 A $100.000", 2, 
                                                                ifelse(school_fee == "MAS DE $100.000", 2, 
                                                                       ifelse(school_fee == "SIN INFORMACION", 0, NA))))))))) %>%
  filter(autism == 1) %>% # We only want to find additional autism cases in the clinical records, we don't care if a student has autism and isn't in the clinical records
  rename(student_region_name = region_name, student_commune_name = commune_name) %>%
  select(sex_desc,
    dob,
    age_june30,
    ses_status,
    autism,
    #school_commune_name,
    student_region_name,
    student_commune_name,
    health_service_name # need to join to chile_communes to have this
  )

# Do the commune names align well? Yes
table(sort(unique(patients$student_commune_name, sort(unique(school$student_commune_name)))))
sort(unique(patients$student_commune_name))
sort(unique(school$student_commune_name))

```



# Try manual linkage

```{r manual linkage}
patients_grouped <- patients %>%
  group_by(sex_desc, 
           dob, 
           student_commune_name) %>%
  summarise(count = n(),
            ids = list(id))

school_grouped <- school %>%
  group_by(sex_desc, 
           dob, 
           student_commune_name) %>%
  summarise(count = n(),
            #ids = list(rowid)
            ses = list(ses_status))


sort(unique(patients$student_commune_name))
sort(unique(school$student_commune_name))

```
All the students that can't be uniquely identified (6) are males in Temuco and SES status doesn't help distinguish them.


# Try ML matching

```{r similarity functions}
get_num_diff <- function(.x, .y) {
  diff_value <- data.frame(.x = .x, .y = .y, val = numeric(length(.x)))
  diff_value <- diff_value %>%
    mutate(val = ifelse(abs(.x-.y) == 0, 1, 
                        ifelse(abs(.x-.y) <= 1, 0.5,
                               ifelse(abs(.x-.y) <= 2, 0.25, 
                                      ifelse(abs(.x-.y) <= 3, 0.125, 0)))))
  
  return(diff_value)
}

```


```{r pairs}

    
get_num_diff(c(1, 2, 3), c(1, 1, 1))
get_num_diff(1, 2)$val

# Generate pairs
# use smaller clinical data for now to get it working
pairs <- # Also try without the blocking 
         pair_blocking(patients, school, on = c("sex_desc", "dob")) %>%
         #pair(x = patients, y = school) %>%
  mutate(#age_june30 = get_num_diff(patients$age_june30[.x], school$age_june30[.y])$val,
         #dob = get_num_diff(patients$dob[.x], school$dob[.y])$val,
         #dob = patients$dob[.x] == school$dob[.y],
         #school_commune_name = (patients$school_commune_name[.x] == school$school_commune_name[.y])# will need a better commune similarity algorithm
         student_commune_name = (patients$student_commune_name[.x] == school$student_commune_name[.y]),
         sex_desc = patients$sex_desc[.x] == school$sex_desc[.y],
         ses = get_num_diff(patients$ses_status[.x], school$ses_status[.y])$val
         #ses_pat = patients$ses_status[.x],
         #ses_sch = school$ses_status[.y]
         ) 

pairs_match <- pairs %>% filter(student_commune_name == TRUE & sex_desc == TRUE)
# Vast majority of school records are free (1).

# Try k-means clustering
set.seed(123)
k <- 2 # We know there are 2 classes: matched records and un-matched records, and we'd like a 3rd class for maybes
kmeans_result <- kmeans(select(pairs, c(-.x, -.y)), k, nstart = 20)
pairs$k_pred <- predict(kmeans_result, select(pairs, c(-.x, -.y)))
#table(pairs$pred)
#table(pairs$dob, pairs$student_commune_name, pairs$sex_desc, pairs$pred)
pairs_grouped <- pairs %>% group_by(k_pred, sex_desc, student_commune_name, 
                                    #dob, 
                                    ses
                                    #ses_pat, ses_sch
                                    ) %>% summarise()
```

```{r unsupervised ML}

# Not very useful

pairs %>% filter(k_pred == 1) %>% summary()
pairs %>% filter(k_pred == 2) %>% summary()
#pairs %>% filter(k_pred == 3) %>% summary()


# Try c-means clustering
set.seed(123)
c <- 2
pairs_trues <- pairs %>% filter((dob == TRUE & student_commune_name == TRUE) |
                                  (dob == TRUE & sex_desc == TRUE) |
                                  (student_commune_name == TRUE & sex_desc == TRUE)) %>% select(-k_pred) # Remove clearly unmatched rows to help computation time
v <- inaparc::kmpp(select(pairs_trues, c(-.x, -.y)), k = c)$v
u <- inaparc::imembrand(nrow(pairs_trues), k = c)$u
cmeans_result <- fcm(select(pairs_trues, c(-.x, -.y)),
                     centers = v, # Starting centers to trial
                     memberships = u,
                     m = 2, # Fuzziness, keep as 2
                     dmetric = "sqeuclidean", # Distance between points - may not be suitable for binary variables
                     nstart = 1) # Number of repeats
pairs_trues$c_pred <- cmeans_result$cluster
cmeans_result$u

pairs_trues %>% filter(c_pred == 1) %>% summary()
pairs_trues %>% filter(c_pred == 2) %>% summary()

# Compare pairs - takes a couple of minutes to run with blocking on sex
#compare_pairs(pairs, on = c("age_june30", "dob", "school_commune_name"), 
#              comparators = list(#age_june30 = get_num_diff(.x, .y)#, # For now, require exact match on age
#                                 dob = jaro_winkler() #, 
#                                 #school_commune_name = jaro_winkler() # For now, require exact match on commune
#                                 ),
#              inplace = TRUE # Allows pairs to be modified in place - makes it more efficient when pairs is large
#              )
# No need to assign this to anything, it updates pairs with additional columns
# compare_pairs() works for patients_small + school (174,173 pairs) but doesn't work for patients + school (655,680 pairs)
# Can't handle more than approx 400,000 pairs


```

In reclin2 package, use ?identical() to see available matching algorithms.

The Jaro-Winkler distance is a string metric for measuring the edit distance between two sequences. It is a variant of the Jaro distance metric proposed by William E. Winkler in 1990 1. The Jaro-Winkler distance uses a prefix scale which gives more favorable ratings to strings that match from the beginning for a set prefix length. The higher the Jaro-Winkler distance for two strings is, the less similar the strings are. The score is normalized such that 0 means an exact match and 1 means there is no similarity 1.

Need to explore different comparator algorithms. Currently it's exact match. Would be good to do communes that are neighbours and ages off by 1.


# Try bayesian linkage

Follow Thomas Stringham https://arxiv.org/pdf/2003.04238.pdf
who followed Sadinle https://arxiv.org/abs/1601.06630
















