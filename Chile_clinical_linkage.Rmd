---
title: "Record matching"
author: "Adele Tyson"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/delat/OneDrive/MPhil Population Health Sciences 2022-2023/12 Dissertation")
```

```{r libraries, message = FALSE, warning = FALSE}

library(janitor)
library(Hmisc)
library(readxl)
library(reclin2)
library(lubridate)
library(tidyverse)

```

```{r import school data}
chile_merged_raw <- read.csv("04_Data/Data_Chile_Merge.csv") %>% clean_names()

chile_merged <- chile_merged_raw %>%
  rename(sex_desc = sex,
         year = agno,
         school_code = rbd,
         school_check_code = dgv_rbd, 
         school_name = nom_rbd,
         school_region_code = cod_reg_rbd,
         school_region_name_abr = nom_reg_rbd_a,
         school_province_code = cod_pro_rbd,
         school_commune_code = cod_com_rbd,
         school_commune_name = nom_com_rbd,
         school_dept_code = cod_deprov_rbd,
         school_dept_name = nom_deprov_rbd,
         school_dependency_code = cod_depe, # has categories 1-6, no1 and no2 here are no1 in grouped
         school_dependency_code_grouped = cod_depe2, # has categories 1-5
         school_rurality_code = rural_rbd,
         school_operation_status = estado_estab, 
         teaching_code1 = cod_ense, # min = 10, max = 910, eg preschool, special education hearing impaired
         teaching_code2 = cod_ense2, # subject matter coding, 1-8
         teaching_code3 = cod_ense3, # age based coding, 1-7
         grade_code1 = cod_grado, # grade of schooling, 1-10, 21-25, 31-34, nests in teaching_code1
         grade_code2 = cod_grado2, # equivalent grade of schooling for adult special education, 1-8, 99
         grade_letter = let_cur, # refers to the class within the grade, close to start of alphabet is higher aptitude
         course_timing = cod_jor, # time of day, morning, afternoon, both, night, no info
         course_type = cod_tip_cur, # 0 = simple course, 1-4 = combined course, 99 = no info
         course_descr = cod_des_cur, # Description of course (TP secondary education only). 0: Does not apply, 1: Only High School, 2: Dual, 3: Other
         student_id = mrun,
         sex = gen_alu, # 0 = no info, 1 = male, 2 = female
         dob = fec_nac_alu,
         age_june30 = edad_alu, # age at 30th June 2021
         special_needs_status = int_alu, # integrated student indicator, 0 = no, 1 = yes. Mostly no
         special_needs_code = cod_int_alu, # ADHD, blindness, etc. 0 = none. 105 = autism, 203 = ADHD. See ER_Matricula_por_alumno_PUBL_MRUN annex 7
         student_region_code = cod_reg_alu,
         student_commune_code = cod_com_alu,
         student_commune_name = nom_com_alu,
         economic_sector_code = cod_sec,
         economic_specialty_code = cod_espe,
         economic_branch_code = cod_rama,
         economic_profspec_code = cod_men,
         teaching_code_new = ens) 


```

```{r import clinical data}
clinical_raw <- read_excel("04_Data/dataset_ssas_2015_2021.xlsx") %>% clean_names
#describe(clinical_raw)

clinical <- clinical_raw %>%
  select(c(-procedence, -ethnicity, -education_level, -disability, -foster_care)) %>%
  # Fix the date columns
  mutate(dob_eng = ifelse(str_detect(date_of_birth, "/"), 1, ifelse(str_detect(date_of_birth, "-"), 0, NA)),
         apt_eng = ifelse(str_detect(date_appointment, "/"), 1, ifelse(str_detect(date_appointment, "-"), 0, NA)),
         dob_day = ifelse(dob_eng == 1, as.integer(str_extract(date_of_birth, "^\\d+")), 
                          ifelse(dob_eng == 0, as.integer(str_extract(date_of_birth, "^\\d+")), NA)),
         dob_month = ifelse(dob_eng == 1, as.integer(str_extract(date_of_birth, "(?<=/)\\d+(?=/)")), 
                            ifelse(dob_eng == 0, str_extract(date_of_birth, "(?<=-)\\w+(?=-)"), NA)),
         dob_year = ifelse(dob_eng == 1, as.integer(str_extract(date_of_birth, "\\d+$")), 
                           ifelse(dob_eng == 0, as.integer(str_extract(date_of_birth, "\\d+$")) + 2000, NA)),
         dob_month_eng = as.integer(ifelse(dob_month == "ene", 1,
                                           ifelse(dob_month == "abr", 4, 
                                                  ifelse(dob_month == "ago", 8, 
                                                         ifelse(dob_month == "sept", 9, 
                                                                ifelse(dob_month == "dic", 12, dob_month)))))),
         dob = make_date(year = dob_year, month = dob_month_eng, day = dob_day),
         apt_day = ifelse(apt_eng == 1, as.integer(str_extract(date_appointment, "^\\d+")), 
                          ifelse(apt_eng == 0, as.integer(str_extract(date_appointment, "^\\d+")), NA)),
         apt_month = ifelse(apt_eng == 1, as.integer(str_extract(date_appointment, "(?<=/)\\d+(?=/)")), 
                            ifelse(apt_eng == 0, str_extract(date_appointment, "(?<=-)\\w+(?=-)"), NA)),
         apt_year = ifelse(apt_eng == 1, as.integer(str_extract(date_appointment, "\\d+$")), 
                           ifelse(apt_eng == 0, as.integer(str_extract(date_appointment, "\\d+$")) + 2000, NA)),
         apt_month_eng = as.integer(ifelse(apt_month == "ene", 1,
                                           ifelse(apt_month == "abr", 4, 
                                                  ifelse(apt_month == "ago", 8, 
                                                         ifelse(apt_month == "sept", 9, 
                                                                ifelse(apt_month == "dic", 12, apt_month)))))),
         apt_date = make_date(year = apt_year, month = apt_month_eng, day = apt_day),
         age_june30 = trunc(time_length(interval(ymd(dob), ymd("2021-06-30")), unit = "year"))) %>%
  select(id, gender, comuna, socio_economic_level, dob, age_june30, apt_date, hospital, medical_specialty, type_appointment, codigo, diagnosis) #%>%
  #left_join(chile_communes, by = )


clinical_small_raw <- read_excel("04_Data/Dataset_Vill_2014_2021.xlsx", col_names = TRUE) %>% clean_names()
#colnames(clinical_small) <- colnames(clinical_raw)

clinical_small <- clinical_small_raw %>%
  rename("dob" = "fecha_nacimiento",
         "apt_date" = "fecha_ejecutada") %>%
  mutate(age_june30 = trunc(time_length(interval(ymd(dob), ymd("2021-06-30")), unit = "year")))


```

Fixed the date columns because they were in English and Spanish. Redefined the age column to be age at 30th June 2021.

Get one row per person to make matching more efficient. Take the earliest appointment for each person.

```{r restructure data}
commune_region <- chile_merged %>%
  group_by(school_region_name_abr, school_commune_name) %>%
  summarise() %>%
  rename("comuna" = "school_commune_name")

patients <- clinical %>%
  group_by(id, gender, comuna, dob, age_june30) %>%
  summarise() %>%
  #summarise(first_apt = min(apt_date)) %>%
  ungroup() %>% 
  rename("dob_full" = "dob",
         "sex_desc" = "gender") %>%
  left_join(commune_region, by = "comuna") %>%
  mutate(school_region_name_abr = ifelse(comuna %in% c("CHOL CHOL", "CURACAUTIN", "PITRUFQUEN", "PUCON", "TOLTEN", "VILCUN"), "ARAUC", school_region_name_abr),
         dob = as.numeric(format(dob_full, "%Y%m"))) %>%
  rename("school_commune_name" = "comuna")
  # Some communes in the clinical data were not represented in the schools data but are also in Araucanía (ARAUC)

patients_small <- clinical_small %>%
  group_by(id, gender, comuna, dob, age_june30) %>%
  summarise(first_apt = min(apt_date)) %>%
  ungroup() %>% 
  rename("dob_full" = "dob") %>%
  left_join(commune_region, by = "comuna") %>%
  mutate(school_region_name_abr = ifelse(comuna %in% c("CHOL CHOL", "CURACAUTIN", "PITRUFQUEN", "PUCON", "TOLTEN", "VILCUN"), "ARAUC", school_region_name_abr),
         dob = as.numeric(format(dob_full, "%Y%m")),
         sex_desc = str_to_title(gender)) %>%
  rename("school_commune_name" = "comuna") %>%
  select(c(id, sex_desc, school_commune_name, age_june30, dob))

```

NB: there are 1473 unique ID's in patients and it's 1477 rows long, therefore 4 duplicates - probably moved communes.

Are all the records in the small dataset in the big one? No

```{r}
clinical %>% filter(id %in% clinical_small$id)

```

Are all the people in the small dataset in the big one? No

```{r}
patients %>% filter(id %in% patients_small$id)

```

Assume this is because the big clinical dataset only has people with autism, not ADHD.


# Record linkage using machine learning

First try linkage using ML, as done by Jan van der Laan here https://cran.r-project.org/web/packages/reclin2/vignettes/record_linkage_using_machine_learning.html 

Only try to link clinical data to records in the schools data for the Araucanía (ARAUC) because that's where the clinical data is from.

```{r set up data}
school <- chile_merged %>%
  filter(school_region_name_abr == "ARAUC") %>%
  filter(age_june30 >= 6 & age_june30 <= 18, sex != 0) %>% # Could try without this filter to pick up edge cases just in case
  mutate(autism = ifelse(special_needs_code == 105, 1, 0)) %>%
  filter(autism == 1) %>% # We only want to find additional autism cases in the clinical records, we don't care if a student has autism and isn't in the clinical records
  select(
    #school_region_name_abr,
    #sex,
    sex_desc,
    dob,
    age_june30,
    #school_rurality_code,
    #school_fee,
    #ethnicity,
    #mapuche,
    #nationality,
    #ethnic_3_group,
    autism,
    school_commune_name
    #health_service_name # need to join to chile_communes to have this
  ) 

```


```{r pairs}
# Generate pairs
# use smaller clinical data for now to get it working
pairs <- pair_blocking(patients_small, school, on = "sex_desc") # Also try without the blocking

# Compare pairs - takes a couple of minutes to run with blocking on sex
compare_pairs(pairs, on = c("age_june30", "dob", "school_commune_name"), 
              #comparators = list(age_june30 = jaro_winkler(), dob = jaro_winkler(), school_commune_name = jaro_winkler()),
              inplace = TRUE # Allows pairs to be modified in place - makes it more efficient when pairs is large
              )
# No need to assign this to anything, it updates pairs with additional columns


```

The Jaro-Winkler distance is a string metric for measuring the edit distance between two sequences. It is a variant of the Jaro distance metric proposed by William E. Winkler in 1990 1. The Jaro-Winkler distance uses a prefix scale which gives more favorable ratings to strings that match from the beginning for a set prefix length. The higher the Jaro-Winkler distance for two strings is, the less similar the strings are. The score is normalized such that 0 means an exact match and 1 means there is no similarity 1.

Need to explore different comparator algorithms. Currently it's exact match.












