---
title: "Autism and ADHD prevalence in Chile through Bayesian prevalence analysis, machine learning and clinical record data linkage"
author: "Student 5526, Newnham College"
date: "`r Sys.Date()`"
output: 
  bookdown::pdf_document2:
    toc: no
    number_sections: TRUE

---
    
<!--header-includes:
  - \usepackage{titling}
  - \pretitle{\begin{center}
  - \posttitle{\end{center}} -->
  
<!-- Optionally include a page break. This will force the start
of the document to the second page -->

\begin{center}

Declaration: 'This dissertation is submitted for the degree of Master of Philosophy.'

\end{center}

\newpage

This dissertation is the result of my own work and includes nothing which is the outcome of work done in collaboration except where specifically indicated in the text. 

The dissertation does not exceed the word limit for the respective Degree Committee. 

Word count: xxx TODO (including footnotes, but excluding tables, appendices, and bibliography)

$$\\[1in]$$

**Acknowledgements**

With thanks to my supervisor, Dr Andres Roman-Urrestarazu, Department of Psychiatry, University of Cambridge, for his time, expertise and encouragement throughout this project, to Jonathan Lewis at Cambridgeshire and Peterborough NHS Foundation Trust for assisting with access to their data, to Health Data Research UK for their generous scholarship, and to my Dad for first sparking my interest in health data science many years ago.

\newpage

```{=latex}
\setcounter{tocdepth}{4}
\tableofcontents
```

\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = "C:/Users/delat/OneDrive/MPhil Population Health Sciences 2022-2023/12 Dissertation")
```


```{r libraries}

#library(nleqslv) # Only needed for robince bayesian prevalence
library(janitor)
library(gridExtra)
library(readxl)
library(writexl)
library(png)
library(viridis)
#library(wesanderson)
library(rgbif)
library(chilemapas) # For commune maps
library(leaflet)
library(plotly)
library(knitr)
library(kableExtra)
library(sf)
library(sp)
library(broom)
library(psych)
library(Hmisc)
library(poolr)
library(epitools)
#library(corrplot)
#library(caret)
library(mltools)
library(ggrepel)
library(rjags)
library(rstan)
library(posterior)
library(tidybayes)
library(bayesplot)
library(reclin2)
library(lubridate)
library(RecordLinkage)
library(dgof) # for statistical testing
library(fdm2id) # for predict that works for kmeans
library(ppclust) # for cmeans
library(factoextra) # for get_cluster_?
library(FactoMineR) # for MCA
library(tidyverse)

```


```{r importGeographicData}

# Import region and commune boundaries
# https://data.humdata.org/dataset/cod-ab-chl
chile.adm1 <- st_read("04_Data/CHL_adm_humdata/chl_admbnda_adm1_bcn_20211008.shp", quiet = TRUE) #%>%
  #st_transform(crs = 32629)
chile.adm3 <- st_read("04_Data/CHL_adm_humdata/chl_admbnda_adm3_bcn_20211008.shp", quiet = TRUE) %>%
  mutate(commune_code = str_sub(ADM3_PCODE, start = 3, end = -1),
         commune_name = ADM3_ES)
#chile.adm3_old <- st_read("04_Data/CHL_adm/CHL_adm3.shp", quiet = TRUE)



# Get communes with health services
chile_communes_raw <- read_excel("04_Data/commune_by_health_service.xlsx") %>%
  clean_names()

chile_communes <- chile_communes_raw %>%
  mutate(commune_name = ifelse(comuna == "La Calera", "Calera",
                        ifelse(comuna == "Coihaique", "Coyhaique",
                        ifelse(comuna == "Paiguano", "Paihuano",
                        ifelse(comuna == "Pedro Aguirre Cerda", "Pedro Aguirre Cerda",
                        comuna))))) %>%
rename("health_service_name" = "servicio_de_salud") %>%
  select(commune_name, health_service_name)

# Create a number for each health service
health_service_lookup <- chile_communes %>%
  group_by(health_service_name) %>%
  summarise() %>% 
  #rename(health_service_name_long = health_service_name) %>%
  mutate(health_service_name_shortish = ifelse(grepl(" Del ", health_service_name), 
                                      str_sub(health_service_name, start = 23, end = -1), 
                                      str_sub(health_service_name, start = 19, end = -1)),
         health_service_name_short = ifelse(health_service_name_shortish == "Libertador B.O'Higgins", "O'Higgins",
                                     ifelse(health_service_name_shortish == "Metropolitano Central", "Metro. Central",
                                     ifelse(health_service_name_shortish == "Metropolitano Norte", "Metro. Norte",
                                     ifelse(health_service_name_shortish == "Metropolitano Occidente", "Metro. Occidente",
                                     ifelse(health_service_name_shortish == "Metropolitano Oriente", "Metro. Oriente",
                                     ifelse(health_service_name_shortish == "Metropolitano Sur", "Metro. Sur",
                                     ifelse(health_service_name_shortish == "Metropolitano Sur Oriente", "Metro. Sur Oriente",
                                     ifelse(health_service_name_shortish == "Valparaíso San Antonio", "Valparaíso",
                                     ifelse(health_service_name_shortish == "Viña del Mar Quillota", "Viña del Mar",
                                            health_service_name_shortish)))))))))) %>%
  arrange(health_service_name_short) %>%
  rowid_to_column("health_service_code")

# Get region codes with region name abbreviations
region_abr_lookup <- data.frame(
  ADM1_PCODE = c(paste0("CL0", c(1:9)), paste0("CL", c(10:16))),
  region_name_abr = c("TPCA", "ANTOF", "ATCMA", "COQ", "VALPO", "LGBO", "MAULE", "BBIO",
                      "ARAUC", "LAGOS", "AYSEN", "MAG", "RM", "RIOS", "AYP", "NUBLE"))

# Put region, health service and communes together
region_service_commune_lookup <- chile.adm3 %>%
  merge(chile_communes, by = "commune_name", all = TRUE) %>%
  mutate(commune_code = ifelse(commune_name == "Antártica", "12202", commune_code),
         ADM3_PCODE = ifelse(commune_name == "Antártica", "CL12202", ADM3_PCODE),
         ADM1_ES = ifelse(commune_name == "Antártica", "Región de Magallanes y Antártica Chilena", ADM1_ES),
         ADM1_PCODE = ifelse(commune_name == "Antártica", "CL12", ADM1_PCODE),
         commune_name = ifelse(ADM3_PCODE == "CL01401", "Pozo Almonte", commune_name),
                        # For the Tocopilla in Tarapaca, use it's old name to avoid duplication issues
         health_service_name = 
           ifelse(ADM3_PCODE == "CL01401", "Servicio de Salud Iquique", 
           ifelse(ADM3_PCODE == "CL11201", "Servicio de Salud Aisén",
           ifelse(ADM3_PCODE == "CL05201", "Servicio de Salud Valparaíso San Antonio", 
                    # Isla del Pascua is actually served by Metro Oriente but maps to Valparaiso
           ifelse(ADM3_PCODE == "CL08206", "Servicio de Salud Arauco",
           ifelse(ADM3_PCODE == "CL08301", "Servicio de Salud Biobío",
           ifelse(ADM3_PCODE == "CL06204", "Servicio de Salud Del Libertador B.O'Higgins",
           ifelse(ADM3_PCODE == "CL13121", "Servicio de Salud Metropolitano Sur",
           ifelse(ADM3_PCODE == "CL16206", "Servicio de Salud Ñuble", health_service_name)))))))),
         region_code = str_sub(ADM1_PCODE, start = 3, end = -1),
         commune_name_upper = toupper(commune_name)) %>%
  rename(region_name = ADM1_ES) %>%
  filter(!is.na(ADM3_PCODE)) %>% # Get rid of the communes that didn't match properly with health service lookup and were corrected above
  merge(region_abr_lookup, by = "ADM1_PCODE")
  
region_service_commune_lookup <- merge(region_service_commune_lookup, 
                                       health_service_lookup,
                                       by = "health_service_name", all = TRUE) %>%
  rename(region_name_long = region_name,
         health_service_name_long = health_service_name,
         health_service_name = health_service_name_short) %>%
  mutate(region_name = ifelse(region_name_long == "Región Metropolitana de Santiago", "Metropolitana de Santiago",
                       ifelse(grepl("Región de ", region_name_long), 
                              substr(region_name_long, start = 11, stop = nchar(region_name_long)), 
                       ifelse(grepl("Región del ", region_name_long), 
                              substr(region_name_long, start = 12, stop = nchar(region_name_long)), NA)))) %>%
  select(region_name_long, region_name, region_name_abr, region_code, ADM1_PCODE,
         commune_name, commune_name_upper, commune_code, 
         health_service_name_long, health_service_name_shortish, health_service_name, health_service_code,
         geometry)

# Aggregate to region level (no )
region_lookup <- region_service_commune_lookup %>% 
  as.tibble() %>%
  select(-geometry) %>%
  group_by(region_code, ADM1_PCODE, region_name, region_name_abr) %>% 
  summarise() 

region_service_lookup <- region_service_commune_lookup %>%
  as.tibble() %>%
  select(-geometry) %>%
  group_by(region_code, region_name, health_service_code, health_service_name_shortish, health_service_name) %>%
  summarise()

# Extract communes for the Araucania Sur and Norte health services
araucnorte_communes <- region_service_commune_lookup %>%
  filter(str_detect(health_service_name, "a Norte")) %>%
  as.tibble() %>%
  select(commune_code, commune_name)
araucsur_communes <- region_service_commune_lookup %>%
  filter(str_detect(health_service_name, "a Sur")) %>%
  as.tibble() %>%
  select(commune_code, commune_name)

```

```{r importStandardPopulationData}
chile_stdpop_raw <- read_excel("04_Data/pop_chile_2021_single_age.xlsx") %>%
  clean_names() 

chile_stdpop <- chile_stdpop_raw %>%
  filter(sex != 9) %>%
  rename("std_pop" = "pop_2021") %>%
  mutate(pop_prop = std_pop / sum(std_pop))
```

```{r importChileDemogData}
# https://www.ine.gob.cl/estadisticas/sociales/demografia-y-vitales/proyecciones-de-poblacion
chile_regionpop_raw <- read_excel("04_Data/ine_estimaciones-y-proyecciones-2002-2035_base-2017_region_area_tabulados.xlsx", sheet = "Region summary 2021") %>%
  clean_names()

chile_regionpop <- chile_regionpop_raw %>%
  mutate(region_name = ifelse(region == "Aysén", "Aysén del Gral. Ibañez del Campo",
                         ifelse(region == "Biobío", "Bío-Bío",
                         ifelse(region == "Magallanes", "Magallanes y Antártica Chilena",
                         ifelse(region == "Metropolitana", "Metropolitana de Santiago",
                         ifelse(region == "OHiggins", "Libertador Bernardo O'Higgins", region)))))) %>%
  select(-region)

# https://www.ine.gob.cl/estadisticas/sociales/ingresos-y-gastos/encuesta-suplementaria-de-ingresos
# Income is from Supplementary Income Survey (ESI) (2021), data is from Instituto Nacional de Estadística (INE).
chile_regionincome_raw <- read_excel("04_Data/ingreso-medio-mensual-por-region-2010---2021.xlsx", skip = 2) %>%
  clean_names()

chile_regionincome <- chile_regionincome_raw %>%
  filter(ano == 2021,
         region != "Nacional") %>%
  mutate(region_short = ifelse(grepl("Región de ", region), 
                               substr(region, start = 11, stop = nchar(region)), 
                        ifelse(grepl("Región del ", region), 
                               substr(region, start = 12, stop = nchar(region)),
                        ifelse(region == "Región Metropolitana", "Metropolitana", NA))),
         region_name = ifelse(region_short == "Aysén", "Aysén del Gral. Ibañez del Campo",
                         ifelse(region_short == "Biobío", "Bío-Bío",
                         ifelse(region_short == "Magallanes", "Magallanes y Antártica Chilena",
                         ifelse(region_short == "Metropolitana", "Metropolitana de Santiago",
                         ifelse(region_short == "O’Higgins", "Libertador Bernardo O'Higgins", region_short)))))) %>%
  select(region_name, ingreso_medio_nominal)

chile_regionrural_raw <- read_excel("04_Data/1_2_poblacion.xls", sheet = "Sheet1") %>%
  clean_names()

chile_regionrural <- chile_regionrural_raw %>%
  mutate(pop = urban + rural,
         urban_perc = urban / pop * 100,
         rural_perc = rural / pop * 100)

```

```{r importSchoolData}

chile_merged_raw <- read.csv("04_Data/Data_Chile_Merge.csv") %>% clean_names()

chile_merged <- chile_merged_raw %>%
  rename(sex_desc = sex,
         year = agno,
         school_code = rbd,
         school_check_code = dgv_rbd, 
         school_name = nom_rbd,
         school_region_code = cod_reg_rbd,
         school_region_name_abr = nom_reg_rbd_a,
         school_province_code = cod_pro_rbd,
         school_commune_code = cod_com_rbd_2,
         school_commune_name = nom_com_rbd_2,
         school_dept_code = cod_deprov_rbd,
         school_dept_name = nom_deprov_rbd,
         school_dependency_code = cod_depe, # has categories 1-6, no1 and no2 here are no1 in grouped
         school_dependency_code_grouped = cod_depe2, # has categories 1-5
         school_rurality_code = rural_rbd,
         school_operation_status = estado_estab, 
         teaching_code1 = cod_ense, # min = 10, max = 910, eg preschool, special education hearing impaired
         teaching_code2 = cod_ense2, # subject matter coding, 1-8
         teaching_code3 = cod_ense3, # age based coding, 1-7
         grade_code1 = cod_grado, # grade of schooling, 1-10, 21-25, 31-34, nests in teaching_code1
         grade_code2 = cod_grado2, # equivalent grade of schooling for adult special education, 1-8, 99
         grade_letter = let_cur, # refers to the class within the grade, close to start of alphabet is higher aptitude
         course_timing = cod_jor, # time of day, morning, afternoon, both, night, no info
         course_type = cod_tip_cur, # 0 = simple course, 1-4 = combined course, 99 = no info
         course_descr = cod_des_cur, # Description of course (TP secondary education only). 0: Does not apply, 1: Only High School, 2: Dual, 3: Other
         student_id = mrun,
         sex = gen_alu, # 0 = no info, 1 = male, 2 = female
         dob = fec_nac_alu_2, # The second one has DD
         age_june30 = edad_alu, # age at 30th June 2021
         special_needs_status = int_alu, # integrated student indicator, 0 = no, 1 = yes. Mostly no
         special_needs_code = cod_int_alu, # ADHD, blindness, etc. 0 = none. 105 = autism, 203 = ADHD. See ER_Matricula_por_alumno_PUBL_MRUN annex 7
         student_region_code = cod_reg_alu,
         student_commune_code = cod_com_alu,
         student_commune_name = nom_com_alu,
         economic_sector_code = cod_sec,
         economic_specialty_code = cod_espe,
         economic_branch_code = cod_rama,
         economic_profspec_code = cod_men,
         teaching_code_new = ens)
```

```{r restructureData}
chile_bayes <- chile_merged %>%
  #select(-student_commune_name) %>%
  filter(age_june30 >= 6 & age_june30 <= 18,
         #special_needs_status == 1,
         sex != 0) %>%
  mutate(autism = ifelse(special_needs_code == 105, 1, 0),
         adhd = ifelse(special_needs_code == 203, 1, 0),
         age_cat_name = factor(ifelse(age_june30 <= 8, "6-8", 
                               ifelse(age_june30 <= 11, "9-11", 
                               ifelse(age_june30 <= 14, "12-14", "15-18"))),
                               levels = c("6-8", "9-11", "12-14", "15-18")),
         # ethnic_2_group = ifelse(ethnic_3_group == "Other ethnic group", "Other Indigenous group",
         #                  ifelse(ethnic_3_group == "Aymara", "Other Indigenous group",
         #                  ifelse(ethnic_3_group == "No Native Group", "No Indigenous group", ethnic_3_group))),
         ethnic_2_group = factor(ifelse(ethnicity == "Mapuche", "Mapuche", 
                          ifelse(ethnicity == "No Native Group" | ethnicity == "No registry", "No Indigenous group",
                                 "Other Indigenous group")), 
                          levels = c("Mapuche", "Other Indigenous group", "No Indigenous group")),
         school_rurality = ifelse(school_rurality_code == 0, "Urban", "Rural"),
         school_fee = factor(ifelse(school_fee == "", "No information",
                             ifelse(school_fee == "GRATUITO", "Free", 
                             ifelse(school_fee == "$1.000 A $10.000", "$1,000-$10,000",
                             ifelse(school_fee == "$10.001 A $25.000", "$10,001-$25,000", 
                             ifelse(school_fee == "$25.001 A $50.000", "$25,001-$50,000",
                             ifelse(school_fee == "$50.001 A $100.000", "$50,001-$100,000",
                             ifelse(school_fee == "MAS DE $100.000", "$100,001+", 
                             ifelse(school_fee == "SIN INFORMACION", "No information", NA)))))))),
                             levels = c("Free", "$1,000-$10,000", "$10,001-$25,000",
                                        "$25,001-$50,000", "$50,001-$100,000", "$100,001+", "No information")),
         commune_code_temp = ifelse(student_commune_code == "0", school_commune_code, student_commune_code),
                             # If there is no commune code for the student, use their school's code instead
         commune_code_old = ifelse(nchar(as.character(commune_code_temp)) == 4,
                                   paste0("0", as.character(commune_code_temp)),
                                   as.character(commune_code_temp)),
         # Fix Biobio to Nuble communes
         commune_code = ifelse(commune_code_old == "08401", "16101",
                        ifelse(commune_code_old == "08402", "16102",
                        ifelse(commune_code_old == "08403", "16202",
                        ifelse(commune_code_old == "08404", "16203",
                        ifelse(commune_code_old == "08405", "16302",
                        ifelse(commune_code_old == "08406", "16103",
                        ifelse(commune_code_old == "08407", "16104",
                        ifelse(commune_code_old == "08408", "16204",
                        ifelse(commune_code_old == "08409", "16303",
                        ifelse(commune_code_old == "08410", "16105",
                        ifelse(commune_code_old == "08411", "16106",
                        ifelse(commune_code_old == "08412", "16205",
                        ifelse(commune_code_old == "08413", "16107",
                        ifelse(commune_code_old == "08414", "16201",
                        ifelse(commune_code_old == "08415", "16206",
                        ifelse(commune_code_old == "08416", "16301",
                        ifelse(commune_code_old == "08417", "16304",
                        ifelse(commune_code_old == "08418", "16108",
                        ifelse(commune_code_old == "08419", "16305",
                        ifelse(commune_code_old == "08420", "16207",
                        ifelse(commune_code_old == "08421", "16109", commune_code_old)))))))))))))))))))))) %>% 
         #                                            "No information")),
         # school_fee_group = ifelse(school_fee == "Free", "Free", 
         #                    ifelse(school_fee %in% c("$1,000-$10,000", "$10,001-$25,000",
         #                                             "$25,001-$50,000", "$50,001-$100,000"), "Low",
         #                    ifelse(school_fee == "$100,001+", "Medium", 
         #                    ifelse(school_fee == "No information", "No information", NA)))),
         # school_fee_group = factor(school_fee_group, levels = c("Free", "Low", "Medium",
         #                                                        "No information"))) %>% 
  left_join(region_service_commune_lookup %>% as.tibble() %>% select(-geometry), by = "commune_code") %>%
  mutate(ssas = ifelse(commune_code %in% araucsur_communes$commune_code, 1, 0)) %>%
  select(#school_region_name_abr,
    region_code,
    region_name,
    region_name_abr,
    commune_code, # student, see chile_merged
    student_commune_name, # upper case, from chile_merged
    commune_name, # Sentence case, from lookup table
    health_service_code,
    health_service_name,
    sex,
    sex_desc,
    dob,
    age_june30,
    age_cat_name,
    school_rurality_code,
    school_rurality,
    pago_matricula,
    pago_mensual,
    school_fee,
    #school_fee_group,
    #school_fee_temp,
    ethnicity,
    mapuche,
    nationality,
    ethnic_3_group,
    ethnic_2_group,
    special_needs_status,
    special_needs_code,
    autism,
    adhd,
    ssas
  ) 

chile_bayes_aut <- chile_bayes %>% select(-adhd)
chile_bayes_adhd <- chile_bayes %>% select(-autism)

mapuche_regions <- c("09", "11", "08", "10", "14", "12", "13")
chile_bayes_aut_ethnic <- chile_bayes_aut %>%
  filter(region_code %in% mapuche_regions)
chile_bayes_adhd_ethnic <- chile_bayes_adhd %>%
  filter(region_code %in% mapuche_regions)
```

```{r importClinicalData}
clinical_large_raw <- read_excel("04_Data/dataset_ssas_2015_2021.xlsx") %>% clean_names
#describe(clinical_raw)

clinical_large <- clinical_large_raw %>%
  select(c(-procedence, -ethnicity, -education_level, -disability, -foster_care)) %>%
  # Fix the date columns
  mutate(dob_eng = ifelse(str_detect(date_of_birth, "/"), 1,
                   ifelse(str_detect(date_of_birth, "-"), 0, NA)),
         apt_eng = ifelse(str_detect(date_appointment, "/"), 1, ifelse(str_detect(date_appointment, "-"), 0, NA)),
         dob_day = ifelse(dob_eng == 1, as.integer(str_extract(date_of_birth, "^\\d+")), 
                   ifelse(dob_eng == 0, as.integer(str_extract(date_of_birth, "^\\d+")), NA)),
         dob_month = ifelse(dob_eng == 1, as.integer(str_extract(date_of_birth, "(?<=/)\\d+(?=/)")), 
                     ifelse(dob_eng == 0, str_extract(date_of_birth, "(?<=-)\\w+(?=-)"), NA)),
         dob_year = ifelse(dob_eng == 1, as.integer(str_extract(date_of_birth, "\\d+$")), 
                    ifelse(dob_eng == 0, as.integer(str_extract(date_of_birth, "\\d+$")) + 2000, NA)),
         dob_month_eng = as.integer(ifelse(dob_month == "ene", 1,
                                    ifelse(dob_month == "abr", 4, 
                                    ifelse(dob_month == "ago", 8, 
                                    ifelse(dob_month == "sept", 9, 
                                    ifelse(dob_month == "dic", 12, dob_month)))))),
         dob = make_date(year = dob_year, month = dob_month_eng, day = dob_day),
         apt_day = ifelse(apt_eng == 1, as.integer(str_extract(date_appointment, "^\\d+")), 
                   ifelse(apt_eng == 0, as.integer(str_extract(date_appointment, "^\\d+")), NA)),
         apt_month = ifelse(apt_eng == 1, as.integer(str_extract(date_appointment, "(?<=/)\\d+(?=/)")), 
                     ifelse(apt_eng == 0, str_extract(date_appointment, "(?<=-)\\w+(?=-)"), NA)),
         apt_year = ifelse(apt_eng == 1, as.integer(str_extract(date_appointment, "\\d+$")), 
                    ifelse(apt_eng == 0, as.integer(str_extract(date_appointment, "\\d+$")) + 2000, NA)),
         apt_month_eng = as.integer(ifelse(apt_month == "ene", 1,
                                    ifelse(apt_month == "abr", 4, 
                                    ifelse(apt_month == "ago", 8, 
                                    ifelse(apt_month == "sept", 9, 
                                    ifelse(apt_month == "dic", 12, apt_month)))))),
         apt_date = make_date(year = apt_year, month = apt_month_eng, day = apt_day),
         age_june30 = trunc(time_length(interval(ymd(dob), ymd("2021-06-30")), unit = "year")),
         commune_name_upper = ifelse(comuna == "CHOL CHOL", "CHOLCHOL",
                        ifelse(comuna == "CURACAUTIN", "CURACAUTÍN",
                        ifelse(comuna == "PITRUFQUEN", "PITRUFQUÉN",
                        ifelse(comuna == "PUCON", "PUCÓN",
                        ifelse(comuna == "TOLTEN", "TOLTÉN",
                        ifelse(comuna == "VILCUN", "VILCÚN", comuna)))))),
         #commune_name_upper = comuna,
         ses_status = ifelse(socio_economic_level == "FONASA - A", 1, 
                      ifelse(socio_economic_level == "FONASA - B", 2,
                      ifelse(socio_economic_level == "FONASA - C", 2, 
                      ifelse(socio_economic_level == "FONASA - D", 2,
                      ifelse(socio_economic_level == "Private Health Insurance", 3, 
                      ifelse(socio_economic_level %in% c("COLMENA GOLDEN CROSS", "RIO BLANCO", "CARABINEROS (DIPRECA)", "BANMEDICA S.A.", "PARTICULAR (SIN PREVISION)", "VIDA TRES"), 3, NA)))))),
         autism = 1,
         intdisab = 0,
         aut_rank = 1
         ) %>%
  left_join(region_service_commune_lookup, by = "commune_name_upper") %>%
  select(id, gender, 
         commune_code, commune_name, commune_name_upper, 
         health_service_name, region_name, 
         socio_economic_level, ses_status, 
         dob, age_june30, 
         apt_date, hospital, medical_specialty, type_appointment,
         autism, intdisab, aut_rank) 

aut_codes <- unique(clinical_large_raw$codigo)

clinical_small_raw <- read_excel("04_Data/Dataset_Vill_2014_2021.xlsx", col_names = TRUE) %>% clean_names()

clinical_small <- clinical_small_raw %>%
  rename("dob" = "fecha_nacimiento",
         "apt_date" = "fecha_ejecutada",
         "type_appointment" = "appoinment",
         "diagnosis" = "diagnostico_1") %>%
  mutate(gender = str_to_title(gender),
         autism = ifelse(cod_dg_1 %in% aut_codes | 
                           cod_dg_2 %in% aut_codes | 
                           cod_dg_3 %in% aut_codes, 1, 0),
         aut_rank = ifelse(cod_dg_1 %in% aut_codes, 1,
                    ifelse(cod_dg_2 %in% aut_codes, 2,
                    ifelse(cod_dg_3 %in% aut_codes, 3, NA))),
         age_june30 = trunc(time_length(interval(ymd(dob), ymd("2021-06-30")), unit = "year")),
         commune_name_upper = ifelse(comuna == "CHOL CHOL", "CHOLCHOL",
                        ifelse(comuna == "CURACAUTIN", "CURACAUTÍN", 
                        ifelse(comuna == "PITRUFQUEN", "PITRUFQUÉN", 
                        ifelse(comuna == "PUCON", "PUCÓN", 
                        ifelse(comuna == "TOLTEN", "TOLTÉN", 
                        ifelse(comuna == "VILCUN", "VILCÚN", 
                        ifelse(comuna == "DIEGO DE ALMAGRO  (#)", "DIEGO DE ALMAGRO",
                        ifelse(comuna == "MACHALI", "MACHALÍ",
                        ifelse(comuna == "TEMUCO (##)", "TEMUCO", comuna))))))))),
         ses_status = ifelse(socio_economic_level == "FONASA - A", 1, 
                      ifelse(socio_economic_level == "FONASA - B", 2,
                      ifelse(socio_economic_level == "FONASA - C", 2, 
                      ifelse(socio_economic_level == "FONASA - D", 2,
                      ifelse(socio_economic_level == "Private Health Insurance", 3, 
                      ifelse(socio_economic_level %in% c("COLMENA GOLDEN CROSS", "RIO BLANCO", "CARABINEROS (DIPRECA)", "BANMEDICA S.A.", "PARTICULAR (SIN PREVISION)", "VIDA TRES"), 3, NA))))))
         ) %>%
  left_join(region_service_commune_lookup, by = "commune_name_upper") %>%
  filter(autism == 1) %>%
  select(id, gender, commune_code, commune_name, commune_name_upper, health_service_name, region_name, socio_economic_level, ses_status, dob, age_june30, apt_date, hospital, medical_specialty, type_appointment, cod_dg_1, cod_dg_2, cod_dg_3, diagnosis, autism, aut_rank) 
# Throws a warning because there are 2 records for Tocopila which is in two regions. Will keep both because we have no way of knowing which is correct.
# Doesn't anymore because I changed the lookup to have only 1 Tocopilla row

intdisab_codes <- unique(c(clinical_small_raw$cod_dg_1, clinical_small_raw$cod_dg_2, clinical_small_raw$cod_dg_3)) %>%
  str_subset("F7") %>%
  sort() 

clinical_small <- clinical_small %>% 
  mutate(intdisab = ifelse(cod_dg_1 %in% intdisab_codes |
                             cod_dg_2 %in% intdisab_codes | 
                             cod_dg_3 %in% intdisab_codes, 1, 0)) %>%
  #rename("codigo" = "cod_dg_1") %>%
  select(c(-cod_dg_1, -cod_dg_2, -cod_dg_3, -diagnosis))

clinical <- rbind(clinical_large, clinical_small)

clinical_communes <- clinical %>% group_by(commune_code) %>% summarise() %>% arrange() %>%
  mutate(commune_in_school_data = ifelse(commune_code %in% unique(chile_merged$commune_code), 1, 0)) # Needs to all be 1's

#clinical_out <- clinical %>% filter(commune_code %in% araucsur_communes$commune_code)
#write_csv(clinical_out, file = "04_Data/Outputs/clinical.csv")

```


```{r functionsBayes}

get_grouped_prev_plot <- function(x, grouping_vars, disease) {
  # Calculates sample prevalence and its confidence intervals for supplied feature grouping
  # x = chile_bayes_aut or chile_bayes_adhd, needs columns called autism or adhd, and count
  # grouping_vars = variables in x to group by
  # disease = autism or adhd
  
  x_grouped <- x %>% 
    group_by(across(all_of(grouping_vars))) %>%
    summarise(count = n()) %>%
    pivot_wider(names_from = disease, values_from = count) %>%
    rename("n_nodisease" = "0", "n_disease" = "1") %>% #, "age" = "age_june30") %>%
    mutate(n_disease = ifelse(is.na(n_disease), 0, n_disease), # If there are no cases of autism in the group, input 0
           sample_pop_size = n_nodisease + n_disease, # Total sample population is autism cases + not cases
           sample_prevalence = n_disease / sample_pop_size, # Prevalence of autism in the group
           ci_lower = sample_prevalence - (1.96 * sqrt(sample_prevalence * (1 - sample_prevalence) / sample_pop_size)),
           ci_upper = sample_prevalence + (1.96 * sqrt(sample_prevalence * (1 - sample_prevalence) / sample_pop_size)),
           ci_lower = ifelse(ci_lower < 0, 0, ci_lower),
           prev_ci = paste0(sprintf("%.2f", round(sample_prevalence * 100, 2)),
                            " (",
                            sprintf("%.2f", round(ci_lower * 100, 2)),
                            ", ", 
                            sprintf("%.2f", round(ci_upper * 100, 2)),
                            ")")) %>%
    ungroup()
  return(x_grouped)
}

get_grouped_prev <- function(x, stdpop, grouping_vars, disease) {
  # Calculates sample prevalence, age- and sex-standardised prevalence and group weighting for supplied feature grouping
  # x = chile_bayes_aut, needs columns called autism, count
  # stdpop = standard population with age and sex counts
  # grouping_vars = variables in x to group by
  # disease = autism or adhd
  
  n_stdpop <- sum(stdpop$std_pop)
  
  x_grouped <- x %>% 
    group_by(across(all_of(grouping_vars))) %>%
    summarise(count = n()) %>%
    pivot_wider(names_from = disease, values_from = count) %>%
    rename("n_nodisease" = "0", "n_disease" = "1", "age" = "age_june30") %>%
    mutate(n_disease = ifelse(is.na(n_disease), 0, n_disease), # If there are no cases of autism in the group, input 0
           sample_pop_size = n_nodisease + n_disease, # Total sample population is autism cases + not cases
           sample_prevalence = n_disease / sample_pop_size) %>% # Prevalence of autism in the group
    left_join(stdpop, by = c("age", "sex")) %>%
    mutate(disease_prev_std = n_disease / sample_pop_size * pop_prop, # Prevalence of autism in the group, standardised to standard population
           w = std_pop / (sample_pop_size * n_stdpop), # Weight of the group using standard population
           w2 = pop_prop / sample_pop_size,
           #sum_std_pop = sum(std_pop)
           ) %>%
    ungroup()
  return(x_grouped)
}

get_adjusted_prev <- function(x, grouping_vars) {
  # Turns grouped prevalences into age- and sex- adjusted prevalences with Fay and Feuer Gamma confidence intervals
  # x = output from get_grouped_prev
  x_adj <- x %>%
  group_by(across(all_of(grouping_vars))) %>%
  summarise(sum_sample_pop_size = sum(sample_pop_size),
            crude_rate = sum(n_disease) / sum(sample_pop_size),
            crude_count = sum(n_disease),
            adjusted_rate = sum(n_disease / sample_pop_size * pop_prop),
            adjusted_count = round(adjusted_rate * sum_sample_pop_size, 0), # had to fudge this to get MCMC to run bc it needs integers
            #adjusted_count = adjusted_rate * sum_sample_pop_size,
            var = sum(pop_prop^2 * n_disease / sample_pop_size^2),
            #se2 = sqrt(sum((std_pop/sum(std_pop))^2 * n_autism/sample_pop_size^2)),
            w_M = max(w),
            crude_ci_lower = crude_rate - (1.96 * sqrt(crude_rate * (1 - crude_rate) / sum_sample_pop_size)),
            crude_ci_upper = crude_rate + (1.96 * sqrt(crude_rate * (1 - crude_rate) / sum_sample_pop_size)),
            adjusted_ci_lower = ifelse(var == 0, 0, var / (2*adjusted_rate) * qchisq(p = 0.05/2, df = 2*adjusted_rate^2 / var)),
            adjusted_ci_upper = (var + w_M^2) / (2*(adjusted_rate + w_M)) * qchisq(p = 1-0.05/2, df = 2*(adjusted_rate+w_M)^2 / (var+w_M^2)),
            crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
            adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower),
            crude_prev_ci = paste0(sprintf("%.2f", round(crude_rate * 100, 2)),
                            " (",
                            sprintf("%.2f", round(crude_ci_lower * 100, 2)),
                            ", ", 
                            sprintf("%.2f", round(crude_ci_upper * 100, 2)),
                            ")"),
            adjusted_prev_ci = paste0(sprintf("%.2f", round(adjusted_rate * 100, 2)),
                            " (",
                            sprintf("%.2f", round(adjusted_ci_lower * 100, 2)),
                            ", ", 
                            sprintf("%.2f", round(adjusted_ci_upper * 100, 2)),
                            ")")) %>%
  arrange(across(all_of(grouping_vars)))
}

do_jags_rand_model <- function(x, feat, model, theta_mu, theta_sigma, pars, nBurn = 1000, nIter = 1000, convergence_checks = FALSE) {
  # x = output from get_adjusted_prev. Needs to have columns sum_sample_pop_size, adjusted_count
  # feat = feature being used as random effect
  # model = JAGS random effects model
  # theta_mu, theta_sigma = mean and sd of beta prior distribution
  # pars = model parameters to report
  # nBurn = number of burn-in samples
  # nIter = number of posterior iterations
  
  nFeat <- length(unique(x[[feat]]))
  FeatNames <- sort(unique(x[[feat]]))
  
  # Define beta prior
  theta_a <- theta_mu * (theta_mu * (1-theta_mu) / theta_sigma^2 - 1)
  theta_b <- (1 - theta_mu) * (theta_mu * (1-theta_mu) / theta_sigma^2 - 1)
  
  # Initial values for model chains
  rand_ini <- list(list(theta = rep(0.001, nFeat)), #, spec = 0.5, sens = 0.5),
                   list(theta = rep(0.01, nFeat))) #, spec = 0.9, sens = 0.9)) 
  
  # Run JAGS model
  rand_data <- list(theta_a = theta_a, 
                    theta_b = theta_b,
                    nObs = x$sum_sample_pop_size,
                    disease_sample = x$adjusted_count,
                    nFeat = nFeat)
  rand_jag <- jags.model(textConnection(model),
                         data = rand_data,
                         inits = rand_ini,
                         n.chains = 2,
                         quiet = TRUE)
  update(rand_jag, n.iter = nBurn)
  rand_sam <- coda.samples(model = rand_jag,
                           variable.names = pars,
                           n.iter = nIter)
  
  # Convergence checks
  if(convergence_checks) {
    print(mcmc_trace(rand_sam, paste0("theta[", 1:nFeat, "]"))) # Convergence looks fine and rhats <= 1.1
    print(mcmc_trace(rand_sam, paste0("disease_pred[", 1:nFeat, "]"))) # Convergence looks fine and rhats <= 1.1
    rand_summ <- summary(subset_draws(as_draws(rand_sam), pars),
                         ~quantile(.x, probs=c(0.025, 0.5, 0.975)),
                         ~mcse_quantile(.x, probs=c(0.025, 0.5, 0.975)),
                         "rhat") %>%
      arrange(desc(rhat))
    print(rand_summ)
  }
  
  # Extract posterior density
  prev_post <- as_tibble(as_draws_matrix(rand_sam), rownames = "Iteration") %>%
    select(c("Iteration", contains("theta["))) %>%
    pivot_longer(cols = contains("theta["),
                 names_to = "Feat",
                 values_to = "predicted_prev") %>%
    mutate(Feat_names = factor(Feat, levels = c(paste0("theta[",1:nFeat,"]")), labels = FeatNames)) %>%
    select(Iteration, Feat_names, predicted_prev)
  
  return(prev_post)
}


plot_post_density <- function(jags_post, sample_data, feat, theta_mu, theta_sigma, disease, title_text = "") {
  # Plots posterior densities and their 95% credible intervals, and sample prevalence confidence intervals
  # jags_post = output from do_jags_rand_model, ie posterior densities
  # sample data = output from get_adjusted_prev, ie sample prevalences with confidence intervals
  # feat = the same feature used as the random effect in do_jags_rand_model
  # theta_mu, theta_sigma = mean and sd of beta prior distribution used in do_jags_rand_model
  # disease = autism or ADHD
  # title_text = any additional text for the title, eg grouing variables
  
  # calcuate posterior credible intervals
  post_ci <- jags_post %>%
  group_by(across(all_of(feat))) %>%
  summarise(post_lower = quantile(predicted_prev, 0.025),
            post_upper = quantile(predicted_prev, 0.975))
  
  print(ggplot() +
          geom_density(data = jags_post, aes(x = predicted_prev)) +
          geom_vline(data = post_ci, aes(xintercept = post_lower), color = "blue", linetype = "dotted") +
          geom_vline(data = post_ci, aes(xintercept = post_upper), color = "blue", linetype = "dotted") +
          geom_vline(data = sample_data, aes(xintercept = adjusted_ci_lower), color = "red", linetype = "dashed") +
          geom_vline(data = sample_data, aes(xintercept = adjusted_ci_upper), color = "red", linetype = "dashed") +
          facet_wrap(as.formula(paste0("~", feat))) +
          labs(title = paste0(disease, " prevalence, prior mean = ", signif(theta_mu, 3), ", prior sd = ", signif(theta_sigma, 3), title_text),
               x = "Posterior predictive distribution",
               y = "Density"))
}
```

```{r functionsRestructure}
# Define some functions to help with restructuring clinical data into patient level data
get.min.na <- function(x) ifelse( !all(is.na(x)), min(x, na.rm = TRUE), NA)

get.max.na <- function(x) ifelse( !all(is.na(x)), max(x, na.rm = TRUE), NA)

get.mode.na <- function(x) {
  ux <- na.omit(unique(x))
  ux[which.max(tabulate(match(x, ux)))]
}

get.mapuche.ethnicity <- function(x) {
  y <- NA
  if(any(x == "Mapuche")) {
    y <- "Mapuche"
  } else if(any(x == "Chilean")) {
    y <- "Chilean"
  } else if(any(x == "Foreign")) {
    y <- "Foreign"
  } else {
    y <- "No ethnicity information"
  }
  return(y)
}

get.yes.disability <- function(x) {
  y <- NA
  if(any(x == "Yes")) {
    y <- "Yes disability"
  } else if(any(x == "No")) {
    y <- "No disability"
  } else {
    y <- "No disability information"
  }
  return(y)
}

get.yes.fostercare <- function(x) {
  y <- NA
  if(any(x == "Yes")) {
    y <- "Yes foster care"
  } else if(any(x == "No")) {
    y <- "No foster care"
  } else {
    y <- "No foster care information"
  }
  return(y)
}
```


```{r colours}
plasma_colours <- viridis(10, option = "C") #"#0D0887FF" "#47039FFF" "#7301A8FF" "#9C179EFF" "#BD3786FF" "#D8576BFF" "#ED7953FF" "#FA9E3BFF" "#FDC926FF" "#F0F921FF"
viridis_colours <- viridis(20, option = "D") 
rocket_colours <- viridis(20, option = "F")
turbo_colours <- viridis(17, option = "H") #"#30123BFF" "#4662D7FF" "#36AAF9FF" "#1AE4B6FF" "#72FE5EFF" "#C7EF34FF" "#FABA39FF" "#F66B19FF" "#CB2A04FF" "#7A0403FF"
  
```



# Abstract

TODO




# Introduction

## Chilean health context

```{r healthRegion}
kbl(region_service_lookup %>% as.tibble() %>% select(region_name, health_service_name_shortish) %>% arrange(region_name),
    col.names = c("Region", "Health services"),
    align = "ll",
    booktabs = TRUE,
    format = "latex",
    linesep = c("\\addlinespace", "\\addlinespace", "\\addlinespace", "\\addlinespace", 
                "", "", "", "\\addlinespace", "\\addlinespace", "", "\\addlinespace", 
                "\\addlinespace",  "", "", "\\addlinespace", "\\addlinespace", "\\addlinespace", 
                "\\addlinespace", "", "", "", "", "", "\\addlinespace", "\\addlinespace", "", "", "\\addlinespace"),
    caption = "Chilean health services by region")
```

```{r map}
#commune_geoms <- data.frame(mapa_comunas)
#communes_lookup <- data.frame(codigos_territoriales)

# Get region-level geometries with demographic data for plotting
demog_geom <- chile.adm1 %>%
  left_join(region_lookup, by = "ADM1_PCODE") %>%
  left_join(chile_regionpop, by = "region_name") %>%
  left_join(chile_regionincome, by = "region_name") %>%
  left_join(select(chile_regionrural, -region), by = "region_code")

#chile.adm2 <- st_read("04_Data/CHL_adm/CHL_adm2.shp") # Also doesn't have Biobio
#chile.adm2 <- st_transform(chile.adm2, crs = 32629)

#region_geoms_demog <- region_geoms %>%
#  left_join(chile_regionpop, by = "nombre_region") %>%
#  left_join(chile_regionincome, by = "nombre_region") %>%
#  select(-region)
```

```{r mapPop, include = FALSE, fig.cap = "Population of 0-14 year olds in Chile in 2021 by region, from 2017 census projections.", fig.height=8}
# Population
ggplot(demog_geom) + 
  geom_sf(mapping = aes(geometry = geometry, fill = youth_pop_2021), linewidth = 0.001, colour = "#555555") +
  geom_sf_text(mapping = aes(geometry = geometry, label = region_name), nudge_x = 9, size = 3.5) +
  scale_fill_viridis(option = "viridis", direction = 1, name = "Population aged 0-14") + #, limits = c(23000, 400000), oob = scales::squish) +
  labs(title = "Population aged 0-14") +
  theme_void() +
  xlab("Longitude") +
  ylab("Latitude") +
  coord_sf(xlim = c(-75, -55), ylim = c(-56, -18))
```

```{r mapIncome, include = TRUE, fig.cap = "Net income from main job in Chile in 2021 by region, from the INE's Supplementary Income Survey.", fig.height=8}
# Income
ggplot(demog_geom) + 
  geom_sf(mapping = aes(geometry = geometry, fill = ingreso_medio_nominal), linewidth = 0.001, color = "#555555") +
  geom_sf_text(mapping = aes(geometry = geometry, label = region_name), nudge_x = 9, size = 3.5) +
  scale_fill_viridis(option = "viridis", direction = 1, name = "Median income (Peso)") +
  labs(title = "Net income from main job") +
  theme_void() +
  xlab("Longitude") +
  ylab("Latitude") +
  coord_sf(xlim = c(-75, -55), ylim = c(-56, -18))
```

```{r mapRural, include = TRUE, fig.cap = "Percentage of population living in rural areas in Chile in 2017 from 2017 census.", fig.height=8}
# Income
ggplot(demog_geom) + 
  geom_sf(mapping = aes(geometry = geometry, fill = rural_perc), linewidth = 0.001, color = "#555555") +
  geom_sf_text(mapping = aes(geometry = geometry, label = region_name), nudge_x = 9, size = 3.5) +
  scale_fill_viridis(option = "viridis", direction = 1, name = "Rural population (%)") +
  labs(title = "Percentage of population living in rural areas") +
  theme_void() +
  xlab("Longitude") +
  ylab("Latitude") +
  coord_sf(xlim = c(-75, -55), ylim = c(-56, -18))
```

Chile is a high income country in Latin America with a population of 19.7 million and spends US\$2,699 per capita annually on health care (1). Chile has a dual health care system with most people accessing care in the public health system that is partly funded by the Government through the Fondo Nacional de Salud (National Health Fund, FONASA) (2). Approximately 15% of the population, mostly those of middle and high income, pay for private care through Instituciones de Salud Previsional (Social Security Institutions, ISAPRE) (2). All workers also pay a mandatory health contribution of 7% of their income which funds both FONASA and ISAPRE services (2). FONASA defines four subsidisation groups based on income with those in groups A and B having low income and receiving 100% subsidised care, and groups C and D having low to middle income and receiving 90% and 80% subsidised care respectively (2). Care is delivered through 29 Servicios de Salud (health services) that cover catchment areas within Chile’s 16 regions, see Table \@ref(tab:healthRegion) (3). The public and private systems have various additional pay-per-service options which creates high out-of-pocket expenses that disproportionally affect people with low income (4). Many conditions are not covered by ISAPRE services meaning high needs and high risk patients are overrepresented in the public system (2). The public system is stretched thin with wait times of up to 1.6 years and 2 million people on specialist waiting lists in 2022 (2). 

Chileans accessing public health care are on average poorer than those accessing private care with 17.2% below the poverty line in 2013, and they are less likely to access specialist medical services (5). Chile has considerable income inequality at both regional and commune levels (6) with income highest in the regions of Magallanes y Antártica Chilena, Santiago, Antofagasta and Aysén del Gral. Ibañez del Campo, see Figure \@ref(fig:mapIncome) (7). 

Chile has a large Indigenous population with nearly 10% of Chileans self-identifying as Mapuche and approximately 2.4% belonging to another Indigenous group (8). Sandoval, Portaccio and Albala found life expectancy at birth of Indigenous Chileans as a whole group is seven years shorter than for non-Indigenous Chileans and 8.3 years shorter for Mapuche people as a group, and cite lack of access to health services as a possible cause (9). Sandoval and Portaccio separately note that accurate analysis of Chile’s health context for Indigenous groups is difficult because ethnicity is not required on death certificates (8). Large population health studies with self-reported ethnicity data are therefore particularly valuable in Chile.

Approximately 12% of Chile’s population lives in rural areas; the regions of Ñuble, La Araucanía and Los Ríos have particularly high prevalence of rural dwelling, see Figure \@ref(fig:mapRural), and approximately 7 million people live in Santiago, Chile’s largest city (10). Núñez and Manzano identified a lack of availability of rural health clinics as a barrier to accessing healthcare in Chile (4). 

Chilean policy encourages children with special education needs and disabilities, including autism and ADHD, to be educated in mainstream schools and the Government provide funding to enable this (11). The schooling system comprises 44% state-funded schools, 51% state-subsidised private schools and 5% non-subsidised private schools (11). Approximately 5% of Chilean students are registered as having special needs and there is evidence that they have not been completely successfully integrated into schools as they experience higher rates of bullying and violence, and teachers report not feeling equipped to meet their needs (11). This may prompt some students with less severe needs to choose not to access support as it would single them out as different from their peers.

## Autism

Autism, or Autism Spectrum Disorder (ASD) describes a range of neurological conditions that cause significant impairment to functioning and include persistent social difficulties and restrictive or repetitive behaviours (12). The ICD-10 codes F84.0 and F84.1 describe autism and the code F84.2, F84.3, F84.4, F84.5, F84.8 and F84.9 describe other pervasive developmental disorders closely related to autism (13). Autism is diagnosed through  specialist or caregiver assessment of behaviour, cognitive function and developmental milestone attainment and generally uses standardised screening tools (14). The Autism Diagnostic Interview-Revised (ADI-R) and the Autism Diagnostic Observation Schedule (ADOS), the gold standard autism diagnostic tools, have been translated into Spanish, and the Modified Checklist for Autism in Toddlers (M-CHAT), Autism Screening Questionnaire (ASQ/SCQ), Autism Behavior Checklist (ABC), Social Responsiveness Scale (SRS), Autism Detection in Early Childhood (ADEC), the Childhood Autism Rating Scale (CARS), the Structured Observation for Autism Screening (OERA), and the Autism Mental Status Examination (AMSE) have been validated in Chile (15). Roman-Urrestarazu showed that a 10 question version of the Quantitative Checklist for Autism in Toddlers (Q-CHAT-25) is valid for use in routine health checks in primary health clinics in Chile (16).

The worldwide population prevalence of autism is estimated to be 1-2% (14), and if this prevalence holds true for Chile it represents a burden of disease of approximately 200,000 – 400,000 people. Given autism is typically diagnosed in early childhood (17), much of this burden falls on schools. Very little research has been conducted on the prevalence of autism in Chile; Yáñez et al’s 2021 study of 272 children in Santiago found autism prevalence of 1.95% with a very wide 95% confidence interval of 0.81-4.63 due to the small sample size (18). Their sample was taken from urban children attending optional checkups at clinicals that primarily treat low to middle income families which is not representative of Chile’s broader population and their prevalence estimate is therefore likely to contain selection bias. Their figure may be an underestimate as participants were aged 18-30 months which is well below the UK’s median diagnosis age of 55 months (17) and therefore children with less severe autism symptoms may have been missed. Some data on autism prevalence is available for other Latin American countries. The estimated prevalence of autism was 0.17% (95% CI 0.015 - 0.019%) among 3-9 year olds in Venezuela in 2008 (19). Prevalence of autism in Buenos Aires between 2010 and 2017 was estimated to be 1.28% from clinical records (20). In Ecuador in 2015, prevalence of autism diagnosis among 51,000 students aged 5-15 was 0.11% and prevalence of suspected autism was 0.21%, with these low estimates thought to be due to children with disabilities having low school attendance rates (21). The older prevalence calculations are likely to be underestimates as the prevalence of known autism diagnoses has been increasing for the last 20 years, though this is thought to be due to better diagnostic approaches and the true prevalence has remained similar (22). To the best of our knowledge, this investigation is the largest study of autism prevalence in Chile to date. 

The prevalence of autism is known to differ by age, sex, socio-economic status, ethnicity and geography (14,23). Individuals with more severe symptoms are more likely to be diagnosed earlier (17) and autism prevalence increases as children age, reflecting the condition’s long diagnostic window (23). 

Loomes, Hull and Mandy’s meta-analysis of male-to-female odds ratios of having autism showed three males are diagnosed for every female in childhood and adolescence (24). This difference is thought to be due to a combination of sex-linked causes, differences in symptom presentation, and bias of diagnostic tools toward traits that are more commonly observed in males and may be masked in females (14,24). Giarelli et al. found that females are more likely than males to meet autism diagnostic criteria but not have a documented diagnosis and that there is no significant difference in mean diagnosis age between female and male children that already had a documented autism diagnosis (25).

Research on the relationship between autism prevalence and socio-economic status is conflicting. Two US studies found high socio-economic status was associated with up to 2.2 times higher prevalence, thought to be due to easier access to diagnostics (26,27), while a French study found the highest prevalence was in the most deprived areas (28) and Roman-Urrestarazu et al’s study of UK school students found higher prevalence among those who had ever been eligible for free school meals, an indicator of low SES (23).

Roman-Urrestarazu et al. also found differences in autism prevalence across ethnicities in UK school students; after adjusting for sex, age group and location and in comparison to students from White backgrounds, students from Roma/Irish Traveller, Asian and Other backgrounds were significantly less likely to have autism, and students from Chinese, Black and un-classified backgrounds were more likely to have autism (23). These differences likely reflect a combination of true prevalence differences, differing access to diagnosis and cultural factors that impact awareness of autism (23). Bailey and Arcaiuli’s literature review found no significant difference in the actual prevalence of autism between Australian Indigenous and non-Indigenous people but did find Indigenous Australians were less likely to have a diagnosis of autism, and cite lack of access to diagnosis services, mis-diagnosis and different cultural understandings of disability as probable causes (29).

A systematic review by Zeidan et al. found no difference in autism prevalence between rural and urban areas when using pooled estimates but note that one component study in India found higher prevalence in rural populations and another in Taiwan found higher prevalence in urban populations (30). 

## ADHD

ADHD is also a neurodevelopmental condition and is characterised by severe inattention and hyperactivity (31). It is described by the ICD-10 codes F90.0, F90.1, F90.8 and F90.9 (13). Like autism, ADHD is typically diagnosed in childhood, using similar diagnostic tools (31). Fioravante, Lozano-Lozano Martella noted in their 2022 article that Chile does not have a standardised, objective ADHD diagnosis process and recommend combining diagnostic instruments such as the Conners Comprehensive Behaviour Scale, Conners Parent Scale, the Strengths and Difficulties Questionnaire (SDQ-Cas) and the Diagnostic and Statistical Manual Version 5 (DVM-V) diagnostic criteria (32). ADHD and autism often occur together and Salazar et al. estimate that 59.1% of people with autism have a co-diagnosis of ADHD (33).

The prevalence of ADHD in Chile was estimated to be 10.0% by de la Barra et al. using data on 1,570 school students in Cautin (La Araucanía region), Santiago, Iquique (Tarapacá region) and Concepción (Bío-Bío region) between 2007 and 2009 (34). They found no significant differences by sex or age and found prevalence was higher in children aged 4-11 than in adolescents (34). They also note that their findings differed from the established literature that shows higher prevalence in males than females and among people with low socio-economic status (34). Assuming applicability across all ages and regions, de la Barra et al.’s estimate represents a burden of disease of nearly 2 million people in Chile. In an earlier publication on what is presumably a subset of the same data, Vicente et al. reported ADHD prevalence of 12.6% in 792 students in Santiago (35). 

ADHD prevalence varies both other socio-demographic features. It is now considered to be more common in people with low socio-economic status but less well diagnosed in this group (36). The prevalence of ADHD among Indigenous people is typically found to be lower than in non-Indigenous people; Borges e Azevêdo et al. found it to be 4.3% among Karajá children in Brazil (37). A study in Vietnam found ADHD prevalence of 7.7% overall, comprising 14.9% in urban areas and just 6.7% in rural areas (38).

## Prevalence analysis techniques

Analysing the population prevalence of a condition can be considered either a population-level task in which the population is assumed to have a particular distribution and inference is made on its mean, or an individual-level task in which the condition is observed in individuals and this informs calculation of the population prevalence, as proposed by Ince et al. (39). They illustrate a hierarchical binomial model of population prevalence, from which frequentist or Bayesian estimation can be made and their Bayesian estimate of population prevalence uses a conjugate beta prior to find the exact formula for the posterior predictive distribution (39). Downing et al. demonstrate a powerful application of Bayesian prevalence analysis to multi-source data in their opioid-dependence study (40). Their study combined opioid treatment data with opioid-related mortality, hospitalisation and arrest datasets and fitted a multi-source Bayesian regression model to extrapolate the prevalence observed in the treatment data to the broader population (40). Bayesian methods are particularly useful when prior information about the condition’s prevalence exists, when some indication of the likelihood of output values is needed, when sample sizes are small, or when frequentist approaches are insufficient to model the complexity of the system under study (41).

##	Machine learning 

Machine learning provides an increasingly valuable suite of tools in population health research and component analysis techniques are well suited to understanding the complexity inherent in epidemiological datasets (42). Multiple Component Analysis (MCA) is a descriptive, unsupervised machine learning technique that is well suited to categorical data (43). It uses Euclidean distances to cluster data points based on similarity of categorical feature values, without making assumptions about features’ distributions (43). MCA is most useful in exploratory analysis or large dataset to find feature categories that group together and associations are often assessed visually (42,43). Costa et al. used MCA to explore the relationship between healthy aging and categorical variables describing 1,051 patients’ cognition, health, lifestyle and demographic features (43).

##	Probabilistic record linkage

Probabilistic record linkage is a technique for joining two datasets that do not share a common feature that uniquely identifies individuals in each dataset (44). It was proposed by Fellegi and Sunter in 1969 (45) and refined by many since then, such as Enamorado, Fifield and Imai who parallelised the algorithm to improve efficiency, added category frequency information to calculations of pair weights and accounted for uncertainty in the merging processes (44). 

Probabilistic record linkage generates all possible record pairs across both datasets, compares the similarities of each pair’s values for each common feature and calculates their weight, typically using an expectation maximisation (EM) algorithm  that includes consideration of the relative contributions of each feature and their categories’ relative frequencies (45,46) (47). Pairs are then allocated as a link, a non-link or a possible link based on user-defined thresholds for the pair weights (45). The similarity comparison is user defined with Jaro-Winkler distance being common for character features such as names and exact matches being common for numeric features (44,47). R’s RecordLinkage package uses Contiero et al.’s EM algorithm, EpiLink, to calculate pair weights (47,48). Blocking can be used to improve efficiency by requiring a perfect match on some pre-specified features and therefore reducing the total number of pairs to be considered (47).

Enamorado, Fifield and Imai recommend using probabilistic rather than deterministic models to merge large datasets because probabilistic models allow the certainty of matches to be quantified and deterministic models do not, meaning the latter are prone to bias due to measurement error (44). They also recommend blocking the data before running the matching algorithm to reduce the number of false matches identified, especially when the overlap between datasets is low (44).

A simulation study by Hejblum et al. validated the use of probabilistic linkage for matching anonymised clinical records using data on patients’ diagnoses (49). They found the Fellegi-Sunter method underperformed compared to their proposed Bayesian method because it is not well suited to one-to-one matching and does not distinguish between the feature values of matches – it weights 0-0 matches the same as 1-1 matches  - which in a clinical data context where missingness is common would cause overweighting of low information matches (49).


#	Aims

This project aims to better understand the prevalence of autism and ADHD in children in Chile. To that end, its objectives are to:

1.	Find a lower bound on the prevalence of autism and ADHD across sex, health service, SES, ethnicity and rurality in Chile from school data using a frequentist method.

2.	Identify common characteristics of Chilean children with autism from clinical data using machine learning clustering.

3.	Link Chilean school data and clinical data and thus obtain an accurate autism prevalence estimate in one health service, then project prevalence bounds across all health services using Bayesian prevalence prediction.


# Methods

## Deviation from research protocol

This investigation differs very substantially from the research protocol provided at Appendix X. The protocol intended to investigate autism prevalence in the Cambridgeshire region using clinical data from the Cambridgeshire and Peterborough NHS Foundation Trust and school data from the UK Department for Education’s National Pupil Database. Unfortunately this clinical data was found to be of insufficient size and quality to conduct the proposed investigation and while this school data was of high quality, it had been well analysed by Roman-Urrestarazu already (8)(10). Therefore school and clinical data from Chile was used instead as they were of high quality and no research on them could be found. The available data from Chile did not have fields on age at autism diagnosis and it was therefore not possible to progress the research protocol’s first aim of using machine learning to analyse autism diagnosis age. The protocol’s second aim of school autism diagnoses with clinical diagnoses was adapted to be supplementation of the Chilean school data diagnoses with clinical diagnoses, see below. Additional aims and analysis that were appropriate to the Chile data were developed and are detailed in Section [Aims] and the rest of this section.

## Data management

The statistical software package R has been used to clean, link, analyse and visualise data. R analysis scripts and version control are managed in GitHub and are available at https://github.com/delatee/Autism-diagnosis-age-ML. Raw data and analysis outputs have not been uploaded to GitHub.  All data is stored on local devices and will be deleted at conclusion of the project.

## Data collection

See Figure \@ref(fig:sampleSize) for an illustration of the data sources and how they through the analysis detailed below. 

### School data

This research uses data from the Chilean Government’s Ministerio de Educación (Ministry of Education) that was provided under a freedom of information request and Chile’s Law 21545 (28). This dataset contains anonymised records of 3.6 million students in all Chilean schools in 2021. It was collected and curated by the Chilean Unidad de Estadísticas (Statistics Unit), Centro de Estudios (Study Centre) and Ministerio de Educación and is housed in the Sistema de Información General de Estudiantes (General Student Information System, SIGE). It includes data on school type and location, student characteristics, academic performance, special needs and monthly school fee contributions. This dataset will be referred to as the school data.

The school data shows whether students have accessed the Subvención de Educación Especial Diferencial (Differential Special Education Grant, SEED), which is provided to students with severe physical or mental disabilities, including autism and ADHD, that require education adjustments such as specialist schools or small class sizes (29). Specialists in the SEED network of providers conduct an external assessment of students that apply for SEED funding to determine whether they have a special educational need (SEN). The school data includes four groups of students who have autism but are recorded in this dataset as not having autism: students with autism who attend private schools which are not eligible for SEED; students with autism who choose not to apply for SEED; students with autism who apply for SEED but are found to not be sufficiently severely affected to receive SEED; and students with autism who receive SEED but for a different disability as only one can be recorded, perhaps one that more severely affects them. The number of students in each of these groups is unknown and these groups are analogous for students with ADHD. Thus all estimates of autism and ADHD prevalence from this dataset alone are likely to be underestimates of the true population prevalence. 

### Clinical data

```{r mapArauc, fig.cap = "Communes in the La Araucanía region, with Servicio de Salud Araucanía Sur (SSAS) communes in green and Servicio de Salud Araucanía Norte (SSAN) communes in blue.", fig.height=8}
# ARAUC communes
arauc <- region_service_commune_lookup %>%
  filter(ADM1_PCODE == "CL09")

ggplot(arauc) +
  geom_sf(mapping = aes(geometry = geometry, fill = health_service_name), color = "grey") +
  geom_sf_text(mapping = aes(geometry = geometry, label = commune_name), size = 3.5) +
  coord_sf(xlim = c(-73.5, -70.8), ylim = c(-39.7, -37.6)) +
  scale_fill_manual(name = "Health service", values = c("#A6FDFD", "#D6FD75")) +
  theme_void() +
  theme(legend.position = "bottom") +
  labs(title = "La Araucanía communes by health service") +
  xlab("Longitude") +
  ylab("Latitude") 
```

This research also uses data from Chile’s Servicio de Salud Araucanía Sur (South Araucanía health service, SSAS), obtained under a freedom of information request. These data are collated from secondary care clinical records, particularly from mental health community care services. They comprise clinical records for public sector specialist health visits of patients aged 6-18 with a primary diagnosis of autism between February 2014 and December 2021 for all communes in the SSES catchment. Figure \@ref(fig:mapArauc) shows the communes in the SSAS and Servicio de Salud Araucanía Norte (North Araucanía health service, SSAN) catchments. The clinical records include wage deducted health insurance contributions from Chile’s Fondo Nacional de Salud (National Health Fund, FONASA), from which a colleague previously inferred socio-economic status of patients’ families. The majority of records are for patients resident in the SSAS catchment area and they do not include any records for privately provided healthcare. These data will be referred to as the clinical data. 

```{r flowchart, include = FALSE, fig.cap="Clinical data pre-processing pathway. N = number of appointment records, N' = number of appointment records for patients resident in SSAS communes.", echo=FALSE, out.width = '80%'}
knitr::include_graphics("Flowchart.jpg", error = FALSE)
```

A subset of the clinical data, those for appointments provided by Villarrica Hospital in the Villarrica commune of Chile’s Araucanía region, were manually validated prior to this investigation. Validation involved a neurologist and a psychiatrist in the SEED network of providers checking the clinical records against central health records to confirm individuals did have autism, adding secondary and tertiary diagnoses where relevant, and adding demographic information including ethnicity, rurality of residence, disability status and experience of foster care status where available. We can be very confident that patients in this subset do have autism. Most patients in this subset were resident in Loncoche, Pucón and Villarrica communes in the SSAS catchment area. These data will be referred to as the validated clinical data, see Figure \@ref(fig:sampleSize).

###	Additional data

Chile’s 2017 census data, held by the Instituto Nacional de Estadisticas (National Statistics Institute, INE) (30), was used to create a standard population of Chile’s age and sex distribution from projections of population size by age and sex in 2021. It was also used to obtain projections of population of youth aged 0-14 in 2021 by region.

Data from the INE’s Encuesta Suplementaria de Ingresos (Supplementary Income Survey, ESI) of 2021 (31) was used to obtain the nominal median income by region in 2021.

For mapping, shapefiles of administrative areas were obtained from The Humanitarian Data Exchange of the United Nations Office for the Coordination of Humanitarian Affairs (32). Additional region and commune naming information was taken from the R package ‘chilemapas’.

## Aim 1: Use school data and frequentist method to find a lower bound on autism and ADHD prevalence

Using the school data, the crude prevalence of autism and ADHD was found. Then frequentists methods were used to find the age- and sex-adjusted autism and ADHD prevalence.

###	School data preparation

The school dataset was restricted to students aged 6-18 as of 30th June 2021 to capture children of school age in Chile. No restriction on sex was necessary as it contained only females and males. Students’ commune of residence was mapped to their respective health service catchment areas. Two issues due to boundary changes were corrected. Firstly, the commune now called Tocopilla which falls across the Antofagasta and Tarapacá regions was formerly two communes, Tocopilla in Antofagasta and Pozo Almonte in Tarapacá. The old names have been retained to ensure appropriate region mapping and they are mapped to Antofagasta and Iquique health services respectively. Secondly, the communes recorded as belonging to the former Ñuble sub-region of the Bío-Bío region were mapped to their corresponding communes in the recently formed Ñuble region.

Commune of residence was missing for 4078 students (0.13%). The commune of their school was imputed as most students are likely to go to school near their place of residence.

Students’ age as of 30th June 2021 was mapped to age-bands of 6-8, 9-11, 12-14 and 15-18, preserving the divide between primary and secondary school as secondary school starts at age 12 in Chile, and with a larger final band as fewer students are expected to be diagnosed older and the 18 years old group may be small due to students leaving schooling. Students’ ethnicity was mapped to being a member of the Mapuche Indigenous group, being a member of another Chilean Indigenous group, or not being a member of an Indigenous group based on their recorded ethnicity which can take at most one value. The 6859 students (0.22%) with ethnicity recorded as ‘no registry’ were mapped to not being a member of an Indigenous group.

Students’ school fee status was mapped to a proxy socio-economic status feature. Students with free schooling were given SES of 1 indicating low status as families with low SES are entitled to schooling rebates. Students paying Chilean Peso \$1,000-\$100,000 monthly were given SES of 2, indicating medium status, and students paying more than \$100,000 monthly were given 3 to indicate high status. For school fee status, 49973 students (1.64%) were coded as ‘No information’ and 29 students (0.00095%) were missing school fee values and these were re-categorised as ‘No information’ to reflect their unknown school fee status. No other features of interest for this analysis had missingness.

###	Crude prevalence
The crude prevalences of autism and of ADHD were calculated as the count of cases divided by the relevant population size. Grouping features of sex, health service of residential commune, monthly school fee as a proxy for SES, ethnicity and school’s rurality were used, and calculations were made for aggregate, by sex, and by sex and age group. 

###	Frequentist age and sex adjustment
For each grouping feature, prevalence was standardised by age and sex using direct standardisation following the method presented by Fay and Feuer (33). The 2017 Chile census projections of the distribution of people by age and sex in 2021 was used as the standard population. Gamma confidence limits were calculated at the 95% level using chi-squared distributions. The adjusted prevalence rates were multiplied by their respective population sizes to give adjusted prevalence counts which were rounded to integers, therefore loosing a small amount of precision.

Ethnicity analysis compared individuals from the Mapuche Indigenous group to those from other Indigenous groups or with no Indigenous group and used data from the Araucanía, Aysén, Biobío, Los Lagos, Los Rios, Magallanes and Región Metropolitana de Santiago regions only as these regions are collectively the five regions with the largest Mapuche populations and the five regions with the highest proportion of Mapuche in their population. 


## Aim 2: Use clinical data and machine learning to identify autism diagnosis characteristics 

The machine learning technique of multiple component analysis (MCA) was used to explore the feature categories in the validated clinical data that explain its variance.

###	Clinical data preparation
The full clinical dataset was cleaned to ensure internal consistency in feature values and translated into English where appropriate. Patients were categorised as having autism if any of their diagnosis codes were in ICD F84-F89 for any appointment. Patients were categorised as having an intellectual disability if any of their diagnoses codes was in ICD F70-F79 for any appointment. No restriction on sex was necessary as these data contained only females and males. The clinical data includes economic data in the form of patients’ family’s health insurance contribution level. Values taken are ‘FONASA-A’ to ‘FONASA-D’ which are respectively larger contributions to this public health fund and are assumed to map to increasing socio-economic status, and ‘Private health insurance’ which indicates contributions to a private health insurance provider rather than the public fund and therefore is assumed to map to the highest socio-economic level. The clinical data was restricted to patients with a diagnosis of autism.

For multiple correspondence analysis, only the validated clinical dataset was used as it contained additional demographic fields not present in the remaining section of the clinical data. In the validated clinical data, patients’ age as of 30th June 2021 was mapped to age-bands of 0-2, 3-5, 6-8, 9-11, 12-14 and 15-18. Students below school age were retained for MCA only to more fully explore the variation in the autism patient data. The validated clinical dataset had many values for ethnicity, disability status and foster care status that were recorded as ‘no information’. For disability and foster care status, additional features were created with the ‘no information’ values imputed as ‘no disability’ and ‘no foster care’ respectively, as it is likely that patients who did have a disability or had experienced foster care would have this recorded. 

The validated clinical data was aggregated to patient level by selecting each patient’s most recent commune and rurality, and most common health insurance contribution level, hospital and medical specialty of appointment. For ethnicity, Mapuche was selected if present in any of that patient’s appointment records, then Chilean if present, then Foreign if present and else ‘No information’ was selected. Similarly, disability and foster care status were selected as ‘Yes’ if recorded for any appointment, then ‘No’ was selected if present, then ‘No information’ if no status was recorded for any appointment. Only patients living most recently in a commune in the SSAS catchment area were included.

### Multiple correspondence analysis

The machine learning technique of multiple correspondence analysis (MCA) was conducted using R’s FactoMineR package with the number of output dimensions equal to the number of input features. MCA was an appropriate technique to use here because the small clinical dataset contains primarily categorical features which MCA is designed to handle. 

Data-led analytics was used to identify features in the small clinical dataset that explained the variance in this patient-level data. Initially, all available features with suspected association with autism were included in MCA, specifically: sex, age group, commune of residence, health insurance contribution level as a proxy for SES, ethnicity, residential rurality, disability status and foster care status. The data grouped well into having information about disability and about foster care and not having information about each, therefore the MCA was rerun with the disability and foster care features exchanged for their respective imputed versions. This identified age, commune and ethnicity as important for explaining the variance, so the MCA was rerun with only these three features.

### Alternative machine learning approaches

Other machine learning techniques including component factor analysis (CFA) and principle component analysis (PCA) were also considered to analyse the features associated with autism diagnosis in the small clinical data. Both are powerful methods for uncovering the latent structure of data, however CFA typically requires ordered categorical variables and PCA requires continuous variables. As the commune feature, an unordered categorical variable, was thought to be important to the features associated with autism diagnosis and therefore needed to be included in analysis, using CFA or PCA would require one-hot-encoding of commune which would reduce the appropriateness of these tests.

## Aim 3a: Use machine learning to link school and clinical records

The school data and clinical data were linked using manual and probabilistic record linkage.

### School data preparation

For data linkage, the school data was further restricted to students with autism that were living in communes in the SSAS catchment in 2021 to maximise comparability with the clinical data. A false empty record was added to the school dataset before linkage that allowed the algorithm to correctly match on SES. This false record was only used during linkage, did not match to any patient records and was removed before comparing matched and unmatched records. This will be referred to as the SSAS school data

### Clinical data preparation

For data linkage, the full clinical dataset was used. It was restricted to appointments for individuals resident in communes in the SSAS catchment as the data is believed to be complete for this catchment area only. It was also restricted to patients aged 6-18 as of 30th June 2021 to maximise compatibility to the school data. Appointment year was not restricted in order to retain more data and thus maximise linkage opportunities, and only patients of female and male sex were present. Patients with familial socio-economic level of FONASA-A were interpreted to have low SES and given proxy status of 1 (equivalent to students with free school fees); patients with FONASA-B, FONASA-C and FONASA-D were interpreted to have moderate SES and given 2 (equivalent to students paying \$1,000-\$100,000 monthly for state schooling); and patients with private health insurance were interpreted to have high SES and given 3 (equivalent to students paying more than \$100,000 monthly). 

The clinical dataset had no missingness in the features of interest for data linkage. 

The clinical data was aggregated to one row per patient per commune in the SSAS catchment, to maximise the opportunity for matching patients that had moved within this health service. The majority of patients lived in only one commune in the SSAS catchment during the study period. Aggregation used the most common SES value for each patient. The resulting dataset will be referred to as the patient data.

### Selection of features for matching

The features available for matching that occurred in both the SSAS school data and the patient data were sex, date of birth, commune of residence, and the proxies for socio-economic status – monthly school fees in the SSAS school data and mode health insurance contributions in the patient data. 

### Manual record linkage

The SSAS school and patient data were blocked on sex and date of birth to improve match quality and reduce runtime. As both datasets are from trusted, large-scale data collections, it is reasonable to assume sex and dates of birth are highly accurate in both datasets, and it would not be reasonable to accept any proposed matches that do not agree on either sex or date of birth. 

Two versions of manual record linkage were tried. First, the SSAS school and patient data were merged with perfect matches required on sex, date of birth, commune of residence and proxies for SES. Second, the SSAS school and patient data were merged with perfect matches required only on sex, date of birth and commune of residence, as the proxies for SES are known to be approximate and therefore requiring perfect matches on SES is not reasonable.

### Probabilistic record linkage

The machine learning technique of probabilistic matching was then used to link the SSAS school and patient data. All possible pairs of blocked matches across these two datasets were generated and agreement weights were calculated for each feature using expectation maximisation, then aggregated into a weight for the pair. Records with missing values were retained as this linkage method is robust to missingness. The similarity comparison method was exact matching for commune of residence, diagnosis with autism and socio-economic status; there was no value in using a string comparison method for commune of residence as all commune names were already standardised and two communes having similarly spelled names does not increase the likelihood of a match between those communes. Linkage was implemented using R’s RecordLinkage package. This included consideration of the average frequencies of categories in each feature and estimated errors rates were supplied: the default estimated error rate of 0.01 was supplied for the commune of residence and diagnosis with autism features as they are expected to be fairly accurate features, and an estimated error rate of 0.1 was supplied for the socio-economic status feature to reflect that it is a loosely defined proxy. 

Pairs were then selected based on weight to create a 1-1, bipartite, matching between SSAS school records and patients. These matches were examined to ensure a patient that lived in multiple communes had matched to only one SSAS school record.

### Alternative record linkage methods

Record linkage using Bayesian methods in which matched status is modelled, as developed by Sadinle (34) and refined by Stringham (35), was considered for record linkage here. This technique is typically more complex and has longer runtimes than probabilistic matching but can more easily enforce one-to-one matching and is particularly well suited to matching names. As the datasets in this investigation did not include names, there was limited benefit from using Bayesian linkage methods.

Record linkage using machine learning to classify matched and unmatched pairs, as explored by Pita et al, was also considered as it is generally thought to be more accurate than probabilistic matching alone (36). However this was not pursued because the datasets under investigation have very few common features to match on, meaning machine learning algorithms would have few options to trial, and there are no known true matches with which to assess the accuracy of machine learning models. 

### Comparison of matched and unmatched records

For the SSAS school and patient datasets, each record was classified as either matched or unmatched based on whether it appeared in the bipartite matching. The discrete Kolmogorov-Smirnov test was used to compare matched and unmatched records within each dataset for each of the features used for matching, excluding date of birth which has too many categories to have meaningful results. Missing values in the socio-economic status feature were omitted before testing as the Kolmogorov-Smirnov test is not robust to missingness.

Permutation tests were then performed for each of the features tested in each dataset by permuting the matched status 2000 times and recomputing the discrete Kolmogorov-Smirnov test for each permutation. The p-values for the Kolmogorov-Smirnov tests on the observed data were then compared to the distributions of p-values for the permuted data to determine the significance of the observed results.

## Aim 3b: Accurately estimate autism prevalence and project prevalence bounds across health services using Bayesian prevalence prediction

An updated estimate of autism prevalence in SSAS was made and projected across health services. Bayesian random effect models were used to predict autism prevalence for several priors.

### Updated autism prevalence estimation 

```{r caseSelection, include = FALSE, fig.cap="Case selection for prevalence calculation after the SSAS school and patient data linkage. White shows students with no known autism diagnosis. Yellow shows known autism cases in the school data for students resident in the Araucanía Sur health service (SSAS) catchment. Green shows patients that matched to a school record. Blue shows patients that did not match to a school record and are assumed to be present in the school data but do not access SEED. Grey shows patients with an autism diagnosis made in the private health sector and therefore not present in the patient dataset.", echo=FALSE, out.width = '80%'}
knitr::include_graphics("Case_selection.jpg", error = FALSE)
```

The patient data was de-duplicated to a single row per patient with the commune of their matched record chosen if they had multiple communes of residence. The unmatched patients were aggregated to counts per age and sex group. The full school dataset was restricted to students resident in SSAS, then was aggregated to counts per age, sex and autism status group. It was assumed that the patients that did not match to the SSAS school data, which only includes students with SEED for autism, do exist in the larger school data of students resident in SSAS but that do not have a diagnosis of autism in the school data because they do not receive SEED or do not receive it for autism. Thus the count of students with autism for each age and sex group in the restricted school data was increased by the number of unmatched patients in that age and sex group, and the number of students without autism was decreased by the same amount. This effectively reallocated the appropriate number of SSAS students recorded as not having autism to having autism and retained the school data sample sizes. Figure \@ref(fig:caseSelection) illustrates the autism cases present after data linkage; the updated prevalence was taken to be the number of cases in the combined left-hand side of the figure plus the blue shaded region of additional cases found in the patient data, divided by the number of students resident in SSAS.

The crude and age- and sex-adjusted updated prevalence of autism was calculated from the updated counts as in sections [4.4.2][Crude prevalence] and [4.4.3][Frequentist age and sex adjustment]. The difference between the adjusted updated prevalence for SSAS (using the reallocated autism diagnosis figures and thus including the additional autism cases found from linkage) and the adjusted school data prevalence for SSAS (using only students with SEED) was calculated and will be reference to as the adjusted prevalence delta. It represents the prevalence of individuals with an autism diagnosis in the public health system that do not access SEED for autism. Unmet need was calculated as the adjusted prevalence delta multiplied by the number of students in the full school dataset.

### Prevalence projection

Prevalence was projected for each of the health services other than SSAS by adding the adjusted prevalence delta to the adjusted prevalence for each health service that was calculated from the school data only. This projects the prevalence of individuals with autism that do not access SEED across the health services. It assumes that all SSAS patients exist in the school data and are recorded in this dataset as resident in SSAS communes. Estimated confidence intervals were calculated for the projections by finding a band around the projection of equal width to the 95% gamma confidence interval for each health service’s school data adjusted prevalence.

### Bayesian prevalence analysis 

Bayesian prevalence analysis of autism was conducted for the school data by health service. Bayesian methods are appropriate here because they allow calculation of prevalence with incomplete data. Here two different types of data, school records and patient appointments, have been combined and both are known to be incomplete. Bayesian analysis is robust to this messiness and allows plausible prevalence predictions to be made. It also provide information about the likelihood of these predictions given the observed school data.

To conduct the Bayesian analysis, a random-effects model was constructed with the random effect on health service as follows. 

Set 
$$y_{i} = \text{adjusted count of autism cases in health service } i$$
$$n_{i} = \text{number of students in health service } i$$
$$\theta_{i} = \text{prevalence of autism in health service } i$$

For each health service $i$, the model formula is 
$$y_{i}  | (n_{i}, \theta_{i})  \sim \text{Binomial}(n_{i}, \theta_{i})$$
With 
$$\theta_{i} \sim \text{Beta}(a,b)$$
And posterior distribution
$$\theta_{i} | (y_{i} ,n_{i})  \sim \text{Beta}(y_{i} + a, n_{i} - y_{i} + b)$$

Fitting a binomial model required integer valued counts of autism cases. As adjusted case counts were used throughout, the adjusted counts had to be rounded to integer values which caused a small amount of precision to be lost. It is anticipated that this may cause the posterior credible intervals to be slightly wider but is not expected to have a large effect on findings.

### Prior selection

Four priors for $\theta_{i}$ were used when fitting the Bayesian prevalence model. First, a conjugate beta prior common to all health services was constructed with the global age- and sex-adjusted prevalence of autism in the school dataset and its standard deviation used respectively as the mean and standard deviation of the prior. This prior was suitable because the global adjusted prevalence in the school data provides a lower bound on the plausible prevalence of autism in Chile. 

Second, a conjugate beta prior specific to each health service using the health service specific age- and sex-adjusted autism prevalence in the school data as the prior means and their standard deviations as the prior standard deviations. This prior was suitable because it was extending the previous prior to each of the random effect categories and it reflects the students know to be receiving SEED for autism. On its own this prior is expected to give uninformative posteriors because it is effectively duplicating the information in the sample data, but it will be used as a more specific lower bound on the plausible prevalence of autism in each health service. 

Third, a conjugate beta prior specific to each health service with the health service specific projections of adjusted updated prevalence from data linkage as the prior means, and prior standard deviations the same as the second prior. This prior was suitable as captures the extra information provided by the linkage and thus represents all students with autism diagnosis, not only those that receive SEED for autism. Additionally, this prior has narrow standard deviations which will model a theoretical upper bound on the prevalence of autism in each health service. 

Fourth, a uniform prior specific to each health service with the adjusted autism prevalences from the school data for each health service as its lower bounds and the adjusted projected prevalences from data linkage for each health service as its upper bounds. This prior is suitable because it captures the information from both the school and clinical datasets, without specifying where within these bounds the true prevalences are likely to be.

### Markov chain Monte Carlo sampling

Bayesian prevalence modelling used the JAGS (Just Another Gibbs Sampler) R package which uses Markov chain Monte Carlo (MCMC) sampling to produce posterior density distributions when given the above priors and adjusted prevalence observations. A burn-in period of 2000 samples was used to ensure models converge, then 2000 iterations were used to model the posterior densities. Visual inspection of trace plots showed no evidence of a lack of convergence and $\hat{r}$ values were less than 1.1.


# Results

```{r sampleSize, fig.cap="The datasets used in this investigation, their size (N) and the number of people with autism and ADHD where applicable. Light blue shows the school data which is used to calculate lower bounds on autism and ADHD prevalence, and subsets of the school data for students resident in Servicio de Salud Araucanía Sur (SSAS) and those that are not. In the school data, autism and ADHD indicate students that access SEED for autism and for ADHD respectively. Green shows the clinical data and its subsets of validated and unvalidated clinical data and autism here indicates clinical diagnoses. Validation involved confirming autism diagnosis against central clinical record, adding 2nd and 3rd diagnoses, and adding demographics data. Red shows the validated clinical data for patients resident in SSAS that is used for multiple component analysis. Yellow shows the subsets of school and clinical data used for data linkage; the patient data is the combination of validated and unvalidated clinical datasets and some patients are represented in both these datasets. Grey shows the matches resulting from three linkage approaches. Dark blue shows the result of data linkage and is used to calculated updated estimates of autism prevalence.", echo=FALSE, out.width = '100%'}
knitr::include_graphics("sample_sizes.jpg", error = FALSE)
```

Figure \@ref(fig:sampleSize) shows the school and clinical data and how they contribute to the three aims of this investigation. The school data is used to address aim 1, finding a lower bound on autism and ADHD prevalence, see sections [5.1][School data] and [5.2][Frequentist prevalence estimation]. The validated clinical data for patients resident in SSAS is used to address aim 2, identifying common characteristics of children with autism, see sections [5.3][Clinical data] and [5.4][Machine learning with clinical data]. Linkage of school and clinical data is used to address aim 3, obtaining and projecting accurate autism prevalence estimates, see sections [5.5][Linkage of school and patient records], [5.6][Updated autism prevalence estimates and delta] and [5.7][Bayesian prevalence projection].

## School data

```{r schoolTable}
school.table <- chile_bayes %>%
  group_by(sex_desc) %>% 
  summarise(variable = "Sex",
            count = n(), 
            perc = sprintf("%.2f", round(count/nrow(chile_bayes)*100, 2))) %>%
  rename(values = sex_desc) %>%
  rbind(chile_bayes %>%
          group_by(age_cat_name) %>% 
          summarise(variable = "Age band",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(chile_bayes)*100, 2))) %>%
          rename(values = age_cat_name),
        chile_bayes %>%
          group_by(health_service_name) %>% 
          summarise(variable = "Health service",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(chile_bayes)*100, 2))) %>%
          rename(values = health_service_name),
        chile_bayes %>%
          group_by(school_fee) %>% 
          summarise(variable = "School fee",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(chile_bayes)*100, 2))) %>%
          rename(values = school_fee),
        chile_bayes %>%
          group_by(ethnic_2_group) %>% 
          summarise(variable = "Ethnicity",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(chile_bayes)*100, 2))) %>%
          rename(values = ethnic_2_group),
        chile_bayes %>%
          group_by(school_rurality) %>% 
          summarise(variable = "Rurality",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(chile_bayes)*100, 2))) %>%
          rename(values = school_rurality),
        chile_bayes %>%
          group_by(special_needs_status) %>% 
          summarise(variable = "Accesses SEED",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(chile_bayes)*100, 2))) %>%
          rename(values = special_needs_status) %>%
          mutate(values = ifelse(values == 0, "No SEED", "Yes SEED")),
        chile_bayes %>%
          group_by(autism) %>% 
          summarise(variable = "Autism",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(chile_bayes)*100, 2))) %>%
          rename(values = autism) %>%
          mutate(values = ifelse(values == 0, "No autism", "Yes autism")),
        chile_bayes %>%
          group_by(adhd) %>% 
          summarise(variable = "ADHD",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(chile_bayes)*100, 2))) %>%
          rename(values = adhd) %>%
          mutate(values = ifelse(values == 0, "No ADHD", "Yes ADHD"))) %>%
  mutate(count_perc = paste0(format(count, big.mark = ",", trim = TRUE), " (", perc, "%)")) %>%
  select(variable, values, count_perc)

kbl(school.table,
    col.names = c("Feature", "Available values", "Count (%)"),
    align = "llr",
    booktabs = TRUE,
    longtable = TRUE,
    format = "latex",
    linesep = c("", "\\addlinespace", # Sex
                "", "", "", "\\addlinespace", # Age
                "", "", "", "", "",
                "", "", "", "", "",
                "", "", "", "", "",
                "", "", "", "", "", 
                "", "", "", "", "",
                "", "", "",  "\\addlinespace", # Health service
                "", "", "", "", "", "", "\\addlinespace", # SES
                "", "", "\\addlinespace", # Ethnicity
                "", "\\addlinespace", # Rurality
                "", "\\addlinespace", # SEED
                "", "\\addlinespace", # Autism
                "", "\\addlinespace" # ADHD
                ), 
    caption = "Count and percentage of features' values in the school dataset.") %>%
  kable_styling(latex_options = c("repeat_header"))
```

```{r adjPrev}
# Autism
aut_prev <- get_grouped_prev(x = chile_bayes_aut, stdpop = chile_stdpop, 
                             grouping_vars = c("age_june30", "age_cat_name", "sex", "sex_desc", "autism"),
                             disease = "autism")

aut_prev_adj <- aut_prev %>% # Don't use get_adjusted_prev here because we have no variables to group on
  summarise(sum_sample_pop_size = sum(sample_pop_size),
            crude_rate = sum(n_disease) / sum(sample_pop_size),
            crude_count = sum(n_disease),
            adjusted_rate = sum(n_disease / sample_pop_size * pop_prop),
            adjusted_count = round(adjusted_rate * sum_sample_pop_size, 0), # had to fudge this to get MCMC to run bc it needs integers
            #adjusted_count = adjusted_rate * sum_sample_pop_size,
            var = sum(pop_prop^2 * n_disease / sample_pop_size^2),
            #se2 = sqrt(sum((std_pop/sum(std_pop))^2 * n_autism/sample_pop_size^2)),
            w_M = max(w),
            crude_ci_lower = crude_rate - (1.96 * sqrt(crude_rate * (1 - crude_rate) / sum_sample_pop_size)),
            crude_ci_upper = crude_rate + (1.96 * sqrt(crude_rate * (1 - crude_rate) / sum_sample_pop_size)),
            adjusted_ci_lower = ifelse(var == 0, 0, var / (2*adjusted_rate) * qchisq(p = 0.05/2, df = 2*adjusted_rate^2 / var)),
            adjusted_ci_upper = (var + w_M^2) / (2*(adjusted_rate + w_M)) * qchisq(p = 1-0.05/2, df = 2*(adjusted_rate+w_M)^2 / (var+w_M^2))) %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))

# ADHD
adhd_prev <- get_grouped_prev(x = chile_bayes_adhd, stdpop = chile_stdpop, 
                             grouping_vars = c("age_june30", "age_cat_name", "sex", "sex_desc", "adhd"),
                             disease = "adhd")

adhd_prev_adj <- adhd_prev %>% # Don't use get_adjusted_prev here because we have no variables to group on
  summarise(sum_sample_pop_size = sum(sample_pop_size),
            crude_rate = sum(n_disease) / sum(sample_pop_size),
            crude_count = sum(n_disease),
            adjusted_rate = sum(n_disease / sample_pop_size * pop_prop),
            adjusted_count = round(adjusted_rate * sum_sample_pop_size, 0), # had to fudge this to get MCMC to run bc it needs integers
            #adjusted_count = adjusted_rate * sum_sample_pop_size,
            var = sum(pop_prop^2 * n_disease / sample_pop_size^2),
            #se2 = sqrt(sum((std_pop/sum(std_pop))^2 * n_autism/sample_pop_size^2)),
            w_M = max(w),
            crude_ci_lower = crude_rate - (1.96 * sqrt(crude_rate * (1 - crude_rate) / sum_sample_pop_size)),
            crude_ci_upper = crude_rate + (1.96 * sqrt(crude_rate * (1 - crude_rate) / sum_sample_pop_size)),
            adjusted_ci_lower = ifelse(var == 0, 0, var / (2*adjusted_rate) * qchisq(p = 0.05/2, df = 2*adjusted_rate^2 / var)),
            adjusted_ci_upper = (var + w_M^2) / (2*(adjusted_rate + w_M)) * qchisq(p = 1-0.05/2, df = 2*(adjusted_rate+w_M)^2 / (var+w_M^2))) %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))
```

The school dataset contained records for `r format(nrow(chile_bayes), big.mark = ",", trim = TRUE)` Chilean students aged 6-18 in 2021, see Table \@ref(tab:schoolTable). Of these, `r format(chile_bayes %>% filter(sex_desc == "Female") %>% nrow(), big.mark = ",", trim = TRUE)` (`r round(chile_bayes %>% filter(sex_desc == "Female") %>% nrow() / nrow(chile_bayes) * 100, 2)`%) were female and the rest were male.  A special needs code was recorded for `r format(chile_bayes %>% filter(special_needs_status == 1) %>% nrow(), big.mark = ",", trim = TRUE)` (`r round(chile_bayes %>% filter(special_needs_status == 1) %>% nrow() / nrow(chile_bayes) * 100, 2)`%) students, indicating they received SEED during that school year. Of these students, `r format(chile_bayes %>% filter(autism == 1) %>% nrow(), big.mark = ",", trim = TRUE)` (`r round(chile_bayes %>% filter(autism == 1) %>% nrow() / chile_bayes %>% filter(special_needs_status == 1) %>% nrow() * 100, 2)`%) received SEED for autism and `r format(chile_bayes %>% filter(adhd == 1) %>% nrow(), big.mark = ",", trim = TRUE)` (`r round(chile_bayes %>% filter(adhd == 1) %>% nrow() / chile_bayes %>% filter(special_needs_status == 1) %>% nrow() * 100, 2)`%) received SEED for ADHD. Thus the global crude prevalence of autism in the school data was `r round(aut_prev_adj$crude_rate * 100, 2)`% (`r round(aut_prev_adj$crude_ci_lower * 100, 2)`-`r round(aut_prev_adj$crude_ci_upper * 100, 2)`%) and the global crude prevalence of ADHD was `r sprintf("%.2f", round(adhd_prev_adj$crude_rate * 100, 2))`% (`r sprintf("%.2f", round(adhd_prev_adj$crude_ci_lower * 100, 2))`-`r round(adhd_prev_adj$crude_ci_upper * 100, 2)`%).

The crude prevalence of autism and ADHD vary with age, as shown in Tables \@ref(tab:prevAgecatAutTable) and \@ref(tab:prevAgecatAdhdTable), Figures \@ref(fig:prevAgecatAutPlot) and \@ref(fig:prevAgecatAdhdPlot), and Supplementary Figures \@ref(fig:prevAgeAutPlot) and \@ref(fig:prevAgeAdhdPlot). Autism prevalence is highest in 6-8 year olds and decreases with age while ADHD prevalence peaks around age 11 then decreases. Both conditions show a small increase in prevalence for age 18.

```{r prevAgecatAutTable}
# Autism
aut_prev.agecat <- get_grouped_prev_plot(x = chile_bayes_aut, 
                                          grouping_vars = c("age_cat_name", "autism"),
                                          disease = "autism") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower)) 

aut_prev.agecat.table <- aut_prev.agecat %>%
  select(age_cat_name, n_disease, prev_ci)

kbl(aut_prev.agecat.table, 
    col.names = c("Age band", "Autism cases", "Prevalence % (95% CI)"),
    align = "rrr",
    booktabs = TRUE,
    format = "latex",
    #linesep = c("", "", "\\addlinespace"), # Extra white space after every 3rd line to match age bands
    caption = "Count and prevalence of autism cases by age band in Chile school data with normal confidence intervals.")
```

```{r prevAgecatAdhdTable}
# ADHD
adhd_prev.agecat <- get_grouped_prev_plot(x = chile_bayes_adhd, 
                                          grouping_vars = c("age_cat_name", "adhd"),
                                          disease = "adhd") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower)) 

adhd_prev.agecat.table <- adhd_prev.agecat %>%
  select(age_cat_name, n_disease, prev_ci)

kbl(adhd_prev.agecat.table,
    col.names = c("Age band", "ADHD cases", "Prevalence % (95% CI)"),
    align = "rrr",
    booktabs = TRUE,
    format = "latex",
    #linesep = c("", "", "\\addlinespace"), # Extra white space after every 3rd line to match age bands
    caption = "Count and prevalence of ADHD cases by age band in Chile school data with normal confidence intervals.")
```

```{r prevAgecatAutPlot, fig.cap = "Sample prevalence of autism in school data by age band. Bars show 95% normal confidence intervals.", fig.height = 3}
# Autism
aut_prev.agecat <- get_grouped_prev_plot(x = chile_bayes_aut, 
                                          grouping_vars = c("age_cat_name", "autism"),
                                          disease = "autism") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

ggplot(data = aut_prev.agecat) +
  geom_col(aes(x = age_cat_name, y = sample_prevalence*100, group = age_cat_name, fill = age_cat_name), position = position_dodge()) +
  geom_errorbar(aes(x = age_cat_name, ymin = ci_lower*100, ymax = ci_upper*100, group = age_cat_name), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_manual(values = c(plasma_colours[3], plasma_colours[5], plasma_colours[7], plasma_colours[9])) +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  labs(title = "Autism prevalence",
       x = "Age band",
       y = "Sample prevalence % (95% CI)",
       fill = "Age band")
```

```{r prevAgecatAdhdPlot, fig.cap = "Sample prevalence of ADHD in school data by age band. Bars show 95% normal confidence intervals.", fig.height = 3}
# ADHD
adhd_prev.agecat <- get_grouped_prev_plot(x = chile_bayes_adhd, 
                                          grouping_vars = c("age_cat_name", "adhd"),
                                          disease = "adhd") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

ggplot(data = adhd_prev.agecat) +
  geom_col(aes(x = age_cat_name, y = sample_prevalence*100, group = age_cat_name, fill = age_cat_name), position = position_dodge()) +
  geom_errorbar(aes(x = age_cat_name, ymin = ci_lower*100, ymax = ci_upper*100, group = age_cat_name), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_manual(values = c(plasma_colours[3], plasma_colours[5], plasma_colours[7], plasma_colours[9])) +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  labs(title = "ADHD prevalence",
       x = "Age band",
       y = "Sample prevalence % (95% CI)",
       fill = "Age band")
```

```{r adjPrevSex}
# Seperate sexes so that standardisation is correct
chile_stdpop_f <- chile_stdpop %>%
  filter(sex == 2) %>%
  mutate(pop_prop = std_pop / sum(std_pop))
chile_stdpop_m <- chile_stdpop %>%
  filter(sex == 1) %>%
  mutate(pop_prop = std_pop / sum(std_pop))

# Autism
aut_prev_f <- chile_bayes_aut %>%
  filter(sex == 2) %>%
  get_grouped_prev(stdpop = chile_stdpop_f, grouping_vars = c("age_june30", "sex", "autism"), disease = "autism")
aut_prev_adj_f <- get_adjusted_prev(aut_prev_f, grouping_vars = c()) %>% mutate(sex_desc = "Female") %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))

aut_prev_m <- chile_bayes_aut %>%
  filter(sex == 1) %>%
  get_grouped_prev(stdpop = chile_stdpop_m, grouping_vars = c("age_june30", "sex", "autism"), disease = "autism")
aut_prev_adj_m <- get_adjusted_prev(aut_prev_m, grouping_vars = c()) %>% mutate(sex_desc = "Male") %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))

aut_prev_sex_adj <- rbind(aut_prev_adj_m, aut_prev_adj_f) 

# ADHD
adhd_prev_f <- chile_bayes_adhd %>%
  filter(sex == 2) %>%
  get_grouped_prev(stdpop = chile_stdpop_f, grouping_vars = c("age_june30", "sex", "adhd"), disease = "adhd")
adhd_prev_adj_f <- get_adjusted_prev(adhd_prev_f, grouping_vars = c()) %>% mutate(sex_desc = "Female") %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))

adhd_prev_m <- chile_bayes_adhd %>%
  filter(sex == 1) %>%
  get_grouped_prev(stdpop = chile_stdpop_m, grouping_vars = c("age_june30", "sex", "adhd"), disease = "adhd")
adhd_prev_adj_m <- get_adjusted_prev(adhd_prev_m, grouping_vars = c()) %>% mutate(sex_desc = "Male") %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))

adhd_prev_sex_adj <- rbind(adhd_prev_adj_m, adhd_prev_adj_f) 

```

In the school data, autism prevalence is `r round(aut_prev_sex_adj$crude_rate[2] * 100, 2)`% (`r round(aut_prev_sex_adj$crude_ci_lower[2] * 100, 2)`-`r round(aut_prev_sex_adj$crude_ci_upper[2] * 100, 2)`%) for females and `r sprintf("%.2f", round(aut_prev_sex_adj$crude_rate[1] * 100, 2))`% (`r round(aut_prev_sex_adj$crude_ci_lower[1] * 100, 2)`-`r round(aut_prev_sex_adj$crude_ci_upper[1] * 100, 2)`%) for males, with male to female ratio of `r round(aut_prev_sex_adj$crude_rate[1] / aut_prev_sex_adj$crude_rate[2], 2)`, see Table \@ref(tab:prevAgecatSexAutTable) and Figure \@ref(fig:prevAgecatSexAutPlot). ADHD prevalence is `r round(adhd_prev_sex_adj$crude_rate[2] * 100, 2)`% (`r sprintf("%.2f", round(adhd_prev_sex_adj$crude_ci_lower[2] * 100, 2))`-`r round(adhd_prev_sex_adj$crude_ci_upper[2] * 100, 2)`%) for females and `r sprintf("%.2f", round(adhd_prev_sex_adj$crude_rate[1] * 100, 2))`% (`r round(adhd_prev_sex_adj$crude_ci_lower[1] * 100, 2)`-`r round(adhd_prev_sex_adj$crude_ci_upper[1] * 100, 2)`%) for males, with male to female ratio of `r round(adhd_prev_sex_adj$crude_rate[1] / adhd_prev_sex_adj$crude_rate[2], 2)` see Table \@ref(tab:prevAgecatSexAdhdTable) and Figure \@ref(fig:prevAgecatSexAdhdPlot). Autism and ADHD prevalences are higher in males than females for all ages, see also Supplementary Figures \@ref(fig:prevAgeSexAutPlot) and \@ref(fig:prevAgeSexAdhdPlot).

```{r prevAgecatSexAutTable}
# Autism
aut_prev.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_aut, 
                                          grouping_vars = c("age_cat_name", "sex_desc", "autism"),
                                          disease = "autism") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

aut_prev.agecat_sex.table <- aut_prev.agecat_sex %>% filter(sex_desc == "Female") %>%
  select(age_cat_name, n_disease, prev_ci) %>%
  cbind(aut_prev.agecat_sex %>% filter(sex_desc == "Male") %>% select(n_disease, prev_ci))

kbl(aut_prev.agecat_sex.table, 
    col.names = c("Age band", "Autism cases", "Prevalence % (95% CI)", "Autism cases", "Prevalence % (95% CI)"),
    align = "rrrrr",
    booktabs = TRUE,
    format = "latex",
    # linesep = c("", "", "\\addlinespace",
    #             "", "", "\\addlinespace",
    #             "", "", "\\addlinespace",
    #             "", "", "", "\\addlinespace"), # Extra white space after every 3rd line to match age bands
    caption = "Count and prevalence of autism cases by age band in Chile school data for females and males with normal confidence intervals.") %>%
  add_header_above(header = c(" " = 1, "Female" = 2, "Male" = 2))
```

```{r prevAgecatSexAdhdTable}
# ADHD
adhd_prev.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_adhd, 
                                          grouping_vars = c("age_cat_name", "sex_desc", "adhd"),
                                          disease = "adhd") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

adhd_prev.agecat_sex.table <- aut_prev.agecat_sex %>% filter(sex_desc == "Female") %>%
  select(age_cat_name, n_disease, prev_ci) %>%
  cbind(adhd_prev.agecat_sex %>% filter(sex_desc == "Male") %>% select(n_disease, prev_ci))

kbl(adhd_prev.agecat_sex.table, 
    col.names = c("Age band", "ADHD cases", "Prevalence % (95% CI)", "ADHD cases", "Prevalence % (95% CI)"),
    align = "rrrrr",
    booktabs = TRUE,
    format = "latex",
    # linesep = c("", "", "\\addlinespace",
    #             "", "", "\\addlinespace",
    #             "", "", "\\addlinespace",
    #             "", "", "", "\\addlinespace"), # Extra white space after every 3rd line to match age bands
    caption = "Count and prevalence of ADHD cases by age band in Chile school data for females and males with normal confidence intervals.") %>%
  add_header_above(c(" " = 1, "Female" = 2, "Male" = 2))
```

```{r prevAgecatSexAutPlot, fig.cap = "Sample prevalence of autism in school data by age band and sex. Bars show 95% normal confidence intervals.", fig.height = 3}
# Autism
aut_prev.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_aut, 
                                          grouping_vars = c("age_cat_name", "sex_desc", "autism"),
                                          disease = "autism") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

ggplot(data = aut_prev.agecat_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence*100, group = age_cat_name, fill = age_cat_name), position = position_dodge()) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower*100, ymax = ci_upper*100, group = age_cat_name), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_manual(values = c(plasma_colours[3], plasma_colours[5], plasma_colours[7], plasma_colours[9])) +
  labs(title = "Autism prevalence",
       x = "Sex",
       y = "Sample prevalence % (95% CI)",
       fill = "Age band")
```

```{r prevAgecatSexAdhdPlot, fig.cap = "Sample prevalence of ADHD in school data by age band and sex. Bars show 95% normal confidence intervals.", fig.height = 3}
# ADHD
adhd_prev.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_adhd, 
                                          grouping_vars = c("age_cat_name", "sex_desc", "adhd"),
                                          disease = "adhd") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

ggplot(data = adhd_prev.agecat_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence*100, group = age_cat_name, fill = age_cat_name), position = position_dodge()) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower*100, ymax = ci_upper*100, group = age_cat_name), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_manual(values = c(plasma_colours[3], plasma_colours[5], plasma_colours[7], plasma_colours[9])) +
  labs(title = "ADHD prevalence",
       x = "Sex",
       y = "Sample prevalence % (95% CI)",
       fill = "Age band")
```

```{r adjPrevHealth}
# Autism
aut_prev_health <- get_grouped_prev(x = chile_bayes_aut, stdpop = chile_stdpop, 
                                    grouping_vars = c("health_service_code", "age_june30", "age_cat_name", "sex", "sex_desc", "autism"),
                                    disease = "autism")

aut_prev_health_adj <- get_adjusted_prev(aut_prev_health, grouping_vars = "health_service_code") %>%
  merge(health_service_lookup, by = "health_service_code") %>%
  rename(health_service_name_long = health_service_name,
         health_service_name = health_service_name_short) %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))

# ADHD
adhd_prev_health <- get_grouped_prev(x = chile_bayes_adhd, stdpop = chile_stdpop, 
                                    grouping_vars = c("health_service_code", "age_june30", "age_cat_name", "sex", "sex_desc", "adhd"),
                                    disease = "adhd")

adhd_prev_health_adj <- get_adjusted_prev(adhd_prev_health, grouping_vars = "health_service_code") %>%
  merge(health_service_lookup, by = "health_service_code") %>%
  rename(health_service_name_long = health_service_name,
         health_service_name = health_service_name_short) %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))
```

Autism varies by health service, as shown in Table \@ref(tab:prevAgecatHealthAutTable), Figure \@ref(fig:prevAgecatHealthAutPlot) and Supplementary Figure \@ref(fig:prevAgeHealthAutPlot). Autism prevalence is highest in Ñuble at `r round(aut_prev_health_adj$crude_rate[29] * 100, 2)`% (`r round(aut_prev_health_adj$crude_ci_lower[29] * 100, 2)` - `r sprintf("%.2f", round(aut_prev_health_adj$crude_ci_upper[29] * 100, 2))`%) and Antofagasta at `r round(aut_prev_health_adj$crude_rate[3] * 100, 2)`% (`r round(aut_prev_health_adj$crude_ci_lower[3] * 100, 2)`- `r round(aut_prev_health_adj$crude_ci_upper[3] * 100, 2)`%), and is lowest in Metropolitano Norte at `r round(aut_prev_health_adj$crude_rate[19] * 100, 2)`% (`r round(aut_prev_health_adj$crude_ci_lower[19] * 100, 2)` - `r sprintf("%.2f", round(aut_prev_health_adj$crude_ci_upper[19] * 100, 2))`%) and Araucanía Norte at `r sprintf("%.2f", round(aut_prev_health_adj$crude_rate[4] * 100, 2))`% (`r round(aut_prev_health_adj$crude_ci_lower[4] * 100, 2)`- `r round(aut_prev_health_adj$crude_ci_upper[4] * 100, 2)`%). Autism peaks in the 6-8 age band across all services except Chiloé and Magallanes where it peaks in the 9-11 band.

ADHD prevalence also varies across health services, as shown in Table \@ref(tab:prevAgecatHealthAdhdTable), Figure \@ref(fig:prevAgecatHealthAdhdPlot) and Supplementary Figure \@ref(fig:prevAgeHealthAdhdPlot). ADHD prevalence is highest in Magallanes at `r round(adhd_prev_health_adj$crude_rate[17] * 100, 2)`% (`r round(adhd_prev_health_adj$crude_ci_lower[17] * 100, 2)` - `r sprintf("%.2f", round(adhd_prev_health_adj$crude_ci_upper[17] * 100, 2))`%) and Talcahuano at `r round(adhd_prev_health_adj$crude_rate[25] * 100, 2)`% (`r round(adhd_prev_health_adj$crude_ci_lower[25] * 100, 2)`- `r round(adhd_prev_health_adj$crude_ci_upper[25] * 100, 2)`%), and is lowest in Atacama at `r round(adhd_prev_health_adj$crude_rate[8] * 100, 2)`% (`r round(adhd_prev_health_adj$crude_ci_lower[8] * 100, 2)` - `r sprintf("%.2f", round(adhd_prev_health_adj$crude_ci_upper[8] * 100, 2))`%) and Antofagasta at `r sprintf("%.2f", round(adhd_prev_health_adj$crude_rate[3] * 100, 2))`% (`r round(adhd_prev_health_adj$crude_ci_lower[3] * 100, 2)`- `r round(adhd_prev_health_adj$crude_ci_upper[3] * 100, 2)`%). 

```{r prevAgecatHealthAutTable}
# Autism
aut_prev_health.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_aut,
                                                    grouping_vars = c("health_service_name", "age_cat_name", "sex_desc", "autism"),
                                                    disease = "autism") %>%
  arrange(age_cat_name)

aut_prev_health.agecat_sex.table <- aut_prev_health.agecat_sex %>% filter(sex_desc == "Female") %>%
  select(health_service_name, age_cat_name, n_disease, prev_ci) %>% 
  cbind(aut_prev_health.agecat_sex %>% filter(sex_desc == "Male") %>%  select(n_disease, prev_ci))

kbl(aut_prev_health.agecat_sex.table, 
  col.names = c("Health service", "Age band", "Autism cases", "Prevalence % (95% CI)", "Autism cases", "Prevalence % (95% CI)"),
  align = "lrrrrr",
  booktabs = TRUE,
  format = "latex",
  longtable = TRUE,
  linesep = c("", "", "", "", "",
              "", "", "", "", "",
              "", "", "", "", "",
              "", "", "", "", "",
              "", "", "", "", "",
              "", "", "", "\\addlinespace"), # Extra white space after every 29th line
  caption = "Count and prevalence of autism cases by health service and age band in Chile school data for females and males with normal confidence intervals.") %>%
  add_header_above(c(" " = 2, "Female" = 2, "Male" = 2)) %>% 
  kable_styling(latex_options = c("repeat_header"), font_size = 8)
```

```{r prevAgecatHealthAdhdTable}
# ADHD
adhd_prev_health.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_adhd, 
                                          grouping_vars = c("health_service_name", "age_cat_name", "sex_desc", "adhd"),
                                          disease = "adhd") %>%
  arrange(age_cat_name)

adhd_prev_health.agecat_sex.table <- adhd_prev_health.agecat_sex %>% filter(sex_desc == "Female") %>%
  select(health_service_name, age_cat_name, n_disease, prev_ci) %>% 
  cbind(adhd_prev_health.agecat_sex %>% filter(sex_desc == "Male") %>%  select(n_disease, prev_ci))

kbl(adhd_prev_health.agecat_sex.table, 
  col.names = c("Health service", "Age band", "ADHD cases", "Prevalence % (95% CI)", "ADHD cases", "Prevalence % (95% CI)"),
  align = "lrrrrr",
  booktabs = TRUE,
  format = "latex",
  longtable = TRUE,
  linesep = c("", "", "", "", "",
              "", "", "", "", "",
              "", "", "", "", "",
              "", "", "", "", "",
              "", "", "", "", "",
              "", "", "", "\\addlinespace"), # Extra white space after every 29th line
  caption = "Count and prevalence of ADHD cases by health service and age band in Chile school data for females and males with normal confidence intervals.") %>%
  add_header_above(c(" " = 2, "Female" = 2, "Male" = 2)) %>% 
  kable_styling(latex_options = c("repeat_header"), font_size = 8)

```

```{r prevAgecatHealthAutPlot, fig.cap = "Sample prevalence of autism in school data by health service, age band and sex. Bars show 95% normal confidence intervals.", fig.height = 10, fig.width = 8.5}
# Autism
aut_prev_health.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_aut, 
                                          grouping_vars = c("health_service_name" ,"age_cat_name", "sex_desc", "autism"),
                                          disease = "autism") %>%
  arrange(age_cat_name)

ggplot(data = aut_prev_health.agecat_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence*100, group = age_cat_name, fill = age_cat_name), position = "dodge") +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower*100, ymax = ci_upper*100, group = age_cat_name), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_manual(values = c(plasma_colours[3], plasma_colours[5], plasma_colours[7], plasma_colours[9])) +
  facet_wrap(~health_service_name) +
  labs(title = "Autism prevalence by health service",
       x = "Sex",
       y = "Sample prevalence (95% CI)",
       fill = "Age category")
```

```{r prevAgecatHealthAdhdPlot, fig.cap = "Sample prevalence of ADHD in school data by health service, age band and sex. Bars show 95% normal confidence intervals.", fig.height = 10, fig.width = 8.5}
# ADHD
adhd_prev_health.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_adhd, 
                                          grouping_vars = c("health_service_name", "age_cat_name", "sex_desc", "adhd"),
                                          disease = "adhd") %>%
  arrange(age_cat_name)

ggplot(data = adhd_prev_health.agecat_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence*100, group = age_cat_name, fill = age_cat_name), position = position_dodge()) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower*100, ymax = ci_upper*100, group = age_cat_name), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_manual(values = c(plasma_colours[3], plasma_colours[5], plasma_colours[7], plasma_colours[9])) +
  facet_wrap(~health_service_name) +
  labs(title = "ADHD prevalence by health service",
       x = "Sex",
       y = "Sample prevalence % (95% CI)",
       fill = "Age band")

```

```{r adjPrevEconA}
# Autism
aut_prev_econA <- get_grouped_prev(x = chile_bayes_aut, stdpop = chile_stdpop, 
                                    grouping_vars = c("school_fee", "age_june30", "age_cat_name", "sex", "sex_desc", "autism"),
                                    disease = "autism")

aut_prev_econA_adj <- get_adjusted_prev(aut_prev_econA, grouping_vars = "school_fee") %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))

# ADHD
adhd_prev_econA <- get_grouped_prev(x = chile_bayes_adhd, stdpop = chile_stdpop, 
                                    grouping_vars = c("school_fee", "age_june30", "age_cat_name", "sex", "sex_desc", "adhd"),
                                    disease = "adhd")

adhd_prev_econA_adj <- get_adjusted_prev(adhd_prev_econA, grouping_vars = "school_fee")  %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))
```

For school fees, which are used here as a proxy for SES, autism prevalence is highest among students that receive free or low fee education, though the sample size for students that pay \$1,000-\$10,000 monthly is very small, see Table \@ref(tab:prevAgecatEconAAutTable), Figure \@ref(fig:prevAgecatEconAAutPlot) and Supplementary Figure \@ref(fig:prevAgeEconAAutPlot). ADHD prevalence is more consistent across school fee levels, except for the  \$1,000-\$10,000 band which has low prevalence and very few cases, see Table \@ref(tab:prevAgecatEconAAdhdTable), Figure \@ref(fig:prevAgecatEconAAdhdPlot) and Supplementary Figure \@ref(fig:prevAgeEconAAdhdPlot). Prevalence is higher among older students for higher fee bands. For both autism and ADHD, prevalence is very low among students paying more than \$100,000 monthly, suggesting students from wealthier families may not be accessing SEED or may not be eligible for it due to attending private schools.

```{r prevAgecatEconAAutTable}
# Autism
aut_prev_econA.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_aut,
                                                    grouping_vars = c("school_fee", "age_cat_name", "sex_desc", "autism"),
                                                    disease = "autism") %>%
  arrange(age_cat_name)

aut_prev_econA.agecat_sex.table <- aut_prev_econA.agecat_sex %>% filter(sex_desc == "Female") %>%
  select(school_fee, age_cat_name, n_disease, prev_ci) %>% 
  cbind(aut_prev_econA.agecat_sex %>% filter(sex_desc == "Male") %>%  select(n_disease, prev_ci))

kbl(aut_prev_econA.agecat_sex.table, 
  col.names = c("School fee", "Age band", "Autism cases", "Prevalence % (95% CI)", "Autism cases", "Prevalence % (95% CI)"),
  align = "lrrrrr",
  booktabs = TRUE,
  format = "latex",
  #longtable = TRUE,
  linesep = c("", "", "", "", "", "", "\\addlinespace"), # Extra white space after every 7th line
  caption = "Count and prevalence of Autism cases by school fee and age band in Chile school data for females and males with normal confidence intervals.") %>%
  add_header_above(c(" " = 2, "Female" = 2, "Male" = 2)) 
```

```{r prevAgecatEconAAdhdTable}
# Autism
adhd_prev_econA.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_adhd,
                                                    grouping_vars = c("school_fee", "age_cat_name", "sex_desc", "adhd"),
                                                    disease = "adhd") %>%
  arrange(age_cat_name)

adhd_prev_econA.agecat_sex.table <- adhd_prev_econA.agecat_sex %>% filter(sex_desc == "Female") %>%
  select(school_fee, age_cat_name, n_disease, prev_ci) %>% 
  cbind(adhd_prev_econA.agecat_sex %>% filter(sex_desc == "Male") %>%  select(n_disease, prev_ci))

kbl(adhd_prev_econA.agecat_sex.table, 
  col.names = c("School fee", "Age band", "ADHD cases", "Prevalence % (95% CI)", "ADHD cases", "Prevalence % (95% CI)"),
  align = "lrrrrr",
  booktabs = TRUE,
  format = "latex",
  #longtable = TRUE,
  linesep = c("", "", "", "", "", "", "\\addlinespace"), # Extra white space after every 7th line
  caption = "Count and prevalence of ADHD cases by school fee and age band in Chile school data for females and males with normal confidence intervals.") %>%
add_header_above(c(" " = 2, "Female" = 2, "Male" = 2))
```

```{r prevAgecatEconAAutPlot, fig.cap = "Sample prevalence of autism in school data by student's monthly school fee (Peso), age band and sex. Bars show 95% normal confidence intervals.", fig.height=6}
# Autism
aut_prev_econA.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_aut,
                                                    grouping_vars = c("school_fee", "age_cat_name", "sex_desc", "autism"),
                                                    disease = "autism") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

ggplot(data = aut_prev_econA.agecat_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence*100, group = age_cat_name, fill = age_cat_name), position = "dodge") +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower*100, ymax = ci_upper*100, group = age_cat_name), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_manual(values = c(plasma_colours[3], plasma_colours[5], plasma_colours[7], plasma_colours[9])) +
  facet_wrap(~school_fee) +
  labs(title = "Autism prevalence by school fee",
       x = "Sex",
       y = "Sample prevalence % (95% CI)",
       fill = "Age category")
```

```{r prevAgecatEconAAdhdPlot, fig.cap = "Sample prevalence of ADHD in school data by student's monthly school fee (Peso), age band and sex. Bars show 95% normal confidence intervals.", fig.height=6}
# ADHD
adhd_prev_econA.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_adhd,
                                                    grouping_vars = c("school_fee", "age_cat_name", "sex_desc", "adhd"),
                                                    disease = "adhd") %>%
  arrange(age_cat_name)

ggplot(data = adhd_prev_econA.agecat_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence*100, group = age_cat_name, fill = age_cat_name), position = "dodge") +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower*100, ymax = ci_upper*100, group = age_cat_name), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_manual(values = c(plasma_colours[3], plasma_colours[5], plasma_colours[7], plasma_colours[9])) +
  facet_wrap(~school_fee) +
  labs(title = "ADHD prevalence by school fee",
       x = "Sex",
       y = "Sample prevalence % (95% CI)",
       fill = "Age category")
```

```{r adjPrevEthnic}
# Autism
aut_prev_ethnic <- get_grouped_prev(x = chile_bayes_aut_ethnic, stdpop = chile_stdpop, 
                                    grouping_vars = c("ethnic_2_group", "age_june30", "age_cat_name", "sex", "sex_desc", "autism"),
                                    disease = "autism")

aut_prev_ethnic_adj <- get_adjusted_prev(aut_prev_ethnic, grouping_vars = "ethnic_2_group") %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))

# ADHD
adhd_prev_ethnic <- get_grouped_prev(x = chile_bayes_adhd_ethnic, stdpop = chile_stdpop, 
                                    grouping_vars = c("ethnic_2_group", "age_june30", "age_cat_name", "sex", "sex_desc", "adhd"),
                                    disease = "adhd")

adhd_prev_ethnic_adj <- get_adjusted_prev(adhd_prev_ethnic, grouping_vars = "ethnic_2_group")  %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))
```

Autism prevalence and distribution by age is very similar between Mapuche and non-Indigenous students in the Araucanía, Aysén, Biobío, Los Lagos, Los Rios, Magallanes and Región Metropolitana de Santiago regions, as shown in Table \@ref(tab:prevAgecatEthnicAutTable), Figure \@ref(fig:prevAgecatEthnicAutPlot) and Supplementary Figure \@ref(fig:prevAgeEthnicAutPlot). ADHD prevalence is also consistent across Mapuche and non-Indigenous students, see Table \@ref(tab:prevAgecatEthnicAdhdTable), Figure \@ref(fig:prevAgecatEthnicAdhdPlot) and Supplementary Figure \@ref(fig:prevAgeEthnicAdhdPlot). Among students of other Indigenous groups, autism and ADHD prevalence appear to peak in older age groups, however this result is based on very few cases. 

```{r prevAgecatEthnicAutTable}
# Autism
aut_prev_ethnic.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_aut_ethnic,
                                                    grouping_vars = c("ethnic_2_group", "age_cat_name", "sex_desc", "autism"),
                                                    disease = "autism") %>%
  arrange(age_cat_name)

aut_prev_ethnic.agecat_sex.table <- aut_prev_ethnic.agecat_sex %>% filter(sex_desc == "Female") %>%
  select(ethnic_2_group, age_cat_name, n_disease, prev_ci) %>% 
  cbind(aut_prev_ethnic.agecat_sex %>% filter(sex_desc == "Male") %>%  select(n_disease, prev_ci))

kbl(aut_prev_ethnic.agecat_sex.table, 
  col.names = c("Ethnicity", "Age band", "Autism cases", "Prevalence % (95% CI)", "Autism cases", "Prevalence % (95% CI)"),
  align = "lrrrrr",
  booktabs = TRUE,
  format = "latex",
  #longtable = TRUE,
  linesep = c("", "", "\\addlinespace"), # Extra white space after every 3rd line
  caption = "Count and prevalence of Autism cases by ethnicity and age band in Chile school data for females and males with normal confidence intervals. Regions with high Mapuche populations only.") %>%
  add_header_above(c(" " = 2, "Female" = 2, "Male" = 2)) %>% 
  kable_styling(font_size = 8)
```

```{r prevAgecatEthnicAdhdTable}
# Autism
adhd_prev_ethnic.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_adhd_ethnic,
                                                    grouping_vars = c("ethnic_2_group", "age_cat_name", "sex_desc", "adhd"),
                                                    disease = "adhd") %>%
  arrange(age_cat_name)

adhd_prev_ethnic.agecat_sex.table <- adhd_prev_ethnic.agecat_sex %>% filter(sex_desc == "Female") %>%
  select(ethnic_2_group, age_cat_name, n_disease, prev_ci) %>% 
  cbind(adhd_prev_ethnic.agecat_sex %>% filter(sex_desc == "Male") %>%  select(n_disease, prev_ci))

kbl(adhd_prev_ethnic.agecat_sex.table, 
  col.names = c("Ethnicity", "Age band", "ADHD cases", "Prevalence % (95% CI)", "ADHD cases", "Prevalence % (95% CI)"),
  align = "lrrrrr",
  booktabs = TRUE,
  format = "latex",
  #longtable = TRUE,
  linesep = c("", "", "\\addlinespace"), # Extra white space after every 3rd line
  caption = "Count and prevalence of ADHD cases by ethnicity and age band in Chile school data for females and males with normal confidence intervals. Regions with high Mapuche populations only.") %>%
add_header_above(c(" " = 2, "Female" = 2, "Male" = 2)) %>% 
  kable_styling(font_size = 8)
```

```{r prevAgecatEthnicAutPlot, fig.cap = "Sample prevalence of autism in school data by ethnicity, age band and sex. Bars show 95% normal confidence intervals. Regions with high Mapuche populations only.", fig.height=3}
# Autism
aut_prev_ethnic.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_aut_ethnic,
                                                    grouping_vars = c("ethnic_2_group", "age_cat_name", "sex_desc", "autism"),
                                                    disease = "autism") %>%
  arrange(age_cat_name)

ggplot(data = aut_prev_ethnic.agecat_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence*100, group = age_cat_name, fill = age_cat_name), position = "dodge") +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower*100, ymax = ci_upper*100, group = age_cat_name), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_manual(values = c(plasma_colours[3], plasma_colours[5], plasma_colours[7], plasma_colours[9])) +
  facet_wrap(~ethnic_2_group) +
  labs(title = "Autism prevalence by ethnicity",
       x = "Sex",
       y = "Sample prevalence % (95% CI)",
       fill = "Age category")
```


```{r prevAgecatEthnicAdhdPlot, fig.cap = "Sample prevalence of ADHD in school data by ethnicity, age band and sex. Bars show 95% normal confidence intervals. Regions with high Mapuche populations only.", fig.height=3}
# ADHD
adhd_prev_ethnic.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_adhd_ethnic,
                                                    grouping_vars = c("ethnic_2_group", "age_cat_name", "sex_desc", "adhd"),
                                                    disease = "adhd") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

ggplot(data = adhd_prev_ethnic.agecat_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence*100, group = age_cat_name, fill = age_cat_name), position = "dodge") +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower*100, ymax = ci_upper*100, group = age_cat_name), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_manual(values = c(plasma_colours[3], plasma_colours[5], plasma_colours[7], plasma_colours[9])) +
  facet_wrap(~ethnic_2_group) +
  labs(title = "ADHD prevalence by ethnicity",
       x = "Sex",
       y = "Sample prevalence % (95% CI)",
       fill = "Age category")
```


```{r adjPrevRurality}
# Autism
aut_prev_rural <- get_grouped_prev(x = chile_bayes_aut, stdpop = chile_stdpop, 
                                    grouping_vars = c("school_rurality", "age_june30", "age_cat_name", "sex", "sex_desc", "autism"),
                                    disease = "autism")

aut_prev_rural_adj <- get_adjusted_prev(aut_prev_rural, grouping_vars = "school_rurality") %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))

# ADHD
adhd_prev_rural <- get_grouped_prev(x = chile_bayes_adhd, stdpop = chile_stdpop, 
                                    grouping_vars = c("school_rurality", "age_june30", "age_cat_name", "sex", "sex_desc", "adhd"),
                                    disease = "adhd")

adhd_prev_rural_adj <- get_adjusted_prev(adhd_prev_rural, grouping_vars = "school_rurality")  %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))
```

Autism and ADHD are slightly more prevalent for students at rural schools and both follow the same age patterns observed earlier. See Tables \@ref(tab:prevAgecatRuralAutTable) and \@ref(tab:prevAgecatRuralAdhdTable), Figures \@ref(fig:prevAgecatRuralAutPlot) and \@ref(fig:prevAgecatRuralAdhdPlot) and Supplementary Figures \@ref(fig:prevAgeRuralAutPlot) and \@ref(fig:prevAgeRuralAdhdPlot).

```{r prevAgecatRuralAutTable}
# Autism
aut_prev_rural.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_aut,
                                                    grouping_vars = c("school_rurality", "age_cat_name", "sex_desc", "autism"),
                                                    disease = "autism") %>%
  arrange(age_cat_name)

aut_prev_rural.agecat_sex.table <- aut_prev_rural.agecat_sex %>% filter(sex_desc == "Female") %>%
  select(school_rurality, age_cat_name, n_disease, prev_ci) %>% 
  cbind(aut_prev_rural.agecat_sex %>% filter(sex_desc == "Male") %>%  select(n_disease, prev_ci))

kbl(aut_prev_rural.agecat_sex.table, 
  col.names = c("School rurality", "Age band", "Autism cases", "Prevalence % (95% CI)", "Autism cases", "Prevalence % (95% CI)"),
  align = "lrrrrr",
  booktabs = TRUE,
  format = "latex",
  #longtable = TRUE,
  linesep = c("", "\\addlinespace"), # Extra white space after every 2nd line
  caption = "Count and prevalence of Autism cases by school's rurality and age band in Chile school data for females and males with normal confidence intervals.") %>%
  add_header_above(c(" " = 2, "Female" = 2, "Male" = 2))
```

```{r prevAgecatRuralAdhdTable}
# Autism
adhd_prev_rural.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_adhd,
                                                    grouping_vars = c("school_rurality", "age_cat_name", "sex_desc", "adhd"),
                                                    disease = "adhd") %>%
  arrange(age_cat_name)

adhd_prev_rural.agecat_sex.table <- adhd_prev_rural.agecat_sex %>% filter(sex_desc == "Female") %>%
  select(school_rurality, age_cat_name, n_disease, prev_ci) %>% 
  cbind(adhd_prev_rural.agecat_sex %>% filter(sex_desc == "Male") %>%  select(n_disease, prev_ci))

kbl(adhd_prev_rural.agecat_sex.table, 
  col.names = c("School rurality", "Age band", "ADHD cases", "Prevalence % (95% CI)", "ADHD cases", "Prevalence % (95% CI)"),
  align = "lrrrrr",
  booktabs = TRUE,
  format = "latex",
  #longtable = TRUE,
  linesep = c("", "\\addlinespace"), # Extra white space after every 2nd line
  caption = "Count and prevalence of ADHD cases by school's rurality and age band in Chile school data for females and males with normal confidence intervals.") %>%
add_header_above(c(" " = 2, "Female" = 2, "Male" = 2))
```

```{r prevAgecatRuralAutPlot, fig.cap = "Sample prevalence of autism in school data by school's rurality, age band and sex. Bars show 95% normal confidence intervals.", fig.height=3}
# Autism
aut_prev_rural.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_aut,
                                                    grouping_vars = c("school_rurality", "age_cat_name", "sex_desc", "autism"),
                                                    disease = "autism") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

ggplot(data = aut_prev_rural.agecat_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence*100, group = age_cat_name, fill = age_cat_name), position = "dodge") +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower*100, ymax = ci_upper*100, group = age_cat_name), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_manual(values = c(plasma_colours[3], plasma_colours[5], plasma_colours[7], plasma_colours[9])) +
  facet_wrap(~school_rurality) +
  labs(title = "Autism prevalence by school's rurality",
       x = "Sex",
       y = "Sample prevalence % (95% CI)",
       fill = "Age category")
```

```{r prevAgecatRuralAdhdPlot, fig.cap="Sample prevalence of ADHD in school data by school's rurality, age band and sex. Bars show 95% normal confidence intervals.", fig.height=3}
# By age and sex
# Age categories
adhd_prev_rural.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_adhd,
                                                    grouping_vars = c("school_rurality", "age_cat_name", "sex_desc", "adhd"),
                                                    disease = "adhd") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

ggplot(data = adhd_prev_rural.agecat_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence*100, group = age_cat_name, fill = age_cat_name), position = "dodge") +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower*100, ymax = ci_upper*100, group = age_cat_name), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_manual(values = c(plasma_colours[3], plasma_colours[5], plasma_colours[7], plasma_colours[9])) +
  facet_wrap(~school_rurality) +
  labs(title = "ADHD prevalence by school's rurality",
       x = "Sex",
       y = "Sample prevalence % (95% CI)",
       fill = "Age category")
```

## Frequentist prevalence estimation

After using frequentist methods to adjust for the age and sex distribution of the child population of Chile in 2021, the adjusted prevalence of autism was `r round(aut_prev_adj$adjusted_rate * 100, 2)`% (`r round(aut_prev_adj$adjusted_ci_lower * 100, 2)`-`r round(aut_prev_adj$adjusted_ci_upper * 100, 2)`%) and the adjusted prevalence of ADHD was `r sprintf("%.2f", round(adhd_prev_adj$adjusted_rate * 100, 2))`% (`r sprintf("%.2f", round(adhd_prev_adj$adjusted_ci_lower * 100, 2))`-`r round(adhd_prev_adj$adjusted_ci_upper * 100, 2)`%). Among females, the adjusted prevalence of autism was `r round(aut_prev_sex_adj$adjusted_rate[2] * 100, 2)`% (`r round(aut_prev_sex_adj$adjusted_ci_lower[2] * 100, 2)`-`r round(aut_prev_sex_adj$adjusted_ci_upper[2] * 100, 2)`%) and among males it was `r round(aut_prev_sex_adj$adjusted_rate[1] * 100, 2)`% (`r round(aut_prev_sex_adj$adjusted_ci_lower[1] * 100, 2)`-`r sprintf("%.2f", round(aut_prev_sex_adj$adjusted_ci_upper[1] * 100, 2))`%). Among females, the adjusted prevalence of ADHD was `r sprintf("%.2f", round(adhd_prev_sex_adj$adjusted_rate[2] * 100, 2))`% (`r sprintf("%.2f", round(adhd_prev_sex_adj$adjusted_ci_lower[2] * 100, 2))`-`r round(adhd_prev_sex_adj$adjusted_ci_upper[2] * 100, 2)`%) and among males it was `r sprintf("%.2f", round(adhd_prev_sex_adj$adjusted_rate[1] * 100, 2))`% (`r sprintf("%.2f", round(adhd_prev_sex_adj$adjusted_ci_lower[1] * 100, 2))`-`r round(adhd_prev_sex_adj$adjusted_ci_upper[1] * 100, 2)`%). This gives male to female ratio of `r sprintf("%.2f", round(aut_prev_sex_adj$adjusted_rate[1] / aut_prev_sex_adj$adjusted_rate[2], 2))` As we know the prevalences of autism and ADHD in this data are likely to be underestimates, the age- and sex-adjusted prevalences can be considered a lower bound on the true prevalence of autism and of ADHD in Chile. 

Considering school data by health service, shown in Table \@ref(tab:adjPrevHealthAutTable), the adjusted prevalence of autism is significantly higher in Ñuble at `r round(aut_prev_health_adj$adjusted_rate[29] * 100, 2)`% (`r round(aut_prev_health_adj$adjusted_ci_lower[29] * 100, 2)` - `r round(aut_prev_health_adj$adjusted_ci_upper[29] * 100, 2)`%) than other health services with non-overlapping confidence intervals. Prevalence is low but not signficantly so in rural areas such as Araucanía, and in the Metropolitano health services which serve Santiago, Chile's largest city. Adjusted ADHD prevalence, shown in Table \@ref(tab:adjPrevHealthAdhdTable), is medial for Metropolitano health services and very low for Atacama, a fairly urbanised region, at `r round(adhd_prev_health_adj$adjusted_rate[8] * 100, 2)`% (`r round(adhd_prev_health_adj$adjusted_ci_lower[8] * 100, 2)` - `r round(adhd_prev_health_adj$adjusted_ci_upper[8] * 100, 2)`%).

```{r adjPrevHealthAutTable}
aut_prev_health_adj.table <- aut_prev_health_adj %>% 
  select(health_service_name, crude_prev_ci, adjusted_prev_ci)
kbl(aut_prev_health_adj.table,
    col.names = c("Health service", "Crude prevalence (95% CI)", "Adjusted prevalence (95% CI)"),
    align = "lrr",
    booktabs = TRUE,
    format = "pandoc",
    linesep = c(""), # No extra white space
    caption = "Crude and age- and sex-adjusted autism prevalence by health service in Chile school data. Crude prevalence has 95% normal confidence intervals and adjusted prevalence has 95% gamma confidence intervals.")
```

```{r adjPrevHealthAdhdTable}
adhd_prev_health_adj.table <- adhd_prev_health_adj %>% 
  select(health_service_name, crude_prev_ci, adjusted_prev_ci)
kbl(adhd_prev_health_adj.table,
    col.names = c("Health service", "Crude prevalence (95% CI)", "Adjusted prevalence (95% CI)"),
    align = "lrr",
    booktabs = TRUE,
    format = "pandoc",
    linesep = c(""), # No extra white space
    caption = "Crude and age- and sex-adjusted ADHD prevalence by health service in Chile school data. Crude prevalence has 95% normal confidence intervals and adjusted prevalence has 95% gamma confidence intervals.")
```

For both autism and ADHD, adjusted prevalences by school fees, ethnicity and school's rurality show similar patterns to crude prevalences, except for students at rural schools which have notably lower adjusted prevalence for both conditions. See tables \@ref(tab:adjPrevEconAAutTable) - \@ref(tab:adjPrevRuralAdhdTable). These results indicate that for autism and ADHD there are differences in prevalence across location and demographic features.

```{r adjPrevEconAAutTable}
aut_prev_econA_adj.table <- aut_prev_econA_adj %>% 
  select(school_fee, crude_prev_ci, adjusted_prev_ci)
kbl(aut_prev_econA_adj.table,
    col.names = c("School fee", "Crude prevalence (95% CI)", "Adjusted prevalence (95% CI)"),
    align = "lrr",
    booktabs = TRUE,
    format = "pandoc",
    linesep = c(""), # No extra white space
    caption = "Crude and age- and sex-adjusted autism prevalence by monthly school fee (Peso) in Chile school data. Crude prevalence has 95% normal confidence intervals and adjusted prevalence has 95% gamma confidence intervals.")
```

```{r adjPrevEconAAdhdTable}
adhd_prev_econA_adj.table <- adhd_prev_econA_adj %>% 
  select(school_fee, crude_prev_ci, adjusted_prev_ci)
kbl(adhd_prev_econA_adj.table,
    col.names = c("School fee", "Crude prevalence (95% CI)", "Adjusted prevalence (95% CI)"),
    align = "lrr",
    booktabs = TRUE,
    format = "pandoc",
    linesep = c(""), # No extra white space
    caption = "Crude and age- and sex-adjusted ADHD prevalence by monthly school fee (Peso) in Chile school data. Crude prevalence has 95% normal confidence intervals and adjusted prevalence has 95% gamma confidence intervals.")
```

```{r adjPrevEthnicAutTable}
aut_prev_ethnic_adj.table <- aut_prev_ethnic_adj %>% 
  select(ethnic_2_group, crude_prev_ci, adjusted_prev_ci)
kbl(aut_prev_ethnic_adj.table,
    col.names = c("Ethnicity", "Crude prevalence (95% CI)", "Adjusted prevalence (95% CI)"),
    align = "lrr",
    booktabs = TRUE,
    format = "pandoc",
    linesep = c(""), # No extra white space
    caption = "Crude and age- and sex-adjusted autism prevalence by ethnicity in Chile school data. Crude prevalence has 95% normal confidence intervals and adjusted prevalence has 95% gamma confidence intervals.")
```

```{r adjPrevEthnicAdhdTable}
adhd_prev_ethnic_adj.table <- adhd_prev_ethnic_adj %>% 
  select(ethnic_2_group, crude_prev_ci, adjusted_prev_ci)
kbl(adhd_prev_ethnic_adj.table,
    col.names = c("Ethnicity", "Crude prevalence (95% CI)", "Adjusted prevalence (95% CI)"),
    align = "lrr",
    booktabs = TRUE,
    format = "pandoc",
    linesep = c(""), # No extra white space
    caption = "Crude and age- and sex-adjusted ADHD prevalence by ethnicity in Chile school data. Crude prevalence has 95% normal confidence intervals and adjusted prevalence has 95% gamma confidence intervals.")
```

```{r adjPrevRuralAutTable}
aut_prev_rural_adj.table <- aut_prev_rural_adj %>% 
  select(school_rurality, crude_prev_ci, adjusted_prev_ci)
kbl(aut_prev_rural_adj.table,
    col.names = c("School rurality", "Crude prevalence (95% CI)", "Adjusted prevalence (95% CI)"),
    align = "lrr",
    booktabs = TRUE,
    format = "pandoc",
    linesep = c(""), # NO extra white space
    caption = "Crude and age- and sex-adjusted autism prevalence by school's rurality in Chile school data. Crude prevalence has 95% normal confidence intervals and adjusted prevalence has 95% gamma confidence intervals.")
```

```{r adjPrevRuralAdhdTable}
adhd_prev_rural_adj.table <- adhd_prev_rural_adj %>% 
  select(school_rurality, crude_prev_ci, adjusted_prev_ci)
kbl(adhd_prev_rural_adj.table,
    col.names = c("School rurality", "Crude prevalence (95% CI)", "Adjusted prevalence (95% CI)"),
    align = "lrr",
    booktabs = TRUE,
    format = "pandoc",
    linesep = c(""), # No extra white space
    caption = "Crude and age- and sex-adjusted ADHD prevalence by school's rurality in Chile school data. Crude prevalence has 95% normal confidence intervals and adjusted prevalence has 95% gamma confidence intervals.")

```

## Clinical data

```{r mcaPatientsSmall}
patients_mca_small <- clinical_small_raw %>% 
  rename("rurality" = "procedence",
         "dob" = "fecha_nacimiento",
         "apt_date" = "fecha_ejecutada",
         "type_appointment" = "appoinment") %>%
  mutate(gender = str_to_title(gender),
         autism = ifelse(cod_dg_1 %in% aut_codes | 
                           cod_dg_2 %in% aut_codes | 
                           cod_dg_3 %in% aut_codes, "Yes autism", "No autism"),
         aut_rank = ifelse(cod_dg_1 %in% aut_codes, 1,
                    ifelse(cod_dg_2 %in% aut_codes, 2,
                    ifelse(cod_dg_3 %in% aut_codes, 3, NA))),
         intdisab = ifelse(cod_dg_1 %in% intdisab_codes | 
                           cod_dg_2 %in% intdisab_codes | 
                           cod_dg_3 %in% intdisab_codes, "Yes intellectual disability", "No intellectual disability"),
         age_june30 = trunc(time_length(interval(ymd(dob), ymd("2021-06-30")), unit = "year")),
         commune_name_upper = ifelse(comuna == "CHOL CHOL", "CHOLCHOL",
                        ifelse(comuna == "CURACAUTIN", "CURACAUTÍN", 
                        ifelse(comuna == "PITRUFQUEN", "PITRUFQUÉN", 
                        ifelse(comuna == "PUCON", "PUCÓN", 
                        ifelse(comuna == "TOLTEN", "TOLTÉN", 
                        ifelse(comuna == "VILCUN", "VILCÚN", 
                        ifelse(comuna == "DIEGO DE ALMAGRO  (#)", "DIEGO DE ALMAGRO",
                        ifelse(comuna == "MACHALI", "MACHALÍ",
                        ifelse(comuna == "TEMUCO (##)", "TEMUCO", comuna))))))))),
         ses_status = ifelse(socio_economic_level %in% c("COLMENA GOLDEN CROSS", "RIO BLANCO", "CARABINEROS (DIPRECA)", "BANMEDICA S.A.", "PARTICULAR (SIN PREVISION)", "VIDA TRES"), "Private Health Insurance", socio_economic_level),
         rurality = ifelse(rurality == "URBAN", "Urban", "Rural"),
         ethnicity = ifelse(ethnicity == "CHILENO", "Chilean",
                     ifelse(ethnicity == "MAPUCHE", "Mapuche",
                     ifelse(ethnicity == "EXTRANJERO", "Foreign", "No ethnicity information"))),
         ethnicity = ifelse(is.na(ethnicity), "No ethnicity information", ethnicity), # for some reason the NA fix doesn't work in preceding line
         disability = ifelse(is.na(disability), "No disability information", disability),
         foster_care = ifelse(is.na(foster_care), "No foster care information", foster_care),
         medical_specialty_english = ifelse(medical_specialty == "Physiatry", "Psychiatry",
                                     ifelse(medical_specialty == "PEDIATRIA", "Paediatrics",
                                     ifelse(medical_specialty == "PSIQUIATRIA", "Psychiatry",
                                     ifelse(medical_specialty == "NEUROLOGIA", "Neurology", medical_specialty)))),
         medical_specialty_grouped = ifelse(medical_specialty_english %in% c("Psychiatry", "Child Psychiatry"), "Psychiatry",
                                     ifelse(medical_specialty_english %in% c("Neurology", "Pediatric Neurology"), "Neurology",
                                     ifelse(medical_specialty_english == "Paediatrics", "Paediatrics", "Other specialty"))),
         ) %>%
  left_join(region_service_commune_lookup, by = "commune_name_upper") %>%
  filter(commune_name %in% araucsur_communes$commune_name,
         autism == "Yes autism") %>%
  group_by(id, gender, age_june30) %>%
  summarise(ses_status = get.mode.na(ses_status), # Fortunately the available values are in alphabetical order by status
            autism = get.max.na(autism),
            intdisab = get.max.na(intdisab),
            medical_specialty_grouped = get.mode.na(medical_specialty_grouped), # Most common medical specialty across visits
            hospital = hospital[which.max(apt_date)], # most recent hospital
            commune_name = commune_name[which.max(apt_date)],
            rurality = rurality[which.max(apt_date)],
            ethnicity = get.mapuche.ethnicity(ethnicity),
            disability = get.yes.disability(disability),
            foster_care = get.yes.fostercare(foster_care)
            ) %>%
  ungroup() %>% 
  rename("sex_desc" = "gender",
         "age" = "age_june30") %>%
  mutate(sex_desc = as.factor(sex_desc),
         age_group = factor(ifelse(age <= 2, "Age 0-2", 
                            ifelse(age >= 3 & age <= 5, "Age 3-5",
                            ifelse(age >=6 & age <= 8, "Age 6-8", 
                            ifelse(age >=9 & age <=11, "Age 9-11", 
                            ifelse(age >=12 & age <= 14, "Age 12-14", 
                            ifelse(age >= 15 & age <= 18, "Age 15-18", "Adult")))))),
                            levels = c("Age 0-2", "Age 3-5", "Age 6-8", "Age 9-11", "Age 12-14", "Age 15-18", "Adult")), 
                            # Shouldn't be any adults in this dataset
         age = as.factor(age),
         commune_name = as.factor(commune_name),
         ses_status = as.factor(ses_status),
         rurality = as.factor(rurality),
         ethnicity = factor(ethnicity, levels = c("Mapuche", "Chilean", "Foreign", "No ethnicity information")),
         disability_imp = as.factor(ifelse(disability == "No disability information", "No disability", disability)),
         disability = factor(disability, levels = c("Yes disability", "No disability", "No disability information")),
         foster_care_imp = as.factor(ifelse(foster_care == "No foster care information", "No foster care", foster_care)),
         foster_care = factor(foster_care, levels = c("Yes foster care", "No foster care", "No foster care information")),
         autism = factor(autism, levels = c("Yes autism", "No autism")),
         intdisab = factor(intdisab, levels = c("Yes intellectual disability", "No intellectual disability")),
         medical_specialty_grouped = as.factor(medical_specialty_grouped),
         hospital = as.factor(hospital))
```

The small clinical dataset has data on `r format(nrow(clinical_small), big.mark = ",", trim = TRUE)` appointments for `r length(unique(clinical_small$id))` unique patients aged 1-18 in 2021, of which `r patients_mca_small %>% nrow()` patients have autism and have lived in a commune in the SSAS catchment area during the period the data covers. Among the patients with autism that live in SSAS, `r patients_mca_small %>% filter(sex_desc == "Female") %>% nrow` (`r round(patients_mca_small %>% filter(sex_desc == "Female") %>% nrow / nrow(patients_mca_small) * 100, 2)`%) are female, `r patients_mca_small %>% filter(ethnicity == "Mapuche") %>% nrow` (`r round(patients_mca_small %>% filter(ethnicity == "Mapuche") %>% nrow / nrow(patients_mca_small) * 100, 2)`%) are Mapuche, `r patients_mca_small %>% filter(rurality == "Urban") %>% nrow` (`r round(patients_mca_small %>% filter(rurality == "Urban") %>% nrow / nrow(patients_mca_small) * 100, 2)`%) live in an urban area, `r patients_mca_small %>% filter(disability == "Yes disability") %>% nrow` (`r round(patients_mca_small %>% filter(disability == "Yes disability") %>% nrow / nrow(patients_mca_small) * 100, 2)`%) have a disability and `r patients_mca_small %>% filter(foster_care == "Yes foster care") %>% nrow` (`r round(patients_mca_small %>% filter(foster_care == "Yes foster care") %>% nrow / nrow(patients_mca_small) * 100, 2)`%) have experienced foster care. `r patients_mca_small %>% filter(intdisab == "Yes intellectual disability") %>% nrow` (`r round(patients_mca_small %>% filter(intdisab == "Yes intellectual disability") %>% nrow / nrow(patients_mca_small) * 100, 2)`%) have an intellectual disability as well as autism.

```{r macPatientsSmallTable}
patients_mca_small.table <- patients_mca_small %>%
  group_by(sex_desc) %>% 
  summarise(variable = "Sex",
            count = n(), 
            perc = sprintf("%.2f", round(count/nrow(patients_mca_small)*100, 2))) %>%
  rename(values = sex_desc) %>%
  rbind(patients_mca_small %>%
          group_by(age_group) %>% 
          summarise(variable = "Age band",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(patients_mca_small)*100, 2))) %>%
          rename(values = age_group),
        patients_mca_small %>%
          group_by(commune_name) %>% 
          summarise(variable = "Commune",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(patients_mca_small)*100, 2))) %>%
          rename(values = commune_name),
        patients_mca_small %>%
          group_by(ses_status) %>% 
          summarise(variable = "Private health level",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(patients_mca_small)*100, 2))) %>%
          rename(values = ses_status),
        patients_mca_small %>%
          group_by(ethnicity) %>% 
          summarise(variable = "Ethnicity",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(patients_mca_small)*100, 2))) %>%
          rename(values = ethnicity),
        patients_mca_small %>%
          group_by(rurality) %>% 
          summarise(variable = "Rurality",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(patients_mca_small)*100, 2))) %>%
          rename(values = rurality),
        patients_mca_small %>%
          group_by(disability) %>% 
          summarise(variable = "Disability",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(patients_mca_small)*100, 2))) %>%
          rename(values = disability),
        patients_mca_small %>%
          group_by(foster_care) %>% 
          summarise(variable = "Foster care",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(patients_mca_small)*100, 2))) %>%
          rename(values = foster_care),
        patients_mca_small %>%
          group_by(intdisab) %>% 
          summarise(variable = "Intellectual disability",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(patients_mca_small)*100, 2))) %>%
          rename(values = intdisab)) %>%
  mutate(count_perc = paste0(count, " (", perc, "%)")) %>%
  select(variable, values, count_perc)

kbl(patients_mca_small.table,
    col.names = c("Feature", "Available values", "Count (%)"),
    align = "llr",
    booktabs = TRUE,
    format = "latex",
    linesep = c("", "\\addlinespace", # Sex
                "", "", "", "", "", "\\addlinespace", # Age band
                "", "", "", "", "", 
                "", "", "", "", "", "\\addlinespace", # Commune
                "", "", "", "", "\\addlinespace", # SES
                "", "", "", "\\addlinespace", # Ethnicity
                "", "\\addlinespace", # Rurality
                "", "", "\\addlinespace", # Disability
                "", "", "\\addlinespace", # Foster care
                "", "\\addlinespace", # Autism
                "", "\\addlinespace"), # Intdisab
    caption = "Count and percentage of features' values in the small clinical dataset.") %>%
  kable_styling(latex_options = c("repeat_header"))
```

## Machine learning with clinical data

Multiple correspondence analysis was first conducted with all features thought to be associated with autism diagnosis with no imputation. Figure \@ref(fig:mcaNoimpFeatures) shows approximately 14.6% of the variance in this data can be captured by the first two dimensions of MCA. Disability and foster care status are well separated by the first dimension but Figures \@ref(fig:mcaNoimpDisab) and\@ref(fig:mcaNoimpFoster) show that this separation is primarily driven by whether information is available for these features. Ethnicity, age band and commune of residence are well separately by the second dimension of MCA, as shown in Figure \@ref(fig:mcaNoimpFeatures), and are somewhat separated by the first dimension. Figures \@ref(fig:mcaNoimpGraph) and \@ref(fig:mcaNoimpCategories) further shows the importance of categories within the foster care, disabilities, ethnicity, age band and commune features for explaining the variance in this data. In particular, categories that explain more of the variance include not having disability or foster care status, or not having information on these, age 0-2 and 3-5, being foreign or Chilean, living in Toltén and having private health insurance. Examining the clustering of individual patients by the first two dimensions of MCA, Figure \@ref(fig:mcaNoimpAge) demonstrates that patients in age bands 0-2 and 3-5 cluster well and those in older age bands do not. There is some clustering by ethnicity in Figure \@ref(fig:mcaNoimpEthnic) but it is obscured by the separation of points into the two larger clustered defined by having or not having information on disability and foster care status. Figure \@ref(fig:mcaNoimpCommune) shows clear separation of Toltén and Nueva Imperial communes, however it is important to know here that these and several other communes are represented by only one patient, see Table \@ref(tab:macPatientsSmallTable). There is decent clustering of patients in Temuco and Pitrufquén communes. Figure \@ref(fig:mcaNoimpSES) shows possible separation for patients with private health insurance and Figures \@ref(fig:mcaNoimpSex) and \@ref(fig:mcaNoimpRural) show little clustering by sex or rurality of residence.

```{r mcaNoimp}
patients_mca_noimp <- patients_mca_small %>%
  #filter(autism == "Yes autism") %>%
  #filter(commune_name %in% araucsur_communes$commune_name) %>%
   select(sex_desc,
          age_group,
          commune_name,
          ses_status,
          ethnicity,
          rurality,
          disability,
          foster_care) %>%
  rename("Sex" = sex_desc,
         "Age band" = age_group,
         "Commune" = commune_name,
         "Health insurance" = ses_status,
         "Rurality" = rurality,
         "Ethnicity" = ethnicity,
         "Disability" = disability,
         "Foster care" = foster_care)

res_mca_patients_noimp <- FactoMineR::MCA(patients_mca_noimp,
                                          ncp = 8, # Needs to match number of features
                                          graph = FALSE) 
```

```{r mcaNoimpFeatures, fig.cap="Categorical features by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features without imputation.", fig.height=3}
# Plot features
fviz_mca_var(res_mca_patients_noimp, 
             choice = "mca.cor", 
             labelsize = 4, 
             pointsize = 3, 
             col.var = turbo_colours[16],
             repel = TRUE,
             ggtheme = theme_minimal()) +
  labs(title = "Categorical features by first two dimensions, no imputation")
```

```{r mcaNoimpGraph, fig.cap="Contribution of the top 15 categories to the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features without imputation. The red line shows the expected average if contributions were uniform.", fig.height=3}

# Total contribution to dimension 1 and 2
fviz_contrib(res_mca_patients_noimp, choice = "var", axes = 1:2, top = 15) +
  labs(title = "Contribution of categories to first two dimensions, no imputation",
       x = "Category",
       y = "Contribution (%)")
```

```{r mcaNoimpCategories, fig.cap="Available categories by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features without imputation. Brigther, more yellow colours indicate larger contribution to the first two dimensions.", fig.height=10, fig.width=8.5}
# Plot categories
fviz_mca_var(res_mca_patients_noimp,
             col.var = "contrib",
             labelsize = 4, 
             pointsize = 3, 
             gradient.cols = c(turbo_colours[2], turbo_colours[5], turbo_colours[8], turbo_colours[10]),
             repel = TRUE,
             ggtheme = theme_minimal()) +
  labs(title = "Categories by first two dimensions, no imputation",
       colour = "Contribution")
```

```{r mcaNoimpPlots}
mca_noimp_sex_plot <- fviz_mca_ind(res_mca_patients_noimp, 
             label = "none", # hide individual labels
             habillage = "Sex", # color by groups 
             palette = c(turbo_colours[14], turbo_colours[17]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by sex, no imputation",
             ggtheme = theme_minimal()) 
mca_noimp_age_plot <- fviz_mca_ind(res_mca_patients_noimp, 
             label = "none",
             habillage = "Age band",
             palette = c(turbo_colours[2], turbo_colours[5], turbo_colours[7], turbo_colours[11], turbo_colours[14], turbo_colours[17]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by age band, no imputation",
             ggtheme = theme_minimal()) 
mca_noimp_commune_plot <- fviz_mca_ind(res_mca_patients_noimp, 
             label = "none",
             habillage = "Commune",
             #palette = turbo_colours,
             palette = c(turbo_colours[2], turbo_colours[3], turbo_colours[5], turbo_colours[7], turbo_colours[9], 
                         turbo_colours[11], turbo_colours[12], turbo_colours[14], turbo_colours[15], turbo_colours[17], turbo_colours[18]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by commune of residence, no imputation",
             ggtheme = theme_minimal())
mca_noimp_ses_plot <- fviz_mca_ind(res_mca_patients_noimp, 
             label = "none",
             habillage = "Health insurance",
             palette = c(turbo_colours[3], turbo_colours[7], turbo_colours[11], turbo_colours[14], turbo_colours[17]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by proxy SES, no imputation",
             ggtheme = theme_minimal()) 
mca_noimp_rural_plot <- fviz_mca_ind(res_mca_patients_noimp, 
             label = "none",
             habillage = "Rurality",
             palette = c(turbo_colours[14], turbo_colours[17]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by rurality, no imputation",
             ggtheme = theme_minimal())
mca_noimp_ethnic_plot <- fviz_mca_ind(res_mca_patients_noimp, 
             label = "none",
             habillage = "Ethnicity",
             palette = c(turbo_colours[3], turbo_colours[7], turbo_colours[11], turbo_colours[14]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by ethnicity, no imputation",
             ggtheme = theme_minimal())
mca_noimp_disab_plot <- fviz_mca_ind(res_mca_patients_noimp, 
             label = "none",
             habillage = "Disability",
             palette = c(turbo_colours[3], turbo_colours[7], turbo_colours[11]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by disability status, no imputation",
             ggtheme = theme_minimal())
mca_noimp_foster_plot <- fviz_mca_ind(res_mca_patients_noimp, 
             label = "none",
             habillage = "Foster care",
             palette = c(turbo_colours[3], turbo_colours[7], turbo_colours[11]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by foster care status, no imputation",
             ggtheme = theme_minimal())
```

```{r mcaNoimpAge, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features without imputation, coloured by age band.", fig.height=3}
mca_noimp_age_plot
```

```{r mcaNoimpEthnic, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features without imputation, coloured by ethnicity.", fig.height=3}
mca_noimp_ethnic_plot
```

```{r mcaNoimpCommune, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features without imputation, coloured by commune of residence.", fig.height=3}
mca_noimp_commune_plot
```

```{r mcaNoimpSES, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features without imputation, coloured by health insurance level.", fig.height=3}
mca_noimp_ses_plot
```

```{r mcaNoimpSex, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features without imputation, coloured by sex.", fig.height=3}
mca_noimp_sex_plot
```

```{r mcaNoimpRural, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features without imputation, coloured by rurality of residence.", fig.height=3}
mca_noimp_rural_plot
```

```{r mcaNoimpDisab, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features without imputation, coloured by disability status.", fig.height=3}
mca_noimp_disab_plot
```

```{r mcaNoimpFoster, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features without imputation, coloured by foster care status.", fig.height=3}
grid.arrange(mca_noimp_foster_plot)
```

Exchanging disability and foster care status for their imputed versions leads to the MCA capturing approximately 14.1% of the variance in that data with its first two dimensions, as shown in Figure \@ref(fig:mcaImpFeatures). Disability and foster care status are no longer well separated by the first dimension and Figures \@ref(fig:mcaImpDisab) and \@ref(fig:mcaImpFoster) show that the patients who have experienced foster care do cluster well but the patients with a disability do not. In Figure \@ref(fig:mcaImpFeatures), age band and ethnicity are now well separated by both dimensions and commune mostly by the second. With the reduced importance of disability and foster care, age bands 0-2 and 3-5, foreign, no information and Chilean ethnicity and Toltén and Nueva Imperial communes contribute most to the first two dimensions, see Figures \@ref(fig:mcaImpGraph) and \@ref(fig:mcaImpCategories). Again patients with age bands 0-2 and 3-5 cluster well and older age bands do not, as shown in Figure \@ref(fig:mcaImpAge). Figure \@ref(fig:mcaImpEthnic) shows much clearer clustering of ethnicity than before. For communes with more than one patient resident, clustering is less clear than before with only Pitrufquén well separated by these dimensions, see Figure \@ref(fig:mcaImpCommune). In Figures \@ref(fig:mcaImpSES), \@ref(fig:mcaImpSex) and \@ref(fig:mcaImpRural), clustering by feature is weak.

```{r mcaImp}
patients_mca_imp <- patients_mca_small %>%
  #filter(autism == "Yes autism") %>%
   select(sex_desc,
          age_group,
          commune_name,
          ses_status,
          ethnicity,
          rurality,
          disability_imp,
          foster_care_imp) %>%
  rename("Sex" = sex_desc,
         "Age band" = age_group,
         "Commune" = commune_name,
         "Health insurance" = ses_status,
         "Rurality" = rurality,
         "Ethnicity" = ethnicity,
         "Disability imputed" = disability_imp,
         "Foster care imputed" = foster_care_imp)

res_mca_patients_imp <- FactoMineR::MCA(patients_mca_imp,
                                          ncp = 8, # Needs to match number of features
                                          graph = FALSE) 
```

```{r mcaImpFeatures, fig.cap="Categorical features by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features with imputation.", fig.height=3}
# Plot features
fviz_mca_var(res_mca_patients_imp, 
             choice = "mca.cor", 
             labelsize = 4, 
             pointsize = 3, 
             col.var = turbo_colours[16],
             repel = TRUE,
             ggtheme = theme_minimal()) +
  labs(title = "Categorical features by first two dimensions, with imputation")
```

```{r mcaImpGraph, fig.cap="Contribution of the top 15 categories to the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features with imputation. The red line shows the expected average if contributions were uniform.", fig.height=3}

# Total contribution to dimension 1 and 2
fviz_contrib(res_mca_patients_imp, choice = "var", axes = 1:2, top = 15) +
  labs(title = "Contribution of categories to first two dimensions, with imputation",
       x = "Category",
       y = "Contribution (%)")
```

```{r mcaImpCategories, fig.cap="Available categories by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features with imputation. Brigther, more yellow colours indicate larger contribution to the first two dimensions.", fig.height=10, fig.width=8.5}
# Plot categories
fviz_mca_var(res_mca_patients_imp,
             col.var = "contrib",
             labelsize = 4, 
             pointsize = 3, 
             gradient.cols = c(turbo_colours[2], turbo_colours[5], turbo_colours[8], turbo_colours[10]),
             repel = TRUE,
             ggtheme = theme_minimal()) +
  labs(title = "Categories by first two dimensions, with imputation",
       colour = "Contribution")
```

```{r mcaImpPlots}
mca_imp_sex_plot <- fviz_mca_ind(res_mca_patients_imp, 
             label = "none", # hide individual labels
             habillage = "Sex", # color by groups 
             palette = c(turbo_colours[14], turbo_colours[17]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by sex, with imputation",
             ggtheme = theme_minimal()) 
mca_imp_age_plot <- fviz_mca_ind(res_mca_patients_imp, 
             label = "none",
             habillage = "Age band",
             palette = c(turbo_colours[2], turbo_colours[5], turbo_colours[7], turbo_colours[11], turbo_colours[14], turbo_colours[17]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by age band, with imputation",
             ggtheme = theme_minimal()) 
mca_imp_commune_plot <- fviz_mca_ind(res_mca_patients_imp, 
             label = "none",
             habillage = "Commune",
             #palette = turbo_colours,
             palette = c(turbo_colours[2], turbo_colours[3], turbo_colours[5], turbo_colours[7], turbo_colours[9], 
                         turbo_colours[11], turbo_colours[12], turbo_colours[14], turbo_colours[15], turbo_colours[17], turbo_colours[18]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by commune of residence, with imputation",
             ggtheme = theme_minimal())
mca_imp_ses_plot <- fviz_mca_ind(res_mca_patients_imp, 
             label = "none",
             habillage = "Health insurance",
             palette = c(turbo_colours[3], turbo_colours[7], turbo_colours[11], turbo_colours[14], turbo_colours[17]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by proxy SES, with imputation",
             ggtheme = theme_minimal()) 
mca_imp_rural_plot <- fviz_mca_ind(res_mca_patients_imp, 
             label = "none",
             habillage = "Rurality",
             palette = c(turbo_colours[14], turbo_colours[17]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by rurality, with imputation",
             ggtheme = theme_minimal())
mca_imp_ethnic_plot <- fviz_mca_ind(res_mca_patients_imp, 
             label = "none",
             habillage = "Ethnicity",
             palette = c(turbo_colours[3], turbo_colours[7], turbo_colours[11], turbo_colours[14]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by ethnicity, with imputation",
             ggtheme = theme_minimal())
mca_imp_disab_plot <- fviz_mca_ind(res_mca_patients_imp, 
             label = "none",
             habillage = "Disability imputed",
             palette = c(turbo_colours[3], turbo_colours[7]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by disability status, with imputation",
             ggtheme = theme_minimal())
mca_imp_foster_plot <- fviz_mca_ind(res_mca_patients_imp, 
             label = "none",
             habillage = "Foster care imputed",
             palette = c(turbo_colours[3], turbo_colours[7]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by foster care status, with imputation",
             ggtheme = theme_minimal())
```

```{r mcaImpAge, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features with imputation, coloured by age band.", fig.height=3}
mca_imp_age_plot
```

```{r mcaImpEthnic, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features with imputation, coloured by ethnicity.", fig.height=3}
mca_imp_ethnic_plot
```

```{r mcaImpCommune, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features with imputation, coloured by commune of residence.", fig.height=3}
mca_imp_commune_plot
```

```{r mcaImpSES, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features with imputation, coloured by health insurance level.", fig.height=3}
mca_imp_ses_plot
```

```{r mcaImpSex, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features with imputation, coloured by sex.", fig.height=3}
mca_imp_sex_plot
```

```{r mcaImpRural, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features with imputation, coloured by rurality of residence.", fig.height=3}
mca_imp_rural_plot
```

```{r mcaImpDisab, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features with imputation, coloured by disability status.", fig.height=3}
mca_imp_disab_plot
```

```{r mcaImpFoster, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features with imputation, coloured by foster care status.", fig.height=3}
mca_imp_foster_plot
```

MCA on the small clinical data using only age band, ethnicity and commune results in the first two dimensions capturing 17.8% of the variance in that data, see Figure \@ref(fig:mcaAutFeatures), and these features are fairly well represented by the first two dimensions. Again age bands 0-2 and 3-5, foreign, no information and Chilean ethnicity and Toltén and Nueva Imperial communes contribute most to the first two dimensions, see Figures \@ref(fig:mcaAutGraph) and \@ref(fig:mcaAutCategories). By patient, age bands 0-2 and 3-5 still cluster well (Figure \@ref(fig:mcaAutAge)), ethnicity clusters are very distinct (Figure \@ref(fig:mcaAutEthnic)), and communes show more structure than previously (Figure \@ref(fig:mcaAutCommune)).

```{r mcaAut}
patients_mca_aut <- patients_mca_small %>%
  filter(autism == "Yes autism") %>%
   select(age_group,
          commune_name,
          ethnicity) %>%
  rename("Age band" = age_group,
         "Commune" = commune_name,
         "Ethnicity" = ethnicity)

res_mca_patients_aut <- FactoMineR::MCA(patients_mca_aut, 
                                          ncp = 3, # Needs to match number of features
                                          graph = FALSE) 
```

```{r mcaAutFeatures, fig.cap="Categorical features by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using patients' age band, commune of residence and ethnicity.", fig.height=3}
# Plot features
fviz_mca_var(res_mca_patients_aut, 
             choice = "mca.cor", 
             labelsize = 4, 
             pointsize = 3, 
             col.var = turbo_colours[16],
             repel = TRUE,
             ggtheme = theme_minimal()) +
  labs(title = "Categorical features by first two dimensions for age band, commune and ethnicity")
```

```{r mcaAutGraph, fig.cap="Contribution of the top 15 categories to the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using patients' age band, commune and ethnicity. The red line shows the expected average if contributions were uniform.", fig.height=3}

# Total contribution to dimension 1 and 2
fviz_contrib(res_mca_patients_aut, choice = "var", axes = 1:2, top = 15) +
  labs(title = "Contribution of categories to first two dimensions for age band, commune and ethnicity",
       x = "Category",
       y = "Contribution (%)")
```

```{r mcaAutCategories, fig.cap="Available categories by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using patients' age band, commune and ethnicity. Brigther, more yellow colours indicate larger contribution to the first two dimensions.", fig.height=10, fig.width=8.5}
# Plot categories
fviz_mca_var(res_mca_patients_aut,
             col.var = "contrib",
             labelsize = 4, 
             pointsize = 3, 
             gradient.cols = c(turbo_colours[2], turbo_colours[5], turbo_colours[8], turbo_colours[10]),
             repel = TRUE,
             ggtheme = theme_minimal()) +
  labs(title = "Categories by first two dimensions for age band, commune and ethnicity",
       colour = "Contribution")
```

```{r mcaAutPlots}
mca_aut_age_plot <- fviz_mca_ind(res_mca_patients_aut, 
             label = "none",
             habillage = "Age band",
             palette = c(turbo_colours[2], turbo_colours[5], turbo_colours[7], turbo_colours[11], turbo_colours[14], turbo_colours[17]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by age band for age band, commune and ethnicity",
             ggtheme = theme_minimal()) 
mca_aut_commune_plot <- fviz_mca_ind(res_mca_patients_aut, 
             label = "none",
             habillage = "Commune",
             #palette = turbo_colours,
             palette = c(turbo_colours[2], turbo_colours[3], turbo_colours[5], turbo_colours[7], turbo_colours[9], 
                         turbo_colours[11], turbo_colours[12], turbo_colours[14], turbo_colours[15], turbo_colours[17], turbo_colours[18]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by commune of residence for age band, commune and ethnicity",
             ggtheme = theme_minimal())
mca_aut_ethnic_plot <- fviz_mca_ind(res_mca_patients_aut, 
             label = "none",
             habillage = "Ethnicity",
             palette = c(turbo_colours[3], turbo_colours[7], turbo_colours[11], turbo_colours[14]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by ethnicity, with imputation for age band, commune and ethnicity",
             ggtheme = theme_minimal())
```

```{r mcaAutAge, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using patients' age band, commune and ethnicity, coloured by age band.", fig.height=3}
mca_aut_age_plot
```

```{r mcaAutEthnic, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using age band, commune and ethnicity, coloured by ethnicity.", fig.height=3}
mca_aut_ethnic_plot
```

```{r mcaAutCommune, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using age band, commune and ethnicity, coloured by commune of residence.", fig.height=3}
mca_aut_commune_plot
```

## Linkage of school and patient records

```{r school}
school_ssas <- chile_bayes %>%
  select(-student_commune_name) %>%
  #left_join(region_service_commune_lookup %>% as.tibble %>% select(-geometry), by = "commune_code") %>%
  filter(commune_code %in% araucsur_communes$commune_code) %>%
  #filter(age_june30 >= 6 & age_june30 <= 18, sex != 0) %>% 
  mutate(#autism = ifelse(special_needs_code == 105, 1, 0),
  #       aut_rank = 1,
         dob = ymd(dob),
         ses_status = ifelse(school_fee == "Free", 1,
                      ifelse(school_fee == "$1,000-$10,000" |
                               school_fee == "$10,001-$50,000" |
                               school_fee == "$50,001-$100,000", 2,
                      ifelse(school_fee == "$100,001+", 3, NA)))
         ) %>%
  rename(student_commune_name = commune_name) %>%
  select(dob,
         sex_desc,
         student_commune_name,
         autism,
         ses_status,
         age_june30,
         age_cat_name)

school_ssas_aut <- school_ssas %>% 
  filter(autism == 1) %>%
  # We only want to find additional autism cases in the clinical records, we don't care if a student has autism and isn't in the clinical records
  select(-age_june30, -autism) %>%
  rowid_to_column("id")
  
# Add a fake row so that pairing works later
# school <- rbind.data.frame(select(school_ssas_aut, -age_cat_name), 
#                            data.frame(id = nrow(school_ssas_aut)+1, dob = "2023-06-01", sex_desc = NA, student_commune_name = NA, ses_status = NA),
#                            stringsAsFactors = FALSE)
# school <- select(school_ssas_aut, -age_cat_name)
school <- rbind(select(school_ssas_aut, -age_cat_name), c(nrow(school_ssas_aut)+1, "2023-06-01", NA, NA, NA))
```

```{r schoolChisq}
# Check if students in SSAS are different to other students

chile_bayes_ssas_grouped <- chile_bayes %>% 
  filter(ssas == 1) %>%
  group_by(sex_desc) %>%
  summarise(variable = "Sex",
            count = n(), 
            ssas_perc = paste0(sprintf("%.2f", round(count / chile_bayes %>% filter(ssas == 1) %>% nrow() * 100, 2)), "%")) %>%
  rename(values = sex_desc) %>%
  rbind(chile_bayes %>%
          filter(ssas == 1) %>%
          group_by(age_cat_name) %>% 
          summarise(variable = "Age band",
                    count = n(), 
                    ssas_perc = paste0(sprintf("%.2f", round(count / chile_bayes %>% filter(ssas == 1) %>% nrow() * 100, 2)), "%")) %>%
          rename(values = age_cat_name),
        chile_bayes %>%
          filter(ssas == 1) %>%
          group_by(school_fee) %>% 
          summarise(variable = "School fee",
                    count = n(), 
                    ssas_perc = paste0(sprintf("%.2f", round(count / chile_bayes %>% filter(ssas == 1) %>% nrow() * 100, 2)), "%")) %>%
          rename(values = school_fee),
        chile_bayes %>%
          filter(ssas == 1) %>%
          group_by(ethnic_2_group) %>% 
          summarise(variable = "Ethnicity",
                    count = n(), 
                    ssas_perc = paste0(sprintf("%.2f", round(count / chile_bayes %>% filter(ssas == 1) %>% nrow() * 100, 2)), "%")) %>%
          rename(values = ethnic_2_group),
        chile_bayes %>%
          filter(ssas == 1) %>%
          group_by(school_rurality) %>% 
          summarise(variable = "Rurality",
                    count = n(), 
                    ssas_perc = paste0(sprintf("%.2f", round(count / chile_bayes %>% filter(ssas == 1) %>% nrow() * 100, 2)), "%")) %>%
          rename(values = school_rurality),
        chile_bayes %>%
          filter(ssas == 1) %>%
          group_by(special_needs_status) %>% 
          summarise(variable = "Accesses SEED",
                    count = n(), 
                    ssas_perc = paste0(sprintf("%.2f", round(count / chile_bayes %>% filter(ssas == 1) %>% nrow() * 100, 2)), "%")) %>%
          rename(values = special_needs_status) %>%
          mutate(values = ifelse(values == 0, "No", "Yes"))) %>%
  select(variable, values, ssas_perc)

# Add a row for $1000-10000 group which is not represented in SSAS data
chile_bayes_ssas_grouped <- rbind(chile_bayes_ssas_grouped[1:7,], 
                                  c("School fee", "$1,000-$10,000", "0.00%"), 
                                  chile_bayes_ssas_grouped[8:19,])

chile_bayes_nonssas_grouped <- chile_bayes %>% 
  filter(ssas == 0) %>%
  group_by(sex_desc) %>%
  summarise(variable = "Sex",
            count = n(), 
            nonssas_perc = paste0(sprintf("%.2f", round(count / chile_bayes %>% filter(ssas == 0) %>% nrow() * 100, 2)), "%")) %>%
  rename(values = sex_desc) %>%
  rbind(chile_bayes %>%
          filter(ssas == 0) %>%
          group_by(age_cat_name) %>% 
          summarise(variable = "Age band",
                    count = n(), 
                    nonssas_perc = paste0(sprintf("%.2f", round(count / chile_bayes %>% filter(ssas == 0) %>% nrow() * 100, 2)), "%")) %>%
          rename(values = age_cat_name),
        chile_bayes %>%
          filter(ssas == 0) %>%
          group_by(school_fee) %>% 
          summarise(variable = "School fee",
                    count = n(), 
                    nonssas_perc = paste0(sprintf("%.2f", round(count / chile_bayes %>% filter(ssas == 0) %>% nrow() * 100, 2)), "%")) %>%
          rename(values = school_fee),
        chile_bayes %>%
          filter(ssas == 0) %>%
          group_by(ethnic_2_group) %>% 
          summarise(variable = "Ethnicity",
                    count = n(), 
                    nonssas_perc = paste0(sprintf("%.2f", round(count / chile_bayes %>% filter(ssas == 0) %>% nrow() * 100, 2)), "%")) %>%
          rename(values = ethnic_2_group),
        chile_bayes %>%
          filter(ssas == 0) %>%
          group_by(school_rurality) %>% 
          summarise(variable = "Rurality",
                    count = n(), 
                    nonssas_perc = paste0(sprintf("%.2f", round(count / chile_bayes %>% filter(ssas == 0) %>% nrow() * 100, 2)), "%")) %>%
          rename(values = school_rurality),
        chile_bayes %>%
          filter(ssas == 0) %>%
          group_by(special_needs_status) %>% 
          summarise(variable = "Accesses SEED",
                    count = n(), 
                    nonssas_perc = paste0(sprintf("%.2f", round(count / chile_bayes %>% filter(ssas == 0) %>% nrow() * 100, 2)), "%")) %>%
          rename(values = special_needs_status) %>%
          mutate(values = ifelse(values == 0, "No", "Yes"))) %>%
  select(variable, values, nonssas_perc)

chisq_pvals <- c(ifelse(chisq.test(chile_bayes$sex_desc, chile_bayes$ssas)$p.value < 0.0001,
                        "<<0.001", signif(chisq.test(chile_bayes$sex_desc, chile_bayes$ssas)$p.value, 3)), "",
                 ifelse(chisq.test(chile_bayes$age_cat_name, chile_bayes$ssas)$p.value < 0.0001,
                        "<<0.001", signif(chisq.test(chile_bayes$age_cat_name, chile_bayes$ssas)$p.value, 3)), "", "", "",
                 ifelse(chisq.test(chile_bayes$school_fee, chile_bayes$ssas)$p.value < 0.0001, 
                        "<<0.001", signif(chisq.test(chile_bayes$school_fee, chile_bayes$ssas)$p.value, 3)), "", "", "", "", "", "",
                 ifelse(chisq.test(chile_bayes$ethnic_2_group, chile_bayes$ssas)$p.value < 0.0001,
                        "<<0.001", signif(chisq.test(chile_bayes$ethnic_2_group, chile_bayes$ssas)$p.value, 3)), "", "",
                 ifelse(chisq.test(chile_bayes$school_rurality, chile_bayes$ssas)$p.value < 0.0001,
                        "<<0.001", signif(chisq.test(chile_bayes$school_rurality, chile_bayes$ssas)$p.value, 3)), "",
                 ifelse(chisq.test(chile_bayes$special_needs_status, chile_bayes$ssas)$p.value < 0.0001,
                        "<<0.001", signif(chisq.test(chile_bayes$special_needs_status, chile_bayes$ssas)$p.value, 3)), "")

chile_bayes_grouped <- cbind(chile_bayes_ssas_grouped, 
                             chile_bayes_nonssas_grouped[, 3],
                             chisq_pvals)

kbl(chile_bayes_grouped,
    col.names = c("Feature", "Available values", "% for SSAS", "% for non-SSAS", "p-value"),
    align = "llrrr",
    booktabs = TRUE,
    format = "latex",
    linesep = c("", "\\addlinespace", # Sex
                "", "", "", "\\addlinespace", # Age
                "", "", "", "", "", "", "\\addlinespace", # SES
                "", "", "\\addlinespace", # Ethnicity
                "", "\\addlinespace", # Rurality,
                "", "\\addlinespace"), # SEED
    caption = "Percentage of features' values for each category for the students in the school data resident in SSAS and those not resident in SSAS with the p-value resulting from Chi squared tests of the difference between SSAS and non-SSAS students for each feature.") %>%
  kable_styling(latex_options = c("repeat_header"))
```

Table \@ref(tab:schoolChisq) shows that students living in SSAS are significantly different to students living in the other health services with regard to age band, SES, ethnicity, rurality and whether they access SEED at all, but do not differ by sex. 

```{r ssasSchoolTable}
school_sass_aut.table <- school_ssas_aut %>%
  group_by(sex_desc) %>% 
  summarise(variable = "Sex",
            count = n(), 
            perc = sprintf("%.2f", round(count/nrow(school_ssas_aut)*100, 2))) %>%
  rename(values = sex_desc) %>%
  rbind(school_ssas_aut %>%
          group_by(age_cat_name) %>% 
          summarise(variable = "Age band",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(school_ssas_aut)*100, 2))) %>%
          rename(values = age_cat_name),
        school_ssas_aut %>%
          group_by(student_commune_name) %>% 
          summarise(variable = "Commune",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(school_ssas_aut)*100, 2))) %>%
          rename(values = student_commune_name),
        school_ssas_aut %>%
          group_by(ses_status) %>% 
          summarise(variable = "Proxy SES (school fee group)",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(school_ssas_aut)*100, 2))) %>%
          rename(values = ses_status)) %>%
  mutate(count_perc = paste0(count, " (", perc, "%)")) %>%
  select(variable, values, count_perc)

kbl(school_sass_aut.table,
    col.names = c("Feature", "Available values", "Count (%)"),
    align = "llr",
    booktabs = TRUE,
    format = "latex",
    linesep = c("", "\\addlinespace", # Sex
                "", "", "", "\\addlinespace", # Age
                "", "", "", "", "", 
                "", "", "", "", "", 
                "", "", "", "", "", 
                "", "", "", "", "", "\\addlinespace", # Commune
                "", "", "", "\\addlinespace"), # SES
    caption = "Count and percentage of features' values in the SSAS school dataset which comprises students with autism resident in the SSAS catchment.") %>%
  kable_styling(latex_options = c("repeat_header"))
```

In the school records, `r format(school_ssas %>% nrow(), big.mark = ",", trim = TRUE)` students live in SSAS health service catchment, of which `r nrow(school)-1` (`r round((nrow(school)-1) / nrow(school_ssas) * 100, 2)`%) have autism. Among the students with autism, shown in \@ref(tab:ssasSchoolTable), there are many more males than females, Temuco is the most common commune of residence and most students have a proxy SES of 1. 

```{r patients}
patients_age <- clinical %>%
  filter(commune_code %in% araucsur_communes$commune_code,
         age_june30 >= 6 & age_june30 <= 18) %>%
  group_by(id, gender, dob, commune_name, region_name) %>%
  summarise(ses_status = get.mode.na(ses_status),
            autism = get.max.na(autism),
            aut_rank = get.min.na(aut_rank),
            age_june30 = get.min.na(age_june30)) %>%
  ungroup() %>% 
  rename("student_commune_name" = "commune_name",
         "student_region_name" = "region_name",
         "sex_desc" = "gender") %>%
  rowid_to_column("row_id") %>%
  select(row_id, 
         id,
         dob, 
         age_june30,
         sex_desc,
         student_commune_name,
         #autism,
         ses_status#,
         #intdisab,
         #aut_rank
         #, student_region_name
         ) 

patients <- patients_age %>% select(-age_june30) %>% mutate(ses_status = as.character(ses_status))

# patients_out <- clinical %>%
#   filter(commune_code %in% araucsur_communes$commune_code) %>%
#   group_by(id, gender, dob) %>%
#   summarise(ses_status = get.min.na(socio_economic_level),
#             autism = get.max.na(autism),
#             intdisab = get.max.na(intdisab),
#             commune_name = commune_name[which.max(apt_date)],
#             commune_code = commune_code[which.max(apt_date)]) %>%
#   ungroup() %>%
#   rowid_to_column("row_id")
# write_csv(patients_out, file = "04_Data/Outputs/patients.csv")

patients_distinct <- patients %>% group_by(id) %>% summarise(commune_count = n(), communes = list(student_commune_name))
```

```{r ssasPatientsTable}
ssas_patients.table <- patients_age %>%
  group_by(sex_desc) %>% 
  summarise(variable = "Sex",
            count = n(), 
            perc = sprintf("%.2f", round(count/nrow(patients_age)*100, 2))) %>%
  rename(values = sex_desc) %>%
  rbind(patients_age %>%
          mutate(age_cat_name = factor(ifelse(age_june30 <= 8, "6-8", 
                                ifelse(age_june30 <= 11, "9-11", 
                                ifelse(age_june30 <= 14, "12-14", "15-18"))),
                                levels = c("6-8", "9-11", "12-14", "15-18"))) %>%
          group_by(age_cat_name) %>% 
          summarise(variable = "Age band",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(patients_age)*100, 2))) %>%
          rename(values = age_cat_name),
        patients_age %>%
          group_by(student_commune_name) %>% 
          summarise(variable = "Commune",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(patients_age)*100, 2))) %>%
          rename(values = student_commune_name),
        patients_age %>%
          group_by(ses_status) %>% 
          summarise(variable = "Proxy SES (health insurance contribution group)",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(patients_age)*100, 2))) %>%
          rename(values = ses_status)) %>%
  mutate(count_perc = paste0(count, " (", perc, "%)")) %>%
  select(variable, values, count_perc)

kbl(ssas_patients.table,
    col.names = c("Feature", "Available values", "Count (%)"),
    align = "llr",
    booktabs = TRUE,
    format = "latex",
    linesep = c("", "\\addlinespace", # Sex
                "", "", "", "\\addlinespace", # Age
                "", "", "", "", "", 
                "", "", "", "", "", 
                "", "", "", "", "", 
                "", "", "", "", "", "\\addlinespace", # Commune
                "", "", "\\addlinespace"), # SES
    caption = "Count and percentage of features' values in the patient dataset.") %>%
  kable_styling(latex_options = c("repeat_header"))
```

Aggregating the combined clinical data to patient-level data for linkage resulted in the patient dataset with `r format(nrow(patients), big.mark = ",", trim = TRUE)` records for `r format(length(unique(patients$id)), big.mark = ",", trim = TRUE)` unique patients as `r patients_distinct %>% filter(commune_count == 2) %>% nrow()` patients lived in 2 communes and `r patients_distinct %>% filter(commune_count == 3) %>% nrow()` lived in 3 during the period covered by the data. Table \@ref(tab:ssasPatientsTable) shows a similar pattern of category frequencies in the patient data as in the SSAS school data; males are more prevalent, Temuco is the most common commune of residence, however most patients have a proxy SES of 2.

### Manual record linkage

```{r manualLinkage}
patients_grouped_ses <- patients %>%
  group_by(sex_desc, 
           dob, 
           student_commune_name,
           ses_status) %>%
  summarise(count = n(),
            ids = list(id)) %>%
  ungroup()

school_grouped_ses <- school %>%
  group_by(sex_desc, 
           dob, 
           student_commune_name,
           ses_status) %>%
  summarise(count = n(),
            ids = list(rowid)) %>%
  ungroup()

merged_ses <- merge(school, patients, by = c("sex_desc", "dob", "student_commune_name", "ses_status"), all = FALSE)
# 79 matches

patients_grouped <- patients %>%
  group_by(sex_desc, 
           dob, 
           student_commune_name) %>%
  summarise(count = n(),
            ids = list(id))

school_grouped <- school %>%
  group_by(sex_desc, 
           dob, 
           student_commune_name) %>%
  summarise(count = n(),
            #ids = list(rowid)
            ses = list(ses_status))

merged <- merge(school, patients, by = c("sex_desc", "dob", "student_commune_name"), all = FALSE)
# 197 matches
```

Using perfect match on sex, date of birth, commune of residence and the proxies for SES, `r nrow(merged_ses)` matches can be found between the SSAS school and patient records. Of these, `r length(unique(merged_ses$id.x))` unique SSAS school records can be perfectly matched to SSAS patient records, and all perfect matches were for unique patients. When mismatch on SES proxy is allowed, `r nrow(merged)` matches can be manually found between the SSAS school and patient records. Of these, `r length(unique(merged$id.x))` unique school records can be perfectly matched to SSAS patient records and `r length(unique(merged$id.y))` SSAS patients can be perfectly matched to SSAS school records.

### Probabilistic record linkage

```{r probabilisticWeights}
# formerly a2
pairs_blocked <- compare.linkage(school,
                     select(patients, -row_id),
                     blockfld = c("sex_desc", "dob"), 
                      # Block on sex and dob because we really want them to be the same and helps computation time
                     #phonetic = FALSE,
                     #strcmp = c(2), # Do string comparison on DOB
                     exclude = c(1) # Exclude the id column in both datasets
                     )

pairs_weighted <- epiWeights(pairs_blocked, e = c(0.01, # Default for DOB
                           0.01, # Default for sex
                           0.01, # Default for commune because we want a good match
                           #0.01, # Keep small so autism in clinical (not intellectual disability) is prioritised over ses match
                           0.1   # Have more error for ses_status because it is loosely defined 
                           ))

pairs_classified <- emClassify(pairs_weighted, threshold.upper = 1, threshold.lower = 0.8)

pairs_blocked.df <- pairs_blocked$pairs %>%
  mutate(weight = pairs_classified$Wdata,
         pred = pairs_classified$prediction) %>%
  rename(".x" = id1, ".y" = id2) %>%
  select(-is_match)

# Turn into a 'pairs' type object so it can be fed to select_n_to_m()
pairs_blocked.pairs <- pair_blocking(school, patients, on = c("sex_desc", "dob")) %>%
         mutate(student_commune_name = (school$student_commune_name[.x] == patients$student_commune_name[.y])) %>%
  left_join(pairs_blocked.df, by = c(".x", ".y")) %>%
  select(c(-student_commune_name.x)) %>%
  rename("student_commune_name" = "student_commune_name.y")

matches <- select_n_to_m(pairs_blocked.pairs, threshold = 0.5, score = "weight", n = 1, m = 1, var = "match") %>%
  filter(match == TRUE) %>%
  rename("id" = ".x",
         "row_id" = ".y") %>%
  mutate(id = as.character(id))
```

```{r matchSchool}
# Now add the matched clinical records to the school records
school_matched <- school %>%
  mutate(id = as.character(id)) %>%
  filter(!is.na(sex_desc)) %>%
  left_join(matches, by = "id") %>%
  rename(id.school = id,
         dob.school = dob.x,
         sex_desc.school = sex_desc.x,
         student_commune_name.school = student_commune_name.x,
         ses_status.school = ses_status.x,
         dob.matched = dob.y,
         sex_desc.matched = sex_desc.y,
         student_commune_name.matched = student_commune_name.y,
         ses_status.matched = ses_status.y) %>%
  select(c(-pred, -match)) %>%
  left_join(patients, by = "row_id") %>%
  rename(id.patient = row_id,
         patient_id = id,
         dob.patient = dob,
         sex_desc.patient = sex_desc,
         student_commune_name.patient = student_commune_name,
         ses_status.patient = ses_status) %>%
  select(id.school, id.patient, patient_id,
         dob.school, dob.patient, dob.matched,
         sex_desc.school, sex_desc.patient, sex_desc.matched,
         student_commune_name.school, student_commune_name.patient, student_commune_name.matched,
         ses_status.school, ses_status.patient, ses_status.matched,
         weight) %>%
  arrange(desc(weight))

school_matched_small <- school_matched %>%
  mutate(matched = ifelse(is.na(patient_id), 0, 1),
         sex.school = ifelse(sex_desc.school == "Male", 1,
                      ifelse(sex_desc.school == "Female", 2, NA))) %>%
  merge(region_service_commune_lookup %>% as.tibble() %>% select(-geometry),
        by.x = "student_commune_name.school", by.y = "commune_name") %>% # doesn't include all.x = TRUE because that would keep the fake record.
  select(id.school, 
         dob.school, 
         sex_desc.school, sex.school,
         student_commune_name.school, commune_code,
         ses_status.school, 
         matched)
```

```{r matchPatient}
# Now add the matched clinical records to the school records
patients_matched <- patients %>%
  left_join(matches, by = "row_id") %>%
  rename(id.patient = row_id,
         patient_id = id.x,
         dob.patient = dob.x,
         sex_desc.patient = sex_desc.x,
         student_commune_name.patient = student_commune_name.x,
         id = id.y,
         ses_status.patient = ses_status.x,
         #autism.patient = autism.x,
         dob.matched = dob.y,
         sex_desc.matched = sex_desc.y,
         student_commune_name.matched = student_commune_name.y,
         ses_status.matched = ses_status.y) %>%
  select(c(-pred, -match)) %>%
  left_join(school, by = "id") %>%
  rename(id.school = id,
         dob.school = dob,
         sex_desc.school = sex_desc,
         student_commune_name.school = student_commune_name,
         ses_status.school = ses_status) %>%
  select(id.school, id.patient, patient_id,
         dob.school, dob.patient, dob.matched,
         sex_desc.school, sex_desc.patient, sex_desc.matched,
         student_commune_name.school, student_commune_name.patient, student_commune_name.matched,
         ses_status.school, ses_status.patient, ses_status.matched,
         weight) %>% #,
         #autism.patient) %>%
  arrange(desc(weight))

patients_matched_small <- patients_matched %>%
  mutate(matched = ifelse(is.na(id.school), 0, 1),
         sex.patient = ifelse(sex_desc.patient == "Male", 1,
                       ifelse(sex_desc.patient == "Female", 2, NA))) %>%
  merge(region_service_commune_lookup %>% as.tibble() %>% select(-geometry),
        by.x = "student_commune_name.patient", by.y = "commune_name") %>%
  select(patient_id, id.patient, 
         dob.patient,
         sex_desc.patient, sex.patient,
         student_commune_name.patient, commune_code,
         ses_status.patient,
         matched) #,
         #autism.patient)
```

```{r patientsUnique}
# Check if any of the patients that lived in multiple communes matched to multiple school records
patients_matched_unique <- patients_matched_small %>%
  group_by(matched, patient_id) %>%
  summarise(count = n())

patients_dup <- patients_matched_unique %>% filter(matched == 1, count > 1) %>% select(patient_id)
# No patient is inadvertently matched to two school records
```

```{r patientsAut, include = FALSE}
# # Check if any matches are to patients that only have intellectual disability
# patients_intdisab <- patients_matched_small %>% filter(matched == 1, autism.patient == 0)
# 
# # There are some so check if any other patient records were available for those DOB and sex values.
# for(j in 1:nrow(patients_intdisab)) {
#   patients %>% 
#     filter(sex_desc == patients_intdisab$sex_desc.patient[j],
#            dob == patients_intdisab$dob.patient[j]) #%>% print()
# }
```

Blocking on sex and date of birth, resulted in `r nrow(pairs_blocked.pairs)` blocked pairs. Probabilistic matching on sex, date of birth, commune of residence and the proxies for SES with selection of possible matches to create a bijective set of matches resulted in `r nrow(matches)` matches of unique SSAS school and patient records. This corresponds to `r round(nrow(matches) / nrow(school) * 100, 2)`% of the school records for students with autism in SSAS having a match in the SSAS patient records, `r round(nrow(matches) / nrow(patients) * 100, 2)`% of the patient records having a match in the SSAS school records and `r round(nrow(matches) / length(unique(patients$id)) * 100, 2)`% of the unique patients having a match in the SSAS school records. For each patient that had lived in more than one commune and therefore appeared more than once in the patient data, only one match to an SSAS school record was made, meaning the matching was bijective for SSAS school records and unique patients. 

Analysis of differences between matched and unmatched records in the SSAS school data and in the patient data by sex, commune and proxy for SES are provided in the Supplementary Figures. Kolmogorov-Smirnov permutation tests found no significant difference in frequency of sexes between matched and unmatched SSAS school records, see Figure \@ref(fig:kolmogorovSchoolSex). They found a strongly significant difference in the frequency of sexes between matched and unmatched patient records, see Figure \@ref(fig:kolmogorovPatientSex). This difference is likely due to the sex ratios differing across the datasets: the SSAS school data is `r round(school %>% filter(sex_desc == "Female") %>% nrow() / nrow(school) * 100, 2)`% female, the patient data is `r round(patients %>% filter(sex_desc == "Female") %>% nrow() / nrow(patients) * 100, 2)`% female and the matches are `r round(school_matched_small %>% filter(sex_desc.school == "Female") %>% nrow() / school_matched_small %>% nrow() * 100, 2)`% females. Kolmogovo-Smirnov permutation testing found matched and unmatched records differed significantly by commune for the SSAS school data, see Figure \@ref(fig:kolmogorovSchoolCommune), and that there was no significant difference between matched and unmatched records by commune for the patient data, see Figure \@ref(fig:kolmogorovSchoolCommune). This appears to be driven by the matchability of students and patients living in Temuco, the most prevalent commune. By proxy SES, there was a strongly significant difference between matched and unmatched records in the SSAS school and a somewhat significant difference for the patient data, see Figure \@ref(fig:kolmogorovSchoolSes) and Figure \@ref(fig:kolmogorovPatientSes) respectively, likely reflecting different frequencies in these values across datasets. Kolmogorov-Smirnov permutation testing was not conducted for date of birth as this feature contains too many categories for results to be meaningful.


## Updated autism prevalence estimates and delta

```{r newPrev}
# Aggregate patients to single row per patient by choosing the commune that has a match where available.
patients_matched_small_dedup <- patients_matched_small %>%
  group_by(patient_id, dob.patient, sex_desc.patient) %>%
  summarise(commune_list = list(student_commune_name.patient),
            student_commune_name.patient = student_commune_name.patient[which.max(matched)],
            ses_list = list(ses_status.patient),
            ses_status.patient = ses_status.patient[which.max(matched)],
            #autism.patient = max(autism.patient),
            matched = max(matched))



n_aut_araucS <- nrow(school_matched) + length(unique(patients_matched$patient_id)) - nrow(matches) 
# OR 
n_aut_araucS <- school_matched_small %>% filter(matched == 0) %>% nrow() +
  dim(patients_matched_small_dedup %>% filter(matched == 0) %>% select(patient_id) %>% unique())[1] + nrow(matches)
```

```{r schoolpatient}
# Get count of autism and no autism in school data
school_ssas_grouped <- school_ssas %>%
  group_by(age_june30, sex_desc, autism) %>%
  summarise(count = n()) %>%
  pivot_wider(names_from = "autism", values_from = "count") %>%
  rename(no_autism_school = "0", yes_autism_school = "1")

# Remove matched patients because they are already counted as yes autism in the school data
# Then get count of autism patients
patients_nomatch_grouped <- patients_matched_small_dedup %>%
  filter(matched == 0) %>%
  mutate(age_june30 = trunc(time_length(interval(ymd(dob.patient), ymd("2021-06-30")), unit = "year"))) %>%
  rename(sex_desc = sex_desc.patient) %>%
  group_by(age_june30, sex_desc) %>%
  summarise(yes_autism_patients = n())

# Combine the counts. Move the number of autism patients from the no autism in school data to yes autism in school data
school_patients_grouped <- merge(school_ssas_grouped, patients_nomatch_grouped,
                                 by = c("age_june30", "sex_desc")) %>%
  mutate(no_autism_linked = no_autism_school - yes_autism_patients,
         yes_autism_linked = yes_autism_school + yes_autism_patients,
         age_cat_name = factor(ifelse(age_june30 <= 8, "6-8", 
                               ifelse(age_june30 <= 11, "9-11", 
                               ifelse(age_june30 <= 14, "12-14", "15-18"))),
                               levels = c("6-8", "9-11", "12-14", "15-18")),
         sex = ifelse(sex_desc == "Female", 2, 1))

# school_patients <- patients_matched_small_dedup %>% 
#   rename(id = patient_id,
#          dob = dob.patient,
#          sex_desc = sex_desc.patient,
#          student_commune_name = student_commune_name.patient,
#          autism = autism.patient,
#          ses_status = ses_status.patient
#          ) %>%
#   mutate(age_june30 = trunc(time_length(interval(ymd(dob), ymd("2021-06-30")), unit = "year")),
#          age_cat_name = factor(ifelse(age_june30 <= 2, "0-2",
#                                ifelse(age_june30 <= 5, "3-5",
#                                ifelse(age_june30 <= 8, "6-8", 
#                                ifelse(age_june30 <= 11, "9-11", 
#                                ifelse(age_june30 <= 14, "12-14", "15-18"))))), 
#                                levels = c("0-2", "3-5", "6-8", "9-11", "12-14", "15-18"))) %>%
#   filter(matched == 0) %>% # remove matches so they're not double counted
#   select(id, dob, sex_desc, student_commune_name, autism, ses_status, age_june30, age_cat_name) %>%
#   mutate(dataset = "patients") %>%
#   rbind(school_ssas %>% rowid_to_column("id") %>% mutate(dataset = "school", id = as.character(id))) %>%
#   mutate(sex = ifelse(sex_desc == "Female", 2, 1))
```

```{r adjNewprevAraucS}
#aut_newprev_araucS <- get_grouped_prev(x = school_patients, stdpop = chile_stdpop, 
#                                    grouping_vars = c("age_june30", "age_cat_name", "sex", "autism"),
#                                    disease = "autism")

n_stdpop <- sum(chile_stdpop$std_pop)

aut_newprev_araucS <- school_patients_grouped %>%
  #select(age_june30, age_cat_name, sex, no_autism_linked, yes_autism_linked) %>%
  rename(age = age_june30) %>%
  mutate(yes_autism_linked = ifelse(is.na(yes_autism_linked), 0, yes_autism_linked), # If there are no cases of autism in the group, input 0
         sample_pop_size = no_autism_linked + yes_autism_linked, # Total sample population is autism cases + not cases
         sample_prevalence = yes_autism_linked / sample_pop_size) %>% # Prevalence of autism in the group
  left_join(chile_stdpop, by = c("age", "sex")) %>%
  mutate(disease_prev_std = yes_autism_linked / sample_pop_size * pop_prop, # Prevalence of autism in the group, standardised to standard population
         w = std_pop / (sample_pop_size * n_stdpop), # Weight of the group using standard population
         w2 = pop_prop / sample_pop_size,
           #sum_std_pop = sum(std_pop)
           ) %>%
  ungroup()

aut_newprev_araucS_adj <- aut_newprev_araucS %>%
  summarise(sum_sample_pop_size = sum(sample_pop_size),
            crude_rate = sum(yes_autism_linked) / sum(sample_pop_size),
            crude_count = sum(yes_autism_linked),
            adjusted_rate = sum(yes_autism_linked / sample_pop_size * pop_prop),
            adjusted_count = round(adjusted_rate * sum_sample_pop_size, 0), # had to fudge this to get MCMC to run bc it needs integers
            #adjusted_count = adjusted_rate * sum_sample_pop_size,
            var = sum(pop_prop^2 * yes_autism_linked / sample_pop_size^2),
            #se2 = sqrt(sum((std_pop/sum(std_pop))^2 * n_autism/sample_pop_size^2)),
            w_M = max(w),
            crude_ci_lower = crude_rate - (1.96 * sqrt(crude_rate * (1 - crude_rate) / sum_sample_pop_size)),
            crude_ci_upper = crude_rate + (1.96 * sqrt(crude_rate * (1 - crude_rate) / sum_sample_pop_size)),
            adjusted_ci_lower = ifelse(var == 0, 0, var / (2*adjusted_rate) * qchisq(p = 0.05/2, df = 2*adjusted_rate^2 / var)),
            adjusted_ci_upper = (var + w_M^2) / (2*(adjusted_rate + w_M)) * qchisq(p = 1-0.05/2, df = 2*(adjusted_rate+w_M)^2 / (var+w_M^2))) %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))
```

```{r adjNewprevAraucSSex}
# Adjusted prevalence by sex
aut_newprev_araucS_f <- school_patients_grouped %>%
  filter(sex == 2) %>%
  rename(age = age_june30) %>%
  mutate(yes_autism_linked = ifelse(is.na(yes_autism_linked), 0, yes_autism_linked), # If there are no cases of autism in the group, input 0
         sample_pop_size = no_autism_linked + yes_autism_linked, # Total sample population is autism cases + not cases
         sample_prevalence = yes_autism_linked / sample_pop_size) %>% # Prevalence of autism in the group
  left_join(chile_stdpop_f, by = c("age", "sex")) %>%
  mutate(disease_prev_std = yes_autism_linked / sample_pop_size * pop_prop, # Prevalence of autism in the group, standardised to standard population
         w = std_pop / (sample_pop_size * n_stdpop), # Weight of the group using standard population
         w2 = pop_prop / sample_pop_size,
           #sum_std_pop = sum(std_pop)
           ) %>%
  ungroup()

aut_newprev_araucS_adj_f <- get_adjusted_prev(rename(aut_newprev_araucS_f, "n_disease" = "yes_autism_linked"),
                                              grouping_vars = c()) %>%
  mutate(sex_desc = "Female") %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))

aut_newprev_araucS_m <- school_patients_grouped %>%
  filter(sex == 1) %>%
  rename(age = age_june30) %>%
  mutate(yes_autism_linked = ifelse(is.na(yes_autism_linked), 0, yes_autism_linked), # If there are no cases of autism in the group, input 0
         sample_pop_size = no_autism_linked + yes_autism_linked, # Total sample population is autism cases + not cases
         sample_prevalence = yes_autism_linked / sample_pop_size) %>% # Prevalence of autism in the group
  left_join(chile_stdpop_m, by = c("age", "sex")) %>%
  mutate(disease_prev_std = yes_autism_linked / sample_pop_size * pop_prop, # Prevalence of autism in the group, standardised to standard population
         w = std_pop / (sample_pop_size * n_stdpop), # Weight of the group using standard population
         w2 = pop_prop / sample_pop_size,
           #sum_std_pop = sum(std_pop)
           ) %>%
  ungroup()

aut_newprev_araucS_adj_m <- get_adjusted_prev(rename(aut_newprev_araucS_m, "n_disease" = "yes_autism_linked"),
                                              grouping_vars = c()) %>%
  mutate(sex_desc = "Male") %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))

aut_newprev_araucS_sex_adj <- rbind(aut_newprev_araucS_adj_m, aut_newprev_araucS_adj_f) 
```

```{r adjNewprevAraucSSexOld}
# # Adjusted prevalence by sex
# aut_newprev_araucS_f <- school_patients %>%
#   filter(sex == 2) %>%
#   get_grouped_prev(stdpop = chile_stdpop_f, grouping_vars = c("age_june30", "sex", "autism"), disease = "autism")
# aut_newprev_araucS_adj_f <- get_adjusted_prev(aut_newprev_araucS_f, grouping_vars = c()) %>% mutate(sex_desc = "Female") %>%
#   mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
#          adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))
# 
# aut_newprev_araucS_m <- school_patients %>%
#   filter(sex == 1) %>%
#   get_grouped_prev(stdpop = chile_stdpop_m, grouping_vars = c("age_june30", "sex", "autism"), disease = "autism")
# aut_newprev_araucS_adj_m <- get_adjusted_prev(aut_newprev_araucS_m, grouping_vars = c()) %>% mutate(sex_desc = "Male") %>%
#   mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
#          adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))
# 
# aut_newprev_araucS_sex_adj <- rbind(aut_newprev_araucS_adj_m, aut_newprev_araucS_adj_f) 
```

```{r adjNewprevAraucSAgecat}
# Adjusted prevalence by age band
chile_stdpop_6 <- chile_stdpop %>%
  filter(age >= 6 & age <= 8) %>%
  mutate(pop_prop = std_pop / sum(std_pop))
chile_stdpop_9 <- chile_stdpop %>%
  filter(age >= 9 & age <= 11) %>%
  mutate(pop_prop = std_pop / sum(std_pop))
chile_stdpop_12 <- chile_stdpop %>%
  filter(age >= 12 & age <= 14) %>%
  mutate(pop_prop = std_pop / sum(std_pop))
chile_stdpop_15 <- chile_stdpop %>%
  filter(age >= 15 & age <= 18) %>%
  mutate(pop_prop = std_pop / sum(std_pop))

# Age 6-8
aut_newprev_araucS_6 <- school_patients_grouped %>%
  filter(age_cat_name == "6-8") %>%
  rename(age = age_june30) %>%
  mutate(yes_autism_linked = ifelse(is.na(yes_autism_linked), 0, yes_autism_linked), # If there are no cases of autism in the group, input 0
         sample_pop_size = no_autism_linked + yes_autism_linked, # Total sample population is autism cases + not cases
         sample_prevalence = yes_autism_linked / sample_pop_size) %>% # Prevalence of autism in the group
  left_join(chile_stdpop_6, by = c("age", "sex")) %>%
  mutate(disease_prev_std = yes_autism_linked / sample_pop_size * pop_prop, # Prevalence of autism in the group, standardised to standard population
         w = std_pop / (sample_pop_size * n_stdpop), # Weight of the group using standard population
         w2 = pop_prop / sample_pop_size) %>%
  ungroup()

aut_newprev_araucS_adj_6 <- get_adjusted_prev(rename(aut_newprev_araucS_6, "n_disease" = "yes_autism_linked"),
                                              grouping_vars = c()) %>%
  mutate(sex_desc = "Male",
         age_cat_name = "6-8") %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))

# Age 9-11
aut_newprev_araucS_9 <- school_patients_grouped %>%
  filter(age_cat_name == "9-11") %>%
  rename(age = age_june30) %>%
  mutate(yes_autism_linked = ifelse(is.na(yes_autism_linked), 0, yes_autism_linked), # If there are no cases of autism in the group, input 0
         sample_pop_size = no_autism_linked + yes_autism_linked, # Total sample population is autism cases + not cases
         sample_prevalence = yes_autism_linked / sample_pop_size) %>% # Prevalence of autism in the group
  left_join(chile_stdpop_9, by = c("age", "sex")) %>%
  mutate(disease_prev_std = yes_autism_linked / sample_pop_size * pop_prop, # Prevalence of autism in the group, standardised to standard population
         w = std_pop / (sample_pop_size * n_stdpop), # Weight of the group using standard population
         w2 = pop_prop / sample_pop_size) %>%
  ungroup()

aut_newprev_araucS_adj_9 <- get_adjusted_prev(rename(aut_newprev_araucS_9, "n_disease" = "yes_autism_linked"),
                                              grouping_vars = c()) %>%
  mutate(sex_desc = "Male",
         age_cat_name = "9-11") %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))

# Age 12-14
aut_newprev_araucS_12 <- school_patients_grouped %>%
  filter(age_cat_name == "12-14") %>%
  rename(age = age_june30) %>%
  mutate(yes_autism_linked = ifelse(is.na(yes_autism_linked), 0, yes_autism_linked), # If there are no cases of autism in the group, input 0
         sample_pop_size = no_autism_linked + yes_autism_linked, # Total sample population is autism cases + not cases
         sample_prevalence = yes_autism_linked / sample_pop_size) %>% # Prevalence of autism in the group
  left_join(chile_stdpop_12, by = c("age", "sex")) %>%
  mutate(disease_prev_std = yes_autism_linked / sample_pop_size * pop_prop, # Prevalence of autism in the group, standardised to standard population
         w = std_pop / (sample_pop_size * n_stdpop), # Weight of the group using standard population
         w2 = pop_prop / sample_pop_size) %>%
  ungroup()

aut_newprev_araucS_adj_12 <- get_adjusted_prev(rename(aut_newprev_araucS_12, "n_disease" = "yes_autism_linked"),
                                              grouping_vars = c()) %>%
  mutate(sex_desc = "Male",
         age_cat_name = "12-14") %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))

# Age 15-18
aut_newprev_araucS_15 <- school_patients_grouped %>%
  filter(age_cat_name == "15-18") %>%
  rename(age = age_june30) %>%
  mutate(yes_autism_linked = ifelse(is.na(yes_autism_linked), 0, yes_autism_linked), # If there are no cases of autism in the group, input 0
         sample_pop_size = no_autism_linked + yes_autism_linked, # Total sample population is autism cases + not cases
         sample_prevalence = yes_autism_linked / sample_pop_size) %>% # Prevalence of autism in the group
  left_join(chile_stdpop_15, by = c("age", "sex")) %>%
  mutate(disease_prev_std = yes_autism_linked / sample_pop_size * pop_prop, # Prevalence of autism in the group, standardised to standard population
         w = std_pop / (sample_pop_size * n_stdpop), # Weight of the group using standard population
         w2 = pop_prop / sample_pop_size) %>%
  ungroup()

aut_newprev_araucS_adj_15 <- get_adjusted_prev(rename(aut_newprev_araucS_15, "n_disease" = "yes_autism_linked"),
                                              grouping_vars = c()) %>%
  mutate(sex_desc = "Male",
         age_cat_name = "15-18") %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))

aut_newprev_araucS_agecat_adj <- rbind(aut_newprev_araucS_adj_6,
                                       aut_newprev_araucS_adj_9,
                                       aut_newprev_araucS_adj_12,
                                       aut_newprev_araucS_adj_15) 

aut_newprev_araucS_agecat_adj.table <- aut_newprev_araucS_agecat_adj %>% 
  select(age_cat_name, crude_prev_ci, adjusted_prev_ci)

kbl(aut_newprev_araucS_agecat_adj.table, 
  col.names = c("Age band", "Crude prevalence (95% CI)", "Adjusted prevalence (95% CI)"),
  align = "lrr",
  booktabs = TRUE,
  format = "pandoc",
  linesep = c(""), # No white space
  caption = "Age- and sex-adjusted updated autism prevalence from data linkage in SSAS by age band with 95% gamma confidence intervals.") 
```

After linking the school and patient data for SSAS, `r format(patients_matched_small_dedup %>% filter(matched == 0) %>% nrow(), big.mark = ",", trim = TRUE)` patients with autism could not be matched to students which represents the unmet need of SSAS students with autism that do not access school-based support for it. After data linkage, the age- and sex-adjusted updated prevalence of autism in SSAS is `r sprintf("%.2f", round(aut_newprev_araucS_adj$adjusted_rate * 100, 2))`% (`r round(aut_newprev_araucS_adj$adjusted_ci_lower * 100, 2)`-`r round(aut_newprev_araucS_adj$adjusted_ci_upper * 100, 2)`%). This includes the students in the school data that access SEED for autism and the additional individuals identified in the patient data as having autism but not accessing SEED for it. The sample size here is `r format(aut_newprev_araucS_adj$sum_sample_pop_size, big.mark = ",", trim = TRUE)`, the same as the number of students resident in SSAS as no individuals have been added, only non-cases in the school data reallocated as cases based on the patient data linkage findings. For females, the adjusted updated prevalence is `r round(aut_newprev_araucS_adj_f$adjusted_rate * 100, 2)`% (`r round(aut_newprev_araucS_adj_f$adjusted_ci_lower * 100, 2)`-`r round(aut_newprev_araucS_adj_f$adjusted_ci_upper * 100, 2)`%) and for males it is `r round(aut_newprev_araucS_adj_m$adjusted_rate * 100, 2)`% (`r round(aut_newprev_araucS_adj_m$adjusted_ci_lower * 100, 2)`-`r round(aut_newprev_araucS_adj_m$adjusted_ci_upper * 100, 2)`%). This gives a updated male to female ratio of `r round(aut_newprev_araucS_adj_m$crude_rate / aut_newprev_araucS_adj_f$crude_rate, 2)` after data linkage. Updated autism prevalence is highest among individuals aged 6-8 at `r round(aut_newprev_araucS_adj_6$adjusted_rate * 100, 2)`% (`r round(aut_newprev_araucS_adj_6$adjusted_ci_lower * 100, 2)`-`r round(aut_newprev_araucS_adj_6$adjusted_ci_upper * 100, 2)`%) and decreases with age, see Table \@ref(tab:adjNewprevAraucSAgecat). 

Taking the adjusted updated prevalence of autism for SSAS and assuming it is applicable across all health services gives a posited `r format(round(aut_newprev_araucS_adj$adjusted_rate * nrow(chile_bayes), 0), big.mark = ",", trim = TRUE)` children aged 6-18 with autism in Chile and an unmet need of `r format((aut_newprev_araucS_adj$adjusted_rate - aut_prev_adj$adjusted_rate) * nrow(chile_bayes) , big.mark = ",", trim = TRUE)` children that do not access SEED for autism.

```{r newPrevAraucS}
araucS_lower_prev <- aut_prev_health_adj %>%
  filter(health_service_name == "Araucanía Sur") %>%
  select(adjusted_rate) %>% as.numeric()
araucS_upper_prev <- aut_newprev_araucS_adj %>%
  select(adjusted_rate) %>% as.numeric()

prev_delta <- araucS_upper_prev - araucS_lower_prev

araucS_lower <- aut_prev_health_adj %>%
  filter(health_service_name == "Araucanía Sur") %>%
  select(adjusted_count) %>% as.numeric()
araucS_upper <- aut_newprev_araucS_adj %>%
  select(adjusted_count) %>% as.numeric()
# araucS_mean <- (araucS_upper + araucS_lower) / 2
# araucS_sd <- (araucS_upper - araucS_lower) / (2*1.96)

aut_prev_health_adj$new_rate <- numeric(nrow(aut_prev_health_adj))
aut_prev_health_adj$new_ci_lower <- numeric(nrow(aut_prev_health_adj))
aut_prev_health_adj$new_ci_upper <- numeric(nrow(aut_prev_health_adj))
aut_prev_health_adj$new_count <- numeric(nrow(aut_prev_health_adj))

for(i in 1:nrow(aut_prev_health_adj)) {
  if(aut_prev_health_adj$health_service_name[i] == "Araucanía Sur") {
    aut_prev_health_adj$new_rate[i] <- araucS_upper_prev
    aut_prev_health_adj$new_ci_lower[i] <- aut_newprev_araucS_adj$adjusted_ci_lower
    aut_prev_health_adj$new_ci_upper[i] <- aut_newprev_araucS_adj$adjusted_ci_upper
    aut_prev_health_adj$new_count[i] <- araucS_upper
  }
  else {
    adjusted_ci_width <- aut_prev_health_adj$adjusted_ci_upper[i] - aut_prev_health_adj$adjusted_ci_lower[i]
    aut_prev_health_adj$new_rate[i] <- aut_prev_health_adj$adjusted_rate[i] + prev_delta
    aut_prev_health_adj$new_ci_lower[i] <- aut_prev_health_adj$new_rate[i] - 0.5*adjusted_ci_width
    aut_prev_health_adj$new_ci_upper[i] <- aut_prev_health_adj$new_rate[i] + 0.5*adjusted_ci_width
    aut_prev_health_adj$new_count[i] <- round(aut_prev_health_adj$new_rate[i] * aut_prev_health_adj$sum_sample_pop_size[i], 0)
  }
}

aut_newprev_health_adj.table <- aut_prev_health_adj %>% 
  mutate(new_prev_ci = paste0(sprintf("%.2f", round(new_rate * 100, 2)),
                            " (",
                            sprintf("%.2f", round(new_ci_lower * 100, 2)),
                            ", ", 
                            sprintf("%.2f", round(new_ci_upper * 100, 2)),
                            ")")) %>%
  select(health_service_name, adjusted_prev_ci, new_prev_ci)
kbl(aut_newprev_health_adj.table,
    col.names = c("Health service", "Adjusted prevalence (95% CI)", "Adjusted updated prevalence (Equivalent CI)"),
    align = "lrr",
    booktabs = TRUE,
    format = "pandoc",
    linesep = c(""), # No extra white space
    caption = "Adjusted prevalence and adjusted updated prevalence of autism by health service in Chile. Adjusted prevalence is from school data only. Adjusted updated prevalence is from linkage of school data and patient data. Prevalences for Servicio de Salud Araucanía Sur were calculated directly from linkage results. Prevalences for other health services were calcuated by adding the adjusted prevalence delta to each health service's adjusted prevalence from the school data only. Adjusted prevalence has 95% gamma confidence intervals and adjusted updated prevalence has confidence intervals equal in width to the school data adjusted prevalence intervals for each health service, except for SSAS which has the 95% gamma confidence intervals found earlier.") %>%
  add_header_above(c(" " = 1, "Adjusted prevalence" = 2))
```

This gives an adjusted prevalence delta for SSAS of `r round(prev_delta * 100, 2)`%. Table \@ref(tab:newPrevAraucS) shows the projection of adjusted updated prevalence from the data linkage for SSAS onto the other health services. The patterns of prevalence across health services are retained and Ñuble has the highest adjusted updated prevalence at `r round(aut_prev_health_adj %>% filter(health_service_code == 29) %>% select(new_rate) %>% as.numeric() * 100, 2)`% (`r round(aut_prev_health_adj %>% filter(health_service_code == 29) %>% select(new_ci_lower) %>% as.numeric() * 100, 2)`, `r sprintf("%.2f", round(aut_prev_health_adj %>% filter(health_service_code == 29) %>% select(new_ci_upper) %>% as.numeric() * 100, 2))`%).

## Bayesian prevalence projection

```{r bayesSetup}
nObs <- nrow(chile_bayes_aut)
nIter <- 2000
nBurn <- 2000
nFeat <- length(unique(aut_prev_health_adj$health_service_code))
FeatNames <- sort(unique(aut_prev_health_adj$health_service_code))
```

```{r bayesConstantPrior, fig.cap = "Posterior predictive distributions for autism prevalence using adjusted case counts from the school data with a random effect on student's health service. Beta conjugate prior of age- and sex-adjusted global autism prevalence from school data. Red dashed lines show the adjusted sample prevalence 95% gamma confidence intervals and blue dotted lines show the posterior 95% credible interval.", fig.height=8, fig.width=8.5}
# Same prior for all health services - specifically the global prevalence in school data
# Could change these to health service specific priors - specifically the adjusted prevalences by health service
aut_theta_mu_prior <- aut_prev_adj$adjusted_rate
#aut_theta_mu_prior_rep <- data.frame(mu = rep(aut_prev_adj$adjusted_rate, times = nFeat), 
#                                     health_service_name = aut_prev_health_adj$health_service_name)
aut_theta_sigma_prior <- (aut_prev_adj$adjusted_ci_upper - aut_prev_adj$adjusted_ci_lower) / (2*1.96)
# # Females
# aut_theta_mu_prior_f <- aut_prev_adj_f$adjusted_rate
# aut_theta_sigma_prior_f <- sqrt(aut_prev_adj_f$var)
# # Males
# theta_mu_prior_m <- aut_prev_adj_m$adjusted_rate
# theta_sigma_prior_m <- sqrt(aut_prev_adj_m$var)

rand_model_constant <- "model {
  for(i in 1:nFeat) { # For each category in the feature grouping
    theta[i] ~ dbeta(theta_a, theta_b)
    disease_sample[i] ~ dbin(theta[i], nObs[i])
    disease_pred[i] ~ dbin(theta[i], nObs[i])
  }
}"

pars <- c("theta_a", "theta_b", "theta", "disease_sample", "disease_pred")

health_low_post <- do_jags_rand_model(x = aut_prev_health_adj,
                              feat = "health_service_name",
                              model = rand_model_constant,
                              theta_mu = aut_theta_mu_prior,
                              theta_sigma = aut_theta_sigma_prior,
                              pars = pars, 
                              convergence_checks = FALSE) %>%
  rename("health_service_name" = "Feat_names")



health_const_post_ci <- health_low_post %>%
  group_by("health_service_name") %>%
  summarise(post_lower = quantile(predicted_prev, 0.025),
            post_upper = quantile(predicted_prev, 0.975))
  
ggplot() +
  geom_density(data = health_low_post, aes(x = predicted_prev*100)) +
  geom_vline(data = health_const_post_ci, aes(xintercept = post_lower*100), color = "blue", linetype = "dotted") +
  geom_vline(data = health_const_post_ci, aes(xintercept = post_upper*100), color = "blue", linetype = "dotted") +
  #geom_vline(data = aut_theta_mu_prior_rep, aes(xintercept = mu), color = "green", linetype = "dashed") +
  geom_vline(data = aut_prev_health_adj, aes(xintercept = adjusted_ci_lower*100), color = "red", linetype = "dashed") +
  geom_vline(data = aut_prev_health_adj, aes(xintercept = adjusted_ci_upper*100), color = "red", linetype = "dashed") +
  facet_wrap(~health_service_name) +
  labs(title = "Posterior predictive distributions for common lower bound",
       x = "Prevalence %",
       y = "Density")


```

Bayesian prevalence projections by health service with common global autism prevalence prior is shown in Figure \@ref(fig:bayesConstantPrior). The differences in adjusted sample prevalence across health services are evident in the red bands and the posterior predictive distributions have been pulled towards the common prior. For regions like Ñuble which have adjusted sample prevalence in the school data higher than the global adjusted prevalence, these posterior densities are not plausible.

```{r bayesLowPrior, fig.cap = "Posterior predictive distributions for autism prevalence using adjusted case counts from the school data with a random effect on student's health service. Beta conjugate prior of health service specific age- and sex-adjusted autism prevalence from school data. Red dashed lines show the adjusted sample prevalence 95% gamma confidence intervals and blue dotted lines show the posterior 95% credible interval.", fig.height=8, fig.width=8.5}
# Now have health service specific priors so need to provide them as vectors and index each as needed
rand_model_low <- "model {
  for(i in 1:nFeat) { # For each category in the feature grouping
    theta[i] ~ dbeta(theta_a[i], theta_b[i])
    disease_sample[i] ~ dbin(theta[i], nObs[i])
    disease_pred[i] ~ dbin(theta[i], nObs[i])
  }
}"

pars <- c("theta_a", "theta_b", "theta", "disease_sample", "disease_pred")

# Define beta prior
theta_mu <- aut_prev_health_adj$adjusted_rate
#theta_mu.df <- data.frame(theta_mu = theta_mu, 
#                          health_service_codee = FeatNames)
#theta_mu <- (aut_prev_health_adj$new_rate + aut_prev_health_adj$adjusted_rate) / 2
theta_sigma <- (aut_prev_health_adj$adjusted_ci_upper - aut_prev_health_adj$adjusted_ci_lower) / (2*1.96)
#theta_sigma <- (aut_prev_health_adj$new_rate - aut_prev_health_adj$adjusted_rate) / (2*1.96)
theta_a <- theta_mu * (theta_mu * (1-theta_mu) / theta_sigma^2 - 1)
theta_b <- (1 - theta_mu) * (theta_mu * (1-theta_mu) / theta_sigma^2 - 1)

# Initial values for model chains
rand_ini <- list(list(theta = rep(0.001, nFeat)),
                 list(theta = rep(0.01, nFeat)))
# Run JAGS model
rand_data <- list(theta_a = theta_a,
                  theta_b = theta_b,
                  nObs = aut_prev_health_adj$sum_sample_pop_size,
                  aut_sample = aut_prev_health_adj$adjusted_count,
                  nFeat = nFeat)
rand_jag <- jags.model(textConnection(rand_model_low),
                       data = rand_data,
                       inits = rand_ini,
                       n.chains = 2,
                       quiet = TRUE)
update(rand_jag, n.iter = nBurn)
rand_sam <- coda.samples(model = rand_jag,
                         variable.names = pars,
                         n.iter = nIter)

convergence_check <- FALSE
if(convergence_check) {
  print(mcmc_trace(rand_sam, paste0("theta[", 1:nFeat, "]"))) # Convergence looks fine and rhats <= 1.1
  print(mcmc_trace(rand_sam, paste0("disease_pred[", 1:nFeat, "]"))) # Convergence looks fine and rhats <= 1.1
  rand_summ <- summary(subset_draws(as_draws(rand_sam), pars),
                           ~quantile(.x, probs=c(0.025, 0.5, 0.975)),
                           ~mcse_quantile(.x, probs=c(0.025, 0.5, 0.975)),
                           "rhat") %>%
        arrange(desc(rhat))
  print(rand_summ)
}

aut_prev_health_post_new <- as_tibble(as_draws_matrix(rand_sam), rownames = "Iteration") %>%
    select(c("Iteration", contains("theta["))) %>%
    pivot_longer(cols = contains("theta["),
                 names_to = "health_service_code",
                 values_to = "predicted_prev") %>%
    mutate(Feat_names = factor(health_service_code, levels = c(paste0("theta[",1:nFeat,"]")), labels = FeatNames)) %>%
    select(Iteration, Feat_names, predicted_prev) %>%
  rename(health_service_code = Feat_names) %>%
  merge(health_service_lookup, by = "health_service_code") %>%
  rename(health_service_name_long = health_service_name,
         health_service_name = health_service_name_short)
  
# Plot manually because we need different CI's now
aut_prev_health_post_new_ci <- aut_prev_health_post_new %>%
  group_by(health_service_name) %>%
  summarise(post_lower = quantile(predicted_prev, 0.025),
            post_upper = quantile(predicted_prev, 0.975))
  
ggplot() +
  geom_density(data = aut_prev_health_post_new, aes(x = predicted_prev*100)) +
  geom_vline(data = aut_prev_health_post_new_ci, aes(xintercept = post_lower*100), color = "blue", linetype = "dotted") +
  geom_vline(data = aut_prev_health_post_new_ci, aes(xintercept = post_upper*100), color = "blue", linetype = "dotted") +
  #geom_vline(data = theta_mu.df, aes(xintercept = theta_mu), color = "green", linetype = "dashed") +
  geom_vline(data = aut_prev_health_adj, aes(xintercept = adjusted_ci_lower*100), color = "red", linetype = "dashed") +
  geom_vline(data = aut_prev_health_adj, aes(xintercept = adjusted_ci_upper*100), color = "red", linetype = "dashed") +
  facet_wrap(~health_service_name) +
  labs(title = "Posterior predictive distribution for health service specific lower bound priors",
       x = "Prevalence %",
       y = "Density")

```

Figure \@ref(fig:bayesLowPrior) shows Bayesian prevalence projections by health service with health service specific priors. As expected, the posterior 95% credible intervals are coincident with the adjusted sample prevalence 95% confidence intervals. The posterior prevalence peaks can be considered lower bounds for the true autism prevalence in each health service.

```{r bayesHighPrior, fig.cap = "Posterior predictive distributions for autism prevalence using adjusted case counts from the school data with a random effect on student's health service. Beta conjugate prior of health service specific age- and sex-adjusted updated autism prevalence from data linkage. Red dashed lines show the adjusted sample prevalence 95% gamma confidence intervals and blue dotted lines show the posterior 95% credible interval.", fig.height=8, fig.width=8.5}
# Now have health service specific priors so need to provide them as vectors and index each as needed
rand_model_high <- "model {
  for(i in 1:nFeat) { # For each category in the feature grouping
    theta[i] ~ dbeta(theta_a[i], theta_b[i])
    disease_sample[i] ~ dbin(theta[i], nObs[i])
    disease_pred[i] ~ dbin(theta[i], nObs[i])
  }
}"

pars <- c("theta_a", "theta_b", "theta", "disease_sample", "disease_pred")

# Define beta prior
theta_mu <- aut_prev_health_adj$new_rate
#theta_mu <- (aut_prev_health_adj$new_rate + aut_prev_health_adj$adjusted_rate) / 2
theta_sigma <- (aut_prev_health_adj$new_ci_upper - aut_prev_health_adj$new_ci_lower) / (2*1.96)
#theta_sigma <- (aut_prev_health_adj$new_rate - aut_prev_health_adj$adjusted_rate) / (2*1.96)
theta_a <- theta_mu * (theta_mu * (1-theta_mu) / theta_sigma^2 - 1)
theta_b <- (1 - theta_mu) * (theta_mu * (1-theta_mu) / theta_sigma^2 - 1)

# Initial values for model chains
rand_ini <- list(list(theta = rep(0.001, nFeat)),
                 list(theta = rep(0.01, nFeat)))
# Run JAGS model
rand_data <- list(theta_a = theta_a,
                  theta_b = theta_b,
                  nObs = aut_prev_health_adj$sum_sample_pop_size,
                  aut_sample = aut_prev_health_adj$adjusted_count,
                  nFeat = nFeat)
rand_jag <- jags.model(textConnection(rand_model_high),
                       data = rand_data,
                       inits = rand_ini,
                       n.chains = 2,
                       quiet = TRUE)
update(rand_jag, n.iter = nBurn)
rand_sam <- coda.samples(model = rand_jag,
                         variable.names = pars,
                         n.iter = nIter)

convergence_check <- FALSE
if(convergence_check) {
  print(mcmc_trace(rand_sam, paste0("theta[", 1:nFeat, "]"))) # Convergence looks fine and rhats <= 1.1
  print(mcmc_trace(rand_sam, paste0("disease_pred[", 1:nFeat, "]"))) # Convergence looks fine and rhats <= 1.1
  rand_summ <- summary(subset_draws(as_draws(rand_sam), pars),
                           ~quantile(.x, probs=c(0.025, 0.5, 0.975)),
                           ~mcse_quantile(.x, probs=c(0.025, 0.5, 0.975)),
                           "rhat") %>%
        arrange(desc(rhat))
  print(rand_summ)
}

aut_prev_health_post_new <- as_tibble(as_draws_matrix(rand_sam), rownames = "Iteration") %>%
    select(c("Iteration", contains("theta["))) %>%
    pivot_longer(cols = contains("theta["),
                 names_to = "health_service_code",
                 values_to = "predicted_prev") %>%
    mutate(Feat_names = factor(health_service_code, levels = c(paste0("theta[",1:nFeat,"]")), labels = FeatNames)) %>%
    select(Iteration, Feat_names, predicted_prev) %>%
  rename(health_service_code = Feat_names) %>%
  merge(health_service_lookup, by = "health_service_code") %>%
  rename(health_service_name_long = health_service_name,
         health_service_name = health_service_name_short)
  
# Plot manually because we need different CI's now
aut_prev_health_post_new_ci <- aut_prev_health_post_new %>%
  group_by(health_service_name) %>%
  summarise(post_lower = quantile(predicted_prev, 0.025),
            post_upper = quantile(predicted_prev, 0.975))
  
ggplot() +
  geom_density(data = aut_prev_health_post_new, aes(x = predicted_prev*100)) +
  geom_vline(data = aut_prev_health_post_new_ci, aes(xintercept = post_lower*100), color = "blue", linetype = "dotted") +
  geom_vline(data = aut_prev_health_post_new_ci, aes(xintercept = post_upper*100), color = "blue", linetype = "dotted") +
  geom_vline(data = aut_prev_health_adj, aes(xintercept = adjusted_ci_lower*100), color = "red", linetype = "dashed") +
  geom_vline(data = aut_prev_health_adj, aes(xintercept = adjusted_ci_upper*100), color = "red", linetype = "dashed") +
  facet_wrap(~health_service_name) +
  labs(title = "Posterior predictive distribution for health service specific upper bound priors",
       x = "Prevalence %",
       y = "Density")

```

With projected prevalence priors, the Bayesian prevalence projections shown in Figure \@ref(fig:bayesHighPrior) are pulled upward toward their priors by approximately delta. For regions with high sample prevalence such as Ñuble, this addition of delta results in a posterior prevalence projects up to 1.5 percentage points higher than the global adjusted prevalence for the school data only which may not be plausible.

```{r bayesUniformPrior, fig.cap = "Posterior predictive distributions for autism prevalence using adjusted case counts from the school data with a random effect on student's health service. Uniform prior bounded by health service specific age- and sex-adjusted autism prevalence from school data, and health service specific age- and sex-adjusted updated autism prevalence from data linkage. Red dashed lines show the adjusted sample prevalence 95% gamma confidence intervals and blue dotted lines show the posterior 95% credible interval.", fig.height=8, fig.width=8.5}

####### Need to do all by health service code not name because name sorts in different orders.

# Now have health service specific priors so need to provide them as vectors and index each as needed
# OR Uniform prior https://stats.stackexchange.com/questions/555260/how-to-set-prior-for-bayesian-analysis 
rand_model_uniform <- "model {
  for(i in 1:nFeat) { # For each category in the feature grouping
    theta[i] ~ dunif(theta_lower[i], theta_upper[i])     #dbeta(theta_a[i], theta_b[i])
    disease_sample[i] ~ dbin(theta[i], nObs[i])
    disease_pred[i] ~ dbin(theta[i], nObs[i])
    #theta_a[i] <- theta_mu * (theta_mu * (1-theta_mu) / pow(theta_sigma, 2) - 1)
    #theta_b[i] <- (1 - theta_mu) * (theta_mu * (1-theta_mu) / pow(theta_sigma, 2) - 1)
  }
  #theta_mu ~ dunif(0, 1)
  #theta_sigma ~ dexp(1)
}"

pars <- c("theta", "disease_sample", "disease_pred")

# Define uniform prior
theta_lower <- aut_prev_health_adj$adjusted_rate
theta_upper <- aut_prev_health_adj$new_rate

# Initial values for model chains
rand_ini <- list(list(theta = rep(0.001, nFeat)),
                 list(theta = rep(0.01, nFeat)))
# Run JAGS model
rand_data <- list(theta_lower = theta_lower,
                  theta_upper = theta_upper,
                  nObs = aut_prev_health_adj$sum_sample_pop_size,
                  aut_sample = aut_prev_health_adj$adjusted_count,
                  nFeat = nFeat)
rand_jag <- jags.model(textConnection(rand_model_uniform),
                       data = rand_data,
                       inits = rand_ini,
                       n.chains = 2,
                       quiet = TRUE)
update(rand_jag, n.iter = nBurn)
rand_sam <- coda.samples(model = rand_jag,
                         variable.names = pars,
                         n.iter = nIter)

convergence_check <- FALSE
if(convergence_check) {
  print(mcmc_trace(rand_sam, paste0("theta[", 1:nFeat, "]"))) # Convergence looks fine and rhats <= 1.1
  print(mcmc_trace(rand_sam, paste0("disease_pred[", 1:nFeat, "]"))) # Convergence looks fine and rhats <= 1.1
  rand_summ <- summary(subset_draws(as_draws(rand_sam), pars),
                           ~quantile(.x, probs=c(0.025, 0.5, 0.975)),
                           ~mcse_quantile(.x, probs=c(0.025, 0.5, 0.975)),
                           "rhat") %>%
        arrange(desc(rhat))
  print(rand_summ)
}

aut_prev_health_post_new <- as_tibble(as_draws_matrix(rand_sam), rownames = "Iteration") %>%
    select(c("Iteration", contains("theta["))) %>%
    pivot_longer(cols = contains("theta["),
                 names_to = "health_service_code",
                 values_to = "predicted_prev") %>%
    mutate(Feat_names = factor(health_service_code, levels = c(paste0("theta[",1:nFeat,"]")), labels = FeatNames)) %>%
    select(Iteration, Feat_names, predicted_prev) %>%
  rename(health_service_code = Feat_names) %>%
  merge(health_service_lookup, by = "health_service_code") %>%
  rename(health_service_name_long = health_service_name,
         health_service_name = health_service_name_short)
  

# Plot manually because we need different CI's now
aut_prev_health_post_new_ci <- aut_prev_health_post_new %>%
  group_by(health_service_name) %>%
  summarise(post_lower = quantile(predicted_prev, 0.025),
            post_upper = quantile(predicted_prev, 0.975))
  
ggplot() +
  geom_density(data = aut_prev_health_post_new, aes(x = predicted_prev*100)) +
  geom_vline(data = aut_prev_health_post_new_ci, aes(xintercept = post_lower*100), color = "blue", linetype = "dotted") +
  geom_vline(data = aut_prev_health_post_new_ci, aes(xintercept = post_upper*100), color = "blue", linetype = "dotted") +
  #geom_vline(data = aut_prev_health_adj, aes(xintercept = adjusted_rate), color = "green", linetype = "dashed") +
  #geom_vline(data = aut_prev_health_adj, aes(xintercept = new_rate), color = "green", linetype = "dashed") +
  geom_vline(data = aut_prev_health_adj, aes(xintercept = adjusted_ci_lower*100), color = "red", linetype = "dashed") +
  geom_vline(data = aut_prev_health_adj, aes(xintercept = adjusted_ci_upper*100), color = "red", linetype = "dashed") +
  facet_wrap(~health_service_name) +
  labs(title = "Posterior predicitve distribution for health service specific uniform priors",
       x = "Prevalence %",
       y = "Density")

```

In Figure \@ref(fig:bayesUniformPrior), the posterior distributions are reflective of their uniform priors with posterior credible intervals slightly within the prior bounds (Table \@ref(tab:newPrevAraucS)). These predictive densities show a considerable departure from the adjusted sample prevalence from the school data and provide a window within which the true prevalence of recorded autism in each health service would plausibly fall.

#	Discussion

## Findings

###	Aim 1: Use school data and frequentist method to find a lower bound on autism and ADHD prevalence

In Chilean 6–18-year-old students, the observed crude prevalence of autism is highest in young students and decreases with age, and this pattern is preserved across demographic features. Assuming true autism prevalence increases with age as individuals can be diagnosed well into adulthood, this result shows that it is easier for young children to access SEN funding in Chile. This could be the result of improved awareness of the SEED programme and policy changes in Chile to increase accessibility and participation for students with autism (11), and could also indicate that students with autism need fewer schooling interventions as they mature. A lower bound on autism prevalence in Chile is `r round(aut_prev_adj$adjusted_rate * 100, 2)`% which is higher than estimates for Venezuela and Ecuador but lower than Argentina and Yáñez et al’s estimate for Chile (18–21).

The crude prevalence of ADHD in Chilean students is highest for early teenagers then decreases somewhat and this pattern is also preserved across demographic features. This suggests ADHD is diagnosed later than autism which is somewhat consistent with others’ work including Sainsbury et al. who note that autism is typically diagnosed at age 5 and ADHD at age 6 (59). The observed decrease in ADHD prevalence in later teenage years could indicate reduced ability to access schooling interventions with age, or reduced need for them. A lower bound on ADHD prevalence across Chile is `r round(adhd_prev_adj$adjusted_rate * 100, 2)`% which is much lower than de la Barra et al. and Vicente et al.’s prevalences of 10.0% and 12.6% respectively (34,35). This is most likely due to the data providing at most one special needs code per student, the high rate of co-diagnosis of ADHD and autism, and autism being more likely to be recorded than ADHD in the case of co-diagnosis (31). More worked focused on ADHD will be needed to quantify how far this lower bound is from the true ADHD prevalence in Chile but it may well be the case that patterns of ADHD distribution found here are preserved in the Chilean population when ADHD cases not recorded here are included.

This investigation appears to show autism and ADHD prevalence is very low in students with the highest socio-economic status, however this is most likely due to data artefacts as privately educated students are ineligible for SEED funding and therefore will not appear has having either condition in this data. No other clear differences in the prevalence of autism or of ADHD by socio-economic status has been found. For ADHD, this is consistent with de la Barra et al.’s findings in Chile (34).

Prevalence of autism and ADHD is lower among students of the Mapuche and other Indigenous groups than among non-Indigenous students, except for autism prevalence for students from other Indigenous groups). This agrees with Lindblom’s findings that Indigenous children with autism in Canada’s British Colombia are underrepresented in school data (60). However it is important to note here that people Indigenous to different regions are not necessarily comparable and very little research has been done on autism and ADHD in Indigenous people in Latin America. 

Autism and ADHD prevalence is higher in rural schools that urban school which is somewhat surprising as urban areas generally have more resources to diagnose and provide adjustments for these conditions, but may be the result of successful implementation of policy interventions described by Núñez and Manzano that aimed to improve healthcare for disadvantaged areas and population groups (4).

###	Aim 2: Use clinical data and machine learning to identify autism diagnosis characteristics

MCA revealed that age, ethnicity and commune of residence, and to some extent disability status, foster care status and health insurance level, are important features for understanding the distribution of autism diagnosis. The clustering of patients based on whether information was available for disability and foster care status shows that missingness in demographic data is important when understanding autism diagnoses. The variance explained by the available features is not large enough to draw strong conclusions about possible composite components associated with autism diagnosis, but it does indicate that further investigation with larger dataset and more demographic characteristics are likely to lead to interesting results.

###	Aim 3a: Use machine learning to link school and clinical records

Chi squared testing showed that students living in SSAS are different to students in other communes for by age band, SES, ethnicity, rurality and special needs status. For the most part this is not surprising as La Araucanía region is known to be poor, rural and have a large Mapuche population (7)(10)(61). SSAS has a somewhat older student population than other regions and significantly fewer students access SEED funding for any condition, meaning the adjusted autism prevalence estimate for SSAS from the school data only of `r sprintf("%.2f", round(aut_prev_health_adj$crude_rate[5] * 100, 2))`% is likely to be an underestimate.

Both manual and probabilistic linkage of SSAS school and patient data of individuals with autism were able to identify a reasonable number of matches. Probabilistic matching was more effective than manual matching here because matching on commune of residence was desirable but not essential, proxy SES features were known to be imprecise so requiring perfect matches would miss many correct matches, and probabilistic matching was able to identify more likely matches.

The proportions of matched and unmatched records in the SSAS school and patient datasets did differ by sex, commune of residence and proxy SES. The differences appear to be driven by differences in the frequency of these features’ categories across the two datasets. In particular, the male to female ratio of people with autism in the patient data is `r round(patients %>% filter(sex_desc == "Male") %>% nrow() / patients %>% filter(sex_desc == "Female") %>% nrow(), 2)`:1 which is very consistent with Yáñez et al’s estimate of 4:1 in the Estación Central commune of Servicio de Salud Metropolitano Central and Santiago commune of Servicio de Salud Metropolitano Occidente, both in Santiago (18). In the SSAS school data, the male to female ratio is `r sprintf("%.2f", round(school_matched_small %>% filter(sex_desc.school == "Male") %>% nrow() / school_matched_small %>% filter(sex_desc.school == "Female") %>% nrow(), 2))`:1, and in the school data for SSAS for students with and without autism it is `r sprintf("%.2f", round(school_ssas %>% filter(sex_desc == "Male") %>% nrow() / school_ssas %>% filter(sex_desc == "Female") %>% nrow(), 2))`:1. This suggests females with autism are underrepresented in the school data and may indicate that there are barriers to females accessing SEED for autism.

###	Aim 3b: Accurately estimate autism prevalence and project prevalence bounds across health services using Bayesian prevalence prediction

The updated estimate for the prevalence of autism in SSAS is `r sprintf("%.2f", round(aut_newprev_araucS_adj$adjusted_rate * 100, 2))`% with a male to female ratio of `r round(aut_newprev_araucS_adj_m$crude_rate / aut_newprev_araucS_adj_f$crude_rate, 2)`. This sex ratio is consistent with the 4:1 ratio found by Yáñez et al (18). The is updated prevalence estimate found here is likely to be an underestimate due to not having private sector diagnoses in the clinical data and it is  somewhat smaller than Yáñez et al’s estimate of 1.96% (0.81-4.63) in Santiago communes but well within their estimate’s confidence interval (18). The sex ratio is also reasonably consistent with Roman-Urrestarazu et al.’s finding of a 4.32:1 ratio in 120,000 English school children but their prevalence estimate was higher at 1.76% (1.75%-1.77%) (23). This suggests either that the data linkage has missed some autism cases, or that autism prevalence is lower or diagnosis less available in Chile than in the UK.

Projecting the adjusted prevalence delta across all regions resulted in updated estimates for all health services that are comparable to Yáñez et al’s estimate (18). Ñuble’s standard adjusted prevalence estimate is considerably higher than for other communes which may indicate that Ñuble uses a different approach for autism SEED funding assessment and this figure may be more indicative of Chile’s true autism prevalence. Using the same adjusted prevalence delta for all regions may not have been appropriate given the regions differ considerably in prevalence observed from the school data. Additionally, SSAS is in the bottom third of adjusted prevalence estimates, meaning it is likely to have a larger difference between adjusted prevalence from the school data and true prevalence. If we can assume the adjusted updated prevalence for SSAS is the true autism prevalence of Chile then the delta to reach this will be larger for SSAS than for regions with higher original adjusted prevalence from the school data. Therefore using SSAS’s delta in higher prevalence regions will produce overestimates. Ñuble’s adjusted updated prevalence is `r round(aut_prev_health_adj %>% filter(health_service_code == 29) %>% select(new_rate) %>% as.numeric() * 100, 2)`% which is biologically possible but there is a phenotypic upper bound on true autism prevalence and it is more likely that a larger proportion of people with autism in Ñuble are accessing SEED than in other regions.  

The Bayes prevalence projection was able to circumvent issues with the applicability of the adjusted prevalence delta by modelling prevalence within plausible bounds provided by the school and clinical dataset. Using uniform priors specific to the health services that spanned the lower bounds found through frequentist methods to the possibly overestimated adjusted updated prevalences found through linkage, the Bayesian modelling found that the true prevalence of autism in each commune is likely to be considerably higher than the prevalences observed from the school data alone. This analysis has determined a plausible range within which the true prevalence for each region is quantifiably likely to fall. 

[Add something on improvement on Robince which didn’t work because there was too much data, prevalence was too small and computational limitations.]

[Add something on unmet need and sex ratios].

## Limitations

This investigation is limited by the quality of available data. Firstly, the school data is limited by having only one special needs code available per student as it is based on their SEED status and not all their extant special needs diagnoses. This limitation prompted the use of clinical data to supplement the available diagnoses, however this data is also somewhat limited as validated diagnoses and demographic information were only available for some patients. Additionally, it only includes patients treated in the public health system and the number of patients with autism that are treated privately is unknown. Autism prevalence estimates using clinical data may therefore be underestimates. 

During MCA, the disability and foster care status features were very unbalanced with few patients having a recorded disability and even fewer having experienced foster care. For both features, nearly two thirds of records had no information available and while reasonable imputation was use, any imputation adds bias to the results and here the bias is likely to be considerable as so many values were imputed. This means the MCA results should be taken as indicative and more research done on larger, more complete dataset to confirm them. 

Linkage of school and clinical data for SSAS used matching on proxy SES. In the school data, SES was mapped from school fees paid and in the clinical data it was mapped from health insurance contributions. These underlying features may not be comparable and the mapping to SES used here for each was imprecise. To account for this, a high error rate was declared when allocating weights during probabilistic linkage, however some incorrect matches based on SES may have been made or correct matches been missed. Linkage also assumed that individuals did not move into or out of SSAS communes between collection of the school and patient data. This is unlikely to be true and a small number of correct matches are likely to have been missed due to individuals who moved not being included in one of the SSAS school data or the patient data being linked. Missed correct matches would cause the updated prevalence estimate for SSAS to be slightly too high and therefore projected updated estimates to also be slightly too high.

The Bayesian modelling did use information from the sample data, the full school dataset, twice during modelling, to varying extents for each prior. For all four analyses, random effects models were fit to health services. For the second prior, which used health service specific autism prevalences, this meant the sample data was directly used twice which generally would not be informative but here was valuable to evidence the lower bound on the true prevalences. For the first prior, the sample data was used indirectly to calculate the common global prevalence and was valuable to demonstrate that the prevalences observed from the school data can only be underestimates of the true prevalence. For the third prior, using the updated prevalences found using data linkage, the sample data was used indirectly to give the prevalence values to which delta was added, and the fourth prior combined the second and third. Although it is usually not appropriate to use sample data twice in Bayesian modelling, it was considered acceptable here as the intention was to conduct exploratory analysis to project the bounds on prevalence rather than predict the true autism prevalence across the other health services.

## Extensions

While this investigation has progressed the understanding of autism and ADHD prevalence in Chile, it has also uncovered new avenues for exploration. If clinical data on ADHD diagnoses were available for a region of Chile, the MCA analysis, data linkage and Bayesian projection conducted here for autism could be extended to ADHD. If clinical data on autism for other health service regions were available, the delta calculation could be validated and thus more accurate autism prevalence estimates could be found. 

This investigation has considered autism and ADHD in isolation from each other. However, given 59.1% of people with autism have a co-diagnosis of ADHD (33), it would be valuable to consider these conditions together. MCA of autism patient data could be used to assess contributions from ADHD and other co-diagnoses such as depression and anxiety, physical disability and intellectual disability.

This investigation used MCA to assess the contribution of feature categories among patients with autism in SSAS which required casting the age feature to categorical age bands. However age is a continuous variable and the information contained in it would be better captured using a continuous variable analysis technique such as principle component analysis. The commune feature would need to be excluded because it cannot be meaningfully encoded as a continuous or ordered categorical variable. The remaining features could be one-hot encoded to pseudo-continuous variables before performing PCA. This would allow the contribution of patient age to be better characterised but one-hot encoding would somewhat reduce the power of inferences about the other features used. Cluster-based analysis of a larger dataset containing patients with and without autism would also be valuable and would allow further identification of the characteristics associated with autism diagnosis.

During data linkage, this investigation assumed that unmatched patients in the clinical data existed in the school data but did not have an autism diagnosis in the school data. It would be valuable to test this assumption by attempting to link the patient data for SSAS to all school records for SSAS, including those students that do not have an autism diagnosis. This would allow the number of patients that do not exist in the school data to be estimated which would provide a more accurate sample size for use as the denominator in prevalence calculation. 

This investigation assumed the adjusted prevalence delta found for SSAS was directly applicable to other regions which may not be the case. Further analysis of the Bayesian prevalence projection could use health service specific deltas that are inversely proportional to the sample prevalence observed for each health service. This would decrease the delta for services with high observed prevalence and thus lessen the increase in the updated prevalence estimate, and would increase the updated prevalence estimate for health services with low observed prevalence. This would provide more biologically plausible prevalence estimates, however subsequent Bayesian analysis would be using information from the school data twice – as the sample data and to inform the health service specific prior through use of observed prevalence to scale delta.

Future work could replicate the prevalence estimation conducted here using the UK Department for Education’s National Pupil Database which is similar to the school data used here. This would provide an interesting comparison of autism and ADHD prevalence in two large countries with different population structures and ethnic profiles.

# Conclusions

This investigation has furthered the understanding of autism and ADHD prevalence in Chile. The patterns of autism and ADHD prevalence in Chile are consistent with other countries. A lower bound on prevalence of autism in Chile is `r round(aut_prev_adj$adjusted_rate * 100, 2)`% (`r round(aut_prev_sex_adj$adjusted_rate[2] * 100, 2)`% in females and `r round(aut_prev_sex_adj$adjusted_rate[1] * 100, 2)`% in males) and a lower bound on the prevalence of ADHD is `r round(adhd_prev_adj$adjusted_rate * 100, 2)`% (`r round(adhd_prev_sex_adj$adjusted_rate[2] * 100, 2)`% in females and `r round(adhd_prev_sex_adj$adjusted_rate[1] * 100, 2)`% in males). In Servicio de Salud Araucanía Sur, age, ethnicity and commune of residence were found to be important components for explaining the variance in data on patients with autism. School data and patient data on individuals with autism in SSAS were successfully linked and used to calculate that a more accurate estimate of the prevalence of autism in this region is `r round(aut_newprev_araucS_adj$crude_rate * 100, 2)`% with male to female ratio of `r sprintf("%.2f", round(aut_newprev_araucS_sex_adj$crude_rate[1] / aut_newprev_araucS_sex_adj$crude_rate[2]))` (`r round(aut_newprev_araucS_sex_adj$crude_rate[2] * 100, 2)`% for females and `r round(aut_newprev_araucS_sex_adj$crude_rate[1] * 100, 2)`% for males). This corresponds to an unmet need of `r sum(patients_nomatch_grouped$yes_autism_patients)` additional students in SSAS with autism that do not receive SEED funding for autism. Bayesian prevalence projection extended prevalence projections across health services and demonstrated that the prevalence of recorded autism cases in Chile could up to `r round(aut_prev_health_adj %>% filter(health_service_code == 29) %>% select(new_rate) %>% as.numeric() * 100, 2)`%.

# Supplementary materials

```{r schooldata, include = FALSE}
school_vars <- data.frame(type = c("Student", "", "", "", "", "", "", "",
                                   "School", "", ""),
                          vars = c("Sex",
                                   "Date of birth",
                                   "Ethnicity, nationality and immigration status",
                                   "SEED special needs status",
                                   "Special need eligible for SEED, e.g. autism, ADHD, blindness",
                                   "Residential commune and region", 
                                   "Monthly school fees paid",
                                   "Academic grade for 2021 school year",
                                   "Name",
                                   "Region and commune", 
                                   "Rurality"))
kbl(school_vars,
    col.names = c("Feature type", "Features"),
    align = "l",
    booktabs = TRUE,
    format = "latex",
    linesep = c("", "", "", "", "", "", "", "\\addlinespace", "", "", ""),
    caption = "Features available in the school data")
```

```{r prevAgeAutPlot, fig.cap = "Sample prevalence of autism in school data by age band. Bars show 95% normal confidence intervals.", fig.height=3, fig.pos='H'}
aut_prev.age <- get_grouped_prev_plot(x = chile_bayes_aut, 
                                          grouping_vars = c("age_june30", "autism"),
                                          disease = "autism") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower)) 

ggplot(data = aut_prev.age) +
  geom_col(aes(x = age_june30, y = sample_prevalence*100, group = age_june30, fill = age_june30), position = position_dodge()) +
  geom_errorbar(aes(x = age_june30, ymin = ci_lower*100, ymax = ci_upper*100, group = age_june30), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_viridis_c(option = "plasma") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  labs(title = "Autism prevalence",
       x = "Age band",
       y = "Sample prevalence % (95% CI)",
       fill = "Age band")
```

```{r prevAgeAdhdPlot, fig.cap = "Sample prevalence of ADHD in school data by age band. Bars show 95% normal confidence intervals.", fig.height=3}
adhd_prev.age <- get_grouped_prev_plot(x = chile_bayes_adhd, 
                                          grouping_vars = c("age_june30", "adhd"),
                                          disease = "adhd") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower)) 

ggplot(data = adhd_prev.age) +
  geom_col(aes(x = age_june30, y = sample_prevalence*100, group = age_june30, fill = age_june30), position = position_dodge()) +
  geom_errorbar(aes(x = age_june30, ymin = ci_lower*100, ymax = ci_upper*100, group = age_june30), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_viridis_c(option = "plasma") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  labs(title = "ADHD prevalence",
       x = "Age band",
       y = "Sample prevalence % (95% CI)",
       fill = "Age band")
```

```{r prevAgeSexAutPlot, fig.cap = "Sample prevalence of autism in school data by age and sex. Bars show 95% normal confidence intervals.", fig.height=3}
# Autism
aut_prev.age_sex <- get_grouped_prev_plot(x = chile_bayes_aut, 
                                          grouping_vars = c("age_june30", "sex_desc", "autism"),
                                          disease = "autism") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

# By age and sex
ggplot(data = aut_prev.age_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence, group = age_june30, fill = age_june30), position = position_dodge()) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower, ymax = ci_upper, group = age_june30), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_viridis_c(option = "plasma") +
  labs(title = "Autism prevalence",
       x = "Sex",
       y = "Sample prevalence",
       fill = "Age")

```

```{r prevAgeSexAdhdPlot, fig.cap = "Sample prevalence of ADHD in school data by age and sex. Bars show 95% normal confidence intervals.", fig.height=3}
# ADHD
adhd_prev.age_sex <- get_grouped_prev_plot(x = chile_bayes_adhd, 
                                          grouping_vars = c("age_june30", "sex_desc", "adhd"),
                                          disease = "adhd") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

# By age and sex
ggplot(data = adhd_prev.age_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence, group = age_june30, fill = age_june30), position = position_dodge()) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower, ymax = ci_upper, group = age_june30), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_viridis_c(option = "plasma") +
  labs(title = "ADHD prevalence",
       x = "Sex",
       y = "Sample prevalence",
       fill = "Age")

```

```{r prevAgeHealthAutPlot, fig.cap = "Sample prevalence of autism in school data by health service, age and sex. Bars show 95% normal confidence intervals.", fig.height=10, fig.width=8.5}
# Single ages
aut_prev_health.age_sex <- get_grouped_prev_plot(x = chile_bayes_aut, 
                                                 grouping_vars = c("health_service_name", "age_june30", "sex_desc", "autism"),
                                                 disease = "autism") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

ggplot(data = aut_prev_health.age_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence, group = age_june30, fill = age_june30), position = position_dodge()) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower, ymax = ci_upper, group = age_june30), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_viridis_c(option = "plasma") +
  #theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.2)) +
  facet_wrap(~health_service_name) +
  labs(title = "Autism prevalence by health service",
       x = "Sex",
       y = "Sample prevalence",
       fill = "Age")
```

```{r prevAgeHealthAdhdPlot, fig.cap = "Sample prevalence of ADHD in school data by health service, age and sex. Bars show 95% normal confidence intervals.", fig.height=10, fig.width=8.5}
# Single ages
adhd_prev_health.age_sex <- get_grouped_prev_plot(x = chile_bayes_adhd, 
                                                 grouping_vars = c("health_service_name", "age_june30", "sex_desc", "adhd"),
                                                 disease = "adhd") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

ggplot(data = adhd_prev_health.age_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence, group = age_june30, fill = age_june30), position = position_dodge()) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower, ymax = ci_upper, group = age_june30), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_viridis_c(option = "plasma") +
  #theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.2)) +
  facet_wrap(~health_service_name) +
  labs(title = "ADHD prevalence by health service",
       x = "Sex",
       y = "Sample prevalence",
       fill = "Age")
```

```{r prevAgeEconAAutPlot, fig.cap = "Sample prevalence of autism in school data by socio-economic (SES) status of student's family, age and sex. Bars show 95% normal confidence intervals.", fig.height=6}
# Single ages
aut_prev_econA.age_sex <- get_grouped_prev_plot(x = chile_bayes_aut, 
                                                 grouping_vars = c("school_fee", "age_june30", "sex_desc", "autism"),
                                                 disease = "autism") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

ggplot(data = aut_prev_econA.age_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence, group = age_june30, fill = age_june30), position = position_dodge()) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower, ymax = ci_upper, group = age_june30), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_viridis_c(option = "plasma") +
  #theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.2)) +
  facet_wrap(~school_fee) +
  labs(title = "Autism prevalence by SES",
       x = "Sex",
       y = "Sample prevalence",
       fill = "Age")
```

```{r prevAgeEconAAdhdPlot, fig.cap = "Sample prevalence of ADHD in school data by socio-economic (SES) status of student's family, age and sex. Bars show 95% normal confidence intervals.", fig.height=6}
# Single ages
adhd_prev_econA.age_sex <- get_grouped_prev_plot(x = chile_bayes_adhd, 
                                                 grouping_vars = c("school_fee", "age_june30", "sex_desc", "adhd"),
                                                 disease = "adhd") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

ggplot(data = adhd_prev_econA.age_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence, group = age_june30, fill = age_june30), position = position_dodge()) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower, ymax = ci_upper, group = age_june30), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_viridis_c(option = "plasma") +
  #theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.2)) +
  facet_wrap(~school_fee) +
  labs(title = "ADHD prevalence by SES",
       x = "Sex",
       y = "Sample prevalence",
       fill = "Age")
```

```{r prevAgeEthnicAutPlot, fig.cap = "Sample prevalence of autism in school data by ethnicity, age and sex. Bars show 95% normal confidence intervals.", fig.height=3}
# Single ages
aut_prev_ethnic.age_sex <- get_grouped_prev_plot(x = chile_bayes_aut, 
                                                 grouping_vars = c("ethnic_2_group", "age_june30", "sex_desc", "autism"),
                                                 disease = "autism") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

ggplot(data = aut_prev_ethnic.age_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence, group = age_june30, fill = age_june30), position = position_dodge()) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower, ymax = ci_upper, group = age_june30), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_viridis_c(option = "plasma") +
  #theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.2)) +
  facet_wrap(~ethnic_2_group) +
  labs(title = "Autism prevalence by ethnicity",
       x = "Sex",
       y = "Sample prevalence",
       fill = "Age")
```

```{r prevAgeEthnicAdhdPlot, fig.cap = "Sample prevalence of ADHD in school data by ethnicity, age and sex. Bars show 95% normal confidence intervals.", fig.height=3}
# Single ages
adhd_prev_ethnic.age_sex <- get_grouped_prev_plot(x = chile_bayes_adhd, 
                                                 grouping_vars = c("ethnic_2_group", "age_june30", "sex_desc", "adhd"),
                                                 disease = "adhd") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

ggplot(data = adhd_prev_ethnic.age_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence, group = age_june30, fill = age_june30), position = position_dodge()) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower, ymax = ci_upper, group = age_june30), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_viridis_c(option = "plasma") +
  #theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.2)) +
  facet_wrap(~ethnic_2_group) +
  labs(title = "ADHD prevalence by ethnicity",
       x = "Sex",
       y = "Sample prevalence",
       fill = "Age")
```

```{r prevAgeRuralAutPlot, fig.cap = "Sample prevalence of autism in school data by school's rurality, age and sex. Bars show 95% normal confidence intervals.", fig.height=3}
# Single ages
aut_prev_rural.age_sex <- get_grouped_prev_plot(x = chile_bayes_aut, 
                                                 grouping_vars = c("school_rurality", "age_june30", "sex_desc", "autism"),
                                                 disease = "autism") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

ggplot(data = aut_prev_rural.age_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence, group = age_june30, fill = age_june30), position = position_dodge()) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower, ymax = ci_upper, group = age_june30), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_viridis_c(option = "plasma") +
  #theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.2)) +
  facet_wrap(~school_rurality) +
  labs(title = "Autism prevalence by school's rurality",
       x = "Sex",
       y = "Sample prevalence",
       fill = "Age")
```

```{r prevAgeRuralAdhdPlot, fig.cap = "Sample prevalence of ADHD in school data by school's rurality, age and sex. Bars show 95% normal confidence intervals.", fig.height=3}
# Single ages
adhd_prev_rural.age_sex <- get_grouped_prev_plot(x = chile_bayes_adhd, 
                                                 grouping_vars = c("school_rurality", "age_june30", "sex_desc", "adhd"),
                                                 disease = "adhd") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

ggplot(data = adhd_prev_rural.age_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence, group = age_june30, fill = age_june30), position = position_dodge()) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower, ymax = ci_upper, group = age_june30), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_viridis_c(option = "plasma") +
  #theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.2)) +
  facet_wrap(~school_rurality) +
  labs(title = "ADHD prevalence by school's rurality",
       x = "Sex",
       y = "Sample prevalence",
       fill = "Age")
```

```{r adjPrevPlot, include = FALSE, fig.cap = "Crude and age- and sex-adjusted sample prevalences of autism and ADHD in school data. Bars for crude prevalence show 95% normal confidence intervals and bars for adjusted prevalence show 95% gamma confidence intervals.", fig.height=5}

# Autism
aut_prev_adj.long <- aut_prev_adj %>%
  select(-sum_sample_pop_size, -crude_count, -adjusted_count, -var, -w_M) %>%
  pivot_longer(cols = c(crude_rate, adjusted_rate, crude_ci_lower, crude_ci_upper, adjusted_ci_lower, adjusted_ci_upper),
               names_to = c("type", ".value"),
               names_pattern = "(crude|adjusted)_(.*)") %>%
  mutate(type = factor(type, levels = c("crude", "adjusted"), labels = c("Crude", "Adjusted")))

aut_prev_adj.long_plot <- ggplot(data = aut_prev_adj.long) +
  geom_col(aes(x = type, y = rate, fill = type), position = position_dodge(), show.legend = TRUE) +
  geom_errorbar(aes(x = type, ymin = ci_lower, ymax = ci_upper, group = type), width = 0.2, position = position_dodge(width = 0.9)) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "Autism prevalence",
       y = "Aggregate prevalence",
       fill = "Prevalence")

# ADHD
adhd_prev_adj.long <- adhd_prev_adj %>%
  select(-sum_sample_pop_size, -crude_count, -adjusted_count, -var, -w_M) %>%
  pivot_longer(cols = c(crude_rate, adjusted_rate, crude_ci_lower, crude_ci_upper, adjusted_ci_lower, adjusted_ci_upper),
               names_to = c("type", ".value"),
               names_pattern = "(crude|adjusted)_(.*)") %>%
  mutate(type = factor(type, levels = c("crude", "adjusted"), labels = c("Crude", "Adjusted")))

adhd_prev_adj.long_plot <- ggplot(data = adhd_prev_adj.long) +
  geom_col(aes(x = type, y = rate, fill = type), position = position_dodge(), show.legend = TRUE) +
  geom_errorbar(aes(x = type, ymin = ci_lower, ymax = ci_upper, group = type), width = 0.2, position = position_dodge(width = 0.9)) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "ADHD prevalence",
       y = "Aggregate prevalence",
       fill = "Prevalence")

grid.arrange(aut_prev_adj.long_plot, adhd_prev_adj.long_plot, ncol = 2)
```

```{r adjPrevSexPlot, include = FALSE, fig.cap = "Crude and age- and sex-adjusted sample prevalences of autism and ADHD in school data by sex. Bars for crude prevalence show 95% normal confidence intervals and bars for adjusted prevalence show 95% gamma confidence intervals.", fig.height=5}
# Females
# aut_prev_adj_f.long <- aut_prev_adj_f %>%
#   select(-sum_sample_pop_size, -crude_count, -adjusted_count, -var, -w_M) %>%
#   pivot_longer(cols = c(crude_rate, adjusted_rate, crude_ci_lower, crude_ci_upper, adjusted_ci_lower, adjusted_ci_upper),
#                names_to = c("type", ".value"),
#                names_pattern = "(crude|adjusted)_(.*)") %>%
#   mutate(type = factor(type, levels = c("crude", "adjusted"), labels = c("Crude", "Adjusted")))
# 
# # Males
# aut_prev_adj_m.long <- aut_prev_adj_m %>%
#   select(-sum_sample_pop_size, -crude_count, -adjusted_count, -var, -w_M) %>%
#   pivot_longer(cols = c(crude_rate, adjusted_rate, crude_ci_lower, crude_ci_upper, adjusted_ci_lower, adjusted_ci_upper),
#                names_to = c("type", ".value"),
#                names_pattern = "(crude|adjusted)_(.*)") %>%
#   mutate(type = factor(type, levels = c("crude", "adjusted"), labels = c("Crude", "Adjusted")))

# Autism
aut_prev_sex_adj.long <- #rbind(aut_prev_adj_m.long, aut_prev_adj_f.long)
  aut_prev_sex_adj %>%
  select(-sum_sample_pop_size, -crude_count, -adjusted_count, -var, -w_M) %>%
  pivot_longer(cols = c(crude_rate, adjusted_rate, crude_ci_lower, crude_ci_upper, adjusted_ci_lower, adjusted_ci_upper),
               names_to = c("type", ".value"),
               names_pattern = "(crude|adjusted)_(.*)") %>%
  mutate(type = factor(type, levels = c("crude", "adjusted"), labels = c("Crude", "Adjusted")))

aut_prev_sex_adj.long_plot <- ggplot(data = aut_prev_sex_adj.long) +
  geom_col(aes(x = sex_desc, y = rate*100, fill = type), position = position_dodge(), show.legend = FALSE) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower*100, ymax = ci_upper*100, group = type), width = 0.2, position = position_dodge(width = 0.9)) +
  #theme(axis.title.x = element_blank()) +
  labs(title = "Autism prevalence",
       x = "Sex",
       y = "Aggregate prevalence")

# ADHD
adhd_prev_sex_adj.long <- #rbind(aut_prev_adj_m.long, aut_prev_adj_f.long)
  adhd_prev_sex_adj %>%
  select(-sum_sample_pop_size, -crude_count, -adjusted_count, -var, -w_M) %>%
  pivot_longer(cols = c(crude_rate, adjusted_rate, crude_ci_lower, crude_ci_upper, adjusted_ci_lower, adjusted_ci_upper),
               names_to = c("type", ".value"),
               names_pattern = "(crude|adjusted)_(.*)") %>%
  mutate(type = factor(type, levels = c("crude", "adjusted"), labels = c("Crude", "Adjusted")))

adhd_prev_sex_adj.long_plot <- ggplot(data = adhd_prev_sex_adj.long) +
  geom_col(aes(x = sex_desc, y = rate*100, fill = type), position = position_dodge(), show.legend = FALSE) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower*100, ymax = ci_upper*100, group = type), width = 0.2, position = position_dodge(width = 0.9)) +
  #theme(axis.title.x = element_blank()) +
  labs(title = "ADHD prevalence",
       x = "Sex",
       y = "Aggregate prevalence")

grid.arrange(aut_prev_sex_adj.long_plot, adhd_prev_sex_adj.long_plot, ncol = 2)
```

```{r adjPrevHealthAutPlot, include = FALSE, fig.cap = "Crude and age- and sex-adjusted sample prevalences of autism in school data by health service. Bars for crude prevalence show 95% normal confidence intervals and bars for adjusted prevalence show 95% gamma confidence intervals."}
# Autism
aut_prev_health_adj.long <- aut_prev_health_adj %>%
  select(-sum_sample_pop_size, -crude_count, -adjusted_count, -var, -w_M) %>%
  pivot_longer(cols = c(crude_rate, adjusted_rate, crude_ci_lower, crude_ci_upper, adjusted_ci_lower, adjusted_ci_upper),
               names_to = c("type", ".value"),
               names_pattern = "(crude|adjusted)_(.*)") %>%
  mutate(type = factor(type, levels = c("crude", "adjusted"), labels = c("Crude", "Adjusted")))

ggplot(data = aut_prev_health_adj.long) +
  geom_col(aes(x = type, y = rate, fill = type), position = position_dodge(), show.legend = TRUE) +
  geom_errorbar(aes(x = type, ymin = ci_lower, ymax = ci_upper, group = type), width = 0.2, position = position_dodge(width = 0.9)) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  facet_wrap(~health_service_name) +
  labs(title = "Autism prevalence by health service",
       x = "Sex",
       y = "Aggregate prevalence",
       fill = "Prevalence")
```

```{r adjPrevHealthAdhdPlot, include = FALSE, fig.cap = "Crude and age- and sex-adjusted sample prevalences of ADHD in school data by health service. Bars for crude prevalence show 95% normal confidence intervals and bars for adjusted prevalence show 95% gamma confidence intervals."}
# ADHD
adhd_prev_health_adj.long <- adhd_prev_health_adj %>%
  select(-sum_sample_pop_size, -crude_count, -adjusted_count, -var, -w_M) %>%
  pivot_longer(cols = c(crude_rate, adjusted_rate, crude_ci_lower, crude_ci_upper, adjusted_ci_lower, adjusted_ci_upper),
               names_to = c("type", ".value"),
               names_pattern = "(crude|adjusted)_(.*)") %>%
  mutate(type = factor(type, levels = c("crude", "adjusted"), labels = c("Crude", "Adjusted")))

ggplot(data = adhd_prev_health_adj.long) +
  geom_col(aes(x = type, y = rate, fill = type), position = position_dodge(), show.legend = TRUE) +
  geom_errorbar(aes(x = type, ymin = ci_lower, ymax = ci_upper, group = type), width = 0.2, position = position_dodge(width = 0.9)) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  facet_wrap(~health_service_name) +
  labs(title = "ADHD prevalence by health service",
       x = "Sex",
       y = "Aggregate prevalence",
       fill = "Prevalence")
```

```{r adjPrevEconAAutPlot, include = FALSE, fig.cap = "Crude and age- and sex-adjusted sample prevalences of autism in school data by socio-economic (SES) status of student's family. Bars for crude prevalence show 95% normal confidence intervals and bars for adjusted prevalence show 95% gamma confidence intervals."}
# Autism
aut_prev_econA_adj.long <- aut_prev_econA_adj %>%
  select(-sum_sample_pop_size, -crude_count, -adjusted_count, -var, -w_M) %>%
  pivot_longer(cols = c(crude_rate, adjusted_rate, crude_ci_lower, crude_ci_upper, adjusted_ci_lower, adjusted_ci_upper),
               names_to = c("type", ".value"),
               names_pattern = "(crude|adjusted)_(.*)") %>%
  mutate(type = factor(type, levels = c("crude", "adjusted"), labels = c("Crude", "Adjusted")))

ggplot(data = aut_prev_econA_adj.long) +
  geom_col(aes(x = type, y = rate, fill = type), position = position_dodge(), show.legend = TRUE) +
  geom_errorbar(aes(x = type, ymin = ci_lower, ymax = ci_upper, group = type), width = 0.2, position = position_dodge(width = 0.9)) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  facet_wrap(~school_fee) +
  labs(title = "Autism prevalence by SES",
       x = "Sex",
       y = "Aggregate prevalence",
       fill = "Prevalence")
```

```{r adjPrevEconAAdhdPlot, include = FALSE, fig.cap = "Crude and age- and sex-adjusted sample prevalences of ADHD in school data by socio-economic (SES) status of student's family. Bars for crude prevalence show 95% normal confidence intervals and bars for adjusted prevalence show 95% gamma confidence intervals."}
# ADHD
adhd_prev_econA_adj.long <- adhd_prev_econA_adj %>%
  select(-sum_sample_pop_size, -crude_count, -adjusted_count, -var, -w_M) %>%
  pivot_longer(cols = c(crude_rate, adjusted_rate, crude_ci_lower, crude_ci_upper, adjusted_ci_lower, adjusted_ci_upper),
               names_to = c("type", ".value"),
               names_pattern = "(crude|adjusted)_(.*)") %>%
  mutate(type = factor(type, levels = c("crude", "adjusted"), labels = c("Crude", "Adjusted")))

ggplot(data = adhd_prev_econA_adj.long) +
  geom_col(aes(x = type, y = rate, fill = type), position = position_dodge(), show.legend = TRUE) +
  geom_errorbar(aes(x = type, ymin = ci_lower, ymax = ci_upper, group = type), width = 0.2, position = position_dodge(width = 0.9)) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  facet_wrap(~school_fee) +
  labs(title = "ADHD prevalence by SES",
       x = "Sex",
       y = "Aggregate prevalence",
       fill = "Prevalence")
```

```{r adjPrevEthnicAutPlot, include = FALSE, fig.cap = "Crude and age- and sex-adjusted sample prevalences of autism in school data by ethnicity. Bars for crude prevalence show 95% normal confidence intervals and bars for adjusted prevalence show 95% gamma confidence intervals."}

# Autism
aut_prev_ethnic_adj.long <- aut_prev_ethnic_adj %>%
  select(-sum_sample_pop_size, -crude_count, -adjusted_count, -var, -w_M) %>%
  pivot_longer(cols = c(crude_rate, adjusted_rate, crude_ci_lower, crude_ci_upper, adjusted_ci_lower, adjusted_ci_upper),
               names_to = c("type", ".value"),
               names_pattern = "(crude|adjusted)_(.*)") %>%
  mutate(type = factor(type, levels = c("crude", "adjusted"), labels = c("Crude", "Adjusted")))

ggplot(data = aut_prev_ethnic_adj.long) +
  geom_col(aes(x = type, y = rate, fill = type), position = position_dodge(), show.legend = TRUE) +
  geom_errorbar(aes(x = type, ymin = ci_lower, ymax = ci_upper, group = type), width = 0.2, position = position_dodge(width = 0.9)) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  facet_wrap(~ethnic_2_group) +
  labs(title = "Autism prevalence by ethnicity",
       #y = "Aggregate prevalence",
       fill = "Prevalence")
```

```{r adjPrevEthnicAdhdPlot, include = FALSE, fig.cap = "Crude and age- and sex-adjusted sample prevalences of ADHD in school data by ethnicity. Bars for crude prevalence show 95% normal confidence intervals and bars for adjusted prevalence show 95% gamma confidence intervals."}
# ADHD
adhd_prev_ethnic_adj.long <- adhd_prev_ethnic_adj %>%
  select(-sum_sample_pop_size, -crude_count, -adjusted_count, -var, -w_M) %>%
  pivot_longer(cols = c(crude_rate, adjusted_rate, crude_ci_lower, crude_ci_upper, adjusted_ci_lower, adjusted_ci_upper),
               names_to = c("type", ".value"),
               names_pattern = "(crude|adjusted)_(.*)") %>%
  mutate(type = factor(type, levels = c("crude", "adjusted"), labels = c("Crude", "Adjusted")))

ggplot(data = adhd_prev_ethnic_adj.long) +
  geom_col(aes(x = type, y = rate, fill = type), position = position_dodge(), show.legend = TRUE) +
  geom_errorbar(aes(x = type, ymin = ci_lower, ymax = ci_upper, group = type), width = 0.2, position = position_dodge(width = 0.9)) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  facet_wrap(~ethnic_2_group) +
  labs(title = "ADHD prevalence by ethnicity",
       x = "Sex",
       y = "Aggregate prevalence",
       fill = "Prevalence")
```

```{r adjPrevRuralAutPlot, include = FALSE, fig.cap = "Crude and age- and sex-adjusted sample prevalences of autism in school data by school's rurality. Bars for crude prevalence show 95% normal confidence intervals and bars for adjusted prevalence show 95% gamma confidence intervals."}
# Autism
aut_prev_rural_adj.long <- aut_prev_rural_adj %>%
  select(-sum_sample_pop_size, -crude_count, -adjusted_count, -var, -w_M) %>%
  pivot_longer(cols = c(crude_rate, adjusted_rate, crude_ci_lower, crude_ci_upper, adjusted_ci_lower, adjusted_ci_upper),
               names_to = c("type", ".value"),
               names_pattern = "(crude|adjusted)_(.*)") %>%
  mutate(type = factor(type, levels = c("crude", "adjusted"), labels = c("Crude", "Adjusted")))

ggplot(data = aut_prev_rural_adj.long) +
  geom_col(aes(x = type, y = rate, fill = type), position = position_dodge(), show.legend = TRUE) +
  geom_errorbar(aes(x = type, ymin = ci_lower, ymax = ci_upper, group = type), width = 0.2, position = position_dodge(width = 0.9)) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  facet_wrap(~school_rurality) +
  labs(title = "Autism prevalence by school's rurality",
       #y = "Aggregate prevalence",
       fill = "Prevalence")
```

```{r adjPrevRuralAdhdPlot, include = FALSE, fig.cap = "Crude and age- and sex-adjusted sample prevalences of ADHD in school data by school's rurality. Bars for crude prevalence show 95% normal confidence intervals and bars for adjusted prevalence show 95% gamma confidence intervals."}
# ADHD
adhd_prev_rural_adj.long <- adhd_prev_rural_adj %>%
  select(-sum_sample_pop_size, -crude_count, -adjusted_count, -var, -w_M) %>%
  pivot_longer(cols = c(crude_rate, adjusted_rate, crude_ci_lower, crude_ci_upper, adjusted_ci_lower, adjusted_ci_upper),
               names_to = c("type", ".value"),
               names_pattern = "(crude|adjusted)_(.*)") %>%
  mutate(type = factor(type, levels = c("crude", "adjusted"), labels = c("Crude", "Adjusted")))

ggplot(data = adhd_prev_rural_adj.long) +
  geom_col(aes(x = type, y = rate, fill = type), position = position_dodge(), show.legend = TRUE) +
  geom_errorbar(aes(x = type, ymin = ci_lower, ymax = ci_upper, group = type), width = 0.2, position = position_dodge(width = 0.9)) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  facet_wrap(~school_rurality) +
  labs(title = "ADHD prevalence by rurality",
       #y = "Aggregate prevalence",
       fill = "Prevalence")
```

```{r kolmogorovSchool, warning = FALSE}

school_yes <- school_matched_small %>% filter(matched == 1) #%>% select(sex.school)
school_no <- school_matched_small %>% filter(matched == 0)

# Kolmogorov tests for our matched results
ks.school.sex <- ks.test(na.omit(school_yes$sex.school),
                         na.omit(school_no$sex.school),
                         alternative = "two.sided", simulate.p.value = TRUE)
#ks.school.sex

ks.school.ses_status <- ks.test(as.numeric(na.omit(school_yes$ses_status.school)),
                                as.numeric(na.omit(school_no$ses_status.school)),
                                alternative = "two.sided", simulate.p.value = TRUE)
#ks.school.ses_status

ks.school.commune_code<- ks.test(as.numeric(na.omit(school_yes$commune_code)),
                                 as.numeric(na.omit(school_no$commune_code)),
                                 alternative = "two.sided", simulate.p.value = TRUE)
#ks.school.commune_code

# Kolmogorov tests with permutation distributions
set.seed(123)
nPerm <- 200 # change to 2000
ks_perm.school.pvals <- data.frame(sex = numeric(nPerm),
                                   commune_code = numeric(nPerm),
                                   ses_status = numeric(nPerm))

school_matched_small_perm <- school_matched_small

for (i in 1:nPerm) {
  #print(i)
  school_matched_small_perm$matched <- school_matched_small$matched[sample(nrow(school_matched_small))] # permute matched status
  school_perm_yes <- school_matched_small_perm %>% filter(matched == 1)
  school_perm_no <- school_matched_small_perm %>% filter(matched == 0)
  
  ks_perm.school.sex <- ks.test(na.omit(school_perm_yes$sex.school),
                                na.omit(school_perm_no$sex.school), 
                                alternative = "two.sided")
  ks_perm.school.commune_code <- ks.test(as.numeric(na.omit(school_perm_yes$commune_code)),
                                        as.numeric(na.omit(school_perm_no$commune_code)),
                                        alternative = "two.sided")
  ks_perm.school.ses_status <- ks.test(as.numeric(na.omit(school_perm_yes$ses_status.school)),
                                       as.numeric(na.omit(school_perm_no$ses_status.school)),
                                       alternative = "two.sided")
  
  ks_perm.school.pvals$sex[i] <- ks_perm.school.sex$p.value
  ks_perm.school.pvals$commune_code[i] <- ks_perm.school.commune_code$p.value
  ks_perm.school.pvals$ses_status[i] <- ks_perm.school.ses_status$p.value
}


```

```{r kolmogorovPatient, warning = FALSE}

patients_yes <- patients_matched_small %>% filter(matched == 1) #%>% select(sex.school)
patients_no <- patients_matched_small %>% filter(matched == 0)

# Kolmogorov tests for our matched results
ks.patients.sex <- ks.test(na.omit(patients_yes$sex.patient),
                         na.omit(patients_no$sex.patient),
                         alternative = "two.sided", simulate.p.value = TRUE)
#ks.patients.sex

ks.patients.ses_status <- ks.test(as.numeric(na.omit(patients_yes$ses_status.patient)),
                                as.numeric(na.omit(patients_no$ses_status.patient)),
                                alternative = "two.sided", simulate.p.value = TRUE)
#ks.patients.ses_status

ks.patients.commune_code<- ks.test(as.numeric(na.omit(patients_yes$commune_code)),
                                 as.numeric(na.omit(patients_no$commune_code)),
                                 alternative = "two.sided", simulate.p.value = TRUE)
#ks.patients.commune_code


# Kolmogorov tests with permutation distributions
set.seed(123)
nPerm <- 200 # change to 2000
ks_perm.patients.pvals <- data.frame(sex = numeric(nPerm),
                                   commune_code = numeric(nPerm),
                                   ses_status = numeric(nPerm))

patients_matched_small_perm <- patients_matched_small

for (i in 1:nPerm) {
  #print(i)
  patients_matched_small_perm$matched <- patients_matched_small$matched[sample(nrow(patients_matched_small))] # permute matched status
  patients_perm_yes <- patients_matched_small_perm %>% filter(matched == 1)
  patients_perm_no <- patients_matched_small_perm %>% filter(matched == 0)
  
  ks_perm.patients.sex <- ks.test(na.omit(patients_perm_yes$sex.patient),
                                na.omit(patients_perm_no$sex.patient), 
                                alternative = "two.sided")
  ks_perm.patients.commune_code <- ks.test(as.numeric(na.omit(patients_perm_yes$commune_code)),
                                        as.numeric(na.omit(patients_perm_no$commune_code)),
                                        alternative = "two.sided")
  ks_perm.patients.ses_status <- ks.test(as.numeric(na.omit(patients_perm_yes$ses_status.patient)),
                                       as.numeric(na.omit(patients_perm_no$ses_status.patient)),
                                       alternative = "two.sided")
  
  ks_perm.patients.pvals$sex[i] <- ks_perm.patients.sex$p.value
  ks_perm.patients.pvals$commune_code[i] <- ks_perm.patients.commune_code$p.value
  ks_perm.patients.pvals$ses_status[i] <- ks_perm.patients.ses_status$p.value
}
```

```{r kolmogorovSchoolSex, fig.cap="a) Difference in frequency of sexes among school records that matched to patient records and school records that did not match. b) Density of Kolmogorov-Smirnov p-values for 2000 permutations of matched status for school records by sex with observed p-value shown in red.", fig.height=8}
# Results for sex
school_match_yes.sex <- school_yes %>% group_by(sex.school) %>% summarise(count = n()) %>% mutate(freq = count/sum(count), matched = 1)
school_match_no.sex <- school_no %>% group_by(sex.school) %>% summarise(count = n()) %>% mutate(freq = count/sum(count), matched = 0)
school_match.sex <- rbind(school_match_yes.sex, school_match_no.sex) %>%
  mutate(sex_desc = ifelse(sex.school == 1, "Male", ifelse(sex.school == 2, "Female", NA))) %>% 
  arrange(sex_desc, matched)

kolmog_school_sex.bar <- ggplot(school_match.sex) +
  geom_col(aes(x = factor(matched, labels = c("Unmatched", "Matched")), 
               y = freq, 
               fill = factor(matched, labels = c("Unmatched", "Matched")))) +
  theme(legend.position = "none") +
  facet_wrap(~sex_desc) +
  labs(title = "Matched status of SSAS school records by sex",
       x = "Matched status",
       y = "Feature frequency",
       fill = "Matched status")

kolmog_school_sex.density <- ggplot(ks_perm.school.pvals, aes(x = sex, y = after_stat(density))) +
  geom_density() +
  geom_vline(xintercept = ks.school.sex$p.value, color = "red") +
  labs(title = "Kolmogorov-Smirnov permutation test on matched status of SSAS school records by sex, with observed p-value",
       x = "Sex",
       y = "Density")

grid.arrange(kolmog_school_sex.bar, kolmog_school_sex.density, nrow = 2)
```

```{r kolmogorovPatientSex, fig.cap="a) Difference in frequency of sexes among patient records that matched to school records and patient records that did not match. b) Density of Kolmogorov-Smirnov p-values for 2000 permutations of matched status for patient records by sex with observed p-value shown in red.", fig.height=8}
# Results for sex
patients_match_yes.sex <- patients_yes %>% group_by(sex.patient) %>% summarise(count = n()) %>% mutate(freq = count/sum(count), matched = 1)
patients_match_no.sex <- patients_no %>% group_by(sex.patient) %>% summarise(count = n()) %>% mutate(freq = count/sum(count), matched = 0)
patients_match.sex <- rbind(patients_match_yes.sex, patients_match_no.sex) %>%
  mutate(sex_desc = ifelse(sex.patient == 1, "Male", ifelse(sex.patient == 2, "Female", NA))) %>% 
  arrange(sex_desc, matched)

kolmog_patient_ses.bar <- ggplot(patients_match.sex) +
  geom_col(aes(x = factor(matched, labels = c("Unmatched", "Matched")), 
               y = freq, 
               fill = factor(matched, labels = c("Unmatched", "Matched")))) +
  theme(legend.position = "none") +
  facet_wrap(~sex_desc) +
  labs(title = "Matched status of SSAS patient records by sex",
       x = "Matched status",
       y = "Feature frequency",
       fill = "Matched status")

kolmog_patient_ses.density <- ggplot(ks_perm.patients.pvals, aes(x = sex, y = after_stat(density))) +
  geom_density() +
  geom_vline(xintercept = ks.patients.sex$p.value, color = "red") +
  labs(title = "Kolmogorov-Smirnov permutation test on matched status of patient records by sex, with observed p-value",
       x = "Sex",
       y = "Density")

grid.arrange(kolmog_patient_ses.bar, kolmog_patient_ses.density, nrow = 2)
```

```{r kolmogorovSchoolCommune, fig.cap="a) Difference in frequency of communes of residence among school records that matched to patient records and school records that did not match. b) Density of Kolmogorov-Smirnov p-values for 2000 permutations of matched status for school records by commune of residence with observed p-value shown in red.", fig.height=8}
# Results for commune
school_match_yes.student_commune_name <- school_yes %>% group_by(student_commune_name.school) %>%
  summarise(count = n()) %>% mutate(freq = count/sum(count)) %>%
  # Would need to merge to a list of commune names and numbers if want to display all communes for all matched statuses
  #merge(commune_, by = "commune_num", all = TRUE) %>% 
  mutate(matched = 1) 
school_match_no.student_commune_name <- school_no %>% group_by(student_commune_name.school) %>%
  summarise(count = n()) %>% mutate(freq = count/sum(count)) %>%
  #merge(commune_nums, by = "commune_num", all = TRUE) %>% 
  mutate(matched = 0)

school_match.student_commune_name <- rbind(school_match_yes.student_commune_name, school_match_no.student_commune_name) %>%
  arrange(student_commune_name.school, matched)

kolmog_school_commune.bar <- ggplot(school_match.student_commune_name) +
  geom_col(aes(x = factor(matched, labels = c("Unmatched", "Matched")), 
               y = freq, 
               fill = factor(matched, labels = c("Unmatched", "Matched")))) +
  theme(legend.position = "none") +
  facet_wrap(~student_commune_name.school, scales = "fixed") +
  #facet_wrap(~student_commune_name.school, scales = "free") +
  labs(title = "Matched status of SSAS school records by commune",
       x = "Matched status",
       y = "Feature frequency",
       fill = "Matched status")
# most of the difference in matched commune frequency is for Temuco which is the biggest commune.

kolmog_school_commune.density <- ggplot(ks_perm.school.pvals, aes(x = commune_code, y = after_stat(density))) +
  geom_density() +
  geom_vline(xintercept = ks.school.commune_code$p.value, color = "red") +
  labs(title = "Kolmogorov-Smirnov permutation test on matched status of SSAS school records by commune, with observed p-value",
       x = "Commune",
       y = "Density")

grid.arrange(kolmog_school_commune.bar, kolmog_school_commune.density, nrow = 2)

```

```{r kolmogorovPatientCommune, fig.cap="a) Difference in frequency of commune of residence among patient records that matched to school records and patient records that did not match. b) Density of Kolmogorov-Smirnov p-values for 2000 permutations of matched status for patient records by commune of residence with observed p-value shown in red.", fig.height=8}
# Results for commune
patients_match_yes.student_commune_name <- patients_yes %>% group_by(student_commune_name.patient) %>%
  summarise(count = n()) %>% mutate(freq = count/sum(count)) %>%
  # Would need to merge to a list of commune names and numbers if want to display all communes for all matched statuses
  #merge(commune_, by = "commune_num", all = TRUE) %>% 
  mutate(matched = 1) 
patients_match_no.student_commune_name <- patients_no %>% group_by(student_commune_name.patient) %>%
  summarise(count = n()) %>% mutate(freq = count/sum(count)) %>%
  #merge(commune_nums, by = "commune_num", all = TRUE) %>% 
  mutate(matched = 0)

patients_match.student_commune_name <- rbind(patients_match_yes.student_commune_name, patients_match_no.student_commune_name) %>%
  arrange(student_commune_name.patient, matched)

kolmog_patient_commune.bar <- ggplot(patients_match.student_commune_name) +
  geom_col(aes(x = factor(matched, labels = c("Unmatched", "Matched")), 
               y = freq, 
               fill = factor(matched, labels = c("Unmatched", "Matched")))) +
  theme(legend.position = "none") +
  facet_wrap(~student_commune_name.patient, scales = "fixed") +
  #facet_wrap(~student_commune_name.school, scales = "free") +
  labs(title = "Matched status of SSAS patient records by commune",
       x = "Matched status",
       y = "Feature frequency",
       fill = "Matched status")
# most of the difference in matched commune frequency is for Temuco which is the biggest commune.

kolmog_patient_commune.density <- ggplot(ks_perm.patients.pvals, aes(x = commune_code, y = after_stat(density))) +
  geom_density() +
  geom_vline(xintercept = ks.patients.commune_code$p.value, color = "red") +
  labs(title = "Kolmogorov-Smirnov permutation test on matched status of patient records by commune, with observed p-value",
       x = "Commune",
       y = "Density")

grid.arrange(kolmog_patient_commune.bar, kolmog_patient_commune.density, nrow = 2)
```

```{r kolmogorovSchoolSes, fig.cap="a) Difference in frequency of proxy SES among school records that matched to patient records and school records that did not match. b) Density of Kolmogorov-Smirnov p-values for 2000 permutations of matched status for school records by proxy SES with observed p-value shown in red.", fig.height=8}
# Results for ses status
school_match_yes.ses_status <- school_yes %>% group_by(ses_status.school) %>% summarise(count = n()) %>% mutate(freq = count/sum(count), matched = 1)
school_match_no.ses_status <- school_no %>% group_by(ses_status.school) %>% summarise(count = n()) %>% mutate(freq = count/sum(count), matched = 0)
school_match.ses_status <- rbind(school_match_yes.ses_status, school_match_no.ses_status) %>%
  arrange(ses_status.school, matched)

kolmog_school_ses.bar <- ggplot(school_match.ses_status) +
  geom_col(aes(x = factor(matched, labels = c("Unmatched", "Matched")), 
               y = freq, 
               fill = factor(matched, labels = c("Unmatched", "Matched")))) +
  theme(legend.position = "none") +
  facet_wrap(~ses_status.school) +
  labs(title = "Matched status of SSAS school records by SES",
       x = "Matched status",
       y = "Feature frequency",
       fill = "Matched status")

kolmog_school_ses.density <- ggplot(ks_perm.school.pvals, aes(x = ses_status, y = after_stat(density))) +
  geom_density() +
  geom_vline(xintercept = ks.school.ses_status$p.value, color = "red") +
  labs(title = "Kolmogorov-Smirnov permutation test on matched status of SSAS school records by SES, with observed p-value",
       x = "Proxy SES",
       y = "Density")

grid.arrange(kolmog_school_ses.bar, kolmog_school_ses.density, nrow = 2)
```

```{r kolmogorovPatientSes, fig.cap="a) Difference in frequency of proxy SES among patient records that matched to school records and patient records that did not match. b) Density of Kolmogorov-Smirnov p-values for 2000 permutations of matched status for patient records by proxy SES with observed p-value shown in red.", fig.height=8}
# Results for ses status
patients_match_yes.ses_status <- patients_yes %>% group_by(ses_status.patient) %>% summarise(count = n()) %>% mutate(freq = count/sum(count), matched = 1)
patients_match_no.ses_status <- patients_no %>% group_by(ses_status.patient) %>% summarise(count = n()) %>% mutate(freq = count/sum(count), matched = 0)
patients_match.ses_status <- rbind(patients_match_yes.ses_status, patients_match_no.ses_status) %>%
  arrange(ses_status.patient, matched)

kolmog_patient_ses.bar <- ggplot(patients_match.ses_status) +
  geom_col(aes(x = factor(matched, labels = c("Unmatched", "Matched")), 
               y = freq, 
               fill = factor(matched, labels = c("Unmatched", "Matched")))) +
  theme(legend.position = "none") +
  facet_wrap(~ses_status.patient) +
  labs(title = "Matched status of SSAS patient records by SES",
       x = "Matched status",
       y = "Feature frequency",
       fill = "Matched status")

kolmog_patient_ses.density <- ggplot(ks_perm.patients.pvals, aes(x = ses_status, y = after_stat(density))) +
  geom_density() +
  geom_vline(xintercept = ks.patients.ses_status$p.value, color = "red") +
  labs(title = "Kolmogorov-Smirnov permutation test on matched status of patient records by SES, with observed p-value",
       x = "Proxy SES",
       y = "Density")

grid.arrange(kolmog_patient_ses.bar, kolmog_patient_ses.density, nrow = 2)
```

\newpage

# References

3	References
1.	Organisation for Economic Co-operation and Development (OECD). Chile. [cited 2023 Jul 14]. Chile - OECD Data. Available from: http://data.oecd.org/chile.htm
2.	World Bank. GDP per capita (current US$) - Chile. [cited 2023 Jul 17]. GDP per capita (current US$) - Chile. Available from: https://data.worldbank.org
3.	Cerda AA, García LY, Rivera-Arroyo J, Riquelme A, Teixeira JP, Jakovljevic M. Comparison of the healthcare system of Chile and Brazil: strengths, inefficiencies, and expenditures. Cost Eff Resour Alloc. 2022 Dec 16;20(1):71. 
4.	Ministerio de Salud. Ministerio de Salud – Gobierno de Chile. [cited 2023 Jul 14]. Ubicación Servicios de Salud. Available from: https://www.minsal.cl/conozcanos_servicios_salud/
5.	Núñez A, Manzano CA. Identifying local barriers to access to healthcare services in Chile using a communitarian approach. Health Expect Int J Public Particip Health Care Health Policy. 2022 Feb;25(1):254–63. 
6.	Koch KJ, Cid Pedraza C, Schmid A. Out-of-pocket expenditure and financial protection in the Chilean health care system—A systematic review. Health Policy. 2017 May 1;121(5):481–94. 
7.	Castillo-Laborde C, Aguilera-Sanhueza X, Hirmas-Adauy M, Matute I, Delgado-Becerra I, Ferrari MND, et al. Health Insurance Scheme Performance and Effects on Health and Health Inequalities in Chile. MEDICC Rev. 2017 Jul;19:57–64. 
8.	World Bank. Gini Index - Chile. [cited 2023 Jul 17]. Gini Index - Chile. Available from: https://data.worldbank.org
9.	Paredes D, Iturra V, Lufin M. A Spatial Decomposition of Income Inequality in Chile. Reg Stud. 2016 May 3;50(5):771–89. 
10.	Instituto Nacional de Estadisticas. Default. [cited 2023 Jul 5]. Encuesta suplementaria de ingresos. Available from: http://www.ine.gob.cl/estadisticas/sociales/seguridad-publica-y-justicia/estadisticas-policiales-y-judiciales/encuesta-suplementaria-de-ingresos
11.	Sandoval MH, Portaccio MEA. Death certificate: The urgent consideration of ethnic and racial origin in Chile. Lancet Reg Health – Am [Internet]. 2022 Dec 1 [cited 2023 Jul 14];16. Available from: https://www.thelancet.com/journals/lanam/article/PIIS2667-193X(22)00219-8/fulltext
12.	Sandoval MH, Alvear Portaccio ME, Albala C. Life expectancy by ethnic origin in Chile. Front Public Health [Internet]. 2023 [cited 2023 Jul 14];11. Available from: https://www.frontiersin.org/articles/10.3389/fpubh.2023.1147542
13.	Instituto Nacional de Estadisticas. Default. [cited 2023 Jul 14]. Censo de Población y Vivienda. Available from: http://www.ine.gob.cl/estadisticas/sociales/censos-de-poblacion-y-vivienda/censo-de-poblacion-y-vivienda
14.	Istuany OE, Wood R. Perspectives on Educational Inclusion from a Small Sample of Autistic Pupils in Santiago, Chile. 2020 Jul 6;22(1):210–20. 
15.	Breinbauer C, Vidal V, Molina P, Trabucco C, Gutierrez L, Cordero M. Early Childhood Development policy in Chile: Progress and pitfalls supporting children with developmental disabilities toward school readiness. Front Public Health [Internet]. 2022 [cited 2023 Jul 18];10. Available from: https://www.frontiersin.org/articles/10.3389/fpubh.2022.983513
16.	Ministerio de Educación. Educación Especial. [cited 2023 Jun 28]. Incremento de la Subvención Especial Diferencial. Available from: https://especial.mineduc.cl/incremento-subvencion-educacion-especial/incremento-la-subvencion-especial-diferencial/
17.	American Psychiatric Association. Diagnostic and Statistical Manual of Mental Disorders [Internet]. 5th ed. Arlington, VA; 2013 [cited 2023 Jul 15]. Available from: https://dsm.psychiatryonline.org/doi/book/10.1176/appi.books.9780890425596
18.	World Health Organisation. International Statistical Classification of Diseases and Related Health Problems (10th Revision) [Internet]. 2019. Available from: https://icd.who.int/browse10/2019/en#/F84
19.	Lai MC, Lombardo MV, Baron-Cohen S. Autism. The Lancet. 2014 Mar 8;383(9920):896–910. 
20.	Paula CS, Cukier S, Cunha GR, Irarrázaval M, Montiel-Nava C, Garcia R, et al. Challenges, priorities, barriers to care, and stigma in families of people with autism: Similarities and differences among six Latin American countries. Autism. 2020 Nov 1;24(8):2228–42. 
21.	Roman-Urrestarazu A, Yáñez C, López-Garí C, Elgueta C, Allison C, Brayne C, et al. Autism screening and conditional cash transfers in Chile: Using the Quantitative Checklist (Q-CHAT) for early autism detection in a low resource setting. Autism. 2021 May 1;25(4):932–45. 
22.	Brett D, Warnell F, McConachie H, Parr JR. Factors Affecting Age at ASD Diagnosis in UK: No Evidence that Diagnosis Age has Decreased Between 2004 and 2014. J Autism Dev Disord. 2016;46:1974–84. 
23.	Yáñez C, Maira P, Elgueta C, Brito M, Crockett MA, Troncoso L, et al. [Prevalence estimation of Autism Spectrum disorders in chilean urban population]. Andes Pediatr Rev Chil Pediatr. 2021 Aug;92(4):519–25. 
24.	Catherine Rice. Centers for Disease Control and Prevention. 2006 [cited 2023 Jul 18]. Prevalence of Autism Spectrum Disorders. Available from: https://www.cdc.gov/mmwr/preview/mmwrhtml/ss5810a1.htm
25.	Elsabbagh M, Divan G, Koh YJ, Kim YS, Kauchali S, Marcín C, et al. Global Prevalence of Autism and Other Pervasive Developmental Disorders. Autism Res. 2012;5(3):160–79. 
26.	Puga C, Pagotto V, Giunta D, Vicens J, Leist M, Vaucheret Paz E, et al. [Prevalence and incidence of disability based on the Unique Certificate of Disability at a teaching hospital in the Metropolitan Area of Buenos Aires]. Arch Argent Pediatr. 2019 Jun 1;117(3):183–7. 
27.	Dekkers LMS, Groot NA, Díaz Mosquera EN, Andrade Zúñiga IP, Delfos MF. Prevalence of Autism Spectrum Disorders in Ecuador: A Pilot Study in Quito. J Autism Dev Disord. 2015 Dec 1;45(12):4165–73. 
28.	Russell G, Stapley S, Newlove-Delgado T, Salmon A, White R, Warren F, et al. Time trends in autism diagnosis over 20 years: a UK population-based cohort study. J Child Psychol Psychiatry. 2022;63(6):674–82. 
29.	Roman-Urrestarazu A, van Kessel R, Allison C, Matthews FE, Brayne C, Baron-Cohen S. Association of Race/Ethnicity and Social Disadvantage With Autism Prevalence in 7 Million School Children in England. JAMA Pediatr. 2021 Jun 7;175(6):e210054–e210054. 
30.	Loomes R, Hull L, Mandy WPL. What Is the Male-to-Female Ratio in Autism Spectrum Disorder? A Systematic Review and Meta-Analysis. J Am Acad Child Adolesc Psychiatry. 2017 Jun;56(6):466–74. 
31.	Giarelli E, Wiggins LD, Rice CE, Levy SE, Kirby RS, Pinto-Martin J, et al. Sex differences in the evaluation and diagnosis of autism spectrum disorders among children. Disabil Health J. 2010 Apr;3(2):107–16. 
32.	Shenouda J, Barrett E, Davidow AL, Halperin W, Silenzio VMB, Zahorodny W. Prevalence of autism spectrum disorder in a large, diverse metropolitan area: Variation by sociodemographic factors. Autism Res. 2022;15(1):146–55. 
33.	Thomas P, Zahorodny W, Peng B, Kim S, Jani N, Halperin W, et al. The association of autism diagnosis with socioeconomic status. Autism. 2012 Mar 1;16(2):201–13. 
34.	Delobel-Ayoub M, Ehlinger V, Klapouszczak D, Maffre T, Raynaud JP, Delpierre C, et al. Socioeconomic Disparities and Prevalence of Autism Spectrum Disorders and Intellectual Disability. PLOS ONE. 2015 Nov 5;10(11):e0141964. 
35.	Bailey B, Arciuli J. Indigenous Australians with autism: A scoping review. Autism. 2020 Jul 1;24(5):1031–46. 
36.	Zeidan J, Fombonne E, Scorah J, Ibrahim A, Durkin MS, Saxena S, et al. Global prevalence of autism: A systematic review update. Autism Res. 2022;15(5):778–90. 
37.	Antshel KM, Russo N. Autism Spectrum Disorders and ADHD: Overlapping Phenomenology, Diagnostic Issues, and Treatment Considerations. Curr Psychiatry Rep. 2019 Mar 22;21(5):34. 
38.	Fioravante I, Lozano-Lozano JA, Martella D. Attention deficit hyperactivity disorder: A pilot study for symptom assessment and diagnosis in children in Chile. Front Psychol [Internet]. 2022 [cited 2023 Jul 15];13. Available from: https://www.frontiersin.org/articles/10.3389/fpsyg.2022.946273
39.	Salazar F, Baird G, Chandler S, Tseng E, O’sullivan T, Howlin P, et al. Co-occurring Psychiatric Disorders in Preschool and Elementary School-Aged Children with Autism Spectrum Disorder. J Autism Dev Disord. 2015 Aug 1;45(8):2283–94. 
40.	de la Barra FE, Vicente B, Saldivia S, Melipillan R. Epidemiology of ADHD in Chilean children and adolescents. ADHD Atten Deficit Hyperact Disord. 2013 Mar 1;5(1):1–8. 
41.	Vicente B, de la Barra F, Saldivia S, Kohn R, Rioseco P, Melipillan R. Prevalence of child and adolescent psychiatric disorders in Santiago, Chile: a community epidemiological study. Soc Psychiatry Psychiatr Epidemiol. 2012 Jul 1;47(7):1099–109. 
42.	Rowland AS, Skipper BJ, Rabiner DL, Qeadan F, Campbell RA, Naftel AJ, et al. Attention-Deficit/Hyperactivity Disorder (ADHD): Interaction between socioeconomic status and parental history of ADHD determines prevalence. J Child Psychol Psychiatry. 2018;59(3):213–22. 
43.	Borges e Azevêdo PV, Caixeta LF, Rabelo Taveira DL, Peixoto Giglio MR, Rosário MC do, Rohde LA. Suggestive diagnosis of attention-deficit/hyperactivity disorder in indigenous children and adolescents from the Brazilian Amazon. Eur Child Adolesc Psychiatry. 2020 Mar 1;29(3):373–84. 
44.	Pham HD, Nguyen HBH, Tran DT. Prevalence of ADHD in primary school children in Vinh Long, Vietnam. Pediatr Int. 2015;57(5):856–9. 
45.	Ince RA, Paton AT, Kay JW, Schyns PG. Bayesian inference of population prevalence. Serences JT, Behrens TE, Huth A, Ling S, editors. eLife. 2021 Oct 6;10:e62461. 
46.	Downing BC, Hickman M, Jones NR, Larney S, Sweeting MJ, Xu Y, et al. Prevalence of opioid dependence in New South Wales, Australia, 2014–16: Indirect estimation from multiple data sources using a Bayesian approach. Addiction [Internet]. [cited 2023 Jul 16];n/a(n/a). Available from: https://onlinelibrary.wiley.com/doi/abs/10.1111/add.16268
47.	Depaoli S, Winter SD, Visser M. The Importance of Prior Sensitivity Analysis in Bayesian Statistics: Demonstrations Using an Interactive Shiny App. Front Psychol. 2020 Nov 24;11:608045. 
48.	Sourial N, Wolfson C, Zhu B, Quail J, Fletcher J, Karunananthan S, et al. Correspondence analysis is a useful tool to uncover the relationships among categorical variables. J Clin Epidemiol. 2010 Jun 1;63(6):638–46. 
49.	Costa PS, Santos NC, Cunha P, Cotter J, Sousa N. The Use of Multiple Correspondence Analysis to Explore Associations between Categories of Qualitative Variables in Healthy Ageing. J Aging Res. 2013;2013:302163. 
50.	Enamorado T, Fifield B, Imai K. Using a Probabilistic Model to Assist Merging of Large-Scale Administrative Records. Am Polit Sci Rev. 2019 May;113(2):353–71. 
51.	Fellegi IP, Sunter AB. A Theory for Record Linkage. J Am Stat Assoc. 1969 Dec;64(328):1183–210. 
52.	Jaro MA. Advances in Record-Linkage Methodology as Applied to Matching the 1985 Census of Tampa, Florida. J Am Stat Assoc. 1989;84(406):414–20. 
53.	Sariyar M, Borg A. The RecordLinkage Package: Detecting Errors in Data. R J. 2010;2(2):61. 
54.	Contiero P, Tittarelli A, Tagliabue G, Maghini A, Fabiano S, Crosignani P, et al. The EpiLink record linkage software: presentation and results of linkage test on cancer registry files. Methods Inf Med. 2005;44(1):66–71. 
55.	Hejblum BP, Weber GM, Liao KP, Palmer NP, Churchill S, Shadick NA, et al. Probabilistic record linkage of de-identified research datasets with discrepancies using diagnosis codes. Sci Data. 2019 Jan 8;6(1):180298. 
56.	Roman-Urrestarazu A, Yang JC, van Kessel R, Warrier V, Dumas G, Jongsma H, et al. Autism incidence and spatial analysis in more than 7 million pupils in English schools: a retrospective, longitudinal, school registry study. Lancet Child Adolesc Health. 2022 Dec 1;6(12):857–68. 
57.	Biblioteca del Congreso Nacional de Chile. www.bcn.cl/leychile. 2023 [cited 2023 Jul 12]. LEY 21545 Establece la promoción de la inclusión, la atención integral, y la protección de los derechos de las persons con trastorno del espectro autista en el ámbito social, de salud y educatión. Available from: https://www.bcn.cl/leychile
58.	Instituto Nacional de Estadisticas. Default. [cited 2023 Jul 5]. Proyecciones de Población. Available from: http://www.ine.gob.cl/estadisticas/sociales/seguridad-publica-y-justicia/estadisticas-policiales-y-judiciales/proyecciones-de-población
59.	Humanitarian Data Exchange. Chile - Subnational Administrative Boundaries [Internet]. [cited 2023 Jul 5]. Available from: https://data.humdata.org/dataset/cod-ab-chl
60.	Fay MP, Feuer EJ. Confidence intervals for directly standardised rates: a method based on the gamma distribution. Stat Med. 1997 Apr 15;16(7):791–801. 
61.	Sadinle M. Bayesian Estimation of Bipartite Matchings for Record Linkage. 2016 [cited 2023 Jun 28]; Available from: https://arxiv.org/abs/1601.06630
62.	Stringham T. Fast Bayesian Record Linkage With Record-Specific Disagreement Parameters. J Bus Econ Stat. 2022 Oct 2;40(4):1509–22. 
63.	Pita R, Mendonça E, Reis S, Barreto M, Denaxas S. A Machine Learning Trainable Model to Assess the Accuracy of Probabilistic Record Linkage. In: Bellatreche L, Chakravarthy S, editors. Big Data Analytics and Knowledge Discovery [Internet]. Cham: Springer International Publishing; 2017 [cited 2023 Jun 28]. p. 214–27. (Lecture Notes in Computer Science; vol. 10440). Available from: http://link.springer.com/10.1007/978-3-319-64283-3_16
64.	Yeargin-Allsopp M, Rice C, Karapurkar T, Doernberg N, Boyle C, Murphy C. Prevalence of Autism in a US Metropolitan Area. JAMA. 2003 Jan 1;289(1):49–55. 
65.	Sainsbury WJ, Carrasco K, Whitehouse AJO, Waddington H. Parent-reported Early Atypical Development and Age of Diagnosis for Children with Co-occurring Autism and ADHD. J Autism Dev Disord. 2023 Jun 1;53(6):2173–84. 
66.	Lindblom A. Under-detection of autism among First Nations children in British Columbia, Canada. Disabil Soc. 2014 Sep 14;29(8):1248–59. 
67.	Rojas F. Poverty determinants of acute respiratory infections among Mapuche indigenous peoples in Chile’s Ninth Region of Araucania, using GIS and spatial statistics to identify health disparities. Int J Health Geogr. 2007 Jul 2;6(1):26. 



\newpage

# Appendix A | R code


# Appendix B | Research Protocol

See overleaf.