---
title: Investigating the autism and ADHD prevalence in Chile through Bayesian prevalence
  analysis and clinical record data linkage
author: "Student 5526"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    number_sections: TRUE

---
    
<!--header-includes:
  - \usepackage{titling}
  - \pretitle{\begin{center}
  - \posttitle{\end{center}} -->
  
<!-- Optionally include a page break. This will force the start
of the document to the second page -->


This dissertation is submitted for the degree of Master of Philosophy. The dissertation does not exceed the word limit for the respective Degree Committee.
Word count: xxx TODO

\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = "C:/Users/delat/OneDrive/MPhil Population Health Sciences 2022-2023/12 Dissertation")
```


```{r libraries}

#library(nleqslv) # Only needed for robince bayesian prevalence
library(janitor)
library(gridExtra)
library(readxl)
library(writexl)
library(viridis)
#library(wesanderson)
library(rgbif)
library(chilemapas) # For commune maps
library(leaflet)
library(plotly)
library(knitr)
library(kableExtra)
library(sf)
library(sp)
library(broom)
library(psych)
library(Hmisc)
library(poolr)
library(epitools)
#library(corrplot)
#library(caret)
library(mltools)
library(ggrepel)
library(rjags)
library(rstan)
library(posterior)
library(tidybayes)
library(bayesplot)
library(reclin2)
library(lubridate)
library(RecordLinkage)
library(dgof) # for statistical testing
library(fdm2id) # for predict that works for kmeans
library(ppclust) # for cmeans
library(factoextra) # for get_cluster_?
library(FactoMineR) # for MCA
library(tidyverse)

```


```{r importGeographicData}

# Import region and commune boundaries
# https://data.humdata.org/dataset/cod-ab-chl
chile.adm1 <- st_read("04_Data/CHL_adm_humdata/chl_admbnda_adm1_bcn_20211008.shp", quiet = TRUE) #%>%
  #st_transform(crs = 32629)
chile.adm3 <- st_read("04_Data/CHL_adm_humdata/chl_admbnda_adm3_bcn_20211008.shp", quiet = TRUE) %>%
  mutate(commune_code = str_sub(ADM3_PCODE, start = 3, end = -1),
         commune_name = ADM3_ES)
#chile.adm3_old <- st_read("04_Data/CHL_adm/CHL_adm3.shp", quiet = TRUE)



# Get communes with health services
chile_communes_raw <- read_excel("04_Data/commune_by_health_service.xlsx") %>%
  clean_names()

chile_communes <- chile_communes_raw %>%
  mutate(commune_name = ifelse(comuna == "La Calera", "Calera",
                        ifelse(comuna == "Coihaique", "Coyhaique",
                        ifelse(comuna == "Paiguano", "Paihuano",
                        ifelse(comuna == "Pedro Aguirre Cerda", "Pedro Aguirre Cerda",
                        comuna))))) %>%
rename("health_service_name" = "servicio_de_salud") %>%
  select(commune_name, health_service_name)

# Create a number for each health service
health_service_lookup <- chile_communes %>%
  group_by(health_service_name) %>%
  summarise() %>% 
  #rename(health_service_name_long = health_service_name) %>%
  mutate(health_service_name_short = ifelse(grepl(" Del ", health_service_name), 
                                      str_sub(health_service_name, start = 23, end = -1), 
                                      str_sub(health_service_name, start = 19, end = -1))) %>%
  arrange(health_service_name) %>%
  rowid_to_column("health_service_code")

# Get region codes with region name abbreviations
region_abr_lookup <- data.frame(
  ADM1_PCODE = c(paste0("CL0", c(1:9)), paste0("CL", c(10:16))),
  region_name_abr = c("TPCA", "ANTOF", "ATCMA", "COQ", "VALPO", "LGBO", "MAULE", "BBIO",
                      "ARAUC", "LAGOS", "AYSEN", "MAG", "RM", "RIOS", "AYP", "NUBLE"))

# Put region, health service and communes together
region_service_commune_lookup <- chile.adm3 %>%
  merge(chile_communes, by = "commune_name", all = TRUE) %>%
  mutate(commune_code = ifelse(commune_name == "Antártica", "12202", commune_code),
         ADM3_PCODE = ifelse(commune_name == "Antártica", "CL12202", ADM3_PCODE),
         ADM1_ES = ifelse(commune_name == "Antártica", "Región de Magallanes y Antártica Chilena", ADM1_ES),
         ADM1_PCODE = ifelse(commune_name == "Antártica", "CL12", ADM1_PCODE),
         commune_name = ifelse(ADM3_PCODE == "CL01401", "Pozo Almonte", commune_name),
                        # For the Tocopilla in Tarapaca, use it's old name to avoid duplication issues
         health_service_name = 
           ifelse(ADM3_PCODE == "CL01401", "Servicio de Salud Iquique", 
           ifelse(ADM3_PCODE == "CL11201", "Servicio de Salud Aisén",
           ifelse(commune_name == "Isla de Pascua", "Servicio de Salud Metropolitano Oriente",
           ifelse(commune_name == "Los Alamos", "Servicio de Salud Arauco",
           ifelse(commune_name == "Los Angeles", "Servicio de Salud Biobío",
           ifelse(ADM3_PCODE == "CL06204", "Servicio de Salud Del Libertador B.O'Higgins",
           ifelse(commune_name == "Pedro Aguirre Cerda", "Servicio de Salud Metropolitano Sur",
           ifelse(commune_name == "Ranquil", "Servicio de Salud Ñuble", health_service_name)))))))),
         region_code = str_sub(ADM1_PCODE, start = 3, end = -1),
         commune_name_upper = toupper(commune_name)) %>%
  rename(region_name = ADM1_ES) %>%
  filter(!is.na(ADM3_PCODE)) %>% # Get rid of the communes that didn't match properly with health service lookup and were corrected above
  merge(region_abr_lookup, by = "ADM1_PCODE")
  
region_service_commune_lookup <- merge(region_service_commune_lookup, 
                                       health_service_lookup,
                                       by = "health_service_name", all = TRUE) %>%
  rename(region_name_long = region_name,
         health_service_name_long = health_service_name,
         health_service_name = health_service_name_short) %>%
  mutate(region_name = ifelse(region_name_long == "Región Metropolitana de Santiago", "Metropolitana de Santiago",
                       ifelse(grepl("Región de ", region_name_long), 
                              substr(region_name_long, start = 11, stop = nchar(region_name_long)), 
                       ifelse(grepl("Región del ", region_name_long), 
                              substr(region_name_long, start = 12, stop = nchar(region_name_long)), NA)))) %>%
  select(region_name_long, region_name, region_name_abr, region_code, ADM1_PCODE,
         commune_name, commune_name_upper, commune_code, 
         health_service_name_long, health_service_name, health_service_code,
         geometry)

# Aggregate to region level (no )
region_lookup <- region_service_commune_lookup %>% 
  as.tibble %>%
  select(-geometry) %>%
  group_by(region_code, ADM1_PCODE, region_name, region_name_abr) %>% 
  summarise() 

# Extract communes for the Araucania Sur and Norte health services
araucnorte_communes <- region_service_commune_lookup %>%
  filter(str_detect(health_service_name, "a Norte")) %>%
  as.tibble() %>%
  select(commune_code, commune_name)
araucsur_communes <- region_service_commune_lookup %>%
  filter(str_detect(health_service_name, "a Sur")) %>%
  as.tibble() %>%
  select(commune_code, commune_name)

```

```{r importStandardPopulationData}
chile_stdpop_raw <- read_excel("04_Data/pop_chile_2021_single_age.xlsx") %>%
  clean_names() 

chile_stdpop <- chile_stdpop_raw %>%
  filter(sex != 9) %>%
  rename("std_pop" = "pop_2021") %>%
  mutate(pop_prop = std_pop / sum(std_pop))
```

```{r importChileDemogData}
# https://www.ine.gob.cl/estadisticas/sociales/demografia-y-vitales/proyecciones-de-poblacion
chile_regionpop_raw <- read_excel("04_Data/ine_estimaciones-y-proyecciones-2002-2035_base-2017_region_area_tabulados.xlsx", sheet = "Region summary 2021") %>%
  clean_names()

chile_regionpop <- chile_regionpop_raw %>%
  mutate(region_name = ifelse(region == "Aysén", "Aysén del Gral. Ibañez del Campo",
                         ifelse(region == "Biobío", "Bío-Bío",
                         ifelse(region == "Magallanes", "Magallanes y Antártica Chilena",
                         ifelse(region == "Metropolitana", "Metropolitana de Santiago",
                         ifelse(region == "OHiggins", "Libertador Bernardo O'Higgins", region)))))) %>%
  select(-region)

# https://www.ine.gob.cl/estadisticas/sociales/ingresos-y-gastos/encuesta-suplementaria-de-ingresos
# Income is from Supplementary Income Survey (ESI) (2021), data is from Instituto Nacional de Estadística (INE).
chile_regionincome_raw <- read_excel("04_Data/ingreso-medio-mensual-por-region-2010---2021.xlsx", skip = 2) %>%
  clean_names()

chile_regionincome <- chile_regionincome_raw %>%
  filter(ano == 2021,
         region != "Nacional") %>%
  mutate(region_short = ifelse(grepl("Región de ", region), 
                               substr(region, start = 11, stop = nchar(region)), 
                        ifelse(grepl("Región del ", region), 
                               substr(region, start = 12, stop = nchar(region)),
                        ifelse(region == "Región Metropolitana", "Metropolitana", NA))),
         region_name = ifelse(region_short == "Aysén", "Aysén del Gral. Ibañez del Campo",
                         ifelse(region_short == "Biobío", "Bío-Bío",
                         ifelse(region_short == "Magallanes", "Magallanes y Antártica Chilena",
                         ifelse(region_short == "Metropolitana", "Metropolitana de Santiago",
                         ifelse(region_short == "O’Higgins", "Libertador Bernardo O'Higgins", region_short)))))) %>%
  select(region_name, ingreso_medio_nominal)

```

```{r importSchoolData}

chile_merged_raw <- read.csv("04_Data/Data_Chile_Merge.csv") %>% clean_names()

chile_merged <- chile_merged_raw %>%
  rename(sex_desc = sex,
         year = agno,
         school_code = rbd,
         school_check_code = dgv_rbd, 
         school_name = nom_rbd,
         school_region_code = cod_reg_rbd,
         school_region_name_abr = nom_reg_rbd_a,
         school_province_code = cod_pro_rbd,
         school_commune_code = cod_com_rbd_2,
         school_commune_name = nom_com_rbd_2,
         school_dept_code = cod_deprov_rbd,
         school_dept_name = nom_deprov_rbd,
         school_dependency_code = cod_depe, # has categories 1-6, no1 and no2 here are no1 in grouped
         school_dependency_code_grouped = cod_depe2, # has categories 1-5
         school_rurality_code = rural_rbd,
         school_operation_status = estado_estab, 
         teaching_code1 = cod_ense, # min = 10, max = 910, eg preschool, special education hearing impaired
         teaching_code2 = cod_ense2, # subject matter coding, 1-8
         teaching_code3 = cod_ense3, # age based coding, 1-7
         grade_code1 = cod_grado, # grade of schooling, 1-10, 21-25, 31-34, nests in teaching_code1
         grade_code2 = cod_grado2, # equivalent grade of schooling for adult special education, 1-8, 99
         grade_letter = let_cur, # refers to the class within the grade, close to start of alphabet is higher aptitude
         course_timing = cod_jor, # time of day, morning, afternoon, both, night, no info
         course_type = cod_tip_cur, # 0 = simple course, 1-4 = combined course, 99 = no info
         course_descr = cod_des_cur, # Description of course (TP secondary education only). 0: Does not apply, 1: Only High School, 2: Dual, 3: Other
         student_id = mrun,
         sex = gen_alu, # 0 = no info, 1 = male, 2 = female
         dob = fec_nac_alu_2, # The second one has DD
         age_june30 = edad_alu, # age at 30th June 2021
         special_needs_status = int_alu, # integrated student indicator, 0 = no, 1 = yes. Mostly no
         special_needs_code = cod_int_alu, # ADHD, blindness, etc. 0 = none. 105 = autism, 203 = ADHD. See ER_Matricula_por_alumno_PUBL_MRUN annex 7
         student_region_code = cod_reg_alu,
         student_commune_code = cod_com_alu,
         student_commune_name = nom_com_alu,
         economic_sector_code = cod_sec,
         economic_specialty_code = cod_espe,
         economic_branch_code = cod_rama,
         economic_profspec_code = cod_men,
         teaching_code_new = ens) %>%
  mutate(commune_code_temp = ifelse(student_commune_code == "0", school_commune_code, student_commune_code),
                             # If there is no commune code for the student, use their school's code instead
         commune_code_old = ifelse(nchar(as.character(commune_code_temp)) == 4,
                                   paste0("0", as.character(commune_code_temp)),
                                   as.character(commune_code_temp)),
         # Fix Biobio to Nuble communes
         commune_code = ifelse(commune_code_old == "08401", "16101",
                        ifelse(commune_code_old == "08402", "16102",
                        ifelse(commune_code_old == "08403", "16202",
                        ifelse(commune_code_old == "08404", "16203",
                        ifelse(commune_code_old == "08405", "16302",
                        ifelse(commune_code_old == "08406", "16103",
                        ifelse(commune_code_old == "08407", "16104",
                        ifelse(commune_code_old == "08408", "16204",
                        ifelse(commune_code_old == "08409", "16303",
                        ifelse(commune_code_old == "08410", "16105",
                        ifelse(commune_code_old == "08411", "16106",
                        ifelse(commune_code_old == "08412", "16205",
                        ifelse(commune_code_old == "08413", "16107",
                        ifelse(commune_code_old == "08414", "16201",
                        ifelse(commune_code_old == "08415", "16206",
                        ifelse(commune_code_old == "08416", "16301",
                        ifelse(commune_code_old == "08417", "16304",
                        ifelse(commune_code_old == "08418", "16108",
                        ifelse(commune_code_old == "08419", "16305",
                        ifelse(commune_code_old == "08420", "16207",
                        ifelse(commune_code_old == "08421", "16109", commune_code_old))))))))))))))))))))))
```

```{r restructureData}
chile_bayes <- chile_merged %>%
  #select(-student_commune_name) %>%
  left_join(region_service_commune_lookup %>% as.tibble() %>% select(-geometry), by = "commune_code") %>%
  filter(age_june30 >= 6 & age_june30 <= 18,
         #special_needs_status == 1,
         sex != 0) %>%
  mutate(autism = ifelse(special_needs_code == 105, 1, 0),
         adhd = ifelse(special_needs_code == 203, 1, 0),
         age_cat_code = ifelse(age_june30 <= 8, 1, 
                   ifelse(age_june30 <= 11, 2, 
                   ifelse(age_june30 <= 14, 3, 4))),
         age_cat_name = factor(ifelse(age_cat_code == 1, "6-8", 
                               ifelse(age_cat_code == 2, "9-11", 
                               ifelse(age_cat_code == 3, "12-14", "15-18"))),
                               levels = c("6-8", "9-11", "12-14", "15-18")),
         # ethnic_2_group = ifelse(ethnic_3_group == "Other ethnic group", "Other Indigenous group",
         #                  ifelse(ethnic_3_group == "Aymara", "Other Indigenous group",
         #                  ifelse(ethnic_3_group == "No Native Group", "No Indigenous group", ethnic_3_group))),
         ethnic_2_group = factor(ifelse(ethnicity == "Mapuche", "Mapuche", 
                          ifelse(ethnicity == "No Native Group" | ethnicity == "No registry", "No Indigenous group",
                                 "Other Indigenous group")), 
                          levels = c("Mapuche", "Other Indigenous group", "No Indigenous group")),
         school_rurality = ifelse(school_rurality_code == 0, "Urban", "Rural"),
         school_fee_temp = school_fee,
         school_fee = ifelse(school_fee == "", "No information", 
                      ifelse(school_fee == "GRATUITO", "Free", 
                      ifelse(school_fee == "$1.000 A $10.000", "$1,000-$10,000",
                      ifelse(school_fee == "$10.001 A $25.000", "$10,001-$25,000", 
                      ifelse(school_fee == "$25.001 A $50.000", "$25,001-$50,000",
                      ifelse(school_fee == "$50.001 A $100.000", "$50,001-$100,000", 
                      ifelse(school_fee == "MAS DE $100.000", "$100,001+", 
                      ifelse(school_fee == "SIN INFORMACION", "No information", NA)))))))),
         school_fee = factor(school_fee, levels = c("Free", "$1,000-$10,000", 
                                                    "$10,001-$25,000", "$25,001-$50,000",
                                                    "$50,001-$100,000", "$100,001+", 
                                                    "No information")),
         school_fee_group = ifelse(school_fee == "Free", "Free", 
                            ifelse(school_fee %in% c("$1,000-$10,000", "$10,001-$25,000",
                                                     "$25,001-$50,000", "$50,001-$100,000"), "Low",
                            ifelse(school_fee == "$100,001+", "Medium", 
                            ifelse(school_fee == "No information", "No information", NA)))),
         school_fee_group = factor(school_fee_group, levels = c("Free", "Low", "Medium",
                                                                "No information"))) %>% 
  select(#school_region_name_abr,
    region_code,
    region_name,
    region_name_abr,
    commune_code, # student, see chile_merged
    student_commune_name, # upper case, from chile_merged
    commune_name, # Sentence case, from lookup table
    health_service_code,
    health_service_name,
    sex,
    sex_desc,
    age_june30,
    age_cat_code,
    age_cat_name,
    school_rurality_code,
    school_rurality,
    pago_matricula,
    pago_mensual,
    school_fee,
    school_fee_group,
    school_fee_temp,
    ethnicity,
    mapuche,
    nationality,
    ethnic_3_group,
    ethnic_2_group,
    special_needs_status,
    special_needs_code,
    autism,
    adhd
  ) 

chile_bayes_aut <- chile_bayes %>% select(-adhd)
chile_bayes_adhd <- chile_bayes %>% select(-autism)

mapuche_regions <- c("09", "11", "09", "10", "14", "12", "13")
chile_bayes_aut_ethnic <- chile_bayes_aut %>%
  filter(region_code %in% mapuche_regions)
chile_bayes_adhd_ethnic <- chile_bayes_adhd %>%
  filter(region_code %in% mapuche_regions)
```

```{r importClinicalData}
clinical_large_raw <- read_excel("04_Data/dataset_ssas_2015_2021.xlsx") %>% clean_names
#describe(clinical_raw)

clinical_large <- clinical_large_raw %>%
  select(c(-procedence, -ethnicity, -education_level, -disability, -foster_care)) %>%
  # Fix the date columns
  mutate(dob_eng = ifelse(str_detect(date_of_birth, "/"), 1,
                   ifelse(str_detect(date_of_birth, "-"), 0, NA)),
         apt_eng = ifelse(str_detect(date_appointment, "/"), 1, ifelse(str_detect(date_appointment, "-"), 0, NA)),
         dob_day = ifelse(dob_eng == 1, as.integer(str_extract(date_of_birth, "^\\d+")), 
                   ifelse(dob_eng == 0, as.integer(str_extract(date_of_birth, "^\\d+")), NA)),
         dob_month = ifelse(dob_eng == 1, as.integer(str_extract(date_of_birth, "(?<=/)\\d+(?=/)")), 
                     ifelse(dob_eng == 0, str_extract(date_of_birth, "(?<=-)\\w+(?=-)"), NA)),
         dob_year = ifelse(dob_eng == 1, as.integer(str_extract(date_of_birth, "\\d+$")), 
                    ifelse(dob_eng == 0, as.integer(str_extract(date_of_birth, "\\d+$")) + 2000, NA)),
         dob_month_eng = as.integer(ifelse(dob_month == "ene", 1,
                                    ifelse(dob_month == "abr", 4, 
                                    ifelse(dob_month == "ago", 8, 
                                    ifelse(dob_month == "sept", 9, 
                                    ifelse(dob_month == "dic", 12, dob_month)))))),
         dob = make_date(year = dob_year, month = dob_month_eng, day = dob_day),
         apt_day = ifelse(apt_eng == 1, as.integer(str_extract(date_appointment, "^\\d+")), 
                   ifelse(apt_eng == 0, as.integer(str_extract(date_appointment, "^\\d+")), NA)),
         apt_month = ifelse(apt_eng == 1, as.integer(str_extract(date_appointment, "(?<=/)\\d+(?=/)")), 
                     ifelse(apt_eng == 0, str_extract(date_appointment, "(?<=-)\\w+(?=-)"), NA)),
         apt_year = ifelse(apt_eng == 1, as.integer(str_extract(date_appointment, "\\d+$")), 
                    ifelse(apt_eng == 0, as.integer(str_extract(date_appointment, "\\d+$")) + 2000, NA)),
         apt_month_eng = as.integer(ifelse(apt_month == "ene", 1,
                                    ifelse(apt_month == "abr", 4, 
                                    ifelse(apt_month == "ago", 8, 
                                    ifelse(apt_month == "sept", 9, 
                                    ifelse(apt_month == "dic", 12, apt_month)))))),
         apt_date = make_date(year = apt_year, month = apt_month_eng, day = apt_day),
         age_june30 = trunc(time_length(interval(ymd(dob), ymd("2021-06-30")), unit = "year")),
         commune_name_upper = ifelse(comuna == "CHOL CHOL", "CHOLCHOL",
                        ifelse(comuna == "CURACAUTIN", "CURACAUTÍN",
                        ifelse(comuna == "PITRUFQUEN", "PITRUFQUÉN",
                        ifelse(comuna == "PUCON", "PUCÓN",
                        ifelse(comuna == "TOLTEN", "TOLTÉN",
                        ifelse(comuna == "VILCUN", "VILCÚN", comuna)))))),
         #commune_name_upper = comuna,
         ses_status = ifelse(socio_economic_level == "FONASA - A", 1, 
                      ifelse(socio_economic_level == "FONASA - B", 2,
                      ifelse(socio_economic_level == "FONASA - C", 2, 
                      ifelse(socio_economic_level == "FONASA - D", 2,
                      ifelse(socio_economic_level == "Private Health Insurance", 3, 
                      ifelse(socio_economic_level %in% c("COLMENA GOLDEN CROSS", "RIO BLANCO", "CARABINEROS (DIPRECA)", "BANMEDICA S.A.", "PARTICULAR (SIN PREVISION)", "VIDA TRES"), 3, NA)))))),
         autism = 1,
         intdisab = 0,
         aut_rank = 1
         ) %>%
  left_join(region_service_commune_lookup, by = "commune_name_upper") %>%
  select(id, gender, 
         commune_code, commune_name, commune_name_upper, 
         health_service_name, region_name, 
         socio_economic_level, ses_status, 
         dob, age_june30, 
         apt_date, hospital, medical_specialty, type_appointment,
         autism, intdisab, aut_rank) 

aut_codes <- unique(clinical_large_raw$codigo)

clinical_small_raw <- read_excel("04_Data/Dataset_Vill_2014_2021.xlsx", col_names = TRUE) %>% clean_names()

clinical_small <- clinical_small_raw %>%
  rename("dob" = "fecha_nacimiento",
         "apt_date" = "fecha_ejecutada",
         "type_appointment" = "appoinment",
         "diagnosis" = "diagnostico_1") %>%
  mutate(gender = str_to_title(gender),
         autism = ifelse(cod_dg_1 %in% aut_codes | 
                           cod_dg_2 %in% aut_codes | 
                           cod_dg_3 %in% aut_codes, 1, 0),
         aut_rank = ifelse(cod_dg_1 %in% aut_codes, 1,
                    ifelse(cod_dg_2 %in% aut_codes, 2,
                    ifelse(cod_dg_3 %in% aut_codes, 3, NA))),
         age_june30 = trunc(time_length(interval(ymd(dob), ymd("2021-06-30")), unit = "year")),
         commune_name_upper = ifelse(comuna == "CHOL CHOL", "CHOLCHOL",
                        ifelse(comuna == "CURACAUTIN", "CURACAUTÍN", 
                        ifelse(comuna == "PITRUFQUEN", "PITRUFQUÉN", 
                        ifelse(comuna == "PUCON", "PUCÓN", 
                        ifelse(comuna == "TOLTEN", "TOLTÉN", 
                        ifelse(comuna == "VILCUN", "VILCÚN", 
                        ifelse(comuna == "DIEGO DE ALMAGRO  (#)", "DIEGO DE ALMAGRO",
                        ifelse(comuna == "MACHALI", "MACHALÍ",
                        ifelse(comuna == "TEMUCO (##)", "TEMUCO", comuna))))))))),
         ses_status = ifelse(socio_economic_level == "FONASA - A", 1, 
                      ifelse(socio_economic_level == "FONASA - B", 2,
                      ifelse(socio_economic_level == "FONASA - C", 2, 
                      ifelse(socio_economic_level == "FONASA - D", 2,
                      ifelse(socio_economic_level == "Private Health Insurance", 3, 
                      ifelse(socio_economic_level %in% c("COLMENA GOLDEN CROSS", "RIO BLANCO", "CARABINEROS (DIPRECA)", "BANMEDICA S.A.", "PARTICULAR (SIN PREVISION)", "VIDA TRES"), 3, NA))))))
         ) %>%
  left_join(region_service_commune_lookup, by = "commune_name_upper") %>%
  #filter(autism == 1) %>%
  select(id, gender, commune_code, commune_name, commune_name_upper, health_service_name, region_name, socio_economic_level, ses_status, dob, age_june30, apt_date, hospital, medical_specialty, type_appointment, cod_dg_1, cod_dg_2, cod_dg_3, diagnosis, autism, aut_rank) 
# Throws a warning because there are 2 records for Tocopila which is in two regions. Will keep both because we have no way of knowing which is correct.
# Doesn't anymore because I changed the lookup to have only 1 Tocopilla row

intdisab_codes <- unique(c(clinical_small_raw$cod_dg_1, clinical_small_raw$cod_dg_2, clinical_small_raw$cod_dg_3)) %>%
  str_subset("F7") %>%
  sort() 

clinical_small <- clinical_small %>% 
  mutate(intdisab = ifelse(cod_dg_1 %in% intdisab_codes |
                             cod_dg_2 %in% intdisab_codes | 
                             cod_dg_3 %in% intdisab_codes, 1, 0)) %>%
  #rename("codigo" = "cod_dg_1") %>%
  select(c(-cod_dg_1, -cod_dg_2, -cod_dg_3, -diagnosis))

clinical <- rbind(clinical_large, clinical_small)

clinical_communes <- clinical %>% group_by(commune_code) %>% summarise() %>% arrange() %>%
  mutate(commune_in_school_data = ifelse(commune_code %in% unique(chile_merged$commune_code), 1, 0)) # Needs to all be 1's

#clinical_out <- clinical %>% filter(commune_code %in% araucsur_communes$commune_code)
#write_csv(clinical_out, file = "04_Data/Outputs/clinical.csv")

```


```{r functionsBayes}

get_grouped_prev_plot <- function(x, grouping_vars, disease) {
  # Calculates sample prevalence and its confidence intervals for supplied feature grouping
  # x = chile_bayes_aut or chile_bayes_adhd, needs columns called autism or adhd, and count
  # grouping_vars = variables in x to group by
  # disease = autism or adhd
  
  x_grouped <- x %>% 
    group_by(across(all_of(grouping_vars))) %>%
    summarise(count = n()) %>%
    pivot_wider(names_from = disease, values_from = count) %>%
    rename("n_nodisease" = "0", "n_disease" = "1") %>% #, "age" = "age_june30") %>%
    mutate(n_disease = ifelse(is.na(n_disease), 0, n_disease), # If there are no cases of autism in the group, input 0
           sample_pop_size = n_nodisease + n_disease, # Total sample population is autism cases + not cases
           sample_prevalence = n_disease / sample_pop_size, # Prevalence of autism in the group
           ci_lower = sample_prevalence - (1.96 * sqrt(sample_prevalence * (1 - sample_prevalence) / sample_pop_size)),
           ci_upper = sample_prevalence + (1.96 * sqrt(sample_prevalence * (1 - sample_prevalence) / sample_pop_size)),
           ci_lower = ifelse(ci_lower < 0, 0, ci_lower),
           prev_ci = paste0(sprintf("%.2f", round(sample_prevalence * 100, 2)),
                            " (",
                            sprintf("%.2f", round(ci_lower * 100, 2)),
                            ", ", 
                            sprintf("%.2f", round(ci_upper * 100, 2)),
                            ")")) %>%
    ungroup()
  return(x_grouped)
}

get_grouped_prev <- function(x, stdpop, grouping_vars, disease) {
  # Calculates sample prevalence, age- and sex-standardised prevalence and group weighting for supplied feature grouping
  # x = chile_bayes_aut, needs columns called autism, count
  # stdpop = standard population with age and sex counts
  # grouping_vars = variables in x to group by
  # disease = autism or adhd
  
  n_stdpop <- sum(stdpop$std_pop)
  
  x_grouped <- x %>% 
    group_by(across(all_of(grouping_vars))) %>%
    summarise(count = n()) %>%
    pivot_wider(names_from = disease, values_from = count) %>%
    rename("n_nodisease" = "0", "n_disease" = "1", "age" = "age_june30") %>%
    mutate(n_disease = ifelse(is.na(n_disease), 0, n_disease), # If there are no cases of autism in the group, input 0
           sample_pop_size = n_nodisease + n_disease, # Total sample population is autism cases + not cases
           sample_prevalence = n_disease / sample_pop_size) %>% # Prevalence of autism in the group
    left_join(stdpop, by = c("age", "sex")) %>%
    mutate(disease_prev_std = n_disease / sample_pop_size * pop_prop, # Prevalence of autism in the group, standardised to standard population
           w = std_pop / (sample_pop_size * n_stdpop), # Weight of the group using standard population
           w2 = pop_prop / sample_pop_size,
           #sum_std_pop = sum(std_pop)
           ) %>%
    ungroup()
  return(x_grouped)
}

get_adjusted_prev <- function(x, grouping_vars) {
  # Turns grouped prevalences into age- and sex- adjusted prevalences with Fay and Feuer Gamma confidence intervals
  # x = output from get_grouped_prev
  x_adj <- x %>%
  group_by(across(all_of(grouping_vars))) %>%
  summarise(sum_sample_pop_size = sum(sample_pop_size),
            crude_rate = sum(n_disease) / sum(sample_pop_size),
            crude_count = sum(n_disease),
            adjusted_rate = sum(n_disease / sample_pop_size * pop_prop),
            adjusted_count = round(adjusted_rate * sum_sample_pop_size, 0), # had to fudge this to get MCMC to run bc it needs integers
            #adjusted_count = adjusted_rate * sum_sample_pop_size,
            var = sum(pop_prop^2 * n_disease / sample_pop_size^2),
            #se2 = sqrt(sum((std_pop/sum(std_pop))^2 * n_autism/sample_pop_size^2)),
            w_M = max(w),
            crude_ci_lower = crude_rate - (1.96 * sqrt(crude_rate * (1 - crude_rate) / sum_sample_pop_size)),
            crude_ci_upper = crude_rate + (1.96 * sqrt(crude_rate * (1 - crude_rate) / sum_sample_pop_size)),
            adjusted_ci_lower = ifelse(var == 0, 0, var / (2*adjusted_rate) * qchisq(p = 0.05/2, df = 2*adjusted_rate^2 / var)),
            adjusted_ci_upper = (var + w_M^2) / (2*(adjusted_rate + w_M)) * qchisq(p = 1-0.05/2, df = 2*(adjusted_rate+w_M)^2 / (var+w_M^2)),
            crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
            adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower),
            crude_prev_ci = paste0(sprintf("%.2f", round(crude_rate * 100, 2)),
                            " (",
                            sprintf("%.2f", round(crude_ci_lower * 100, 2)),
                            ", ", 
                            sprintf("%.2f", round(crude_ci_upper * 100, 2)),
                            ")"),
            adjusted_prev_ci = paste0(sprintf("%.2f", round(adjusted_rate * 100, 2)),
                            " (",
                            sprintf("%.2f", round(adjusted_ci_lower * 100, 2)),
                            ", ", 
                            sprintf("%.2f", round(adjusted_ci_upper * 100, 2)),
                            ")")) %>%
  arrange(across(all_of(grouping_vars)))
}

do_jags_rand_model <- function(x, feat, model, theta_mu, theta_sigma, pars, nBurn = 1000, nIter = 1000, convergence_checks = FALSE) {
  # x = output from get_adjusted_prev. Needs to have columns sum_sample_pop_size, adjusted_count
  # feat = feature being used as random effect
  # model = JAGS random effects model
  # theta_mu, theta_sigma = mean and sd of beta prior distribution
  # pars = model parameters to report
  # nBurn = number of burn-in samples
  # nIter = number of posterior iterations
  
  nFeat <- length(unique(x[[feat]]))
  FeatNames <- sort(unique(x[[feat]]))
  
  # Define beta prior
  theta_a <- theta_mu * (theta_mu * (1-theta_mu) / theta_sigma^2 - 1)
  theta_b <- (1 - theta_mu) * (theta_mu * (1-theta_mu) / theta_sigma^2 - 1)
  
  # Initial values for model chains
  rand_ini <- list(list(theta = rep(0.001, nFeat)), #, spec = 0.5, sens = 0.5),
                   list(theta = rep(0.01, nFeat))) #, spec = 0.9, sens = 0.9)) 
  
  # Run JAGS model
  rand_data <- list(theta_a = theta_a, 
                    theta_b = theta_b,
                    nObs = x$sum_sample_pop_size,
                    disease_sample = x$adjusted_count,
                    nFeat = nFeat)
  rand_jag <- jags.model(textConnection(model),
                         data = rand_data,
                         inits = rand_ini,
                         n.chains = 2,
                         quiet = TRUE)
  update(rand_jag, n.iter = nBurn)
  rand_sam <- coda.samples(model = rand_jag,
                           variable.names = pars,
                           n.iter = nIter)
  
  # Convergence checks
  if(convergence_checks) {
    print(mcmc_trace(rand_sam, paste0("theta[", 1:nFeat, "]"))) # Convergence looks fine and rhats <= 1.1
    print(mcmc_trace(rand_sam, paste0("disease_pred[", 1:nFeat, "]"))) # Convergence looks fine and rhats <= 1.1
    rand_summ <- summary(subset_draws(as_draws(rand_sam), pars),
                         ~quantile(.x, probs=c(0.025, 0.5, 0.975)),
                         ~mcse_quantile(.x, probs=c(0.025, 0.5, 0.975)),
                         "rhat") %>%
      arrange(desc(rhat))
    print(rand_summ)
  }
  
  # Extract posterior density
  prev_post <- as_tibble(as_draws_matrix(rand_sam), rownames = "Iteration") %>%
    select(c("Iteration", contains("theta["))) %>%
    pivot_longer(cols = contains("theta["),
                 names_to = "Feat",
                 values_to = "predicted_prev") %>%
    mutate(Feat_names = factor(Feat, levels = c(paste0("theta[",1:nFeat,"]")), labels = FeatNames)) %>%
    select(Iteration, Feat_names, predicted_prev)
  
  return(prev_post)
}


plot_post_density <- function(jags_post, sample_data, feat, theta_mu, theta_sigma, disease, title_text = "") {
  # Plots posterior densities and their 95% credible intervals, and sample prevalence confidence intervals
  # jags_post = output from do_jags_rand_model, ie posterior densities
  # sample data = output from get_adjusted_prev, ie sample prevalences with confidence intervals
  # feat = the same feature used as the random effect in do_jags_rand_model
  # theta_mu, theta_sigma = mean and sd of beta prior distribution used in do_jags_rand_model
  # disease = autism or ADHD
  # title_text = any additional text for the title, eg grouing variables
  
  # calcuate posterior credible intervals
  post_ci <- jags_post %>%
  group_by(across(all_of(feat))) %>%
  summarise(post_lower = quantile(predicted_prev, 0.025),
            post_upper = quantile(predicted_prev, 0.975))
  
  print(ggplot() +
          geom_density(data = jags_post, aes(x = predicted_prev)) +
          geom_vline(data = post_ci, aes(xintercept = post_lower), color = "blue", linetype = "dotted") +
          geom_vline(data = post_ci, aes(xintercept = post_upper), color = "blue", linetype = "dotted") +
          geom_vline(data = sample_data, aes(xintercept = adjusted_ci_lower), color = "red", linetype = "dashed") +
          geom_vline(data = sample_data, aes(xintercept = adjusted_ci_upper), color = "red", linetype = "dashed") +
          facet_wrap(as.formula(paste0("~", feat))) +
          labs(title = paste0(disease, " prevalence, prior mean = ", signif(theta_mu, 3), ", prior sd = ", signif(theta_sigma, 3), title_text),
               x = "Posterior predictive distribution",
               y = "Density"))
}
```

```{r functionsRestructure}
# Define some functions to help with restructuring clinical data into patient level data
get.min.na <- function(x) ifelse( !all(is.na(x)), min(x, na.rm = TRUE), NA)

get.max.na <- function(x) ifelse( !all(is.na(x)), max(x, na.rm = TRUE), NA)

get.mode.na <- function(x) {
  ux <- na.omit(unique(x))
  ux[which.max(tabulate(match(x, ux)))]
}

get.mapuche.ethnicity <- function(x) {
  y <- NA
  if(any(x == "Mapuche")) {
    y <- "Mapuche"
  } else if(any(x == "Chilean")) {
    y <- "Chilean"
  } else if(any(x == "Foreign")) {
    y <- "Foreign"
  } else {
    y <- "No ethnicity information"
  }
  return(y)
}

get.yes.disability <- function(x) {
  y <- NA
  if(any(x == "Yes")) {
    y <- "Yes disability"
  } else if(any(x == "No")) {
    y <- "No disability"
  } else {
    y <- "No disability information"
  }
  return(y)
}

get.yes.fostercare <- function(x) {
  y <- NA
  if(any(x == "Yes")) {
    y <- "Yes foster care"
  } else if(any(x == "No")) {
    y <- "No foster care"
  } else {
    y <- "No foster care information"
  }
  return(y)
}
```


```{r colours}
plasma_colours <- viridis(10, option = "C") #"#0D0887FF" "#47039FFF" "#7301A8FF" "#9C179EFF" "#BD3786FF" "#D8576BFF" "#ED7953FF" "#FA9E3BFF" "#FDC926FF" "#F0F921FF"
viridis_colours <- viridis(20, option = "D") 
rocket_colours <- viridis(20, option = "F")
turbo_colours <- viridis(17, option = "H") #"#30123BFF" "#4662D7FF" "#36AAF9FF" "#1AE4B6FF" "#72FE5EFF" "#C7EF34FF" "#FABA39FF" "#F66B19FF" "#CB2A04FF" "#7A0403FF"
  
```



# Abstract

TODO


# Declaration

This dissertation is the result of my own work and includes nothing which is the outcome of work done in collaboration except where specifically indicated in the text.

USN: xxxxx July, 2022

TODO - is this section needed?


# Introduction

TODO - copy in intro text

```{r map}
#commune_geoms <- data.frame(mapa_comunas)
#communes_lookup <- data.frame(codigos_territoriales)

# Get region-level geometries with demographic data for plotting
demog_geom <- chile.adm1 %>%
  left_join(region_lookup, by = "ADM1_PCODE") %>%
  left_join(chile_regionpop, by = "region_name") %>%
  left_join(chile_regionincome, by = "region_name")

#chile.adm2 <- st_read("04_Data/CHL_adm/CHL_adm2.shp") # Also doesn't have Biobio
#chile.adm2 <- st_transform(chile.adm2, crs = 32629)

#region_geoms_demog <- region_geoms %>%
#  left_join(chile_regionpop, by = "nombre_region") %>%
#  left_join(chile_regionincome, by = "nombre_region") %>%
#  select(-region)
```

```{r mapPop, include = TRUE, fig.cap = "Population of 0-14 year olds in Chile in 2021 by region, from 2017 census projections."}
# Population
ggplot(demog_geom) + 
  geom_sf(mapping = aes(geometry = geometry, fill = youth_pop_2021), linewidth = 0.01) +
  geom_sf_text(mapping = aes(geometry = geometry, label = region_name), nudge_x = 8, size = 3) +
  scale_fill_viridis(option = "viridis", direction = 1, name = "Population") + #, limits = c(23000, 400000), oob = scales::squish) +
  labs(title = "Population aged 0-14 (2021 projections)") +
  xlab("Longitude") +
  ylab("Latitude") +
  coord_sf(xlim = c(-85, -50), ylim = c(-60, -15))
```

```{r mapIncome, include = TRUE, fig.cap = "Net income from main job in Chile in 2021 by region, from the INE's Supplementary Income Survey."}
# Income
ggplot(demog_geom) + 
  geom_sf(mapping = aes(geometry = geometry, fill = ingreso_medio_nominal), linewidth = 0.01) +
  geom_sf_text(mapping = aes(geometry = geometry, label = region_name), nudge_x = 8, size = 3) +
  scale_fill_viridis(option = "viridis", direction = 1, name = "Median income (Peso)") +
  labs(title = "Net income (2021)") +
  xlab("Longitude") +
  ylab("Latitude") +
  coord_sf(xlim = c(-85, -50), ylim = c(-60, -15))
```


```{r healthRegion, fig.cap = "Residential communes aggregated to region level and the health services associated with the aggregated communes, with counts of the number of students resident in the communes in each health service's catchment area."}
map_tab_df <- as.data.frame(table(chile_bayes$region_name, chile_bayes$health_service_name))
ggplot(map_tab_df, aes(x = Var1, y = Var2, fill = Freq)) +
  geom_tile() +
  scale_fill_viridis_c(option = "rocket", direction = -1) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  scale_y_discrete(limits = rev(levels(map_tab_df$Var2))) +
  labs(title = "Students' residential region and health service",
       x = "Region", y = "Health service", fill = "Count")
```

```{r mapHealthServices, include = FALSE, fig.cap = "Health services in Chile, coloured by region they serve."}
# Income

# health_service_geom <- region_service_commune_lookup %>%
#   group_by(health_service_name) %>% 
#   summarize(geometry = st_union(geometry))
# 
# ggplot(region_service_commune_lookup %>% filter(health_service_name == "Iquique")) + 
#   geom_sf(mapping = aes(geometry = geometry, fill = health_service_name), linewidth = 0.01) +
#   geom_sf_text(mapping = aes(geometry = geometry, label = commune_name), nudge_x = 8, size = 3) +
#   #scale_fill_viridis(option = "viridis", direction = 1, name = "Health service") +
#   labs(title = "Net income (2021)") +
#   xlab("Longitude") +
#   ylab("Latitude") #+
#   #coord_sf(xlim = c(-85, -50), ylim = c(-60, -15))
# 
# 
# region_service_commune_lookup %>% 
#   filter(health_service_name == "Iquique") %>%
#   summarise(geometry = st_union(geometry))
```

```{r mapArauc, fig.cap = "Communes in the Araucanía region, coloured red for the Araucanía Norte (north Araucanía) health services and blue for the Araucanía Sur (south Araucanía) health service."}
# ARAUC communes
arauc <- region_service_commune_lookup %>%
  filter(ADM1_PCODE == "CL09")

ggplot(arauc) +
  geom_sf(mapping = aes(geometry = geometry, fill = health_service_name)) +
  geom_sf_text(mapping = aes(geometry = geometry, label = commune_name), size = 3) +
  coord_sf(xlim = c(-74, -70.5), ylim = c(-40, -37.5)) +
  labs(title = "Communes in La Araucania") +
  xlab("Longitude") +
  ylab("Latitude")
```

# Methods

TODO - copy in methods


# Results

## School data

```{r adjPrev}
# Autism
aut_prev <- get_grouped_prev(x = chile_bayes_aut, stdpop = chile_stdpop, 
                             grouping_vars = c("age_june30", "age_cat_name", "sex", "sex_desc", "autism"),
                             disease = "autism")

aut_prev_adj <- aut_prev %>% # Don't use get_adjusted_prev here because we have no variables to group on
  summarise(sum_sample_pop_size = sum(sample_pop_size),
            crude_rate = sum(n_disease) / sum(sample_pop_size),
            crude_count = sum(n_disease),
            adjusted_rate = sum(n_disease / sample_pop_size * pop_prop),
            adjusted_count = round(adjusted_rate * sum_sample_pop_size, 0), # had to fudge this to get MCMC to run bc it needs integers
            #adjusted_count = adjusted_rate * sum_sample_pop_size,
            var = sum(pop_prop^2 * n_disease / sample_pop_size^2),
            #se2 = sqrt(sum((std_pop/sum(std_pop))^2 * n_autism/sample_pop_size^2)),
            w_M = max(w),
            crude_ci_lower = crude_rate - (1.96 * sqrt(crude_rate * (1 - crude_rate) / sum_sample_pop_size)),
            crude_ci_upper = crude_rate + (1.96 * sqrt(crude_rate * (1 - crude_rate) / sum_sample_pop_size)),
            adjusted_ci_lower = ifelse(var == 0, 0, var / (2*adjusted_rate) * qchisq(p = 0.05/2, df = 2*adjusted_rate^2 / var)),
            adjusted_ci_upper = (var + w_M^2) / (2*(adjusted_rate + w_M)) * qchisq(p = 1-0.05/2, df = 2*(adjusted_rate+w_M)^2 / (var+w_M^2))) %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))

# ADHD
adhd_prev <- get_grouped_prev(x = chile_bayes_adhd, stdpop = chile_stdpop, 
                             grouping_vars = c("age_june30", "age_cat_name", "sex", "sex_desc", "adhd"),
                             disease = "adhd")

adhd_prev_adj <- adhd_prev %>% # Don't use get_adjusted_prev here because we have no variables to group on
  summarise(sum_sample_pop_size = sum(sample_pop_size),
            crude_rate = sum(n_disease) / sum(sample_pop_size),
            crude_count = sum(n_disease),
            adjusted_rate = sum(n_disease / sample_pop_size * pop_prop),
            adjusted_count = round(adjusted_rate * sum_sample_pop_size, 0), # had to fudge this to get MCMC to run bc it needs integers
            #adjusted_count = adjusted_rate * sum_sample_pop_size,
            var = sum(pop_prop^2 * n_disease / sample_pop_size^2),
            #se2 = sqrt(sum((std_pop/sum(std_pop))^2 * n_autism/sample_pop_size^2)),
            w_M = max(w),
            crude_ci_lower = crude_rate - (1.96 * sqrt(crude_rate * (1 - crude_rate) / sum_sample_pop_size)),
            crude_ci_upper = crude_rate + (1.96 * sqrt(crude_rate * (1 - crude_rate) / sum_sample_pop_size)),
            adjusted_ci_lower = ifelse(var == 0, 0, var / (2*adjusted_rate) * qchisq(p = 0.05/2, df = 2*adjusted_rate^2 / var)),
            adjusted_ci_upper = (var + w_M^2) / (2*(adjusted_rate + w_M)) * qchisq(p = 1-0.05/2, df = 2*(adjusted_rate+w_M)^2 / (var+w_M^2))) %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))
```

The school dataset contained records for `r format(nrow(chile_bayes), big.mark = ",", trim = TRUE)` Chilean students aged 6-18 in 2021. Of these, `r format(chile_bayes %>% filter(sex_desc == "Female") %>% nrow(), big.mark = ",", trim = TRUE)` (`r round(chile_bayes %>% filter(sex_desc == "Female") %>% nrow() / nrow(chile_bayes) * 100, 2)`%) were female and the rest were male.  A special needs code was recorded for `r format(chile_bayes %>% filter(special_needs_status == 1) %>% nrow(), big.mark = ",", trim = TRUE)` (`r round(chile_bayes %>% filter(special_needs_status == 1) %>% nrow() / nrow(chile_bayes) * 100, 2)`%) students, indicating they received SEED during that school year. Of these students, `r format(chile_bayes %>% filter(autism == 1) %>% nrow(), big.mark = ",", trim = TRUE)` (`r round(chile_bayes %>% filter(autism == 1) %>% nrow() / chile_bayes %>% filter(special_needs_status == 1) %>% nrow() * 100, 2)`%) received SEED for autism and `r format(chile_bayes %>% filter(adhd == 1) %>% nrow(), big.mark = ",", trim = TRUE)` (`r round(chile_bayes %>% filter(adhd == 1) %>% nrow() / chile_bayes %>% filter(special_needs_status == 1) %>% nrow() * 100, 2)`%) received SEED for ADHD. Thus the global crude prevalence of autism in the school data was `r round(aut_prev_adj$crude_rate * 100, 3)`% (`r round(aut_prev_adj$crude_ci_lower * 100, 3)`-`r round(aut_prev_adj$crude_ci_upper * 100, 3)`%) and the global crude prevalence of ADHD was `r sprintf("%.2f", round(adhd_prev_adj$crude_rate * 100, 2))`% (`r sprintf("%.2f", round(adhd_prev_adj$crude_ci_lower * 100, 2))`-`r round(adhd_prev_adj$crude_ci_upper * 100, 2)`%).

Tables \@ref(tab:prevAgeAutTable) and \@ref(tab:prevAgeAdhdTable) and Supplementary Figure x show the crude prevalences of autism and ADHD by age and Figure 5 shows these by 2-year age band. Autism prevalence is highest in the youngest ages and decreases with age while ADHD prevalence peaks at age 11 then decreases. Both conditions show a small increase in prevalence for age 18.

```{r prevAgeAutTable}
# Autism
aut_prev.age <- get_grouped_prev_plot(x = chile_bayes_aut, 
                                          grouping_vars = c("age_june30", "autism"),
                                          disease = "autism") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower)) 

aut_prev.age.table <- aut_prev.age %>%
  select(age_june30, n_disease, prev_ci)

kbl(aut_prev.age.table, 
    col.names = c("Age", "Autism cases", "Prevalence % (95% CI)"),
    align = "rrr",
    booktabs = TRUE,
    format = "pandoc",
    linesep = c("", "", "\\addlinespace"), # Extra white space after every 3rd line to match age bands
    caption = "Count and prevalence of autism cases by age in Chile school data with normal confidence intervals.")
```

```{r prevAgeAdhdTable}
# ADHD
adhd_prev.age <- get_grouped_prev_plot(x = chile_bayes_adhd, 
                                          grouping_vars = c("age_june30", "adhd"),
                                          disease = "adhd") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower)) 

adhd_prev.age.table <- adhd_prev.age %>%
  select(age_june30, n_disease, prev_ci)

kbl(adhd_prev.age.table,
    col.names = c("Age", "ADHD cases", "Prevalence % (95% CI)"),
    align = "rrr",
    booktabs = TRUE,
    format = "pandoc",
    linesep = c("", "", "\\addlinespace"), # Extra white space after every 3rd line to match age bands
    caption = "Count and prevalence of ADHD cases by age in Chile school data with normal confidence intervals.")
```

```{r prevAgecatPlot, fig.cap = "Sample prevalence of autism and ADHD by age band. Bars show 95% normal confidence intervals.", fig.height = 3}
# Plot both by age category
# Autism
aut_prev.agecat <- get_grouped_prev_plot(x = chile_bayes_aut, 
                                          grouping_vars = c("age_cat_name", "autism"),
                                          disease = "autism") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

aut_prev.agecat.plot <- ggplot(data = aut_prev.agecat) +
  geom_col(aes(x = age_cat_name, y = sample_prevalence*100, group = age_cat_name, fill = age_cat_name), position = position_dodge()) +
  geom_errorbar(aes(x = age_cat_name, ymin = ci_lower*100, ymax = ci_upper*100, group = age_cat_name), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_manual(values = c(plasma_colours[3], plasma_colours[5], plasma_colours[7], plasma_colours[9])) +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  labs(title = "Autism prevalence",
       x = "Age band",
       y = "Sample prevalence % (95% CI)",
       fill = "Age band")

# ADHD
adhd_prev.agecat <- get_grouped_prev_plot(x = chile_bayes_adhd, 
                                          grouping_vars = c("age_cat_name", "adhd"),
                                          disease = "adhd") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

adhd_prev.agecat.plot <- ggplot(data = adhd_prev.agecat) +
  geom_col(aes(x = age_cat_name, y = sample_prevalence*100, group = age_cat_name, fill = age_cat_name), position = position_dodge()) +
  geom_errorbar(aes(x = age_cat_name, ymin = ci_lower*100, ymax = ci_upper*100, group = age_cat_name), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_manual(values = c(plasma_colours[3], plasma_colours[5], plasma_colours[7], plasma_colours[9])) +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  labs(title = "ADHD prevalence",
       x = "Age band",
       y = "Sample prevalence % (95% CI)",
       fill = "Age band")

grid.arrange(aut_prev.agecat.plot, adhd_prev.agecat.plot, ncol = 2)
```


```{r adjPrevSex}
# Seperate sexes so that standardisation is correct
chile_stdpop_f <- chile_stdpop %>%
  filter(sex == 2) %>%
  mutate(pop_prop = std_pop / sum(std_pop))
chile_stdpop_m <- chile_stdpop %>%
  filter(sex == 1) %>%
  mutate(pop_prop = std_pop / sum(std_pop))

# Autism
aut_prev_f <- chile_bayes_aut %>%
  filter(sex == 2) %>%
  get_grouped_prev(stdpop = chile_stdpop_f, grouping_vars = c("age_june30", "sex", "autism"), disease = "autism")
aut_prev_adj_f <- get_adjusted_prev(aut_prev_f, grouping_vars = c()) %>% mutate(sex_desc = "Female") %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))

aut_prev_m <- chile_bayes_aut %>%
  filter(sex == 1) %>%
  get_grouped_prev(stdpop = chile_stdpop_m, grouping_vars = c("age_june30", "sex", "autism"), disease = "autism")
aut_prev_adj_m <- get_adjusted_prev(aut_prev_m, grouping_vars = c()) %>% mutate(sex_desc = "Male") %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))

aut_prev_sex_adj <- rbind(aut_prev_adj_m, aut_prev_adj_f) 

# ADHD
adhd_prev_f <- chile_bayes_adhd %>%
  filter(sex == 2) %>%
  get_grouped_prev(stdpop = chile_stdpop_f, grouping_vars = c("age_june30", "sex", "adhd"), disease = "adhd")
adhd_prev_adj_f <- get_adjusted_prev(adhd_prev_f, grouping_vars = c()) %>% mutate(sex_desc = "Female") %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))

adhd_prev_m <- chile_bayes_adhd %>%
  filter(sex == 1) %>%
  get_grouped_prev(stdpop = chile_stdpop_m, grouping_vars = c("age_june30", "sex", "adhd"), disease = "adhd")
adhd_prev_adj_m <- get_adjusted_prev(adhd_prev_m, grouping_vars = c()) %>% mutate(sex_desc = "Male") %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))

adhd_prev_sex_adj <- rbind(adhd_prev_adj_m, adhd_prev_adj_f) 

```


Tables 3 and 4 and figure 6 show prevalence by sex. Autism prevalence is `r round(aut_prev_sex_adj$crude_rate[2] * 100, 3)`% (`r round(aut_prev_sex_adj$crude_ci_lower[2] * 100, 3)`-`r round(aut_prev_sex_adj$crude_ci_upper[2] * 100, 3)`%) for females and `r sprintf("%.2f", round(aut_prev_sex_adj$crude_rate[1] * 100, 2))`% (`r round(aut_prev_sex_adj$crude_ci_lower[1] * 100, 2)`-`r round(aut_prev_sex_adj$crude_ci_upper[1] * 100, 2)`%) for males. ADHD prevalence is `r round(adhd_prev_sex_adj$crude_rate[2] * 100, 2)`% (`r sprintf("%.2f", round(adhd_prev_sex_adj$crude_ci_lower[2] * 100, 2))`-`r round(adhd_prev_sex_adj$crude_ci_upper[2] * 100, 2)`%) for females and `r sprintf("%.2f", round(adhd_prev_sex_adj$crude_rate[1] * 100, 2))`% (`r round(adhd_prev_sex_adj$crude_ci_lower[1] * 100, 2)`-`r round(adhd_prev_sex_adj$crude_ci_upper[1] * 100, 2)`%) for males. Autism and ADHD prevalences are higher in males than females for all ages.

```{r prevAgeSexAutTable}
# Autism
aut_prev.age_sex <- get_grouped_prev_plot(x = chile_bayes_aut, 
                                          grouping_vars = c("age_june30", "sex_desc", "autism"),
                                          disease = "autism") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

aut_prev.age_sex.table <- aut_prev.age_sex %>% filter(sex_desc == "Female") %>%
  select(age_june30, n_disease, prev_ci) %>%
  cbind(aut_prev.age_sex %>% filter(sex_desc == "Male") %>% select(n_disease, prev_ci))

kbl(aut_prev.age_sex.table, 
    col.names = c("Age", "Autism cases", "Prevalence % (95% CI)", "Autism cases", "Prevalence % (95% CI)"),
    align = "rrrrr",
    booktabs = TRUE,
    format = "pandoc",
    linesep = c("", "", "\\addlinespace",
                "", "", "\\addlinespace",
                "", "", "\\addlinespace",
                "", "", "", "\\addlinespace"), # Extra white space after every 3rd line to match age bands
    caption = "Count and prevalence of autism cases by age in Chile school data for females and males with normal confidence intervals.") %>%
  add_header_above(c(" " = 1, "Female" = 2, "Male" = 2))
```

```{r prevAgeSexAdhdTable}
# ADHD
adhd_prev.age_sex <- get_grouped_prev_plot(x = chile_bayes_adhd, 
                                          grouping_vars = c("age_june30", "sex_desc", "adhd"),
                                          disease = "adhd") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

adhd_prev.age_sex.table <- aut_prev.age_sex %>% filter(sex_desc == "Female") %>%
  select(age_june30, n_disease, prev_ci) %>%
  cbind(adhd_prev.age_sex %>% filter(sex_desc == "Male") %>% select(n_disease, prev_ci))

kbl(adhd_prev.age_sex.table, 
    col.names = c("Age", "ADHD cases", "Prevalence % (95% CI)", "ADHD cases", "Prevalence % (95% CI)"),
    align = "rrrrr",
    booktabs = TRUE,
    format = "pandoc",
    linesep = c("", "", "\\addlinespace",
                "", "", "\\addlinespace",
                "", "", "\\addlinespace",
                "", "", "", "\\addlinespace"), # Extra white space after every 3rd line to match age bands
    caption = "Count and prevalence of ADHD cases by age in Chile school data for females and males with normal confidence intervals.") %>%
  add_header_above(c(" " = 1, "Female" = 2, "Male" = 2))
```

```{r prevAgecatSexPlot, fig.cap = "Sample prevalence of autism and ADHD by age band and sex. Bars show 95% normal confidence intervals.", fig.height = 4}
# Plot both by age category and sex
# Autism
aut_prev.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_aut, 
                                          grouping_vars = c("age_cat_name", "sex_desc", "autism"),
                                          disease = "autism") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

aut_prev.agecat_sex.plot <- ggplot(data = aut_prev.agecat_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence*100, group = age_cat_name, fill = age_cat_name), position = position_dodge()) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower*100, ymax = ci_upper*100, group = age_cat_name), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_manual(values = c(plasma_colours[3], plasma_colours[5], plasma_colours[7], plasma_colours[9])) +
  labs(title = "Autism prevalence",
       x = "Sex",
       y = "Sample prevalence % (95% CI)",
       fill = "Age band")

# ADHD
adhd_prev.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_adhd, 
                                          grouping_vars = c("age_cat_name", "sex_desc", "adhd"),
                                          disease = "adhd") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

adhd_prev.agecat_sex.plot <- ggplot(data = adhd_prev.agecat_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence*100, group = age_cat_name, fill = age_cat_name), position = position_dodge()) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower*100, ymax = ci_upper*100, group = age_cat_name), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_manual(values = c(plasma_colours[3], plasma_colours[5], plasma_colours[7], plasma_colours[9])) +
  labs(title = "ADHD prevalence",
       x = "Sex",
       y = "Sample prevalence % (95% CI)",
       fill = "Age band")

grid.arrange(aut_prev.agecat_sex.plot, adhd_prev.agecat_sex.plot, ncol = 2)
```

```{r adjPrevHealth}
# Autism
aut_prev_health <- get_grouped_prev(x = chile_bayes_aut, stdpop = chile_stdpop, 
                                    grouping_vars = c("health_service_code", "age_june30", "age_cat_name", "sex", "sex_desc", "autism"),
                                    disease = "autism")

aut_prev_health_adj <- get_adjusted_prev(aut_prev_health, grouping_vars = "health_service_code") %>%
  merge(health_service_lookup, by = "health_service_code") %>%
  rename(health_service_name_long = health_service_name,
         health_service_name = health_service_name_short) %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))

# ADHD
adhd_prev_health <- get_grouped_prev(x = chile_bayes_adhd, stdpop = chile_stdpop, 
                                    grouping_vars = c("health_service_code", "age_june30", "age_cat_name", "sex", "sex_desc", "adhd"),
                                    disease = "adhd")

adhd_prev_health_adj <- get_adjusted_prev(adhd_prev_health, grouping_vars = "health_service_code") %>%
  merge(health_service_lookup, by = "health_service_code") %>%
  rename(health_service_name_long = health_service_name,
         health_service_name = health_service_name_short) %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))
```

Autism varies by health service, as shown in Table 5 and Figure 7. Autism prevalence is highest in Ñuble at `r round(aut_prev_health_adj$crude_rate[29] * 100, 2)`% (`r round(aut_prev_health_adj$crude_ci_lower[29] * 100, 2)` - `r sprintf("%.2f", round(aut_prev_health_adj$crude_ci_upper[29] * 100, 2))`%) and Antofagasta at `r round(aut_prev_health_adj$crude_rate[3] * 100, 2)`% (`r round(aut_prev_health_adj$crude_ci_lower[3] * 100, 2)`- `r round(aut_prev_health_adj$crude_ci_upper[3] * 100, 2)`%), and is lowest in Metropolitano Norte at `r round(aut_prev_health_adj$crude_rate[19] * 100, 2)`% (`r round(aut_prev_health_adj$crude_ci_lower[19] * 100, 2)` - `r sprintf("%.2f", round(aut_prev_health_adj$crude_ci_upper[19] * 100, 2))`%) and Araucanía Norte at `r sprintf("%.2f", round(aut_prev_health_adj$crude_rate[4] * 100, 2))`% (`r round(aut_prev_health_adj$crude_ci_lower[4] * 100, 2)`- `r round(aut_prev_health_adj$crude_ci_upper[4] * 100, 2)`%). Autism peaks in the 6-8 age band across all services except Chiloé and Magallanes where it peaks in the 9-11 band.

ADHD prevalence also varies across health services, as shown in Table 6 and Figure 8. ADHD prevalence is highest in Magallanes at `r round(adhd_prev_health_adj$crude_rate[17] * 100, 2)`% (`r round(adhd_prev_health_adj$crude_ci_lower[17] * 100, 2)` - `r sprintf("%.2f", round(adhd_prev_health_adj$crude_ci_upper[17] * 100, 2))`%) and Talcahuano at `r round(adhd_prev_health_adj$crude_rate[25] * 100, 2)`% (`r round(adhd_prev_health_adj$crude_ci_lower[25] * 100, 2)`- `r round(adhd_prev_health_adj$crude_ci_upper[25] * 100, 2)`%), and is lowest in Atacama at `r round(adhd_prev_health_adj$crude_rate[8] * 100, 2)`% (`r round(adhd_prev_health_adj$crude_ci_lower[8] * 100, 2)` - `r sprintf("%.2f", round(adhd_prev_health_adj$crude_ci_upper[8] * 100, 2))`%) and Antofagasta at `r sprintf("%.2f", round(adhd_prev_health_adj$crude_rate[3] * 100, 2))`% (`r round(adhd_prev_health_adj$crude_ci_lower[3] * 100, 2)`- `r round(adhd_prev_health_adj$crude_ci_upper[3] * 100, 2)`%). 

```{r prevAgeHealthAutTable}
# Autism
aut_prev_health.age_sex <- get_grouped_prev_plot(x = chile_bayes_aut,
                                                    grouping_vars = c("health_service_name", "age_june30", "sex_desc", "autism"),
                                                    disease = "autism") %>%
  arrange(age_june30)

aut_prev_health.age_sex.table <- aut_prev_health.age_sex %>% filter(sex_desc == "Female") %>%
  select(health_service_name, age_june30, n_disease, prev_ci) %>% 
  cbind(aut_prev_health.age_sex %>% filter(sex_desc == "Male") %>%  select(n_disease, prev_ci))

kbl(aut_prev_health.age_sex.table, 
  col.names = c("Health service", "Age", "Autism cases", "Prevalence % (95% CI)", "Autism cases", "Prevalence % (95% CI)"),
  align = "lrrrrr",
  booktabs = TRUE,
  format = "pandoc",
  longtable = TRUE,
  linesep = c("", "", "", "", "",
              "", "", "", "", "",
              "", "", "", "", "",
              "", "", "", "", "",
              "", "", "", "", "",
              "", "", "", "\\addlinespace"), # Extra white space after every 29th line
  caption = "Count and prevalence of autism cases by health service and age in Chile school data for females and males with normal confidence intervals.") %>%
  add_header_above(c(" " = 2, "Female" = 2, "Male" = 2)) %>%
  kable_styling(latex_options = c("repeat_header"))
```

```{r prevAgeHealthAdhdTable}
# ADHD
adhd_prev_health.age_sex <- get_grouped_prev_plot(x = chile_bayes_adhd, 
                                          grouping_vars = c("health_service_name", "age_june30", "sex_desc", "adhd"),
                                          disease = "adhd") %>%
  arrange(age_june30)

adhd_prev_health.age_sex.table <- adhd_prev_health.age_sex %>% filter(sex_desc == "Female") %>%
  select(health_service_name, age_june30, n_disease, prev_ci) %>% 
  cbind(adhd_prev_health.age_sex %>% filter(sex_desc == "Male") %>%  select(n_disease, prev_ci))

kbl(adhd_prev_health.age_sex.table, 
  col.names = c("Health service", "Age", "ADHD cases", "Prevalence % (95% CI)", "ADHD cases", "Prevalence % (95% CI)"),
  align = "lrrrrr",
  booktabs = TRUE,
  format = "pandoc",
  longtable = TRUE,
  linesep = c("", "", "", "", "",
              "", "", "", "", "",
              "", "", "", "", "",
              "", "", "", "", "",
              "", "", "", "", "",
              "", "", "", "\\addlinespace"), # Extra white space after every 29th line
  caption = "Count and prevalence of ADHD cases by health service and age in Chile school data for females and males with normal confidence intervals.") %>%
  add_header_above(c(" " = 2, "Female" = 2, "Male" = 2)) %>%
  kable_styling(latex_options = c("repeat_header"))

```

```{r prevAgecatHealthAutPlot, fig.cap = "Sample prevalence of autism by health service, age band and sex. Bars show 95% normal confidence intervals.", fig.height = 10, fig.width = 8.5}
# Autism
aut_prev_health.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_aut, 
                                          grouping_vars = c("health_service_name" ,"age_cat_name", "sex_desc", "autism"),
                                          disease = "autism") %>%
  arrange(age_cat_name)

ggplot(data = aut_prev_health.agecat_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence*100, group = age_cat_name, fill = age_cat_name), position = "dodge") +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower*100, ymax = ci_upper*100, group = age_cat_name), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_manual(values = c(plasma_colours[3], plasma_colours[5], plasma_colours[7], plasma_colours[9])) +
  facet_wrap(~health_service_name) +
  labs(title = "Autism prevalence by health service",
       x = "Sex",
       y = "Sample prevalence (95% CI)",
       fill = "Age category")
```

```{r prevAgecatHealthAdhdPlot, fig.cap = "Sample prevalence of ADHD by health service, age band and sex. Bars show 95% normal confidence intervals.", fig.height = 10, fig.width = 8.5}
# ADHD
adhd_prev_health.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_adhd, 
                                          grouping_vars = c("health_service_name", "age_cat_name", "sex_desc", "adhd"),
                                          disease = "adhd") %>%
  arrange(age_cat_name)

ggplot(data = adhd_prev_health.agecat_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence*100, group = age_cat_name, fill = age_cat_name), position = position_dodge()) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower*100, ymax = ci_upper*100, group = age_cat_name), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_manual(values = c(plasma_colours[3], plasma_colours[5], plasma_colours[7], plasma_colours[9])) +
  facet_wrap(~health_service_name) +
  labs(title = "ADHD prevalence by health service",
       x = "Sex",
       y = "Sample prevalence % (95% CI)",
       fill = "Age band")

```

```{r adjPrevEconA}
# Autism
aut_prev_econA <- get_grouped_prev(x = chile_bayes_aut, stdpop = chile_stdpop, 
                                    grouping_vars = c("school_fee", "age_june30", "age_cat_name", "sex", "sex_desc", "autism"),
                                    disease = "autism")

aut_prev_econA_adj <- get_adjusted_prev(aut_prev_econA, grouping_vars = "school_fee") %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))

# ADHD
adhd_prev_econA <- get_grouped_prev(x = chile_bayes_adhd, stdpop = chile_stdpop, 
                                    grouping_vars = c("school_fee", "age_june30", "age_cat_name", "sex", "sex_desc", "adhd"),
                                    disease = "adhd")

adhd_prev_econA_adj <- get_adjusted_prev(adhd_prev_econA, grouping_vars = "school_fee")  %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))
```

For school fees, which are used here as a proxy for SES, autism prevalence is highest among students that receive free or low fee education, though the sample size for students that pay \$1,000-\$10,000 monthly is very small. ADHD prevalence is more consistent across school fee levels, except for the  \$1,000-\$10,000 band which has low prevalence and very few cases. Prevalence is higher among older students for higher fee bands. For both autism and ADHD, prevalence is very low among students paying more than \$100,000 monthly, suggesting students from wealthier families may not be accessing SEED or may not be eligible for it due to attending private schools.

```{r prevAgeEconAAutTable}
# Autism
aut_prev_econA.age_sex <- get_grouped_prev_plot(x = chile_bayes_aut,
                                                    grouping_vars = c("school_fee", "age_june30", "sex_desc", "autism"),
                                                    disease = "autism") %>%
  arrange(age_june30)

aut_prev_econA.age_sex.table <- aut_prev_econA.age_sex %>% filter(sex_desc == "Female") %>%
  select(school_fee, age_june30, n_disease, prev_ci) %>% 
  cbind(aut_prev_econA.age_sex %>% filter(sex_desc == "Male") %>%  select(n_disease, prev_ci))

kbl(aut_prev_econA.age_sex.table, 
  col.names = c("School fee", "Age", "Autism cases", "Prevalence % (95% CI)", "Autism cases", "Prevalence % (95% CI)"),
  align = "lrrrrr",
  booktabs = TRUE,
  format = "pandoc",
  longtable = TRUE,
  linesep = c("", "", "", "", "", "", "\\addlinespace"), # Extra white space after every 7th line
  caption = "Count and prevalence of Autism cases by school fee and age in Chile school data for females and males with normal confidence intervals.") %>%
  add_header_above(c(" " = 2, "Female" = 2, "Male" = 2)) %>%
  kable_styling(latex_options = c("repeat_header"))
```

```{r prevAgeEconAAdhdTable}
# Autism
adhd_prev_econA.age_sex <- get_grouped_prev_plot(x = chile_bayes_adhd,
                                                    grouping_vars = c("school_fee", "age_june30", "sex_desc", "adhd"),
                                                    disease = "adhd") %>%
  arrange(age_june30)

adhd_prev_econA.age_sex.table <- adhd_prev_econA.age_sex %>% filter(sex_desc == "Female") %>%
  select(school_fee, age_june30, n_disease, prev_ci) %>% 
  cbind(adhd_prev_econA.age_sex %>% filter(sex_desc == "Male") %>%  select(n_disease, prev_ci))

kbl(adhd_prev_econA.age_sex.table, 
  col.names = c("School fee", "Age", "ADHD cases", "Prevalence % (95% CI)", "ADHD cases", "Prevalence % (95% CI)"),
  align = "lrrrrr",
  booktabs = TRUE,
  format = "pandoc",
  longtable = TRUE,
  linesep = c("", "", "", "", "", "", "\\addlinespace"), # Extra white space after every 7th line
  caption = "Count and prevalence of ADHD cases by school fee and age in Chile school data for females and males with normal confidence intervals.") %>%
add_header_above(c(" " = 2, "Female" = 2, "Male" = 2)) %>%
  kable_styling(latex_options = c("repeat_header"))
```

```{r prevAgecatEconAAutPlot, fig.cap = "Sample prevalence of autism by student's monthly school fee (Peso), age band and sex. Bars show 95% normal confidence intervals.", fig.height=6}
# Autism
aut_prev_econA.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_aut,
                                                    grouping_vars = c("school_fee", "age_cat_name", "sex_desc", "autism"),
                                                    disease = "autism") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

ggplot(data = aut_prev_econA.agecat_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence*100, group = age_cat_name, fill = age_cat_name), position = "dodge") +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower*100, ymax = ci_upper*100, group = age_cat_name), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_manual(values = c(plasma_colours[3], plasma_colours[5], plasma_colours[7], plasma_colours[9])) +
  facet_wrap(~school_fee) +
  labs(title = "Autism prevalence by school fee",
       x = "Sex",
       y = "Sample prevalence % (95% CI)",
       fill = "Age category")
```

```{r prevAgecatEconAAdhdPlot, fig.cap = "Sample prevalence of ADHD by student's monthly school fee (Peso), age band and sex. Bars show 95% normal confidence intervals.", fig.height=6}
# ADHD
adhd_prev_econA.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_adhd,
                                                    grouping_vars = c("school_fee", "age_cat_name", "sex_desc", "adhd"),
                                                    disease = "adhd") %>%
  arrange(age_cat_name)

ggplot(data = adhd_prev_econA.agecat_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence*100, group = age_cat_name, fill = age_cat_name), position = "dodge") +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower*100, ymax = ci_upper*100, group = age_cat_name), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_manual(values = c(plasma_colours[3], plasma_colours[5], plasma_colours[7], plasma_colours[9])) +
  facet_wrap(~school_fee) +
  labs(title = "ADHD prevalence by school fee",
       x = "Sex",
       y = "Sample prevalence % (95% CI)",
       fill = "Age category")
```

```{r adjPrevEthnic}
# Autism
aut_prev_ethnic <- get_grouped_prev(x = chile_bayes_aut_ethnic, stdpop = chile_stdpop, 
                                    grouping_vars = c("ethnic_2_group", "age_june30", "age_cat_name", "sex", "sex_desc", "autism"),
                                    disease = "autism")

aut_prev_ethnic_adj <- get_adjusted_prev(aut_prev_ethnic, grouping_vars = "ethnic_2_group") %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))

# ADHD
adhd_prev_ethnic <- get_grouped_prev(x = chile_bayes_adhd_ethnic, stdpop = chile_stdpop, 
                                    grouping_vars = c("ethnic_2_group", "age_june30", "age_cat_name", "sex", "sex_desc", "adhd"),
                                    disease = "adhd")

adhd_prev_ethnic_adj <- get_adjusted_prev(adhd_prev_ethnic, grouping_vars = "ethnic_2_group")  %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))
```

Autism prevalence and distribution by age is very similar between Mapuche and non-Indigenous students in the Araucanía, Aysén, Biobío, Los Lagos, Los Rios, Magallanes and Región Metropolitana de Santiago regions. ADHD prevalence is also consistent across Mapuche and non-Indigenous students. Among students of other Indigenous groups, autism and ADHD prevalence appear to peak in older age groups, however this result is based on very few cases. 

```{r prevAgeEthnicAutTable}
# Autism
aut_prev_ethnic.age_sex <- get_grouped_prev_plot(x = chile_bayes_aut_ethnic,
                                                    grouping_vars = c("ethnic_2_group", "age_june30", "sex_desc", "autism"),
                                                    disease = "autism") %>%
  arrange(age_june30)

aut_prev_ethnic.age_sex.table <- aut_prev_ethnic.age_sex %>% filter(sex_desc == "Female") %>%
  select(ethnic_2_group, age_june30, n_disease, prev_ci) %>% 
  cbind(aut_prev_ethnic.age_sex %>% filter(sex_desc == "Male") %>%  select(n_disease, prev_ci))

kbl(aut_prev_ethnic.age_sex.table, 
  col.names = c("Ethnicity", "Age", "Autism cases", "Prevalence % (95% CI)", "Autism cases", "Prevalence % (95% CI)"),
  align = "lrrrrr",
  booktabs = TRUE,
  format = "pandoc",
  longtable = TRUE,
  linesep = c("", "", "\\addlinespace"), # Extra white space after every 3rd line
  caption = "Count and prevalence of Autism cases by ethnicity and age in Chile school data for females and males with normal confidence intervals. Regions with high Mapuche populations only.") %>%
  add_header_above(c(" " = 2, "Female" = 2, "Male" = 2)) %>%
  kable_styling(latex_options = c("repeat_header"))
```

```{r prevAgeEthnicAdhdTable}
# Autism
adhd_prev_ethnic.age_sex <- get_grouped_prev_plot(x = chile_bayes_adhd_ethnic,
                                                    grouping_vars = c("ethnic_2_group", "age_june30", "sex_desc", "adhd"),
                                                    disease = "adhd") %>%
  arrange(age_june30)

adhd_prev_ethnic.age_sex.table <- adhd_prev_ethnic.age_sex %>% filter(sex_desc == "Female") %>%
  select(ethnic_2_group, age_june30, n_disease, prev_ci) %>% 
  cbind(adhd_prev_ethnic.age_sex %>% filter(sex_desc == "Male") %>%  select(n_disease, prev_ci))

kbl(adhd_prev_ethnic.age_sex.table, 
  col.names = c("Ethnicity", "Age", "ADHD cases", "Prevalence % (95% CI)", "ADHD cases", "Prevalence % (95% CI)"),
  align = "lrrrrr",
  booktabs = TRUE,
  format = "pandoc",
  longtable = TRUE,
  linesep = c("", "", "\\addlinespace"), # Extra white space after every 3rd line
  caption = "Count and prevalence of ADHD cases by ethnicity and age in Chile school data for females and males with normal confidence intervals. Regions with high Mapuche populations only.") %>%
add_header_above(c(" " = 2, "Female" = 2, "Male" = 2)) %>%
  kable_styling(latex_options = c("repeat_header"))
```

```{r prevAgecatEthnicAutPlot, fig.cap = "Sample prevalence of autism by ethnicity, age band and sex. Bars show 95% normal confidence intervals. Regions with high Mapuche populations only."}
# Autism
aut_prev_ethnic.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_aut_ethnic,
                                                    grouping_vars = c("ethnic_2_group", "age_cat_name", "sex_desc", "autism"),
                                                    disease = "autism") %>%
  arrange(age_cat_name)

ggplot(data = aut_prev_ethnic.agecat_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence*100, group = age_cat_name, fill = age_cat_name), position = "dodge") +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower*100, ymax = ci_upper*100, group = age_cat_name), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_manual(values = c(plasma_colours[3], plasma_colours[5], plasma_colours[7], plasma_colours[9])) +
  facet_wrap(~ethnic_2_group) +
  labs(title = "Autism prevalence by ethnicity",
       x = "Sex",
       y = "Sample prevalence % (95% CI)",
       fill = "Age category")
```


```{r prevAgecatEthnicAdhdPlot, fig.cap = "Sample prevalence of ADHD by ethnicity, age band and sex. Bars show 95% normal confidence intervals. Regions with high Mapuche populations only."}
# ADHD
adhd_prev_ethnic.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_adhd_ethnic,
                                                    grouping_vars = c("ethnic_2_group", "age_cat_name", "sex_desc", "adhd"),
                                                    disease = "adhd") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

ggplot(data = adhd_prev_ethnic.agecat_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence*100, group = age_cat_name, fill = age_cat_name), position = "dodge") +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower*100, ymax = ci_upper*100, group = age_cat_name), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_manual(values = c(plasma_colours[3], plasma_colours[5], plasma_colours[7], plasma_colours[9])) +
  facet_wrap(~ethnic_2_group) +
  labs(title = "ADHD prevalence by ethnicity",
       x = "Sex",
       y = "Sample prevalence % (95% CI)",
       fill = "Age category")
```


```{r adjPrevRurality}
# Autism
aut_prev_rural <- get_grouped_prev(x = chile_bayes_aut, stdpop = chile_stdpop, 
                                    grouping_vars = c("school_rurality", "age_june30", "age_cat_name", "sex", "sex_desc", "autism"),
                                    disease = "autism")

aut_prev_rural_adj <- get_adjusted_prev(aut_prev_rural, grouping_vars = "school_rurality") %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))

# ADHD
adhd_prev_rural <- get_grouped_prev(x = chile_bayes_adhd, stdpop = chile_stdpop, 
                                    grouping_vars = c("school_rurality", "age_june30", "age_cat_name", "sex", "sex_desc", "adhd"),
                                    disease = "adhd")

adhd_prev_rural_adj <- get_adjusted_prev(adhd_prev_rural, grouping_vars = "school_rurality")  %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))
```

Autism and ADHD are slightly more prevalent for students at rural schools and both follow the same age patterns observed earlier.

```{r prevAgeRuralAutTable}
# Autism
aut_prev_rural.age_sex <- get_grouped_prev_plot(x = chile_bayes_aut,
                                                    grouping_vars = c("school_rurality", "age_june30", "sex_desc", "autism"),
                                                    disease = "autism") %>%
  arrange(age_june30)

aut_prev_rural.age_sex.table <- aut_prev_rural.age_sex %>% filter(sex_desc == "Female") %>%
  select(school_rurality, age_june30, n_disease, prev_ci) %>% 
  cbind(aut_prev_rural.age_sex %>% filter(sex_desc == "Male") %>%  select(n_disease, prev_ci))

kbl(aut_prev_rural.age_sex.table, 
  col.names = c("School rurality", "Age", "Autism cases", "Prevalence % (95% CI)", "Autism cases", "Prevalence % (95% CI)"),
  align = "lrrrrr",
  booktabs = TRUE,
  format = "pandoc",
  #longtable = TRUE,
  linesep = c("", "\\addlinespace"), # Extra white space after every 2nd line
  caption = "Count and prevalence of Autism cases by school's rurality and age in Chile school data for females and males with normal confidence intervals.") %>%
  add_header_above(c(" " = 2, "Female" = 2, "Male" = 2)) #%>%
  #kable_styling(latex_options = c("repeat_header"))
```

```{r prevAgeRuralAdhdTable}
# Autism
adhd_prev_rural.age_sex <- get_grouped_prev_plot(x = chile_bayes_adhd,
                                                    grouping_vars = c("school_rurality", "age_june30", "sex_desc", "adhd"),
                                                    disease = "adhd") %>%
  arrange(age_june30)

adhd_prev_rural.age_sex.table <- adhd_prev_rural.age_sex %>% filter(sex_desc == "Female") %>%
  select(school_rurality, age_june30, n_disease, prev_ci) %>% 
  cbind(adhd_prev_rural.age_sex %>% filter(sex_desc == "Male") %>%  select(n_disease, prev_ci))

kbl(adhd_prev_rural.age_sex.table, 
  col.names = c("School rurality", "Age", "ADHD cases", "Prevalence % (95% CI)", "ADHD cases", "Prevalence % (95% CI)"),
  align = "lrrrrr",
  booktabs = TRUE,
  format = "pandoc",
  #longtable = TRUE,
  linesep = c("", "\\addlinespace"), # Extra white space after every 2nd line
  caption = "Count and prevalence of ADHD cases by school's rurality and age in Chile school data for females and males with normal confidence intervals.") %>%
add_header_above(c(" " = 2, "Female" = 2, "Male" = 2)) #%>%
  #kable_styling(latex_options = c("repeat_header"))
```


```{r prevAgecatRuralAutPlot, fig.cap = "Sample prevalence of autism by school's rurality, age band and sex. Bars show 95% normal confidence intervals."}
# Autism
aut_prev_rural.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_aut,
                                                    grouping_vars = c("school_rurality", "age_cat_name", "sex_desc", "autism"),
                                                    disease = "autism") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

ggplot(data = aut_prev_rural.agecat_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence*100, group = age_cat_name, fill = age_cat_name), position = "dodge") +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower*100, ymax = ci_upper*100, group = age_cat_name), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_manual(values = c(plasma_colours[3], plasma_colours[5], plasma_colours[7], plasma_colours[9])) +
  facet_wrap(~school_rurality) +
  labs(title = "Autism prevalence by school's rurality",
       x = "Sex",
       y = "Sample prevalence % (95% CI)",
       fill = "Age category")
```

```{r prevAgecatRuralAdhdPlot, fig.cap = "Sample prevalence of ADHD by school's rurality, age band and sex. Bars show 95% normal confidence intervals."}
# By age and sex
# Age categories
adhd_prev_rural.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_adhd,
                                                    grouping_vars = c("school_rurality", "age_cat_name", "sex_desc", "adhd"),
                                                    disease = "adhd") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

ggplot(data = adhd_prev_rural.agecat_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence*100, group = age_cat_name, fill = age_cat_name), position = "dodge") +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower*100, ymax = ci_upper*100, group = age_cat_name), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_manual(values = c(plasma_colours[3], plasma_colours[5], plasma_colours[7], plasma_colours[9])) +
  facet_wrap(~school_rurality) +
  labs(title = "ADHD prevalence by school's rurality",
       x = "Sex",
       y = "Sample prevalence % (95% CI)",
       fill = "Age category")
```



## Frequentist prevalence estimation

After using frequentist methods to adjust for the age and sex distribution of the child population of Chile in 2021, the adjusted prevalence of autism was `r round(aut_prev_adj$adjusted_rate * 100, 3)`% (`r round(aut_prev_adj$adjusted_ci_lower * 100, 3)`-`r round(aut_prev_adj$adjusted_ci_upper * 100, 3)`%) and the adjusted prevalence of ADHD was `r sprintf("%.2f", round(adhd_prev_adj$adjusted_rate * 100, 2))`% (`r sprintf("%.2f", round(adhd_prev_adj$adjusted_ci_lower * 100, 2))`-`r round(adhd_prev_adj$adjusted_ci_upper * 100, 2)`%). Among females, the adjusted prevalence of autism was `r round(aut_prev_sex_adj$adjusted_rate[2] * 100, 3)`% (`r round(aut_prev_sex_adj$adjusted_ci_lower[2] * 100, 3)`-`r round(aut_prev_sex_adj$adjusted_ci_upper[2] * 100, 3)`%) and among males it was `r round(aut_prev_sex_adj$adjusted_rate[1] * 100, 3)`% (`r round(aut_prev_sex_adj$adjusted_ci_lower[1] * 100, 3)`-`r round(aut_prev_sex_adj$adjusted_ci_upper[1] * 100, 3)`%). Among females, the adjusted prevalence of ADHD was `r sprintf("%.2f", round(adhd_prev_sex_adj$adjusted_rate[2] * 100, 2))`% (`r sprintf("%.2f", round(adhd_prev_sex_adj$adjusted_ci_lower[2] * 100, 2))`-`r round(adhd_prev_sex_adj$adjusted_ci_upper[2] * 100, 2)`%) and among males it was `r sprintf("%.2f", round(adhd_prev_sex_adj$adjusted_rate[1] * 100, 2))`% (`r sprintf("%.2f", round(adhd_prev_sex_adj$adjusted_ci_lower[1] * 100, 2))`-`r round(adhd_prev_sex_adj$adjusted_ci_upper[1] * 100, 2)`%).

As we know the prevalences of autism and ADHD in this data are likely to be underestimates, the age- and sex-adjusted prevalences can be considered a lower bound on the true prevalence of autism and of ADHD in Chile. Considering school data by health service, the adjusted prevalence of autism is much higher in Ñuble at `r round(aut_prev_health_adj$adjusted_rate[29] * 100, 2)`% (`r round(aut_prev_health_adj$adjusted_ci_lower[29] * 100, 2)` - `r round(aut_prev_health_adj$adjusted_ci_upper[29] * 100, 2)`%) than other health services and is low in rural areas such as Araucanía. It is also low in the Metropolitano health services which serve Santiago, Chile's largest city. Adjusted ADHD prevalence is medial for Metropolitano health services and very low for Atacama, a fairly urbanised region, at `r round(adhd_prev_health_adj$adjusted_rate[8] * 100, 2)`% (`r round(adhd_prev_health_adj$adjusted_ci_lower[8] * 100, 2)` - `r round(adhd_prev_health_adj$adjusted_ci_upper[8] * 100, 2)`%).

```{r adjPrevHealthAutTable}
aut_prev_health_adj.table <- aut_prev_health_adj %>% 
  select(health_service_name, crude_prev_ci, adjusted_prev_ci)
kbl(aut_prev_health_adj.table,
    col.names = c("Health service", "Crude prevalence (95% CI)", "Adjusted prevalence (95% CI)"),
    align = "lrr",
    booktabs = TRUE,
    format = "pandoc",
    linesep = c(""), # No extra white space
    caption = "Crude and age- and sex-adjusted autism prevalence by health service in Chile school data. Crude prevalence has 95% normal confidence intervals and adjusted prevalence has 95% gamma confidence intervals.")
```

```{r adjPrevHealthAdhdTable}
adhd_prev_health_adj.table <- adhd_prev_health_adj %>% 
  select(health_service_name, crude_prev_ci, adjusted_prev_ci)
kbl(adhd_prev_health_adj.table,
    col.names = c("Health service", "Crude prevalence (95% CI)", "Adjusted prevalence (95% CI)"),
    align = "lrr",
    booktabs = TRUE,
    format = "pandoc",
    linesep = c(""), # No extra white space
    caption = "Crude and age- and sex-adjusted ADHD prevalence by health service in Chile school data. Crude prevalence has 95% normal confidence intervals and adjusted prevalence has 95% gamma confidence intervals.")

```


For autism and ADHD, Adjusted prevalences by school fees, ethnicity and school's rurality show similar patterns to crude prevalences, except for students at rural schools which have notably lower adjusted prevalence for both conditions. See tables x, x, x, x, x, and x. These results indicate that there are differences in the prevalence of autism and of ADHD across location and demographic features.


```{r adjPrevEconAAutTable}
aut_prev_econA_adj.table <- aut_prev_econA_adj %>% 
  select(school_fee, crude_prev_ci, adjusted_prev_ci)
kbl(aut_prev_econA_adj.table,
    col.names = c("School fee", "Crude prevalence (95% CI)", "Adjusted prevalence (95% CI)"),
    align = "lrr",
    booktabs = TRUE,
    format = "pandoc",
    linesep = c(""), # No extra white space
    caption = "Crude and age- and sex-adjusted autism prevalence by monthly school fee (Peso) in Chile school data. Crude prevalence has 95% normal confidence intervals and adjusted prevalence has 95% gamma confidence intervals.")
```

```{r adjPrevEconAAdhdTable}
adhd_prev_econA_adj.table <- adhd_prev_econA_adj %>% 
  select(school_fee, crude_prev_ci, adjusted_prev_ci)
kbl(adhd_prev_econA_adj.table,
    col.names = c("School fee", "Crude prevalence (95% CI)", "Adjusted prevalence (95% CI)"),
    align = "lrr",
    booktabs = TRUE,
    format = "pandoc",
    linesep = c(""), # No extra white space
    caption = "Crude and age- and sex-adjusted ADHD prevalence by monthly school fee (Peso) in Chile school data. Crude prevalence has 95% normal confidence intervals and adjusted prevalence has 95% gamma confidence intervals.")

```

```{r adjPrevEthnicAutTable}
aut_prev_ethnic_adj.table <- aut_prev_ethnic_adj %>% 
  select(ethnic_2_group, crude_prev_ci, adjusted_prev_ci)
kbl(aut_prev_ethnic_adj.table,
    col.names = c("Ethnicity", "Crude prevalence (95% CI)", "Adjusted prevalence (95% CI)"),
    align = "lrr",
    booktabs = TRUE,
    format = "pandoc",
    linesep = c(""), # No extra white space
    caption = "Crude and age- and sex-adjusted autism prevalence by ethnicity in Chile school data. Crude prevalence has 95% normal confidence intervals and adjusted prevalence has 95% gamma confidence intervals.")
```

```{r adjPrevEthnicAdhdTable}
adhd_prev_ethnic_adj.table <- adhd_prev_ethnic_adj %>% 
  select(ethnic_2_group, crude_prev_ci, adjusted_prev_ci)
kbl(adhd_prev_ethnic_adj.table,
    col.names = c("Ethnicity", "Crude prevalence (95% CI)", "Adjusted prevalence (95% CI)"),
    align = "lrr",
    booktabs = TRUE,
    format = "pandoc",
    linesep = c(""), # No extra white space
    caption = "Crude and age- and sex-adjusted ADHD prevalence by ethnicity in Chile school data. Crude prevalence has 95% normal confidence intervals and adjusted prevalence has 95% gamma confidence intervals.")

```

```{r adjPrevRuralAutTable}
aut_prev_rural_adj.table <- aut_prev_rural_adj %>% 
  select(school_rurality, crude_prev_ci, adjusted_prev_ci)
kbl(aut_prev_rural_adj.table,
    col.names = c("School rurality", "Crude prevalence (95% CI)", "Adjusted prevalence (95% CI)"),
    align = "lrr",
    booktabs = TRUE,
    format = "pandoc",
    linesep = c(""), # NO extra white space
    caption = "Crude and age- and sex-adjusted autism prevalence by school's rurality in Chile school data. Crude prevalence has 95% normal confidence intervals and adjusted prevalence has 95% gamma confidence intervals.")
```

```{r adjPrevRuralAdhdTable}
adhd_prev_rural_adj.table <- adhd_prev_rural_adj %>% 
  select(school_rurality, crude_prev_ci, adjusted_prev_ci)
kbl(adhd_prev_rural_adj.table,
    col.names = c("School rurality", "Crude prevalence (95% CI)", "Adjusted prevalence (95% CI)"),
    align = "lrr",
    booktabs = TRUE,
    format = "pandoc",
    linesep = c(""), # No extra white space
    caption = "Crude and age- and sex-adjusted ADHD prevalence by school's rurality in Chile school data. Crude prevalence has 95% normal confidence intervals and adjusted prevalence has 95% gamma confidence intervals.")

```


## Clinical data

```{r mcaPatientsSmall}
patients_mca_small <- clinical_small_raw %>% 
  rename("rurality" = "procedence",
         "dob" = "fecha_nacimiento",
         "apt_date" = "fecha_ejecutada",
         "type_appointment" = "appoinment") %>%
  mutate(gender = str_to_title(gender),
         autism = ifelse(cod_dg_1 %in% aut_codes | 
                           cod_dg_2 %in% aut_codes | 
                           cod_dg_3 %in% aut_codes, "Yes autism", "No autism"),
         aut_rank = ifelse(cod_dg_1 %in% aut_codes, 1,
                    ifelse(cod_dg_2 %in% aut_codes, 2,
                    ifelse(cod_dg_3 %in% aut_codes, 3, NA))),
         intdisab = ifelse(cod_dg_1 %in% intdisab_codes | 
                           cod_dg_2 %in% intdisab_codes | 
                           cod_dg_3 %in% intdisab_codes, "Yes intellectual disability", "No intellectual disability"),
         age_june30 = trunc(time_length(interval(ymd(dob), ymd("2021-06-30")), unit = "year")),
         commune_name_upper = ifelse(comuna == "CHOL CHOL", "CHOLCHOL",
                        ifelse(comuna == "CURACAUTIN", "CURACAUTÍN", 
                        ifelse(comuna == "PITRUFQUEN", "PITRUFQUÉN", 
                        ifelse(comuna == "PUCON", "PUCÓN", 
                        ifelse(comuna == "TOLTEN", "TOLTÉN", 
                        ifelse(comuna == "VILCUN", "VILCÚN", 
                        ifelse(comuna == "DIEGO DE ALMAGRO  (#)", "DIEGO DE ALMAGRO",
                        ifelse(comuna == "MACHALI", "MACHALÍ",
                        ifelse(comuna == "TEMUCO (##)", "TEMUCO", comuna))))))))),
         ses_status = ifelse(socio_economic_level %in% c("COLMENA GOLDEN CROSS", "RIO BLANCO", "CARABINEROS (DIPRECA)", "BANMEDICA S.A.", "PARTICULAR (SIN PREVISION)", "VIDA TRES"), "Private Health Insurance", socio_economic_level),
         rurality = ifelse(rurality == "URBAN", "Urban", "Rural"),
         ethnicity = ifelse(ethnicity == "CHILENO", "Chilean",
                     ifelse(ethnicity == "MAPUCHE", "Mapuche",
                     ifelse(ethnicity == "EXTRANJERO", "Foreign", "No ethnicity information"))),
         ethnicity = ifelse(is.na(ethnicity), "No ethnicity information", ethnicity), # for some reason the NA fix doesn't work in preceding line
         disability = ifelse(is.na(disability), "No disability information", disability),
         foster_care = ifelse(is.na(foster_care), "No foster care information", foster_care),
         medical_specialty_english = ifelse(medical_specialty == "Physiatry", "Psychiatry",
                                     ifelse(medical_specialty == "PEDIATRIA", "Paediatrics",
                                     ifelse(medical_specialty == "PSIQUIATRIA", "Psychiatry",
                                     ifelse(medical_specialty == "NEUROLOGIA", "Neurology", medical_specialty)))),
         medical_specialty_grouped = ifelse(medical_specialty_english %in% c("Psychiatry", "Child Psychiatry"), "Psychiatry",
                                     ifelse(medical_specialty_english %in% c("Neurology", "Pediatric Neurology"), "Neurology",
                                     ifelse(medical_specialty_english == "Paediatrics", "Paediatrics", "Other specialty"))),
         ) %>%
  left_join(region_service_commune_lookup, by = "commune_name_upper") %>%
  group_by(id, gender, age_june30) %>%
  summarise(ses_status = get.mode.na(ses_status), # Fortunately the available values are in alphabetical order by status
            autism = get.max.na(autism),
            intdisab = get.max.na(intdisab),
            medical_specialty_grouped = get.mode.na(medical_specialty_grouped), # Most common medical specialty across visits
            hospital = hospital[which.max(apt_date)], # most recent hospital
            commune_name = commune_name[which.max(apt_date)],
            rurality = rurality[which.max(apt_date)],
            ethnicity = get.mapuche.ethnicity(ethnicity),
            disability = get.yes.disability(disability),
            foster_care = get.yes.fostercare(foster_care)
            ) %>%
  ungroup() %>% 
  rename("sex_desc" = "gender",
         "age" = "age_june30") %>%
  mutate(sex_desc = as.factor(sex_desc),
         age_group = factor(ifelse(age <= 2, "Age 0-2", 
                            ifelse(age >= 3 & age <= 5, "Age 3-5",
                            ifelse(age >=6 & age <= 8, "Age 6-8", 
                            ifelse(age >=9 & age <=11, "Age 9-11", 
                            ifelse(age >=12 & age <= 14, "Age 12-14", 
                            ifelse(age >= 15 & age <= 18, "Age 15-18", "Adult")))))),
                            levels = c("Age 0-2", "Age 3-5", "Age 6-8", "Age 9-11", "Age 12-14", "Age 15-18", "Adult")), 
                            # Shouldn't be any adults in this dataset
         age = as.factor(age),
         commune_name = as.factor(commune_name),
         ses_status = as.factor(ses_status),
         rurality = as.factor(rurality),
         ethnicity = factor(ethnicity, levels = c("Mapuche", "Chilean", "Foreign", "No ethnicity information")),
         disability_imp = as.factor(ifelse(disability == "No disability information", "No disability", disability)),
         disability = factor(disability, levels = c("Yes disability", "No disability", "No disability information")),
         foster_care_imp = as.factor(ifelse(foster_care == "No foster care information", "No foster care", foster_care)),
         foster_care = factor(foster_care, levels = c("Yes foster care", "No foster care", "No foster care information")),
         autism = factor(autism, levels = c("Yes autism", "No autism")),
         intdisab = factor(intdisab, levels = c("Yes intellectual disability", "No intellectual disability")),
         medical_specialty_grouped = as.factor(medical_specialty_grouped),
         hospital = as.factor(hospital))
```


The small clinical dataset has data on `r nrow(clinical_small)` appointments for `r length(unique(clinical_small$id))` unique patients aged 1-18 in 2021. `r patients_mca_small %>% filter(sex_desc == "Female") %>% nrow` (`r round(patients_mca_small %>% filter(sex_desc == "Female") %>% nrow / nrow(patients_mca_small) * 100, 2)`%) are female, `r patients_mca_small %>% filter(ethnicity == "Mapuche") %>% nrow` (`r round(patients_mca_small %>% filter(ethnicity == "Mapuche") %>% nrow / nrow(patients_mca_small) * 100, 2)`%) are Mapuche, `r patients_mca_small %>% filter(rurality == "URBAN") %>% nrow` (`r round(patients_mca_small %>% filter(rurality == "URBAN") %>% nrow / nrow(patients_mca_small) * 100, 2)`%) live in an urban area, `r patients_mca_small %>% filter(disability == "Yes disability") %>% nrow` (`r round(patients_mca_small %>% filter(disability == "Yes disability") %>% nrow / nrow(patients_mca_small) * 100, 2)`%) have a disability and `r patients_mca_small %>% filter(foster_care == "Yes foster care") %>% nrow` (`r round(patients_mca_small %>% filter(foster_care == "Yes foster care") %>% nrow / nrow(patients_mca_small) * 100, 2)`%) have experienced foster care. `r patients_mca_small %>% filter(autism == 1) %>% nrow` (`r round(patients_mca_small %>% filter(autism == 1) %>% nrow / nrow(patients_mca_small) * 100, 2)`%) patients have autism, `r patients_mca_small %>% filter(intdisab == 1) %>% nrow` (`r round(patients_mca_small %>% filter(intdisab == 1) %>% nrow / nrow(patients_mca_small) * 100, 2)`%) have an intellectual disability and `r patients_mca_small %>% filter(autism == 1 & intdisab == 1) %>% nrow` (`r round(patients_mca_small %>% filter(autism == 1 & intdisab == 1) %>% nrow / nrow(patients_mca_small) * 100, 2)`%).

```{r macPatientsSmallTable}
patients_mca_small.table <- patients_mca_small %>%
  group_by(sex_desc) %>% 
  summarise(variable = "Sex",
            count = n(), 
            perc = sprintf("%.2f", round(count/nrow(patients_mca_small)*100, 2))) %>%
  rename(values = sex_desc) %>%
  rbind(patients_mca_small %>%
          group_by(age_group) %>% 
          summarise(variable = "Age band",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(patients_mca_small)*100, 2))) %>%
          rename(values = age_group),
        patients_mca_small %>%
          group_by(ses_status) %>% 
          summarise(variable = "Private health level",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(patients_mca_small)*100, 2))) %>%
          rename(values = ses_status),
        patients_mca_small %>%
          group_by(commune_name) %>% 
          summarise(variable = "Commune",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(patients_mca_small)*100, 2))) %>%
          rename(values = commune_name),
        patients_mca_small %>%
          group_by(rurality) %>% 
          summarise(variable = "Rurality",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(patients_mca_small)*100, 2))) %>%
          rename(values = rurality),
        patients_mca_small %>%
          group_by(ethnicity) %>% 
          summarise(variable = "Ethnicity",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(patients_mca_small)*100, 2))) %>%
          rename(values = ethnicity),
        patients_mca_small %>%
          group_by(disability) %>% 
          summarise(variable = "Disability",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(patients_mca_small)*100, 2))) %>%
          rename(values = disability),
        patients_mca_small %>%
          group_by(foster_care) %>% 
          summarise(variable = "Foster care",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(patients_mca_small)*100, 2))) %>%
          rename(values = foster_care),
        patients_mca_small %>%
          group_by(autism) %>% 
          summarise(variable = "Autism",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(patients_mca_small)*100, 2))) %>%
          rename(values = autism),
        patients_mca_small %>%
          group_by(intdisab) %>% 
          summarise(variable = "Intellectual disability",
                    count = n(), 
                    perc = sprintf("%.2f", round(count/nrow(patients_mca_small)*100, 2))) %>%
          rename(values = intdisab)) %>%
  mutate(count_perc = paste0(count, " (", perc, "%)")) %>%
  select(variable, values, count_perc)

kbl(patients_mca_small.table,
    col.names = c("Feature", "Available values", "Count (%)"),
    align = "llr",
    booktabs = TRUE,
    format = "pandoc",
    linesep = c("", "\\addlinespace", # Sex
                "", "", "", "", "", "\\addlinespace", # Age band
                "", "", "", "", "\\addlinespace", # SES
                "", "", "", "", "", 
                "", "", "", "", "",
                "", "", "", "", "",
                "", "", "", "", "\\addlinespace", # Commune
                "", "\\addlinespace", # Rurality
                "", "", "", "\\addlinespace", # Ethnicity
                "", "", "\\addlinespace", # Disability
                "", "", "\\addlinespace", # Foster care
                "", "\\addlinespace", # Autism
                "", "\\addlinespace"), # Intdisab
    caption = "Count and percentage of features' values in the small clinical dataset.") %>%
  kable_styling(latex_options = c("repeat_header"))
```


## Multiple Correspondence Analysis

```{r mcaNoimp}
patients_mca_noimp <- patients_mca_small %>%
  filter(autism == "Yes autism") %>%
   select(sex_desc,
          age_group,
          commune_name,
          ses_status,
          ethnicity,
          rurality,
          disability,
          foster_care) %>%
  rename("Sex" = sex_desc,
         "Age band" = age_group,
         "Commune" = commune_name,
         "Health insurance" = ses_status,
         "Rurality" = rurality,
         "Ethnicity" = ethnicity,
         "Disability" = disability,
         "Foster care" = foster_care)

res_mca_patients_noimp <- FactoMineR::MCA(patients_mca_noimp,
                                          ncp = 8, # Needs to match number of features
                                          graph = FALSE) 
```

```{r mcaNoimpFeatures, fig.cap="Categorical features by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features without imputation."}
# Plot features
fviz_mca_var(res_mca_patients_noimp, 
             choice = "mca.cor", 
             labelsize = 4, 
             pointsize = 3, 
             col.var = turbo_colours[16],
             repel = TRUE,
             ggtheme = theme_minimal()) +
  labs(title = "Categorical features by first two dimensions, no imputation")
```

```{r mcaNoimpCategories, fig.cap="Available categories by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features without imputation.", fig.height=10, fig.width=8.5}
# Plot categories
fviz_mca_var(res_mca_patients_noimp,
             col.var = "contrib",
             labelsize = 4, 
             pointsize = 3, 
             gradient.cols = c(turbo_colours[2], turbo_colours[5], turbo_colours[8], turbo_colours[10]),
             repel = TRUE,
             ggtheme = theme_minimal()) +
  labs(title = "Categories by first two dimensions, no imputation",
       colour = "Contribution")
```

```{r mcaNoimpGraph, fig.cap="Contribution of the top 15 categories to the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features without imputation. The red line shows the expected average if contributions were uniform.", fig.height = 4}

# Total contribution to dimension 1 and 2
fviz_contrib(res_mca_patients_noimp, choice = "var", axes = 1:2, top = 15) +
  labs(title = "Contribution of categories to first two dimensions, no imputation",
       x = "Category",
       y = "Contribution (%)")
```

```{r mcaNoimpPlots}
mca_noimp_sex_plot <- fviz_mca_ind(res_mca_patients_noimp, 
             label = "none", # hide individual labels
             habillage = "Sex", # color by groups 
             palette = c(turbo_colours[14], turbo_colours[17]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by sex, no imputation",
             ggtheme = theme_minimal()) 
mca_noimp_age_plot <- fviz_mca_ind(res_mca_patients_noimp, 
             label = "none",
             habillage = "Age band",
             palette = c(turbo_colours[2], turbo_colours[5], turbo_colours[7], turbo_colours[11], turbo_colours[14], turbo_colours[17]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by age band, no imputation",
             ggtheme = theme_minimal()) 
mca_noimp_commune_plot <- fviz_mca_ind(res_mca_patients_noimp, 
             label = "none",
             habillage = "Commune",
             palette = turbo_colours,
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by commune of residence, no imputation",
             ggtheme = theme_minimal())
mca_noimp_ses_plot <- fviz_mca_ind(res_mca_patients_noimp, 
             label = "none",
             habillage = "Health insurance",
             palette = c(turbo_colours[3], turbo_colours[7], turbo_colours[11], turbo_colours[14], turbo_colours[17]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by SES status, no imputation",
             ggtheme = theme_minimal()) 
mca_noimp_rural_plot <- fviz_mca_ind(res_mca_patients_noimp, 
             label = "none",
             habillage = "Rurality",
             palette = c(turbo_colours[14], turbo_colours[17]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by rurality, no imputation",
             ggtheme = theme_minimal())
mca_noimp_ethnic_plot <- fviz_mca_ind(res_mca_patients_noimp, 
             label = "none",
             habillage = "Ethnicity",
             palette = c(turbo_colours[3], turbo_colours[7], turbo_colours[11], turbo_colours[14]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by ethnicity, no imputation",
             ggtheme = theme_minimal())
mca_noimp_disab_plot <- fviz_mca_ind(res_mca_patients_noimp, 
             label = "none",
             habillage = "Disability",
             palette = c(turbo_colours[3], turbo_colours[7], turbo_colours[11]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by disability status, no imputation",
             ggtheme = theme_minimal())
mca_noimp_foster_plot <- fviz_mca_ind(res_mca_patients_noimp, 
             label = "none",
             habillage = "Foster care",
             palette = c(turbo_colours[3], turbo_colours[7], turbo_colours[11]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by foster care status, no imputation",
             ggtheme = theme_minimal())
```

```{r mcaNoimpAge, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features without imputation, coloured by age band."}
grid.arrange(mca_noimp_age_plot)
```

```{r mcaNoimpCommune, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features without imputation, coloured by commune of residence."}
grid.arrange(mca_noimp_commune_plot)
```

```{r mcaNoimpEthnic, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features without imputation, coloured by ethnicity."}
grid.arrange(mca_noimp_ethnic_plot)
```

```{r mcaNoimpSES, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features without imputation, coloured by health insurance level."}
grid.arrange(mca_noimp_ses_plot)
```

```{r mcaNoimpSexRural, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features without imputation, coloured by sex and by rurality of residence.", fig.height=8}
grid.arrange(mca_noimp_sex_plot, mca_noimp_rural_plot, nrow = 2)
```

```{r mcaNoimpDisabFoster, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features without imputation, coloured by disability status and by foster care status.", fig.height=8}
grid.arrange(mca_noimp_disab_plot, mca_noimp_foster_plot, nrow = 2)
```


```{r mcaImp}
patients_mca_imp <- patients_mca_small %>%
  filter(autism == "Yes autism") %>%
   select(sex_desc,
          age_group,
          commune_name,
          ses_status,
          ethnicity,
          rurality,
          disability_imp,
          foster_care_imp) %>%
  rename("Sex" = sex_desc,
         "Age band" = age_group,
         "Commune" = commune_name,
         "Health insurance" = ses_status,
         "Rurality" = rurality,
         "Ethnicity" = ethnicity,
         "Disability imputed" = disability_imp,
         "Foster care imputed" = foster_care_imp)

res_mca_patients_imp <- FactoMineR::MCA(patients_mca_imp,
                                          ncp = 8, # Needs to match number of features
                                          graph = FALSE) 
```

```{r mcaImpFeatures, fig.cap="Categorical features by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features with imputation."}
# Plot features
fviz_mca_var(res_mca_patients_imp, 
             choice = "mca.cor", 
             labelsize = 4, 
             pointsize = 3, 
             col.var = turbo_colours[16],
             repel = TRUE,
             ggtheme = theme_minimal()) +
  labs(title = "Categorical features by first two dimensions, with imputation")
```

```{r mcaImpCategories, fig.cap="Available categories by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features with imputation.", fig.height=10, fig.width=8.5}
# Plot categories
fviz_mca_var(res_mca_patients_imp,
             col.var = "contrib",
             labelsize = 4, 
             pointsize = 3, 
             gradient.cols = c(turbo_colours[2], turbo_colours[5], turbo_colours[8], turbo_colours[10]),
             repel = TRUE,
             ggtheme = theme_minimal()) +
  labs(title = "Categories by first two dimensions, with imputation",
       colour = "Contribution")
```

```{r mcaImpGraph, fig.cap="Contribution of the top 15 categories to the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features with imputation. The red line shows the expected average if contributions were uniform.", fig.height = 4}

# Total contribution to dimension 1 and 2
fviz_contrib(res_mca_patients_imp, choice = "var", axes = 1:2, top = 15) +
  labs(title = "Contribution of categories to first two dimensions, with imputation",
       x = "Category",
       y = "Contribution (%)")
```

```{r mcaImpPlots}
mca_imp_sex_plot <- fviz_mca_ind(res_mca_patients_imp, 
             label = "none", # hide individual labels
             habillage = "Sex", # color by groups 
             palette = c(turbo_colours[14], turbo_colours[17]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by sex, with imputation",
             ggtheme = theme_minimal()) 
mca_imp_age_plot <- fviz_mca_ind(res_mca_patients_imp, 
             label = "none",
             habillage = "Age band",
             palette = c(turbo_colours[2], turbo_colours[5], turbo_colours[7], turbo_colours[11], turbo_colours[14], turbo_colours[17]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by age band, with imputation",
             ggtheme = theme_minimal()) 
mca_imp_commune_plot <- fviz_mca_ind(res_mca_patients_imp, 
             label = "none",
             habillage = "Commune",
             palette = turbo_colours,
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by commune of residence, with imputation",
             ggtheme = theme_minimal())
mca_imp_ses_plot <- fviz_mca_ind(res_mca_patients_imp, 
             label = "none",
             habillage = "Health insurance",
             palette = c(turbo_colours[3], turbo_colours[7], turbo_colours[11], turbo_colours[14], turbo_colours[17]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by SES status, with imputation",
             ggtheme = theme_minimal()) 
mca_imp_rural_plot <- fviz_mca_ind(res_mca_patients_imp, 
             label = "none",
             habillage = "Rurality",
             palette = c(turbo_colours[14], turbo_colours[17]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by rurality, with imputation",
             ggtheme = theme_minimal())
mca_imp_ethnic_plot <- fviz_mca_ind(res_mca_patients_imp, 
             label = "none",
             habillage = "Ethnicity",
             palette = c(turbo_colours[3], turbo_colours[7], turbo_colours[11], turbo_colours[14]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by ethnicity, with imputation",
             ggtheme = theme_minimal())
mca_imp_disab_plot <- fviz_mca_ind(res_mca_patients_imp, 
             label = "none",
             habillage = "Disability imputed",
             palette = c(turbo_colours[3], turbo_colours[7]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by disability status, with imputation",
             ggtheme = theme_minimal())
mca_imp_foster_plot <- fviz_mca_ind(res_mca_patients_imp, 
             label = "none",
             habillage = "Foster care imputed",
             palette = c(turbo_colours[3], turbo_colours[7]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by foster care status, with imputation",
             ggtheme = theme_minimal())
```

```{r mcaImpAge, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features with imputation, coloured by age band."}
grid.arrange(mca_imp_age_plot)
```

```{r mcaImpCommune, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features with imputation, coloured by commune of residence."}
grid.arrange(mca_imp_commune_plot)
```

```{r mcaImpEthnic, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features with imputation, coloured by ethnicity."}
grid.arrange(mca_imp_ethnic_plot)
```

```{r mcaImpSES, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features with imputation, coloured by health insurance level."}
grid.arrange(mca_imp_ses_plot)
```

```{r mcaImpSexRural, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features with imputation, coloured by sex and by rurality of residence.", fig.height=8}
grid.arrange(mca_imp_sex_plot, mca_imp_rural_plot, nrow = 2)
```

```{r mcaImpDisabFoster, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using all features with imputation, coloured by disability status and by foster care status.", fig.height=8}
grid.arrange(mca_imp_disab_plot, mca_imp_foster_plot, nrow = 2)
```


```{r mcaAut}
patients_mca_aut <- patients_mca_small %>%
  filter(autism == "Yes autism") %>%
   select(age_group,
          commune_name,
          ethnicity) %>%
  rename("Age band" = age_group,
         "Commune" = commune_name,
         "Ethnicity" = ethnicity)

res_mca_patients_aut <- FactoMineR::MCA(patients_mca_aut, 
                                          ncp = 3, # Needs to match number of features
                                          graph = FALSE) 
```

```{r mcaAutFeatures, fig.cap="Categorical features by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using patients' age band, commune of residence and ethnicity."}
# Plot features
fviz_mca_var(res_mca_patients_aut, 
             choice = "mca.cor", 
             labelsize = 4, 
             pointsize = 3, 
             col.var = turbo_colours[16],
             repel = TRUE,
             ggtheme = theme_minimal()) +
  labs(title = "Categorical features by first two dimensions for age band, commune and ethnicity")
```

```{r mcaAutCategories, fig.cap="Available categories by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using patients' age band, commune and ethnicity.", fig.height=10, fig.width=8.5}
# Plot categories
fviz_mca_var(res_mca_patients_aut,
             col.var = "contrib",
             labelsize = 4, 
             pointsize = 3, 
             gradient.cols = c(turbo_colours[2], turbo_colours[5], turbo_colours[8], turbo_colours[10]),
             repel = TRUE,
             ggtheme = theme_minimal()) +
  labs(title = "Categories by first two dimensions for age band, commune and ethnicity",
       colour = "Contribution")
```

```{r mcaAutGraph, fig.cap="Contribution of the top 15 categories to the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using patients' age band, commune and ethnicity. The red line shows the expected average if contributions were uniform.", fig.height = 4}

# Total contribution to dimension 1 and 2
fviz_contrib(res_mca_patients_aut, choice = "var", axes = 1:2, top = 15) +
  labs(title = "Contribution of categories to first two dimensions for age band, commune and ethnicity",
       x = "Category",
       y = "Contribution (%)")
```

```{r mcaAutPlots}
mca_aut_age_plot <- fviz_mca_ind(res_mca_patients_aut, 
             label = "none",
             habillage = "Age band",
             palette = c(turbo_colours[2], turbo_colours[5], turbo_colours[7], turbo_colours[11], turbo_colours[14], turbo_colours[17]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by age band for age band, commune and ethnicity",
             ggtheme = theme_minimal()) 
mca_aut_commune_plot <- fviz_mca_ind(res_mca_patients_aut, 
             label = "none",
             habillage = "Commune",
             palette = turbo_colours,
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by commune of residence for age band, commune and ethnicity",
             ggtheme = theme_minimal())
mca_aut_ethnic_plot <- fviz_mca_ind(res_mca_patients_aut, 
             label = "none",
             habillage = "Ethnicity",
             palette = c(turbo_colours[3], turbo_colours[7], turbo_colours[11], turbo_colours[14]),
             addEllipses = TRUE, ellipse.type = "confidence",
             title = "Patients by ethnicity, with imputation for age band, commune and ethnicity",
             ggtheme = theme_minimal())
```

```{r mcaAutAge, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using patients' age band, commune and ethnicity, coloured by age band."}
grid.arrange(mca_aut_age_plot)
```

```{r mcaAutCommune, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using age band, commune and ethnicity, coloured by commune of residence."}
grid.arrange(mca_aut_commune_plot)
```

```{r mcaAutEthnic, fig.cap="Patients by the first two dimensions of multiple correspondence analysis on autism patients in the small clinical data using age band, commune and ethnicity, coloured by ethnicity."}
grid.arrange(mca_aut_ethnic_plot)
```





## Probabilistic data linkage

```{r patients}
patients <- clinical %>%
  filter(commune_code %in% araucsur_communes$commune_code) %>%
  group_by(id, gender, dob, commune_name, region_name) %>%
  summarise(ses_status = get.mode.na(ses_status),
            autism = get.max.na(autism),
            aut_rank = get.min.na(aut_rank)) %>%
  ungroup() %>% 
  rename("student_commune_name" = "commune_name",
         "student_region_name" = "region_name",
         "sex_desc" = "gender") %>%
  rowid_to_column("row_id") %>%
  select(row_id, 
         id,
         dob, 
         sex_desc,
         student_commune_name,
         autism,
         ses_status#,
         #intdisab,
         #aut_rank
         #, student_region_name
         ) 

patients_out <- clinical %>%
  filter(commune_code %in% araucsur_communes$commune_code) %>%
  group_by(id, gender, dob) %>%
  summarise(ses_status = get.min.na(socio_economic_level),
            autism = get.max.na(autism),
            intdisab = get.max.na(intdisab),
            commune_name = commune_name[which.max(apt_date)],
            commune_code = commune_code[which.max(apt_date)]) %>%
  ungroup() %>%
  rowid_to_column("row_id")
# write_csv(patients_out, file = "04_Data/Outputs/patients.csv")

```

NB: there are 1688 unique ID's in patients and it's 1702 rows long because some people are represented in 2 communes.

```{r school}
school <- chile_merged %>%
  select(-student_commune_name) %>%
  left_join(region_service_commune_lookup %>% as.tibble %>% select(-geometry), by = "commune_code") %>%
  filter(commune_code %in% araucsur_communes$commune_code) %>%
  filter(age_june30 >= 6 & age_june30 <= 18, sex != 0) %>% 
  mutate(autism = ifelse(special_needs_code == 105, 1, 0),
         aut_rank = 1,
         dob = ymd(dob),
         ses_status = ifelse(school_fee == "", NA, 
                      ifelse(school_fee == "GRATUITO", 1, 
                      ifelse(school_fee == "$1.000 A $10.000", 2,
                      ifelse(school_fee == "$10.001 A $25.000", 2, 
                      ifelse(school_fee == "$25.001 A $50.000", 2,
                      ifelse(school_fee == "$50.001 A $100.000", 2, 
                      ifelse(school_fee == "MAS DE $100.000", 3, 
                      ifelse(school_fee == "SIN INFORMACION", NA, NA))))))))) %>%
  filter(autism == 1) %>%
    # We only want to find additional autism cases in the clinical records, we don't care if a student has autism and isn't in the clinical records
  rename(student_commune_name = commune_name) %>%
  select(dob,
         sex_desc,
         student_commune_name,
         #commune_name, 
         #health_service_name,
         autism,
         ses_status#,
         #intdisab,
         #aut_rank#,
         #student_region_name
  ) %>%
  rowid_to_column("id")

# Add a fake row so that pairing works later
school[dim(school)[1]+1, ] <- c(dim(school)[1]+1, "2023-06-01", NA, NA, NA, NA, NA)
```

### Number matched

```{r manualLinkage}
patients_grouped_ses <- patients %>%
  group_by(sex_desc, 
           dob, 
           student_commune_name,
           ses_status) %>%
  summarise(count = n(),
            ids = list(id)) %>%
  ungroup()

school_grouped_ses <- school %>%
  group_by(sex_desc, 
           dob, 
           student_commune_name,
           ses_status) %>%
  summarise(count = n(),
            ids = list(rowid)) %>%
  ungroup()

merged_ses <- merge(school, patients, by = c("sex_desc", "dob", "student_commune_name", "ses_status"), all = FALSE)
# 84 matches

patients_grouped <- patients %>%
  group_by(sex_desc, 
           dob, 
           student_commune_name) %>%
  summarise(count = n(),
            ids = list(id))

school_grouped <- school %>%
  group_by(sex_desc, 
           dob, 
           student_commune_name) %>%
  summarise(count = n(),
            #ids = list(rowid)
            ses = list(ses_status))

merged <- merge(school, patients, by = c("sex_desc", "dob", "student_commune_name"), all = FALSE)
# 197 matches


```

Using perfect match on sex, date of birth and commune of residence, `r nrow(merged)` matches can be found between the school and patient records.
`r length(unique(merged$id.x)) - 1` unique school records can be perfectly matched to clinical records. `r length(unique(merged$id.y))` patients can be linked to school records.

```{r probabilisticWeights}
# formerly a2
pairs_blocked <- compare.linkage(school,
                     select(patients, -row_id),
                     blockfld = c("sex_desc", "dob"), 
                      # Block on sex and dob because we really want them to be the same and helps computation time
                     #phonetic = FALSE,
                     #strcmp = c(2), # Do string comparison on DOB
                     exclude = c(1) # Exclude the id column in both datasets
                     )

pairs_weighted <- epiWeights(pairs_blocked, e = c(0.01, # Default for DOB
                           0.01, # Default for sex
                           0.01, # Default for commune because we want a good match
                           0.01, # Keep small so autism in clinical (not intellectual disability) is prioritised over ses match
                           0.6#, # Have more error for ses_status because it is loosely defined 
                           #0.01 # Allow some mismatch on whether autism is the primary diagnosis 
                                  # so we take record with higher placed autism diagnosis when there 
                                  # are multiple clinical record options for a single school record
))
#summary(pairs_weighted)
#allPairs2 <- getPairs(pairs_weighted)
#head(allPairs2, n = 20)

pairs_classified <- emClassify(pairs_weighted, threshold.upper = 1, threshold.lower = 0.8)

pairs_blocked.df <- pairs_blocked$pairs %>%
  mutate(weight = pairs_classified$Wdata,
         pred = pairs_classified$prediction) %>%
  rename(".x" = id1, ".y" = id2) %>%
  select(-is_match)

#finalPairs2 <- getPairs(b2, max.weight = 1, min.weight = 0, single.rows = TRUE) # Take them all when blocked on sex_desc and dob together

# Turn into a 'pairs' type object so it can be fed to select_n_to_m()
pairs_blocked.pairs <- pair_blocking(school, patients, on = c("sex_desc", "dob")) %>%
         mutate(student_commune_name = (school$student_commune_name[.x] == patients$student_commune_name[.y])#,
         #ses = get_num_diff(school$ses_status[.x], patients$ses_status[.y])$val
         ) %>%
  left_join(pairs_blocked.df, by = c(".x", ".y")) %>%
  select(c(-student_commune_name.x)) %>%
  rename("student_commune_name" = "student_commune_name.y")

matches <- select_n_to_m(pairs_blocked.pairs, threshold = 0.5, score = "weight", n = 1, m = 1, var = "match") %>%
  filter(match == TRUE) %>%
  rename("id" = ".x",
         "row_id" = ".y") %>%
  mutate(id = as.character(id))
```


```{r matchSchool}

# Now add the matched clinical records to the school records
school_matched <- school %>%
  mutate(id = as.character(id)) %>%
  #filter(student_commune_name != "Misc") %>%
  left_join(matches, by = "id") %>%
  rename(id.school = id,
         dob.school = dob.x,
         sex_desc.school = sex_desc.x,
         student_commune_name.school = student_commune_name.x,
         ses_status.school = ses_status.x,
         dob.matched = dob.y,
         sex_desc.matched = sex_desc.y,
         student_commune_name.matched = student_commune_name.y,
         ses_status.matched = ses_status.y) %>%
  select(c(-pred, -match)) %>%
  left_join(patients, by = "row_id") %>%
  rename(id.patient = row_id,
         patient_id = id,
         dob.patient = dob,
         sex_desc.patient = sex_desc,
         student_commune_name.patient = student_commune_name,
         ses_status.patient = ses_status) %>%
  select(id.school, id.patient, patient_id,
         dob.school, dob.patient, dob.matched,
         sex_desc.school, sex_desc.patient, sex_desc.matched,
         student_commune_name.school, student_commune_name.patient, student_commune_name.matched,
         ses_status.school, ses_status.patient, ses_status.matched,
         weight) %>%
  arrange(desc(weight))

school_matched_small <- school_matched %>%
  mutate(matched = ifelse(is.na(patient_id), 0, 1),
         sex.school = ifelse(sex_desc.school == "Male", 1,
                      ifelse(sex_desc.school == "Female", 2, NA))) %>%
  merge(region_service_commune_lookup %>% as.tibble() %>% select(-geometry),
        by.x = "student_commune_name.school", by.y = "commune_name") %>% # doesn't include all.x = TRUE because that would keep the fake record.
  select(id.school, 
         dob.school, 
         sex_desc.school, sex.school,
         student_commune_name.school, commune_code,
         ses_status.school, 
         matched)

```

```{r matchPatient}

# Now add the matched clinical records to the school records
patients_matched <- patients %>%
  left_join(matches, by = "row_id") %>%
  rename(id.patient = row_id,
         patient_id = id.x,
         dob.patient = dob.x,
         sex_desc.patient = sex_desc.x,
         student_commune_name.patient = student_commune_name.x,
         id = id.y,
         ses_status.patient = ses_status.x,
         dob.matched = dob.y,
         sex_desc.matched = sex_desc.y,
         student_commune_name.matched = student_commune_name.y,
         ses_status.matched = ses_status.y) %>%
  select(c(-pred, -match)) %>%
  left_join(school, by = "id") %>%
  rename(id.school = id,
         dob.school = dob,
         sex_desc.school = sex_desc,
         student_commune_name.school = student_commune_name,
         ses_status.school = ses_status) %>%
  select(id.school, id.patient, patient_id,
         dob.school, dob.patient, dob.matched,
         sex_desc.school, sex_desc.patient, sex_desc.matched,
         student_commune_name.school, student_commune_name.patient, student_commune_name.matched,
         ses_status.school, ses_status.patient, ses_status.matched,
         weight) %>%
  arrange(desc(weight))

patients_matched_small <- patients_matched %>%
  mutate(matched = ifelse(is.na(id.school), 0, 1),
         sex.patient = ifelse(sex_desc.patient == "Male", 1,
                       ifelse(sex_desc.patient == "Female", 2, NA))) %>%
  merge(region_service_commune_lookup %>% as.tibble() %>% select(-geometry),
        by.x = "student_commune_name.patient", by.y = "commune_name") %>%
  select(patient_id, id.patient, 
         dob.patient,
         sex_desc.patient, sex.patient,
         student_commune_name.patient, commune_code,
         ses_status.patient,
         matched)

```


```{r patientsUnique}
patients_matched_unique <- patients_matched_small %>%
  group_by(matched, patient_id) %>%
  summarise(count = n())

patients_dup <- patients_matched_unique %>% filter(matched == 1, count > 1) %>% select(patient_id)
# No patient is inadvertently matched to two school records

```

Bit easier to match SES status of 1 (probably more common)

Our matched/non-matched are not different by sex (p-value in Kolmog is same as most of distribution of permuted pvals) but are different by commune and ses status. Cohen's D test isn't suitable to compare the matched and un-matched because the data don't have standard deviations.

??Add commune maps here with size of sample for school and clinical?? Also size of other features.


There are no patients that lived in different communes therefore were in the patient dataset twice that are matched to multiple school records.

TODO - comment on whether any of the matched patients had only intellectual disability and not autism.

### Prev delta

```{r newPrev}
n_aut_araucS <- nrow(school_matched) + length(unique(patients_matched$patient_id)) - nrow(matches) # Use this version because accounts for non-unique patients with both match and non-match
#n_aut_araucS <- school_matched_small %>% filter(matched == 0) %>% nrow() +
#  dim(patients_matched_small %>% filter(matched == 0) %>% select(patient_id) %>% unique())[1] + nrow(matches)
```





## Bayesian prevalence projection


```{r newPrevArauc}
araucS_lower_prev <- aut_prev_health_adj %>%
  filter(health_service_name == "Araucanía Sur") %>%
  select(adjusted_rate) %>% as.numeric
araucS_upper_prev <- n_aut_araucS / aut_prev_health_adj %>%
  filter(health_service_name == "Araucanía Sur") %>%
  select(sum_sample_pop_size) %>% as.numeric
prev_delta <- araucS_upper_prev - araucS_lower_prev

araucS_lower <- aut_prev_health_adj %>%
  filter(health_service_name == "Araucanía Sur") %>%
  select(adjusted_count) %>% as.numeric
araucS_upper <- n_aut_araucS
araucS_mean <- (araucS_upper + araucS_lower) / 2
araucS_sd <- (araucS_upper - araucS_lower) / (2*1.96)

aut_prev_health_adj$new_rate <- numeric(nrow(aut_prev_health_adj))
aut_prev_health_adj$new_count <- numeric(nrow(aut_prev_health_adj))

for(i in 1:nrow(aut_prev_health_adj)) {
  if(aut_prev_health_adj$health_service_name[i] == "Servicio de Salud Araucanía Sur") {
    aut_prev_health_adj$new_rate[i] <- araucS_upper_prev
    aut_prev_health_adj$new_count[i] <- araucS_upper
  }
  else {
    aut_prev_health_adj$new_rate[i] <- aut_prev_health_adj$adjusted_rate[i] + prev_delta
    aut_prev_health_adj$new_count[i] <- round(aut_prev_health_adj$new_rate[i] * aut_prev_health_adj$sum_sample_pop_size[i], 0)
  }
}

```

```{r bayesSetup}
nObs <- nrow(chile_bayes_aut)
nIter <- 2000
nBurn <- 2000
nFeat <- length(unique(aut_prev_health_adj$health_service_code))
FeatNames <- sort(unique(aut_prev_health_adj$health_service_code))

```

```{r newPrevHealth, include = FALSE}

# Need to do all by health service code not name because name sorts in different orders.

# Now have health service specific priors so need to provide them as vectors and index each as needed
rand_model_new <- "model {
  for(i in 1:nFeat) { # For each category in the feature grouping
    theta[i] ~ dbeta(theta_a[i], theta_b[i])
    disease_sample[i] ~ dbin(theta[i], nObs[i])
    disease_pred[i] ~ dbin(theta[i], nObs[i])
  }
}"

nFeat <- length(unique(aut_prev_health_adj$health_service_code))
FeatNames <- sort(unique(aut_prev_health_adj$health_service_code))

pars <- c("theta_a", "theta_b", "theta", "disease_sample", "disease_pred")

# Define beta prior
theta_mu <- (aut_prev_health_adj$new_rate + aut_prev_health_adj$adjusted_rate) / 2
theta_sigma <- (aut_prev_health_adj$new_rate - aut_prev_health_adj$adjusted_rate) / (2*1.96)
theta_a <- theta_mu * (theta_mu * (1-theta_mu) / theta_sigma^2 - 1)
theta_b <- (1 - theta_mu) * (theta_mu * (1-theta_mu) / theta_sigma^2 - 1)

#x <- seq(0,1, by =0.01)
#for(i in 1:29) {
#  plot(x, dbeta(x, theta_a[i], theta_b[i]), type = "l", xlim = c(0,0.1))
#}

# Initial values for model chains
rand_ini <- list(list(theta = rep(0.001, nFeat)),
                 list(theta = rep(0.01, nFeat)))
# Run JAGS model
rand_data <- list(theta_a = theta_a,
                  theta_b = theta_b,
                  nObs = aut_prev_health_adj$sum_sample_pop_size,
                  aut_sample = aut_prev_health_adj$adjusted_count,
                  nFeat = nFeat)
rand_jag <- jags.model(textConnection(rand_model_new),
                       data = rand_data,
                       inits = rand_ini,
                       n.chains = 2,
                       quiet = TRUE)
update(rand_jag, n.iter = nBurn)
rand_sam <- coda.samples(model = rand_jag,
                         variable.names = pars,
                         n.iter = nIter)

convergence_check <- FALSE
if(convergence_check) {
  print(mcmc_trace(rand_sam, paste0("theta[", 1:nFeat, "]"))) # Convergence looks fine and rhats <= 1.1
  print(mcmc_trace(rand_sam, paste0("disease_pred[", 1:nFeat, "]"))) # Convergence looks fine and rhats <= 1.1
  rand_summ <- summary(subset_draws(as_draws(rand_sam), pars),
                           ~quantile(.x, probs=c(0.025, 0.5, 0.975)),
                           ~mcse_quantile(.x, probs=c(0.025, 0.5, 0.975)),
                           "rhat") %>%
        arrange(desc(rhat))
  print(rand_summ)
}

aut_prev_health_post_new <- as_tibble(as_draws_matrix(rand_sam), rownames = "Iteration") %>%
    select(c("Iteration", contains("theta["))) %>%
    pivot_longer(cols = contains("theta["),
                 names_to = "health_service_code",
                 values_to = "predicted_prev") %>%
    mutate(Feat_names = factor(health_service_code, levels = c(paste0("theta[",1:nFeat,"]")), labels = FeatNames)) %>%
    select(Iteration, Feat_names, predicted_prev) %>%
  rename(health_service_code = Feat_names) %>%
  merge(health_service_lookup, by = "health_service_code") %>%
  rename(health_service_name_long = health_service_name,
         health_service_name = health_service_name_short)
  

# Plot manually because we need different CI's now
aut_prev_health_post_new_ci <- aut_prev_health_post_new %>%
  group_by(health_service_name) %>%
  summarise(post_lower = quantile(predicted_prev, 0.025),
            post_upper = quantile(predicted_prev, 0.975))
  
ggplot() +
  geom_density(data = aut_prev_health_post_new, aes(x = predicted_prev)) +
  geom_vline(data = aut_prev_health_post_new_ci, aes(xintercept = post_lower), color = "blue", linetype = "dotted") +
  geom_vline(data = aut_prev_health_post_new_ci, aes(xintercept = post_upper), color = "blue", linetype = "dotted") +
  geom_vline(data = aut_prev_health_adj, aes(xintercept = adjusted_rate), color = "red", linetype = "dashed") +
  geom_vline(data = aut_prev_health_adj, aes(xintercept = new_rate), color = "red", linetype = "dashed") +
  facet_wrap(~health_service_name) +
  labs(title = "Region specific priors informed by clinical data from Araucanía Sur",
       x = "Posterior predictive distribution",
       y = "Density")

```


```{r newPrevHealthUniform}

####### Need to do all by health service code not name because name sorts in different orders.

# Now have health service specific priors so need to provide them as vectors and index each as needed
# OR Uniform prior https://stats.stackexchange.com/questions/555260/how-to-set-prior-for-bayesian-analysis 
rand_model_new <- "model {
  for(i in 1:nFeat) { # For each category in the feature grouping
    theta[i] ~ dunif(theta_lower[i], theta_upper[i])     #dbeta(theta_a[i], theta_b[i])
    disease_sample[i] ~ dbin(theta[i], nObs[i])
    disease_pred[i] ~ dbin(theta[i], nObs[i])
    #theta_a[i] <- theta_mu * (theta_mu * (1-theta_mu) / pow(theta_sigma, 2) - 1)
    #theta_b[i] <- (1 - theta_mu) * (theta_mu * (1-theta_mu) / pow(theta_sigma, 2) - 1)
  }
  #theta_mu ~ dunif(0, 1)
  #theta_sigma ~ dexp(1)
}"

pars <- c("theta", "disease_sample", "disease_pred")

# Define uniform prior
theta_lower <- aut_prev_health_adj$adjusted_rate
theta_upper <- aut_prev_health_adj$new_rate

# Initial values for model chains
rand_ini <- list(list(theta = rep(0.001, nFeat)),
                 list(theta = rep(0.01, nFeat)))
# Run JAGS model
rand_data <- list(theta_lower = theta_lower,
                  theta_upper = theta_upper,
                  nObs = aut_prev_health_adj$sum_sample_pop_size,
                  aut_sample = aut_prev_health_adj$adjusted_count,
                  nFeat = nFeat)
rand_jag <- jags.model(textConnection(rand_model_new),
                       data = rand_data,
                       inits = rand_ini,
                       n.chains = 2,
                       quiet = TRUE)
update(rand_jag, n.iter = nBurn)
rand_sam <- coda.samples(model = rand_jag,
                         variable.names = pars,
                         n.iter = nIter)

convergence_check <- FALSE
if(convergence_check) {
  print(mcmc_trace(rand_sam, paste0("theta[", 1:nFeat, "]"))) # Convergence looks fine and rhats <= 1.1
  print(mcmc_trace(rand_sam, paste0("disease_pred[", 1:nFeat, "]"))) # Convergence looks fine and rhats <= 1.1
  rand_summ <- summary(subset_draws(as_draws(rand_sam), pars),
                           ~quantile(.x, probs=c(0.025, 0.5, 0.975)),
                           ~mcse_quantile(.x, probs=c(0.025, 0.5, 0.975)),
                           "rhat") %>%
        arrange(desc(rhat))
  print(rand_summ)
}

aut_prev_health_post_new <- as_tibble(as_draws_matrix(rand_sam), rownames = "Iteration") %>%
    select(c("Iteration", contains("theta["))) %>%
    pivot_longer(cols = contains("theta["),
                 names_to = "health_service_code",
                 values_to = "predicted_prev") %>%
    mutate(Feat_names = factor(health_service_code, levels = c(paste0("theta[",1:nFeat,"]")), labels = FeatNames)) %>%
    select(Iteration, Feat_names, predicted_prev) %>%
  rename(health_service_code = Feat_names) %>%
  merge(health_service_lookup, by = "health_service_code") %>%
  rename(health_service_name_long = health_service_name,
         health_service_name = health_service_name_short)
  

# Plot manually because we need different CI's now
aut_prev_health_post_new_ci <- aut_prev_health_post_new %>%
  group_by(health_service_name) %>%
  summarise(post_lower = quantile(predicted_prev, 0.025),
            post_upper = quantile(predicted_prev, 0.975))
  
ggplot() +
  geom_density(data = aut_prev_health_post_new, aes(x = predicted_prev)) +
  geom_vline(data = aut_prev_health_post_new_ci, aes(xintercept = post_lower), color = "blue", linetype = "dotted") +
  geom_vline(data = aut_prev_health_post_new_ci, aes(xintercept = post_upper), color = "blue", linetype = "dotted") +
  geom_vline(data = aut_prev_health_adj, aes(xintercept = adjusted_rate), color = "red", linetype = "dashed") +
  geom_vline(data = aut_prev_health_adj, aes(xintercept = new_rate), color = "red", linetype = "dashed") +
  facet_wrap(~health_service_name) +
  labs(title = "Region specific priors informed by clinical data from Araucanía Sur",
       x = "Posterior predictive distribution",
       y = "Density")

```

Red is the prior 95% CI (adjusted sample rate and it + prev_delta), blue is posterior 95% CrI


# Supplementary materials

```{r prevAgeAutPlot}
ggplot(data = aut_prev.age) +
  geom_col(aes(x = age_june30, y = sample_prevalence*100, group = age_june30, fill = age_june30), position = position_dodge()) +
  geom_errorbar(aes(x = age_june30, ymin = ci_lower*100, ymax = ci_upper*100, group = age_june30), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_viridis_c(option = "plasma") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  labs(title = "Autism prevalence",
       x = "Age band",
       y = "Sample prevalence % (95% CI)",
       fill = "Age band")
```

```{r prevAgeAdhdPlot}
ggplot(data = adhd_prev.age) +
  geom_col(aes(x = age_june30, y = sample_prevalence*100, group = age_june30, fill = age_june30), position = position_dodge()) +
  geom_errorbar(aes(x = age_june30, ymin = ci_lower*100, ymax = ci_upper*100, group = age_june30), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_viridis_c(option = "plasma") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  labs(title = "ADHD prevalence",
       x = "Age band",
       y = "Sample prevalence % (95% CI)",
       fill = "Age band")
```

```{r prevAgeSexAutPlot, fig.cap = "Sample prevalence of autism by age and sex. Bars show 95% normal confidence intervals."}
# Autism

# By age and sex
ggplot(data = aut_prev.age_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence, group = age_june30, fill = age_june30), position = position_dodge()) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower, ymax = ci_upper, group = age_june30), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_viridis_c(option = "plasma") +
  labs(title = "Autism prevalence",
       x = "Sex",
       y = "Sample prevalence",
       fill = "Age")

```

```{r prevAgeSexAdhdPlot, fig.cap = "Sample prevalence of ADHD by age and sex. Bars show 95% normal confidence intervals."}
# ADHD
adhd_prev.age_sex <- get_grouped_prev_plot(x = chile_bayes_adhd, 
                                          grouping_vars = c("age_june30", "sex_desc", "adhd"),
                                          disease = "adhd") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

# By age and sex
ggplot(data = adhd_prev.age_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence, group = age_june30, fill = age_june30), position = position_dodge()) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower, ymax = ci_upper, group = age_june30), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_viridis_c(option = "plasma") +
  labs(title = "ADHD prevalence",
       x = "Sex",
       y = "Sample prevalence",
       fill = "Age")

```

```{r prevAgeHealthAutPlot, fig.cap = "Sample prevalence of autism by health service, age and sex. Bars show 95% normal confidence intervals."}
# Single ages
aut_prev_health.age_sex <- get_grouped_prev_plot(x = chile_bayes_aut, 
                                                 grouping_vars = c("health_service_name", "age_june30", "sex_desc", "autism"),
                                                 disease = "autism") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

ggplot(data = aut_prev_health.age_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence, group = age_june30, fill = age_june30), position = position_dodge()) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower, ymax = ci_upper, group = age_june30), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_viridis_c(option = "plasma") +
  #theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.2)) +
  facet_wrap(~health_service_name) +
  labs(title = "Autism prevalence by health service",
       x = "Sex",
       y = "Sample prevalence",
       fill = "Age")
```

```{r prevAgeHealthAdhdPlot, fig.cap = "Sample prevalence of ADHD by health service, age and sex. Bars show 95% normal confidence intervals."}
# Single ages
adhd_prev_health.age_sex <- get_grouped_prev_plot(x = chile_bayes_adhd, 
                                                 grouping_vars = c("health_service_name", "age_june30", "sex_desc", "adhd"),
                                                 disease = "adhd") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

ggplot(data = adhd_prev_health.age_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence, group = age_june30, fill = age_june30), position = position_dodge()) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower, ymax = ci_upper, group = age_june30), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_viridis_c(option = "plasma") +
  #theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.2)) +
  facet_wrap(~health_service_name) +
  labs(title = "ADHD prevalence by health service",
       x = "Sex",
       y = "Sample prevalence",
       fill = "Age")
```

```{r prevAraucSAgeAutPlot, fig.cap = "Sample prevalence of autism by commune in Araucanía Sur health service, age and sex. Bars show 95% normal confidence intervals.", include=FALSE}
# Single ages
# aut_prev_araucS.age_sex <- get_grouped_prev_plot(x = chile_bayes_aut_araucS, 
#                                                  grouping_vars = c("commune_name", "age_june30", "sex_desc", "autism"),
#                                                  disease = "autism") %>%
#   mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))
# 
# ggplot(data = aut_prev_araucS.age_sex) +
#   geom_col(aes(x = sex_desc, y = sample_prevalence, group = age_june30, fill = age_june30), position = position_dodge()) +
#   geom_errorbar(aes(x = sex_desc, ymin = ci_lower, ymax = ci_upper, group = age_june30), width = 0.2, position = position_dodge(width = 0.9)) +
#   scale_fill_viridis_c(option = "plasma") +
#   #theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.2)) +
#   facet_wrap(~commune_name) +
#   labs(title = "Autism prevalence by commune in Araucanía Sur",
#        x = "Sex",
#        y = "Sample prevalence",
#        fill = "Age")
```

```{r prevEconAAgeAutPlot, fig.cap = "Sample prevalence of autism by socio-economic (SES) status of student's family, age and sex. Bars show 95% normal confidence intervals."}
# Single ages
aut_prev_econA.age_sex <- get_grouped_prev_plot(x = chile_bayes_aut, 
                                                 grouping_vars = c("school_fee", "age_june30", "sex_desc", "autism"),
                                                 disease = "autism") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

ggplot(data = aut_prev_econA.age_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence, group = age_june30, fill = age_june30), position = position_dodge()) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower, ymax = ci_upper, group = age_june30), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_viridis_c(option = "plasma") +
  #theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.2)) +
  facet_wrap(~school_fee) +
  labs(title = "Autism prevalence by SES status",
       x = "Sex",
       y = "Sample prevalence",
       fill = "Age")
```

```{r prevEconAAgeAdhdPlot, fig.cap = "Sample prevalence of ADHD by socio-economic (SES) status of student's family, age and sex. Bars show 95% normal confidence intervals."}
# Single ages
adhd_prev_econA.age_sex <- get_grouped_prev_plot(x = chile_bayes_adhd, 
                                                 grouping_vars = c("school_fee", "age_june30", "sex_desc", "adhd"),
                                                 disease = "adhd") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

ggplot(data = adhd_prev_econA.age_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence, group = age_june30, fill = age_june30), position = position_dodge()) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower, ymax = ci_upper, group = age_june30), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_viridis_c(option = "plasma") +
  #theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.2)) +
  facet_wrap(~school_fee) +
  labs(title = "ADHD prevalence by SES status",
       x = "Sex",
       y = "Sample prevalence",
       fill = "Age")
```

```{r prevEthnicAgeAutPlot, fig.cap = "Sample prevalence of autism by ethnicity, age and sex. Bars show 95% normal confidence intervals."}
# Single ages
aut_prev_ethnic.age_sex <- get_grouped_prev_plot(x = chile_bayes_aut, 
                                                 grouping_vars = c("ethnic_2_group", "age_june30", "sex_desc", "autism"),
                                                 disease = "autism") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

ggplot(data = aut_prev_ethnic.age_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence, group = age_june30, fill = age_june30), position = position_dodge()) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower, ymax = ci_upper, group = age_june30), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_viridis_c(option = "plasma") +
  #theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.2)) +
  facet_wrap(~ethnic_2_group) +
  labs(title = "Autism prevalence by ethnicity",
       x = "Sex",
       y = "Sample prevalence",
       fill = "Age")
```

```{r prevEthnicAgeAdhdPlot, fig.cap = "Sample prevalence of ADHD by ethnicity, age and sex. Bars show 95% normal confidence intervals."}
# Single ages
adhd_prev_ethnic.age_sex <- get_grouped_prev_plot(x = chile_bayes_adhd, 
                                                 grouping_vars = c("ethnic_2_group", "age_june30", "sex_desc", "adhd"),
                                                 disease = "adhd") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

ggplot(data = adhd_prev_ethnic.age_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence, group = age_june30, fill = age_june30), position = position_dodge()) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower, ymax = ci_upper, group = age_june30), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_viridis_c(option = "plasma") +
  #theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.2)) +
  facet_wrap(~ethnic_2_group) +
  labs(title = "ADHD prevalence by ethnicity",
       x = "Sex",
       y = "Sample prevalence",
       fill = "Age")
```

```{r prevRuralAgeAutPlot, fig.cap = "Sample prevalence of autism by school's rurality, age and sex. Bars show 95% normal confidence intervals."}
# Single ages
aut_prev_rural.age_sex <- get_grouped_prev_plot(x = chile_bayes_aut, 
                                                 grouping_vars = c("school_rurality", "age_june30", "sex_desc", "autism"),
                                                 disease = "autism") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

ggplot(data = aut_prev_rural.age_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence, group = age_june30, fill = age_june30), position = position_dodge()) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower, ymax = ci_upper, group = age_june30), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_viridis_c(option = "plasma") +
  #theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.2)) +
  facet_wrap(~school_rurality) +
  labs(title = "Autism prevalence by school's rurality",
       x = "Sex",
       y = "Sample prevalence",
       fill = "Age")
```

```{r prevRuralAgeAdhdPlot, fig.cap = "Sample prevalence of ADHD by school's rurality, age and sex. Bars show 95% normal confidence intervals."}
# Single ages
adhd_prev_rural.age_sex <- get_grouped_prev_plot(x = chile_bayes_adhd, 
                                                 grouping_vars = c("school_rurality", "age_june30", "sex_desc", "adhd"),
                                                 disease = "adhd") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

ggplot(data = adhd_prev_rural.age_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence, group = age_june30, fill = age_june30), position = position_dodge()) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower, ymax = ci_upper, group = age_june30), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_viridis_c(option = "plasma") +
  #theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.2)) +
  facet_wrap(~school_rurality) +
  labs(title = "ADHD prevalence by school's rurality",
       x = "Sex",
       y = "Sample prevalence",
       fill = "Age")
```

## AraucS prevalence

```{r adjPrevAraucS, include = FALSE}
# Only do autism here because we only have clinical data for autism
chile_bayes_aut_araucS <- chile_bayes_aut %>%
  filter(health_service_code == 5)

aut_prev_araucS <- get_grouped_prev(x = chile_bayes_aut_araucS, stdpop = chile_stdpop, 
                                    grouping_vars = c("commune_name", "age_june30", "age_cat_name", "sex", "sex_desc", "autism"),
                                    disease = "autism")

aut_prev_araucS_adj <- get_adjusted_prev(aut_prev_araucS, grouping_vars = "commune_name") %>%
  mutate(crude_ci_lower = ifelse(crude_ci_lower < 0, 0, crude_ci_lower),
         adjusted_ci_lower = ifelse(adjusted_ci_lower < 0, 0, adjusted_ci_lower))

aut_prev_araucS_adj %>% 
  select(commune_name, 
         crude_ci_lower, crude_rate, crude_ci_upper, 
         adjusted_ci_lower, adjusted_rate, adjusted_ci_upper) %>%
  mutate(across(is.numeric, round, digits = 5)) 
```

```{r prevAraucSAgecatAutPlot, fig.cap = "Sample prevalence of autism by commune in Araucanía Sur health service, age band and sex. Bars show 95% normal confidence intervals.", include = FALSE}
# By age and sex
# Age categories
aut_prev_araucS.agecat_sex <- get_grouped_prev_plot(x = chile_bayes_aut_araucS,
                                                    grouping_vars = c("commune_name", "age_cat_name", "sex_desc", "autism"),
                                                    disease = "autism") %>%
  mutate(ci_lower = ifelse(ci_lower < 0, 0, ci_lower))

ggplot(data = aut_prev_araucS.agecat_sex) +
  geom_col(aes(x = sex_desc, y = sample_prevalence, group = age_cat_name, fill = age_cat_name), position = "dodge") +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower, ymax = ci_upper, group = age_cat_name), width = 0.2, position = position_dodge(width = 0.9)) +
  scale_fill_viridis_d(option = "plasma") +
  facet_wrap(~commune_name) +
  labs(title = "Autism prevalence by commune in Araucanía Sur",
       x = "Sex",
       y = "Sample prevalence",
       fill = "Age category")
```

```{r adjPrevAraucSAutPlot, fig.cap = "Crude and age- and sex-adjusted sample prevalences of autism by commune in Araucanía Sur health service. Bars for crude prevalence show 95% normal confidence intervals and bars for adjusted prevalence show 95% gamma confidence intervals.", include = FALSE}
# All
aut_prev_araucS_adj.long <- aut_prev_araucS_adj %>%
  select(-sum_sample_pop_size, -crude_count, -adjusted_count, -var, -w_M) %>%
  pivot_longer(cols = c(crude_rate, adjusted_rate, crude_ci_lower, crude_ci_upper, adjusted_ci_lower, adjusted_ci_upper),
               names_to = c("type", ".value"),
               names_pattern = "(crude|adjusted)_(.*)") %>%
  mutate(type = factor(type, levels = c("crude", "adjusted"), labels = c("Crude", "Adjusted")))

ggplot(data = aut_prev_araucS_adj.long) +
  geom_col(aes(x = type, y = rate, fill = type), position = position_dodge(), show.legend = TRUE) +
  geom_errorbar(aes(x = type, ymin = ci_lower, ymax = ci_upper, group = type), width = 0.2, position = position_dodge(width = 0.9)) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  facet_wrap(~commune_name) +
  labs(title = "Autism prevalence by commune in Araucanía Sur",
       #y = "Aggregate prevalence",
       fill = "Prevalence")
```

## Adjusted prevalence

```{r adjPrevPlot, fig.cap = "Crude and age- and sex-adjusted sample prevalences of autism and ADHD. Bars for crude prevalence show 95% normal confidence intervals and bars for adjusted prevalence show 95% gamma confidence intervals.", fig.height=5}

# Autism
aut_prev_adj.long <- aut_prev_adj %>%
  select(-sum_sample_pop_size, -crude_count, -adjusted_count, -var, -w_M) %>%
  pivot_longer(cols = c(crude_rate, adjusted_rate, crude_ci_lower, crude_ci_upper, adjusted_ci_lower, adjusted_ci_upper),
               names_to = c("type", ".value"),
               names_pattern = "(crude|adjusted)_(.*)") %>%
  mutate(type = factor(type, levels = c("crude", "adjusted"), labels = c("Crude", "Adjusted")))

aut_prev_adj.long_plot <- ggplot(data = aut_prev_adj.long) +
  geom_col(aes(x = type, y = rate, fill = type), position = position_dodge(), show.legend = TRUE) +
  geom_errorbar(aes(x = type, ymin = ci_lower, ymax = ci_upper, group = type), width = 0.2, position = position_dodge(width = 0.9)) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "Autism prevalence",
       y = "Aggregate prevalence",
       fill = "Prevalence")

# ADHD
adhd_prev_adj.long <- adhd_prev_adj %>%
  select(-sum_sample_pop_size, -crude_count, -adjusted_count, -var, -w_M) %>%
  pivot_longer(cols = c(crude_rate, adjusted_rate, crude_ci_lower, crude_ci_upper, adjusted_ci_lower, adjusted_ci_upper),
               names_to = c("type", ".value"),
               names_pattern = "(crude|adjusted)_(.*)") %>%
  mutate(type = factor(type, levels = c("crude", "adjusted"), labels = c("Crude", "Adjusted")))

adhd_prev_adj.long_plot <- ggplot(data = adhd_prev_adj.long) +
  geom_col(aes(x = type, y = rate, fill = type), position = position_dodge(), show.legend = TRUE) +
  geom_errorbar(aes(x = type, ymin = ci_lower, ymax = ci_upper, group = type), width = 0.2, position = position_dodge(width = 0.9)) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "ADHD prevalence",
       y = "Aggregate prevalence",
       fill = "Prevalence")

grid.arrange(aut_prev_adj.long_plot, adhd_prev_adj.long_plot, ncol = 2)
```

```{r adjPrevSexPlot, fig.cap = "Crude and age- and sex-adjusted sample prevalences of autism and ADHD by sex. Bars for crude prevalence show 95% normal confidence intervals and bars for adjusted prevalence show 95% gamma confidence intervals.", fig.height=5}
# Females
# aut_prev_adj_f.long <- aut_prev_adj_f %>%
#   select(-sum_sample_pop_size, -crude_count, -adjusted_count, -var, -w_M) %>%
#   pivot_longer(cols = c(crude_rate, adjusted_rate, crude_ci_lower, crude_ci_upper, adjusted_ci_lower, adjusted_ci_upper),
#                names_to = c("type", ".value"),
#                names_pattern = "(crude|adjusted)_(.*)") %>%
#   mutate(type = factor(type, levels = c("crude", "adjusted"), labels = c("Crude", "Adjusted")))
# 
# # Males
# aut_prev_adj_m.long <- aut_prev_adj_m %>%
#   select(-sum_sample_pop_size, -crude_count, -adjusted_count, -var, -w_M) %>%
#   pivot_longer(cols = c(crude_rate, adjusted_rate, crude_ci_lower, crude_ci_upper, adjusted_ci_lower, adjusted_ci_upper),
#                names_to = c("type", ".value"),
#                names_pattern = "(crude|adjusted)_(.*)") %>%
#   mutate(type = factor(type, levels = c("crude", "adjusted"), labels = c("Crude", "Adjusted")))

# Autism
aut_prev_sex_adj.long <- #rbind(aut_prev_adj_m.long, aut_prev_adj_f.long)
  aut_prev_sex_adj %>%
  select(-sum_sample_pop_size, -crude_count, -adjusted_count, -var, -w_M) %>%
  pivot_longer(cols = c(crude_rate, adjusted_rate, crude_ci_lower, crude_ci_upper, adjusted_ci_lower, adjusted_ci_upper),
               names_to = c("type", ".value"),
               names_pattern = "(crude|adjusted)_(.*)") %>%
  mutate(type = factor(type, levels = c("crude", "adjusted"), labels = c("Crude", "Adjusted")))

aut_prev_sex_adj.long_plot <- ggplot(data = aut_prev_sex_adj.long) +
  geom_col(aes(x = sex_desc, y = rate*100, fill = type), position = position_dodge(), show.legend = FALSE) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower*100, ymax = ci_upper*100, group = type), width = 0.2, position = position_dodge(width = 0.9)) +
  #theme(axis.title.x = element_blank()) +
  labs(title = "Autism prevalence",
       x = "Sex",
       y = "Aggregate prevalence")

# ADHD
adhd_prev_sex_adj.long <- #rbind(aut_prev_adj_m.long, aut_prev_adj_f.long)
  adhd_prev_sex_adj %>%
  select(-sum_sample_pop_size, -crude_count, -adjusted_count, -var, -w_M) %>%
  pivot_longer(cols = c(crude_rate, adjusted_rate, crude_ci_lower, crude_ci_upper, adjusted_ci_lower, adjusted_ci_upper),
               names_to = c("type", ".value"),
               names_pattern = "(crude|adjusted)_(.*)") %>%
  mutate(type = factor(type, levels = c("crude", "adjusted"), labels = c("Crude", "Adjusted")))

adhd_prev_sex_adj.long_plot <- ggplot(data = adhd_prev_sex_adj.long) +
  geom_col(aes(x = sex_desc, y = rate*100, fill = type), position = position_dodge(), show.legend = FALSE) +
  geom_errorbar(aes(x = sex_desc, ymin = ci_lower*100, ymax = ci_upper*100, group = type), width = 0.2, position = position_dodge(width = 0.9)) +
  #theme(axis.title.x = element_blank()) +
  labs(title = "ADHD prevalence",
       x = "Sex",
       y = "Aggregate prevalence")

grid.arrange(aut_prev_sex_adj.long_plot, adhd_prev_sex_adj.long_plot, ncol = 2)
```

```{r adjPrevHealthAutPlot, fig.cap = "Crude and age- and sex-adjusted sample prevalences of autism by health service. Bars for crude prevalence show 95% normal confidence intervals and bars for adjusted prevalence show 95% gamma confidence intervals."}
# Autism
aut_prev_health_adj.long <- aut_prev_health_adj %>%
  select(-sum_sample_pop_size, -crude_count, -adjusted_count, -var, -w_M) %>%
  pivot_longer(cols = c(crude_rate, adjusted_rate, crude_ci_lower, crude_ci_upper, adjusted_ci_lower, adjusted_ci_upper),
               names_to = c("type", ".value"),
               names_pattern = "(crude|adjusted)_(.*)") %>%
  mutate(type = factor(type, levels = c("crude", "adjusted"), labels = c("Crude", "Adjusted")))

ggplot(data = aut_prev_health_adj.long) +
  geom_col(aes(x = type, y = rate, fill = type), position = position_dodge(), show.legend = TRUE) +
  geom_errorbar(aes(x = type, ymin = ci_lower, ymax = ci_upper, group = type), width = 0.2, position = position_dodge(width = 0.9)) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  facet_wrap(~health_service_name) +
  labs(title = "Autism prevalence by health service",
       x = "Sex",
       y = "Aggregate prevalence",
       fill = "Prevalence")
```

```{r adjPrevHealthAdhdPlot, fig.cap = "Crude and age- and sex-adjusted sample prevalences of ADHD by health service. Bars for crude prevalence show 95% normal confidence intervals and bars for adjusted prevalence show 95% gamma confidence intervals."}
# ADHD
adhd_prev_health_adj.long <- adhd_prev_health_adj %>%
  select(-sum_sample_pop_size, -crude_count, -adjusted_count, -var, -w_M) %>%
  pivot_longer(cols = c(crude_rate, adjusted_rate, crude_ci_lower, crude_ci_upper, adjusted_ci_lower, adjusted_ci_upper),
               names_to = c("type", ".value"),
               names_pattern = "(crude|adjusted)_(.*)") %>%
  mutate(type = factor(type, levels = c("crude", "adjusted"), labels = c("Crude", "Adjusted")))

ggplot(data = adhd_prev_health_adj.long) +
  geom_col(aes(x = type, y = rate, fill = type), position = position_dodge(), show.legend = TRUE) +
  geom_errorbar(aes(x = type, ymin = ci_lower, ymax = ci_upper, group = type), width = 0.2, position = position_dodge(width = 0.9)) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  facet_wrap(~health_service_name) +
  labs(title = "ADHD prevalence by health service",
       x = "Sex",
       y = "Aggregate prevalence",
       fill = "Prevalence")
```

```{r adjPrevEconAAutPlot, fig.cap = "Crude and age- and sex-adjusted sample prevalences of autism by socio-economic (SES) status of student's family. Bars for crude prevalence show 95% normal confidence intervals and bars for adjusted prevalence show 95% gamma confidence intervals."}
# Autism
aut_prev_econA_adj.long <- aut_prev_econA_adj %>%
  select(-sum_sample_pop_size, -crude_count, -adjusted_count, -var, -w_M) %>%
  pivot_longer(cols = c(crude_rate, adjusted_rate, crude_ci_lower, crude_ci_upper, adjusted_ci_lower, adjusted_ci_upper),
               names_to = c("type", ".value"),
               names_pattern = "(crude|adjusted)_(.*)") %>%
  mutate(type = factor(type, levels = c("crude", "adjusted"), labels = c("Crude", "Adjusted")))

ggplot(data = aut_prev_econA_adj.long) +
  geom_col(aes(x = type, y = rate, fill = type), position = position_dodge(), show.legend = TRUE) +
  geom_errorbar(aes(x = type, ymin = ci_lower, ymax = ci_upper, group = type), width = 0.2, position = position_dodge(width = 0.9)) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  facet_wrap(~school_fee) +
  labs(title = "Autism prevalence by SES status",
       x = "Sex",
       y = "Aggregate prevalence",
       fill = "Prevalence")
```

```{r adjPrevEconAAdhdPlot, fig.cap = "Crude and age- and sex-adjusted sample prevalences of ADHD by socio-economic (SES) status of student's family. Bars for crude prevalence show 95% normal confidence intervals and bars for adjusted prevalence show 95% gamma confidence intervals."}
# ADHD
adhd_prev_econA_adj.long <- adhd_prev_econA_adj %>%
  select(-sum_sample_pop_size, -crude_count, -adjusted_count, -var, -w_M) %>%
  pivot_longer(cols = c(crude_rate, adjusted_rate, crude_ci_lower, crude_ci_upper, adjusted_ci_lower, adjusted_ci_upper),
               names_to = c("type", ".value"),
               names_pattern = "(crude|adjusted)_(.*)") %>%
  mutate(type = factor(type, levels = c("crude", "adjusted"), labels = c("Crude", "Adjusted")))

ggplot(data = adhd_prev_econA_adj.long) +
  geom_col(aes(x = type, y = rate, fill = type), position = position_dodge(), show.legend = TRUE) +
  geom_errorbar(aes(x = type, ymin = ci_lower, ymax = ci_upper, group = type), width = 0.2, position = position_dodge(width = 0.9)) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  facet_wrap(~school_fee) +
  labs(title = "ADHD prevalence by SES status",
       x = "Sex",
       y = "Aggregate prevalence",
       fill = "Prevalence")
```

```{r adjPrevEthnicAutPlot, fig.cap = "Crude and age- and sex-adjusted sample prevalences of autism by ethnicity. Bars for crude prevalence show 95% normal confidence intervals and bars for adjusted prevalence show 95% gamma confidence intervals."}

# Autism
aut_prev_ethnic_adj.long <- aut_prev_ethnic_adj %>%
  select(-sum_sample_pop_size, -crude_count, -adjusted_count, -var, -w_M) %>%
  pivot_longer(cols = c(crude_rate, adjusted_rate, crude_ci_lower, crude_ci_upper, adjusted_ci_lower, adjusted_ci_upper),
               names_to = c("type", ".value"),
               names_pattern = "(crude|adjusted)_(.*)") %>%
  mutate(type = factor(type, levels = c("crude", "adjusted"), labels = c("Crude", "Adjusted")))

ggplot(data = aut_prev_ethnic_adj.long) +
  geom_col(aes(x = type, y = rate, fill = type), position = position_dodge(), show.legend = TRUE) +
  geom_errorbar(aes(x = type, ymin = ci_lower, ymax = ci_upper, group = type), width = 0.2, position = position_dodge(width = 0.9)) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  facet_wrap(~ethnic_2_group) +
  labs(title = "Autism prevalence by ethnicity",
       #y = "Aggregate prevalence",
       fill = "Prevalence")
```

```{r adjPrevEthnicAdhdPlot, fig.cap = "Crude and age- and sex-adjusted sample prevalences of ADHD by ethnicity. Bars for crude prevalence show 95% normal confidence intervals and bars for adjusted prevalence show 95% gamma confidence intervals."}
# ADHD
adhd_prev_ethnic_adj.long <- adhd_prev_ethnic_adj %>%
  select(-sum_sample_pop_size, -crude_count, -adjusted_count, -var, -w_M) %>%
  pivot_longer(cols = c(crude_rate, adjusted_rate, crude_ci_lower, crude_ci_upper, adjusted_ci_lower, adjusted_ci_upper),
               names_to = c("type", ".value"),
               names_pattern = "(crude|adjusted)_(.*)") %>%
  mutate(type = factor(type, levels = c("crude", "adjusted"), labels = c("Crude", "Adjusted")))

ggplot(data = adhd_prev_ethnic_adj.long) +
  geom_col(aes(x = type, y = rate, fill = type), position = position_dodge(), show.legend = TRUE) +
  geom_errorbar(aes(x = type, ymin = ci_lower, ymax = ci_upper, group = type), width = 0.2, position = position_dodge(width = 0.9)) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  facet_wrap(~ethnic_2_group) +
  labs(title = "ADHD prevalence by ethnicity",
       x = "Sex",
       y = "Aggregate prevalence",
       fill = "Prevalence")
```

```{r adjPrevRuralAutPlot, fig.cap = "Crude and age- and sex-adjusted sample prevalences of autism by school's rurality. Bars for crude prevalence show 95% normal confidence intervals and bars for adjusted prevalence show 95% gamma confidence intervals."}
# Autism
aut_prev_rural_adj.long <- aut_prev_rural_adj %>%
  select(-sum_sample_pop_size, -crude_count, -adjusted_count, -var, -w_M) %>%
  pivot_longer(cols = c(crude_rate, adjusted_rate, crude_ci_lower, crude_ci_upper, adjusted_ci_lower, adjusted_ci_upper),
               names_to = c("type", ".value"),
               names_pattern = "(crude|adjusted)_(.*)") %>%
  mutate(type = factor(type, levels = c("crude", "adjusted"), labels = c("Crude", "Adjusted")))

ggplot(data = aut_prev_rural_adj.long) +
  geom_col(aes(x = type, y = rate, fill = type), position = position_dodge(), show.legend = TRUE) +
  geom_errorbar(aes(x = type, ymin = ci_lower, ymax = ci_upper, group = type), width = 0.2, position = position_dodge(width = 0.9)) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  facet_wrap(~school_rurality) +
  labs(title = "Autism prevalence by school's rurality",
       #y = "Aggregate prevalence",
       fill = "Prevalence")
```

```{r adjPrevRuralAdhdPlot, fig.cap = "Crude and age- and sex-adjusted sample prevalences of ADHD by school's rurality. Bars for crude prevalence show 95% normal confidence intervals and bars for adjusted prevalence show 95% gamma confidence intervals."}
# ADHD
adhd_prev_rural_adj.long <- adhd_prev_rural_adj %>%
  select(-sum_sample_pop_size, -crude_count, -adjusted_count, -var, -w_M) %>%
  pivot_longer(cols = c(crude_rate, adjusted_rate, crude_ci_lower, crude_ci_upper, adjusted_ci_lower, adjusted_ci_upper),
               names_to = c("type", ".value"),
               names_pattern = "(crude|adjusted)_(.*)") %>%
  mutate(type = factor(type, levels = c("crude", "adjusted"), labels = c("Crude", "Adjusted")))

ggplot(data = adhd_prev_rural_adj.long) +
  geom_col(aes(x = type, y = rate, fill = type), position = position_dodge(), show.legend = TRUE) +
  geom_errorbar(aes(x = type, ymin = ci_lower, ymax = ci_upper, group = type), width = 0.2, position = position_dodge(width = 0.9)) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  facet_wrap(~school_rurality) +
  labs(title = "ADHD prevalence by rurality",
       #y = "Aggregate prevalence",
       fill = "Prevalence")
```


## Differences between un/matched


```{r kolmogorovSchool, warning = FALSE}

school_yes <- school_matched_small %>% filter(matched == 1) #%>% select(sex.school)
school_no <- school_matched_small %>% filter(matched == 0)

# Kolmogorov tests for our matched results
ks.school.sex <- ks.test(na.omit(school_yes$sex.school),
                         na.omit(school_no$sex.school),
                         alternative = "two.sided", simulate.p.value = TRUE)
#ks.school.sex

ks.school.ses_status <- ks.test(as.numeric(na.omit(school_yes$ses_status.school)),
                                as.numeric(na.omit(school_no$ses_status.school)),
                                alternative = "two.sided", simulate.p.value = TRUE)
#ks.school.ses_status

ks.school.commune_code<- ks.test(as.numeric(na.omit(school_yes$commune_code)),
                                 as.numeric(na.omit(school_no$commune_code)),
                                 alternative = "two.sided", simulate.p.value = TRUE)
#ks.school.commune_code

# Kolmogorov tests with permutation distributions
set.seed(123)
nPerm <- 200 # change to 2000
ks_perm.school.pvals <- data.frame(sex = numeric(nPerm),
                                   commune_code = numeric(nPerm),
                                   ses_status = numeric(nPerm))

school_matched_small_perm <- school_matched_small

for (i in 1:nPerm) {
  #print(i)
  school_matched_small_perm$matched <- school_matched_small$matched[sample(nrow(school_matched_small))] # permute matched status
  school_perm_yes <- school_matched_small_perm %>% filter(matched == 1)
  school_perm_no <- school_matched_small_perm %>% filter(matched == 0)
  
  ks_perm.school.sex <- ks.test(na.omit(school_perm_yes$sex.school),
                                na.omit(school_perm_no$sex.school), 
                                alternative = "two.sided")
  ks_perm.school.commune_code <- ks.test(as.numeric(na.omit(school_perm_yes$commune_code)),
                                        as.numeric(na.omit(school_perm_no$commune_code)),
                                        alternative = "two.sided")
  ks_perm.school.ses_status <- ks.test(as.numeric(na.omit(school_perm_yes$ses_status.school)),
                                       as.numeric(na.omit(school_perm_no$ses_status.school)),
                                       alternative = "two.sided")
  
  ks_perm.school.pvals$sex[i] <- ks_perm.school.sex$p.value
  ks_perm.school.pvals$commune_code[i] <- ks_perm.school.commune_code$p.value
  ks_perm.school.pvals$ses_status[i] <- ks_perm.school.ses_status$p.value
}


```

```{r kolmogorovSchoolSex, fig.cap="a) Difference in frequency of sexes among school records that matched to patient records and school records that did not match. b) Density of Kolmogorov-Smirnov p-values for 2000 permutations of matched status for school records by sex with observed p-value shown in red.", fig.height=9}
# Results for sex
school_match_yes.sex <- school_yes %>% group_by(sex.school) %>% summarise(count = n()) %>% mutate(freq = count/sum(count), matched = 1)
school_match_no.sex <- school_no %>% group_by(sex.school) %>% summarise(count = n()) %>% mutate(freq = count/sum(count), matched = 0)
school_match.sex <- rbind(school_match_yes.sex, school_match_no.sex) %>%
  mutate(sex_desc = ifelse(sex.school == 1, "Male", ifelse(sex.school == 2, "Female", NA))) %>% 
  arrange(sex_desc, matched)

kolmog_school_sex.bar <- ggplot(school_match.sex) +
  geom_col(aes(x = as.factor(matched), y = freq, fill = as.factor(matched))) +
  facet_wrap(~sex_desc) +
  labs(title = "Matching of school record to clinical record by sex",
       x = "Matched status",
       y = "Feature frequency",
       fill = "Matched status")

kolmog_school_sex.density <- ggplot(ks_perm.school.pvals, aes(x = sex, y = after_stat(density))) +
  geom_density() +
  geom_vline(xintercept = ks.school.sex$p.value, color = "red") +
  labs(title = "Kolmogorov-Smirnov permutation test on matched status in school data by sex and observed p-value (red)",
       x = "Sex",
       y = "Density")

grid.arrange(kolmog_school_sex.bar, kolmog_school_sex.density, nrow = 2)
```

```{r kolmogorovSchoolCommune, fig.cap="a) Difference in frequency of communes of residence among school records that matched to patient records and school records that did not match. b) Density of Kolmogorov-Smirnov p-values for 2000 permutations of matched status for school records by commune of residence with observed p-value shown in red.", fig.height=9}
# Results for commune
school_match_yes.student_commune_name <- school_yes %>% group_by(student_commune_name.school) %>%
  summarise(count = n()) %>% mutate(freq = count/sum(count)) %>%
  # Would need to merge to a list of commune names and numbers if want to display all communes for all matched statuses
  #merge(commune_, by = "commune_num", all = TRUE) %>% 
  mutate(matched = 1) 
school_match_no.student_commune_name <- school_no %>% group_by(student_commune_name.school) %>%
  summarise(count = n()) %>% mutate(freq = count/sum(count)) %>%
  #merge(commune_nums, by = "commune_num", all = TRUE) %>% 
  mutate(matched = 0)

school_match.student_commune_name <- rbind(school_match_yes.student_commune_name, school_match_no.student_commune_name) %>%
  arrange(student_commune_name.school, matched)

kolmog_school_commune.bar <- ggplot(school_match.student_commune_name) +
  geom_col(aes(x = as.factor(matched), y = freq, fill = as.factor(matched))) +
  facet_wrap(~student_commune_name.school, scales = "fixed") +
  #facet_wrap(~student_commune_name.school, scales = "free") +
  labs(title = "Matching of school record to clinical record by commune",
       x = "Matched status",
       y = "Feature frequency",
       fill = "Matched status")
# most of the difference in matched commune frequency is for Temuco which is the biggest commune.

kolmog_school_commune.density <- ggplot(ks_perm.school.pvals, aes(x = commune_code, y = after_stat(density))) +
  geom_density() +
  geom_vline(xintercept = ks.school.commune_code$p.value, color = "red") +
  labs(title = "Kolmogorov-Smirnov permutation test on matched status in school data by commune and observed p-value (red)",
       x = "Commune",
       y = "Density")

grid.arrange(kolmog_school_commune.bar, kolmog_school_commune.density, nrow = 2)

```

```{r kolmogorovSchoolSes, fig.cap="a) Difference in frequency of proxy SES among school records that matched to patient records and school records that did not match. b) Density of Kolmogorov-Smirnov p-values for 2000 permutations of matched status for school records by proxy SES with observed p-value shown in red.", fig.height=9}
# Results for ses status
school_match_yes.ses_status <- school_yes %>% group_by(ses_status.school) %>% summarise(count = n()) %>% mutate(freq = count/sum(count), matched = 1)
school_match_no.ses_status <- school_no %>% group_by(ses_status.school) %>% summarise(count = n()) %>% mutate(freq = count/sum(count), matched = 0)
school_match.ses_status <- rbind(school_match_yes.ses_status, school_match_no.ses_status) %>%
  arrange(ses_status.school, matched)

kolmog_school_ses.bar <- ggplot(school_match.ses_status) +
  geom_col(aes(x = as.factor(matched), y = freq, fill = as.factor(matched))) +
  facet_wrap(~ses_status.school) +
  labs(title = "Matching of school record to clinical record by SES status",
       x = "Matched status",
       y = "Feature frequency",
       fill = "Matched status")

kolmog_school_ses.density <- ggplot(ks_perm.school.pvals, aes(x = ses_status, y = after_stat(density))) +
  geom_density() +
  geom_vline(xintercept = ks.school.ses_status$p.value, color = "red") +
  labs(title = "Kolmogorov-Smirnov permutation test on matched status in school data by proxy SES and observed p-value (red)",
       x = "Proxy SES",
       y = "Density")

grid.arrange(kolmog_school_ses.bar, kolmog_school_ses.density, nrow = 2)

```

```{r kolmogorovPatient, warning = FALSE}

patients_yes <- patients_matched_small %>% filter(matched == 1) #%>% select(sex.school)
patients_no <- patients_matched_small %>% filter(matched == 0)

# Kolmogorov tests for our matched results
ks.patients.sex <- ks.test(na.omit(patients_yes$sex.patient),
                         na.omit(patients_no$sex.patient),
                         alternative = "two.sided", simulate.p.value = TRUE)
#ks.patients.sex

ks.patients.ses_status <- ks.test(as.numeric(na.omit(patients_yes$ses_status.patient)),
                                as.numeric(na.omit(patients_no$ses_status.patient)),
                                alternative = "two.sided", simulate.p.value = TRUE)
#ks.patients.ses_status

ks.patients.commune_code<- ks.test(as.numeric(na.omit(patients_yes$commune_code)),
                                 as.numeric(na.omit(patients_no$commune_code)),
                                 alternative = "two.sided", simulate.p.value = TRUE)
#ks.patients.commune_code


# Kolmogorov tests with permutation distributions
set.seed(123)
nPerm <- 200 # change to 2000
ks_perm.patients.pvals <- data.frame(sex = numeric(nPerm),
                                   commune_code = numeric(nPerm),
                                   ses_status = numeric(nPerm))

patients_matched_small_perm <- patients_matched_small

for (i in 1:nPerm) {
  #print(i)
  patients_matched_small_perm$matched <- patients_matched_small$matched[sample(nrow(patients_matched_small))] # permute matched status
  patients_perm_yes <- patients_matched_small_perm %>% filter(matched == 1)
  patients_perm_no <- patients_matched_small_perm %>% filter(matched == 0)
  
  ks_perm.patients.sex <- ks.test(na.omit(patients_perm_yes$sex.patient),
                                na.omit(patients_perm_no$sex.patient), 
                                alternative = "two.sided")
  ks_perm.patients.commune_code <- ks.test(as.numeric(na.omit(patients_perm_yes$commune_code)),
                                        as.numeric(na.omit(patients_perm_no$commune_code)),
                                        alternative = "two.sided")
  ks_perm.patients.ses_status <- ks.test(as.numeric(na.omit(patients_perm_yes$ses_status.patient)),
                                       as.numeric(na.omit(patients_perm_no$ses_status.patient)),
                                       alternative = "two.sided")
  
  ks_perm.patients.pvals$sex[i] <- ks_perm.patients.sex$p.value
  ks_perm.patients.pvals$commune_code[i] <- ks_perm.patients.commune_code$p.value
  ks_perm.patients.pvals$ses_status[i] <- ks_perm.patients.ses_status$p.value
}
```

```{r kolmogorovPatientSex, fig.cap="a) Difference in frequency of sexes among patient records that matched to school records and patient records that did not match. b) Density of Kolmogorov-Smirnov p-values for 2000 permutations of matched status for patient records by sex with observed p-value shown in red.", fig.height=9}
# Results for sex
patients_match_yes.sex <- patients_yes %>% group_by(sex.patient) %>% summarise(count = n()) %>% mutate(freq = count/sum(count), matched = 1)
patients_match_no.sex <- patients_no %>% group_by(sex.patient) %>% summarise(count = n()) %>% mutate(freq = count/sum(count), matched = 0)
patients_match.sex <- rbind(patients_match_yes.sex, patients_match_no.sex) %>%
  mutate(sex_desc = ifelse(sex.patient == 1, "Male", ifelse(sex.patient == 2, "Female", NA))) %>% 
  arrange(sex_desc, matched)

kolmog_patient_ses.bar <- ggplot(patients_match.sex) +
  geom_col(aes(x = as.factor(matched), y = freq, fill = as.factor(matched))) +
  facet_wrap(~sex_desc) +
  labs(title = "Matching of clinical record to school record by sex",
       x = "Matched status",
       y = "Feature frequency",
       fill = "Matched status")

kolmog_patient_ses.density <- ggplot(ks_perm.patients.pvals, aes(x = sex, y = after_stat(density))) +
  geom_density() +
  geom_vline(xintercept = ks.patients.sex$p.value, color = "red") +
  labs(title = "Kolmogorov-Smirnov permutation test on matched status in patient data by sex and observed p-value (red)",
       x = "Sex",
       y = "Density")

grid.arrange(kolmog_patient_ses.bar, kolmog_patient_ses.density, nrow = 2)
```

```{r kolmogorovPatientCommune, fig.cap="a) Difference in frequency of commune of residence among patient records that matched to school records and patient records that did not match. b) Density of Kolmogorov-Smirnov p-values for 2000 permutations of matched status for patient records by commune of residence with observed p-value shown in red.", fig.height=9}
# Results for commune
patients_match_yes.student_commune_name <- patients_yes %>% group_by(student_commune_name.patient) %>%
  summarise(count = n()) %>% mutate(freq = count/sum(count)) %>%
  # Would need to merge to a list of commune names and numbers if want to display all communes for all matched statuses
  #merge(commune_, by = "commune_num", all = TRUE) %>% 
  mutate(matched = 1) 
patients_match_no.student_commune_name <- patients_no %>% group_by(student_commune_name.patient) %>%
  summarise(count = n()) %>% mutate(freq = count/sum(count)) %>%
  #merge(commune_nums, by = "commune_num", all = TRUE) %>% 
  mutate(matched = 0)

patients_match.student_commune_name <- rbind(patients_match_yes.student_commune_name, patients_match_no.student_commune_name) %>%
  arrange(student_commune_name.patient, matched)

kolmog_patient_commune.bar <- ggplot(patients_match.student_commune_name) +
  geom_col(aes(x = as.factor(matched), y = freq, fill = as.factor(matched))) +
  facet_wrap(~student_commune_name.patient, scales = "fixed") +
  #facet_wrap(~student_commune_name.school, scales = "free") +
  labs(title = "Matching of clinical record to school record by commune",
       x = "Matched status",
       y = "Feature frequency",
       fill = "Matched status")
# most of the difference in matched commune frequency is for Temuco which is the biggest commune.


kolmog_patient_commune.density <- ggplot(ks_perm.patients.pvals, aes(x = commune_code, y = after_stat(density))) +
  geom_density() +
  geom_vline(xintercept = ks.patients.commune_code$p.value, color = "red") +
  labs(title = "Kolmogorov-Smirnov permutation test on matched status in patient data by commune and observed p-value (red)",
       x = "Commune",
       y = "Density")

grid.arrange(kolmog_patient_commune.bar, kolmog_patient_commune.density, nrow = 2)
```

```{r kolmogorovPatientSes, fig.cap="a) Difference in frequency of proxy SES among patient records that matched to school records and patient records that did not match. b) Density of Kolmogorov-Smirnov p-values for 2000 permutations of matched status for patient records by proxy SES with observed p-value shown in red.", fig.height=9}
# Results for ses status
patients_match_yes.ses_status <- patients_yes %>% group_by(ses_status.patient) %>% summarise(count = n()) %>% mutate(freq = count/sum(count), matched = 1)
patients_match_no.ses_status <- patients_no %>% group_by(ses_status.patient) %>% summarise(count = n()) %>% mutate(freq = count/sum(count), matched = 0)
patients_match.ses_status <- rbind(patients_match_yes.ses_status, patients_match_no.ses_status) %>%
  arrange(ses_status.patient, matched)

kolmog_patient_ses.bar <- ggplot(patients_match.ses_status) +
  geom_col(aes(x = as.factor(matched), y = freq, fill = as.factor(matched))) +
  facet_wrap(~ses_status.patient) +
  labs(title = "Matching of clinical record to school record by SES status",
       x = "Matched status",
       y = "Feature frequency",
       fill = "Matched status")

kolmog_patient_ses.density <- ggplot(ks_perm.patients.pvals, aes(x = ses_status, y = after_stat(density))) +
  geom_density() +
  geom_vline(xintercept = ks.patients.ses_status$p.value, color = "red") +
  labs(title = "Kolmogorov-Smirnov permutation test on matched status in patient data by proxy SES and observed p-value (red)",
       x = "Proxy SES",
       y = "Density")

grid.arrange(kolmog_patient_ses.bar, kolmog_patient_ses.density, nrow = 2)
```


## Bayesian prevalence estimation

```{r bayesAdjParams}
nObs <- nrow(chile_bayes)
nIter <- 1000
nBurn <- 1000
pars <- c("theta_a", "theta_b", "theta", "disease_sample", "disease_pred")

# Autism priors
# All
aut_theta_mu_prior <- aut_prev_adj$adjusted_rate
aut_theta_sigma_prior <- (aut_prev_adj$adjusted_ci_upper - aut_prev_adj$adjusted_ci_lower) / (2*1.96)
# Females
aut_theta_mu_prior_f <- aut_prev_adj_f$adjusted_rate
aut_theta_sigma_prior_f <- sqrt(aut_prev_adj_f$var)
# Males
theta_mu_prior_m <- aut_prev_adj_m$adjusted_rate
theta_sigma_prior_m <- sqrt(aut_prev_adj_m$var)
# Projections, use same sigma as before
aut_theta_mu_proj <- c(0.005, 0.01, 0.02, 0.03) # 0.5%, 1%, 2%, 3% prevalence
aut_theta_mu_proj_f <- c(0.0025, 0.005, 0.01, 0.02)
aut_theta_mu_proj_m <- c(0.01, 0.02, 0.03, 0.05)
aut_theta_sigma_proj <- c(rep((aut_prev_adj$adjusted_ci_upper - aut_prev_adj$adjusted_ci_lower) / (2*1.96), 4))

# ADHD priors
# All
adhd_theta_mu_prior <- adhd_prev_adj$adjusted_rate
adhd_theta_sigma_prior <- (adhd_prev_adj$adjusted_ci_upper - adhd_prev_adj$adjusted_ci_lower) / (2*1.96)
# Females
adhd_theta_mu_prior_f <- adhd_prev_adj_f$adjusted_rate
adhd_theta_sigma_prior_f <- sqrt(adhd_prev_adj_f$var)
# Males
adhd_theta_mu_prior_m <- adhd_prev_adj_m$adjusted_rate
adhd_theta_sigma_prior_m <- sqrt(adhd_prev_adj_m$var)
# Projections, use same sigma as before
adhd_theta_mu_proj <- c(0.02, 0.03, 0.05, 0.07) # 2%, 3%, 5%, 7% prevalence
adhd_theta_mu_proj_f <- c(0.015, 0.02, 0.03, 0.05)
adhd_theta_mu_proj_m <- c(0.02, 0.03, 0.05, 0.07)
adhd_theta_sigma_proj <- c(rep((adhd_prev_adj$adjusted_ci_upper - adhd_prev_adj$adjusted_ci_lower) / (2*1.96), 4))

rand_model <- "model {
  for(i in 1:nFeat) { # For each category in the feature grouping
    theta[i] ~ dbeta(theta_a, theta_b)
    disease_sample[i] ~ dbin(theta[i], nObs[i])
    disease_pred[i] ~ dbin(theta[i], nObs[i])
  }
}"
```

```{r bayesSexAut, fig.cap = "Posterior predictive distribution for autism with a random effect on sex, and with age- and sex-adjusted global prevalence prior."}
aut_prev_sex_adj <- rbind(aut_prev_adj_m, aut_prev_adj_f) 
# have to put m first because 1 comes before 2 and otherwise will mess up naming in do_jags_rand_model

aut_prev_sex_post <- do_jags_rand_model(x = aut_prev_sex_adj,
                              feat = "sex_desc",
                              model = rand_model,
                              theta_mu = aut_theta_mu_prior,
                              theta_sigma = aut_theta_sigma_prior,
                              pars = pars, 
                              convergence_checks = FALSE) %>%
  rename("sex_desc" = "Feat_names")

plot_post_density(aut_prev_sex_post, aut_prev_sex_adj, 
                  feat = "sex_desc", 
                  theta_mu = aut_theta_mu_prior, theta_sigma = aut_theta_sigma_prior,
                  disease = "Autism")
```

```{r bayesSexAdhd, fig.cap = "Posterior predictive distribution for ADHD with a random effect on sex, and with age- and sex-adjusted global prevalence prior."}
adhd_prev_sex_adj <- rbind(adhd_prev_adj_m, adhd_prev_adj_f) 
# have to put m first because 1 comes before 2 and otherwise will mess up naming in do_jags_rand_model

adhd_prev_sex_post <- do_jags_rand_model(x = adhd_prev_sex_adj,
                              feat = "sex_desc",
                              model = rand_model,
                              theta_mu = adhd_theta_mu_prior,
                              theta_sigma = adhd_theta_sigma_prior,
                              pars = pars, 
                              convergence_checks = FALSE) %>%
  rename("sex_desc" = "Feat_names")

plot_post_density(adhd_prev_sex_post, adhd_prev_sex_adj, 
                  feat = "sex_desc", 
                  theta_mu = adhd_theta_mu_prior, theta_sigma = adhd_theta_sigma_prior,
                  disease = "ADHD")
```

```{r bayesHealthAut, fig.cap = "Posterior predictive distribution for autism with a random effect on student's health service, and with age- and sex-adjusted global prevalence prior."}
aut_prev_health_post <- do_jags_rand_model(x = aut_prev_health_adj,
                              feat = "health_service_name",
                              model = rand_model,
                              theta_mu = aut_theta_mu_prior,
                              theta_sigma = aut_theta_sigma_prior,
                              pars = pars, 
                              convergence_checks = FALSE) %>%
  rename("health_service_name" = "Feat_names")

plot_post_density(aut_prev_health_post, aut_prev_health_adj, 
                  feat = "health_service_name", 
                  theta_mu = aut_theta_mu_prior, theta_sigma = aut_theta_sigma_prior,
                  disease = "Autism")
```

```{r bayesHealthAdhd, fig.cap = "Posterior predictive distribution for ADHD with a random effect on health service, and with age- and sex-adjusted global prevalence prior."}
adhd_prev_health_post <- do_jags_rand_model(x = adhd_prev_health_adj,
                              feat = "health_service_name",
                              model = rand_model,
                              theta_mu = adhd_theta_mu_prior,
                              theta_sigma = adhd_theta_sigma_prior,
                              pars = pars, 
                              convergence_checks = FALSE) %>%
  rename("health_service_name" = "Feat_names")

plot_post_density(adhd_prev_health_post, adhd_prev_health_adj, 
                  feat = "health_service_name", 
                  theta_mu = adhd_theta_mu_prior, theta_sigma = adhd_theta_sigma_prior,
                  disease = "ADHD")
```

```{r bayesAraucSAut, fig.cap = "Posterior predictive distribution for autism with a random effect on commune within Araucanía Sur health service, and with age- and sex-adjusted global prevalence prior.", include=FALSE}
# aut_prev_araucS_post <- do_jags_rand_model(x = aut_prev_araucS_adj,
#                               feat = "commune_name",
#                               model = rand_model,
#                               theta_mu = aut_theta_mu_prior,
#                               theta_sigma = aut_theta_sigma_prior,
#                               pars = pars, 
#                               convergence_checks = FALSE) %>%
#   rename("commune_name" = "Feat_names")
# 
# plot_post_density(aut_prev_araucS_post, aut_prev_araucS_adj, 
#                   feat = "commune_name", 
#                   theta_mu = aut_theta_mu_prior, theta_sigma = aut_theta_sigma_prior,
#                   disease = "Autism")
```

```{r bayesEconAAut, fig.cap = "Posterior predictive distribution for autism with a random effect on socio-economic status of student's family, and with age- and sex-adjusted global prevalence prior."}
aut_prev_econA_post <- do_jags_rand_model(x = aut_prev_econA_adj,
                              feat = "school_fee",
                              model = rand_model,
                              theta_mu = aut_theta_mu_prior,
                              theta_sigma = aut_theta_sigma_prior,
                              pars = pars, 
                              convergence_checks = FALSE) %>%
  rename("school_fee" = "Feat_names")

plot_post_density(aut_prev_econA_post, aut_prev_econA_adj, 
                  feat = "school_fee", 
                  theta_mu = aut_theta_mu_prior, theta_sigma = aut_theta_sigma_prior,
                  disease = "Autism")
```

```{r bayesEconAAdhd, fig.cap = "Posterior predictive distribution for ADHD with a random effect on socio-economic status of student's family, and with age- and sex-adjusted global prevalence prior."}
adhd_prev_econA_post <- do_jags_rand_model(x = adhd_prev_econA_adj,
                              feat = "school_fee",
                              model = rand_model,
                              theta_mu = adhd_theta_mu_prior,
                              theta_sigma = adhd_theta_sigma_prior,
                              pars = pars, 
                              convergence_checks = FALSE) %>%
  rename("school_fee" = "Feat_names")

plot_post_density(adhd_prev_econA_post, adhd_prev_econA_adj, 
                  feat = "school_fee", 
                  theta_mu = adhd_theta_mu_prior, theta_sigma = adhd_theta_sigma_prior,
                  disease = "ADHD")
```

```{r bayesEthnicAut, fig.cap = "Posterior predictive distribution for autism with a random effect on ethnicity, and with age- and sex-adjusted global prevalence prior."}
aut_prev_ethnic_post <- do_jags_rand_model(x = aut_prev_ethnic_adj,
                              feat = "ethnic_2_group",
                              model = rand_model,
                              theta_mu = aut_theta_mu_prior,
                              theta_sigma = aut_theta_sigma_prior,
                              pars = pars, 
                              convergence_checks = FALSE) %>%
  rename("ethnic_2_group" = "Feat_names")

plot_post_density(aut_prev_ethnic_post, aut_prev_ethnic_adj, 
                  feat = "ethnic_2_group", 
                  theta_mu = aut_theta_mu_prior, theta_sigma = aut_theta_sigma_prior,
                  disease = "Autism")
```

```{r bayesEthnicAdhd, fig.cap = "Posterior predictive distribution for ADHD with a random effect on ethnicity, and with age- and sex-adjusted global prevalence prior."}
adhd_prev_ethnic_post <- do_jags_rand_model(x = adhd_prev_ethnic_adj,
                              feat = "ethnic_2_group",
                              model = rand_model,
                              theta_mu = adhd_theta_mu_prior,
                              theta_sigma = adhd_theta_sigma_prior,
                              pars = pars, 
                              convergence_checks = FALSE) %>%
  rename("ethnic_2_group" = "Feat_names")

plot_post_density(adhd_prev_ethnic_post, adhd_prev_ethnic_adj, 
                  feat = "ethnic_2_group", 
                  theta_mu = adhd_theta_mu_prior, theta_sigma = adhd_theta_sigma_prior,
                  disease = "ADHD")
```

```{r bayesRuralAut, fig.cap = "Posterior predictive distribution for autism with a random effect on school's rurality, and with age- and sex-adjusted global prevalence prior."}
aut_prev_rural_post <- do_jags_rand_model(x = aut_prev_rural_adj,
                              feat = "school_rurality",
                              model = rand_model,
                              theta_mu = aut_theta_mu_prior,
                              theta_sigma = aut_theta_sigma_prior,
                              pars = pars, 
                              convergence_checks = FALSE) %>%
  rename("school_rurality" = "Feat_names")

plot_post_density(aut_prev_rural_post, aut_prev_rural_adj, 
                  feat = "school_rurality", 
                  theta_mu = aut_theta_mu_prior, theta_sigma = aut_theta_sigma_prior,
                  disease = "Autism")
```

```{r bayesRuralAdhd, fig.cap = "Posterior predictive distribution for ADHD with a random effect on school's rurality, and with age- and sex-adjusted global prevalence prior."}
adhd_prev_rural_post <- do_jags_rand_model(x = adhd_prev_rural_adj,
                              feat = "school_rurality",
                              model = rand_model,
                              theta_mu = adhd_theta_mu_prior,
                              theta_sigma = adhd_theta_sigma_prior,
                              pars = pars, 
                              convergence_checks = FALSE) %>%
  rename("school_fee" = "Feat_names")

plot_post_density(adhd_prev_econA_post, adhd_prev_econA_adj, 
                  feat = "school_fee", 
                  theta_mu = adhd_theta_mu_prior, theta_sigma = adhd_theta_sigma_prior,
                  disease = "ADHD")
```

